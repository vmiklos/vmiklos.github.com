title: Perfect WW8 comment import
author: Miklos
tags: en, libreoffice
pubdate: 2015-01-24T22:14:50Z
<<<
TL;DR: Import of annotated text ranges from binary DOC format was a problem
for quite some time, now it should be as good as it always was in the
ODT/DOCX/RTF filter.

Longer version: the import of annotation marks from binary DOC was never
perfect. My
http://cgit.freedesktop.org/libreoffice/core/commit/?id=7907cc0ef9751d553014bd3bab49be9e7fc31bca[initial
implementation] had a somewhat hidden, but important shortcoming, in the form
of a "Don't support ranges affecting multiple SwTxtNode for now." comment. The
underlying problem was that annotation marks have a start and end position,
and this is described as an offset into the piece table (so the unit was a
character position, CP) in the binary DOC format, while in Writer, we work
with document model positions (text node and content indexes, SwPosition), and it isn't
trivial to map between these two.

http://zolnaitamas.blogspot.com/[TamÃ¡s] somewhat
http://cgit.freedesktop.org/libreoffice/core/commit/?id=f2945255df273404ee2457dcf761cb8f334b732b[improved]
this homegrown CP -> SwPosition mapping code, but was still far from perfect. Here is an example. This is how http://people.freedesktop.org/~vmiklos/2015/perfect-ww8-comment-import.doc[this demo document] looks like now in LibreOffice Writer:

image::https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s800/[align="center",link="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s0/"]

And this is how it looked like before the end of last year:

image::https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s800/[align="center",link="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s0/"]

Notice how "Start" is commented and it wasn't before. Which one is correct? Here is the reference:

image::https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s800/[align="center",link="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s0/"]

The reason is that the document has fields and tables, and the homegrown CP ->
SwPosition mapping did not handle this. A much better approach is to handle
the mapping as we do it for bookmarks: even if at the end annotation marks and
bookmarks are entires in `sw::mark::MarkManager`, it's possible to set the
start position as a character attribute during import (since mapping the
_current_ CP to the current SwPosition is easy) and when we know both the
start and end, delete the character attribute and turn it into a mark manager
entry. That's exactly what I've done. The first screenshot is the result of 3
changes:

- http://cgit.freedesktop.org/libreoffice/core/commit/?id=271722d923610d128a358528e64d7233641ea0dc[add
  a annotationmark-start character attribute]
- http://cgit.freedesktop.org/libreoffice/core/commit/?id=677fdd4fa235466649911042577bc4980d42deb6[tokenize
  the annitationmark start and end structures from binary DOC]
- http://cgit.freedesktop.org/libreoffice/core/commit/?id=0ec0ec267986644084baaa5bda5ba917dc5744df[handle
  annotation marks via the character attribute added in the first change]

Hopefully this makes LibreOffice not only
http://cgit.freedesktop.org/libreoffice/core/commit/?id=b1cd83c625a2afeb9da43cc9745d79c01963c797[avoid
crashing] on such complex annotated contents, but also puts and end to the
long story of "annotation marks from binary DOC" problems.

NOTE: Just like how $$C++11$$ perfect forwarding isn't perfect -- if you think
it is, see "Familiarize yourself with perfect forwarding failure cases." in
http://scottmeyers.blogspot.hu/2014/08/near-final-draft-of-effective-modern-c.html[this
post of Scoot] -- the above changes may still not result in a truly perfect
import result of DOC annotation marks. But I think the #1 problem in this area
is now solved. :-)

// vim: ft=asciidoc
