= Insert PDF as image in LibreOffice 5.3

:slug: lo-insert-pdf-image
:category: libreoffice
:tags: en
:date: 2016-10-10T08:31:37Z

== Results

LibreOffice 5.3 will add one more vector-based format that can be inserted as
an image into documents: PDF. First, thanks to http://pmg.be/[PMG] who made
this work possible. On the user interface you can now select PDF files when
you choose e.g. Writer's Insert -> Image option:

image::https://farm6.staticflickr.com/5552/29583461353_02fc75dd7f_z.jpg[align="center",link="https://farm6.staticflickr.com/5552/29583461353_0c2da79c8e_o.png"]

The first page of the PDF document will be shown, which is handy if the PDF
file is basically used as a vector image format.

Similarly to the SVG feature, the original vector image is stored in the
document, but when saving to ODF, a replacement PNG file is also generated to
be backwards compatible with older ODF readers. The image context menu -> Save
menu item allows to extract your original PDF data from the image, too:

image::https://farm8.staticflickr.com/7501/30098334712_535e16ea05_z.jpg[align="center",link="https://farm8.staticflickr.com/7501/30098334712_569ebbe55b_o.png"]

And that's it, as long as you save your document in ODF, your PDF-as-an-image
will be kept without loosing any data. As usual, you can try this right now
with a 5.3 http://dev-builds.libreoffice.org/daily/master/[daily build]. :-)

However, if you're interested in how this is implemented, keep reading...

== Document model

The PDF image in the document model is really similar to how SVG is handled,
next to `Graphic::getSvgData()`, there is now a `Graphic::getPdfData()`.
This new member function exposes the original PDF data, otherwise the Graphic
is just a metafile.

== UNO API

The `ReplacementGraphicURL` property of the image at an UNO level now exposes
the generated metafile for PDF images. This is implemented for both Draw and
Writer images, and is used by the ODF export filter.

== Layout

When the `Graphic` instance is rendered, the layout knows nothing about the
PDF data attached to the object, only parses the generated metafile. This way
the display of the PDF image works out of the box.

== Filters

First I've implemented a
https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=878a860dff10bd91491d6c9f2f4e2308bfe4f0b2[PDF
import-as-graphic filter], then the
https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=7d76bb251e0c88ff17282a33b801a5d17a434af5[export
equivalent of it]. As you can see, the PDF import-as-graphic filter isn't too
complicated, it completely reuses the existing "import PDF into Draw" filter,
it simply copies the first page of the resulting document model as a metafile.

Second, once the graphic filters were working, I've also
https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=d1c346ba848c54424d6ffa88df7a5ff6a3717430[improved]
the ODF import to recognize PDF data -- the export side needed no explicit
work, once the `ReplacementGraphicURL` bits were in place.

== Tests

As mentioned above, the Draw and the Writer image implementation is separate,
so first I've added tests for ODT files in the `testEmbeddedPdf` of
`CppunitTest_sw_odfexport`, and then `SdExportTest::testEmbeddedPdf()` to
cover ODP files (and other ODF formats).  Second, the PDF part of the graphic
swapout/in code has a dedicated test in `GraphicObjectTest::testPdf()`, and
the UI's "Save original PDF" feature has a new
`XOutdevTest::testPdfGraphicExport()` test.

Oh, and if you intent to test this manually in a self-created build, make sure
to avoid `--disable-pdfimport`, otherwise this feature can't work. ;-)

// vim: ft=asciidoc
