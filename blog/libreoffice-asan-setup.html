<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<meta name="description" content="A LibreOffice / AddressSanitizer setup - Miklos' blog" />
<meta name="keywords" content="vmiklos, libereoffice, swig, git, python, hacking, bitlbee" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/index.rss" />
<link rel="stylesheet" href="/blog/xhtml11.css" type="text/css" />
<link rel="stylesheet" href="/blog/xhtml11-quirks.css" type="text/css" />
<link rel="stylesheet" href="/blog/layout.css" type="text/css" />
<title>A LibreOffice / AddressSanitizer setup</title>
<!-- google analytics start -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24726997-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- google analytics end -->
</head>
<body>
<div id="layout-menu-box">
<div id="layout-menu">
  <div>&#187;<a href="/">Root</a></div>
  <div>&#187;<a href="/blog/">Rejourn root</a></div>
  <div>&#187;<a href="http://planet.documentfoundation.org/">LibreOffice Community Blogs</a></div>
  <div>
    Search:<br/>
    <form action="http://www.google.com/cse" id="cse-search-box" target="_blank">
    <input type="hidden" name="cx" value="007336731492173318056:bik8fqvatno"/><input type="hidden" name="ie" value="UTF-8"/><input type="text" name="q" size="15"/><br/>
    <input type="submit" name="sa" value="&#187;"/></form>
  </div>
</div>

</div>
<div id="layout-content-box">
<div id="layout-content">
<div id="header">
	<h1>A LibreOffice / AddressSanitizer setup</h1>
</div>
<div id="preamble">
<div class="sectionbody">

<!-- Single entry -->
<div class="verseblock">
<div class="verseblock-content">Posted <span class="timeago" title="2016-07-25T09:52:14Z">Monday, 25 July 2016</span> by Miklos<br />
    Tags:
    <a href="tags/en.html">en</a>
    <a href="tags/libreoffice.html">libreoffice</a>
<div class="nav-previous"><a href="/blog/vc-voc-oc.html" rel="prev"><span class="meta-nav">&larr;</span> On LibreOffice's ViewContact/ViewObjectContact/ObjectContact</a></div>
<div class="nav-next"><a href="/blog/libreoffice-xmlsec.html" rel="next">LibreOffice now bundles the latest libxmlsec version <span class="meta-nav">&rarr;</span></a></div>
</div>
</div>

<!-- Body -->
<div class="paragraph"><p><a href="https://github.com/google/sanitizers">sanitizers</a> (ASAN, UBSAN, etc.) is a
collection of tools to detect memory corruption bugs, undefined behavior and
more by instrumenting the code generated by the compiler. (That&#8217;s the main
difference from valgrind.) From LibreOffice&#8217;s perspective one more important
difference is that there is a
<a href="http://ci.libreoffice.org/job/lo_ubsan/">Jenkins_Linux_Ubsan</a> tinderbox that
makes sure that the master branch is kept clean from errors detected by a
given configuration.</p></div>
<div class="paragraph"><p>So when the tinderbox failed after a commit of mine, I wanted to set up a
similar environment locally, reproduce and fix the bug, and push the fix once
I saw that the fix indeed solves the problem. You can set many options both at
build and runtime, so while we have some
<a href="https://wiki.documentfoundation.org/Development/-fsanitize">documentation</a> on
the TDF wiki (and also Stephan was kind enough to share
<a href="https://people.freedesktop.org/~vmiklos/2016/sanitizers-config-sberg">his
config</a>) on how to use these sanitizers, it wasn&#8217;t clear to me what to do step
by step. So here is one possible setup that worked for me&#8201;&#8212;&#8201;in my case I
wanted to reproduce a stack-use-after-return problem. If you haven&#8217;t ever built
LibreOffice before, then go to
<a href="https://wiki.documentfoundation.org/Development">the Development wiki page</a>,
first do a normal build, and if everything went fine, came back here.</p></div>
<div class="sect1">
<h2 id="_build_options">Build options</h2>
<div class="sectionbody">
<div class="paragraph"><p>My <code>autogen.input</code> looks like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>CC=clang -fsanitize=address
CXX=clang++ -fsanitize=address
--enable-dbgutil
--disable-firebird-sdbc</code></pre>
</div></div>
<div class="paragraph"><p>Which is a normal clang debug build, except:</p></div>
<div class="ulist"><ul>
<li>
<p>
you need to add <code>-fsanitize=...</code> to <code>CXX</code> (not to <code>CXXFLAGS</code>), as explained
  on the wiki
</p>
</li>
<li>
<p>
you need to explicitly disable Firebird integration for now
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_building">Building</h2>
<div class="sectionbody">
<div class="paragraph"><p>My first attempt failed at build time, as even the tools used only during the
build are instrumented, and some memory leak was detected there, which means
the build aborted before reaching the problem I was interested in. To disable
leak detection during build, and disable parallelism (I needed this, as I did
the build in the background while using the machine for something else):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>make build-nocheck ASAN_OPTIONS=detect_leaks=0 PARALLELISM=1</code></pre>
</div></div>
<div class="paragraph"><p>This also means that I explicitly disabled running any tests, as I knew which
is the single unit test I want to run for the purposes of reproducing and
fixing the problem.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">
<div class="paragraph"><p>Once the build completed, it turns out that the stack-use-after-return detection is disabled at runtime by default, which means I could not see any problem locally. Here is the commandline to run one specific CppunitTest with this detection on:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>cd sw; make -sr CppunitTest_sw_tiledrendering ASAN_OPTIONS=detect_leaks=0:detect_stack_use_after_return=1</code></pre>
</div></div>
<div class="paragraph"><p>Again, this is just one possible setup, you can use other <code>-fsanitize=...</code>
options, other environment variables during build and during testing&#8201;&#8212;&#8201;but
hopefully it helps in the future to avoid pushing fixes for such problems
detected by sanitizers just blindly.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_update_2019_01_25">Update, 2019-01-25</h2>
<div class="sectionbody">
<div class="paragraph"><p>The above described "do it yourself" way doesn&#8217;t work with LibreOffice master
(towards 6.3) and openSUSE Leap 15.0 anymore. I tried to debug what is the
exact problem, but there are many moving parts here:</p></div>
<div class="ulist"><ul>
<li>
<p>
gcc version (providing libstdc++)
</p>
</li>
<li>
<p>
clang version (5.0.2 is too old; 7 failed to build the plugins, trunk
  towards 9 also generated false positives for me)
</p>
</li>
<li>
<p>
various sanitizer-related environment variables
</p>
</li>
<li>
<p>
various sanitizer-related compiler options
</p>
</li>
</ul></div>
<div class="paragraph"><p>So it&#8217;s much easier to just use the combination used by the
<code>Jenkins_Linux_Ubsan</code> tinderbox than something custom. Doing that is
reasonably straightforward, but still there are a couple of non-trivial steps.
What worked for me is:</p></div>
<div class="ulist"><ul>
<li>
<p>
Set up LODE according to its
  <a href="https://wiki.documentfoundation.org/Development/lode">wiki page</a>.
</p>
</li>
<li>
<p>
Instead of plain <code>./setup --dev</code>, do:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>./setup --jenkins
./setup --jenkins-san
./setup --dev
cd $LODE_HOME/dev/core</code></pre>
</div></div>
<div class="paragraph"><p>This will build a working version of both gcc and clang for you.</p></div>
<div class="ulist"><ul>
<li>
<p>
Instead of manually setting up the environment variables, do:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>. $LODE_HOME/bin/lode_ubsan_env</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Instead of manually setting autogen options, use this autogen.input:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>--with-distro=Jenkins/Linux_ubsan_master
--with-lang=en-US</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Finally to build the code and run a specific test based on tinderbox mail:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>make build-nocheck
cd sw; make -sr CppunitTest_sw_unowriter CPPUNIT_TEST_NAME="testPasteListener"</code></pre>
</div></div>
</div>
</div>


</div>
</div>
</div>
</div>
</body>
</html>
