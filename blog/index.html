<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />


  <title>
    What is Miklos hacking
  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable7.html">Multi-page floating tables in Writer: overlap control, border and footnotes</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 01 September 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 4 minutes</p>
  </div>
  <div class="article_text">
    <p>This post is part of a series to describe how Writer now gets a feature to handle tables that are
both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable6.html">sixth post</a> for the previous part.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>The current post features sub-tasks for the multi-page floating table work that is around an
explicit table overlap control that Word has (and Writer lacked so far), compatible border rendering
of split tables and having footnotes in floating tables, which was not working previously.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Regarding testing, the core.git repository has 60 files now which are focusing on correct
handling of floating tables (filename matching <code>floattable-|floating-table-</code>). This doesn't count
cases where the document model is built using C++ code in the memory and then we assert the result
of some operation.</p>
<p>Here are some screenshots from the fixes this month:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-02-floattable-edit-dummy-text.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-02-floattable-edit-dummy-text.png"><figcaption>Old, new and reference rendering after expanding an autotext.</figcaption></figure></a></p>
<p>The first screenshot shows a case where the anchor paragraph of a floating table had some autotext
(e.g. "dt", which stands for dummy text), and pressing the relevant shortcut (F3) expands that
autotext with the actual content. This includes changing the anchor position of the floating table,
which lead to overlapping text. (A multi-page floating table has multiple anchors, we have to make
sure we don't set all of them to the new value as-is.)</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-10-floattable-overlap-never.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-10-floattable-overlap-never.png"><figcaption>Old, new and reference rendering of tables with the overlap=never markup.</figcaption></figure></a></p>
<p>The next screenshot shows a case where two tables are positioned in a way that they would overlap.
Word has a flag that asks the layout to still re-position the second table so the overlap doesn't
happen, and now Writer supports this as well.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-16-floattable-duplicated.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-16-floattable-duplicated.png"><figcaption>Old, new and reference rendering of duplicated anchor text.</figcaption></figure></a></p>
<p>This screenshot shows a bug where the anchor text on the first page was also duplicated on the
second page. Now we properly start the anchor text on the last page of the floating table, like Word
does.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-21-floattable-split-border.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-21-floattable-split-border.png"><figcaption>Old, new and reference rendering of a multi-page floating table with borders.</figcaption></figure></a></p>
<p>What you can see is a floating table that has 2 pages, but simply a split of the table would result
in no bottom border on the first page and no top border for the second, like perhaps you would
expect it, matching Word. This is now fixed, the layout infers the border style in those cases
correctly.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-24-floattable-footnote.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-24-floattable-footnote.png"><figcaption>Old, new and reference rendering of a footnote in a floating table.</figcaption></figure></a></p>
<p>The last screenshot shows a mini-feature: it was possible to float tables and to have footnotes in
tables, but not both at the same time. The screenshot shows a case where a floating table is
needed, so a specific paragraph is <em>above</em> the table. But we couldn't float the table, because
it had a footnote and that would be lost as-is. Now you can have a correct position for that
paragraph and the footnote is there as well, at the same time.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/2b401b7c0322d9ff972d252208ebe9a77913778d">tdf#156350 sw floattable: fix bad additional draw:frame in ODT with layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/073072f0a3abacfe4f9cc920b8138d7abc84db70">tdf#156260 sw floattable: avoid overlapping flys on anchor change</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b6a22e2be79cd874c7526107a6793fae692620dc">tdf#156260 sw floattable: avoid moving text from the last anchor to its precede</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f151ba5ebc8662d5459eacb1c5d6f01a4c826f26">sw floattable: simplify collecting frames at node with layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/107de1a2c6882213cf0ef6783417302f43cdada0">tdf#156349 sw floattable: fix caption insert for tables inside split fly frames</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c545a0729e89ee2e8f14534b77422cc9eb4eb7cf">sw floattable, crashtesting: fix PDF export of tdf73201-1.docx</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0d571ff8079f858a5650bf6cbb38296d22cc58e1">tdf#156589 sw floattable: fix follow fly moving inside a table on the next page</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d3a0ff741f5a7ff0dcec301e5b34ee9d638acf98">sw floattable: import w:tblOverlap w:val="never" from DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/905962db870e9d1cf1dcf3bd1be44c347cddafe1">sw floattable: handle AllowOverlap==false in the layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5af44a176d2a738dd7523713202aeee27c5578b6">sw floattable: export w:tblOverlap w:val=never to DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d44af60677740b151305799a4325d0f0699fce66">sw floattable: handle AllowOverlap==false in the DOC filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/68c8466dd80e7a964e1377ee3e0308dc449fbf2d">sw floattable: handle AllowOverlap==false in the RTF filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1cf29168840f84c2e946e2678b99988e83503c96">tdf#156682 sw floattable: fix missing del of master anchor para por on split</a></li>
<li><a href="https://git.libreoffice.org/core/commit/53798fef2cc0b5b0b9706081a4af5ceca964a41b">Related: tdf#156351 sw floattable: fix missing top border in follow table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/08aea5526c75ff4c5385e960bd940f10ffa19cd5">tdf#156351 sw floattable: fix missing bottom border in master table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/56da1d30afe48cc4acd79567052a575e81f8c7a0">tdf#77760 sw floattable: add support for footnotes, doc model</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f8e1a62f944e5358fe498008b4ff8701f1e190a0">tdf#77760 sw floattable: add support for footnotes, layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/178421a6c719dac9c16f220b76292fec16a53f60">tdf#77760 sw floattable: add support for footnotes, DOCX import</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2e1ddc8aeb0a92cc43ef4b7dc4762cd50a6b7fbc">sw floattable: don't split if anchored inside a footnote</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c7b59c9484ae6ff88cd8d7017aeb83b02e212c9c">tdf#77760 sw floattable: add support for footnotes, DOC import</a></li>
<li><a href="https://git.libreoffice.org/core/commit/739597df38dcaab0460482e3bc3f18f2471d43ab">tdf#77760 sw floattable: add support for footnotes, UI</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable6.html">Multi-page floating tables in Writer: part 6</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 01 August 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 5 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has continued steps to handle tables that are both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable5.html">fifth post</a> for background.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>The previous post finished with an "almost done" state for overlapping tables: this is a cluster of
problems where tables are allowed to overlap, but various other formatting make them not overlap in
practice in Word, but they do overlap in Writer. In this post, we'll see what was necessary so an
initial set of old documents now render perfectly, which started to work during the past month.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The feature is enabled by default and the DOCX/DOC/RTF import makes use of it.</p>
<p>On the positive side, core.git repository has has 49 files now which are focusing on correct
handling of floating tables (filename matching <code>floattable-|floating-table-</code>).  Also, there are
additional tests that quickly build a specific multi-page floating table in the memory and do some
operation on it, e.g.  delete the last row and assert what happens.</p>
<p>Here are some screenshots from the fixes this month (right click, open image in new tab for larger size):</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable6/2023-07-03-floattable-negative-vert-offset-emptyanchor.png"><figcaption>Old, new and reference rendering of a floating table with negative vertical position, relative to an empty anchor.</figcaption>
</figure>
</p>
<p>The first case is about a document where the bottom of the page had a floating table, where the
position (relative to the anchor) was a negative vertical offset. In this case Writer used to move
the floating table to the next page, but now matches Word: the space in the previous page is used
for the floating table. This fixed overlapping text on the next page.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable6/2023-07-05-floattable-anchor-bottom-margin.png"><figcaption>Old, new and reference rendering of a floating table with a large bottom margin in the anchor paragraph. Notice how the old rendering had a larger spacing between footnotes, which resulted in a 2 page document. The new and reference renderings have smaller spacing between footnotes and are of 1 page.</figcaption>
</figure>
</p>
<p>The next case is about floating tables in footnotes, the anchor needs to have no visible margins to
provide the correct layout.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable6/2023-07-06-floattable-overlap-vert-offset.png"><figcaption>Old, new and reference rendering of a floating table with an overlap due to vertical offsets. The old rendering had a big second table, it completely covered the first table. The new and reference renderings shift the second table to a next page to avoid overlap.</figcaption>
</figure>
</p>
<p>This case was about an unwanted overlap of floating tables. Incorrect handling of the vertical
offsets meant that the second floating table was rendered on top of the first one, making the text
in the first floating table unreadable. Now we shift down the second floating table, so no overlap
happens.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable6/2023-07-12-floattable-newline-loop.png"><figcaption>New rendering of a floating table with anchor text that starts with a newline.</figcaption>
</figure>
</p>
<p>This document had a layout loop on load. The problem was specific to the case when the anchor text
of a floating table started with a newline character, which has its own position in the document
model, but doesn't really have a width at a layout level, so needs special handling. This is now
fixed, the document loads and renders fine.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable6/2023-07-13-floattable-suse.png"><figcaption>Old, new and reference rendering of a document with lots of floating tables.</figcaption>
</figure>
</p>
<p>This document had only 4 pages, but lots of floating tables, carefully positioned to not overlap in
Word. You can see how the old Writer rendering result was hard to read and it now looks correct.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable6/2023-07-14-floattable-suse-hidden.png"><figcaption>Old, new and reference rendering of a floating table with a hidden anchor.</figcaption>
</figure>
</p>
<p>Writer used to hide floating tables anchored inside hidden paragraphs, but Word shows them all the
time, now we match this behavior.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable6/2023-07-17-floattable-overlap-table.png"><figcaption>Old, new and reference rendering of a floating table with an overlap.</figcaption>
</figure>
</p>
<p>The next document first had all of its tables in the first page, now fixed.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable6/2023-07-18-floattable-overlap-footer.png"><figcaption>Old, new and reference rendering of a floating table with an overlap between the table and the footer area.</figcaption>
</figure>
</p>
<p>A remaining problem was that the second table and the footer area could still overlap. This is now
fixed: Word sometimes does allow such an overlap, but it depends on the baseline of the anchor
position, so in the current case we can detect that such an overlap is not wanted.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable6/2023-07-19-floattable-halfrow.png"><figcaption>Old, new and reference rendering of a floating table with a half row on the first page.</figcaption>
</figure>
</p>
<p>The last problem with this document was a poor split of the floating table, the first half row of
the second table still went to the first page. Now we correctly detect that such a split is not
wanted and simply start the second floating table on the second page, which results in a pretty good
rendering of this document.</p>
<p>And that's where we stand. Certainly more work is needed to fix rough edges, but we get there step
by step -- the theme is slowly transitioning from overlap problems right after load to unexpected
rendering problems during editing.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/16b5b21d36da87be9b50235acbbb8008ed23b8bb">sw floattable: fix negative vert offset with on page boundary without anch text</a></li>
<li><a href="https://git.libreoffice.org/core/commit/79ddca4def81198e3eee42eca8aca42fef964c80">sw floattable: fix lost floating table right before a table from DOC</a></li>
<li><a href="https://git.libreoffice.org/core/commit/9ac864159b241d2093e86f664ab6f4b76c69196d">tdf#156059 sw floattable: fix lost 0 bottom margin of anchor in ftn from DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1f2d523aeeafd241c71a468c970054120fb23b3d">sw floattable: enable AddVerticalFrameOffsets compat flag for DOC</a></li>
<li><a href="https://git.libreoffice.org/core/commit/663db89378aa1f0425e795ef5d471f134e658dc4">sw floattable: make sure floattable after floattable gets own anch pos from DOC</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d59704b6b8c7e5395c0606fa01f37392afc4b2cd">cool#6857 sw floattable: try harder to keep anchor text in the last follow</a></li>
<li><a href="https://git.libreoffice.org/core/commit/52d265c0d2f2638c386475e58c3ee489ccd3f06c">sw floattable: fix lost floating table right before a hidden para from DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8bd30999098567b3bdb84a6ca65c071952192932">tdf#120262 sw floattable: don't wrap text around fly when no content would fit</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a4af5432753408c4eea8a8d56c2f48202160c5fe">tdf#120262 sw floattable, legacy: fix text wrap around fly when no content fits</a></li>
<li><a href="https://git.libreoffice.org/core/commit/9a5d1c250cbaac855b3e63d8c5fa0882ba7d14a2">tdf#120262 sw floattable, legacy: go outside body only for page frame vert pos</a></li>
<li><a href="https://git.libreoffice.org/core/commit/45574624ff05673d44f11cdbbbb49e1af599133e">tdf#120262 sw floattable: no split when none of first row fits the vert space</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (7.6).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable5.html">Multi-page floating tables in Writer: part 5</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 03 July 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 5 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has continued steps to handle tables that are both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable4.html">fourth post</a> for background.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>The previous post finished with a first fix for overlapping tables: this is a cluster of problems
where tables are allowed to overlap, but various other formatting make them not overlap in practice
in Word, but they do overlap in Writer. In this post, we'll see what started to work during the past
month.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The feature is enabled by default and the DOCX/DOC/RTF import makes use of it. This allows
stress-testing the layout code with complex user documents. The next target is to actively search
for documents that rendered reasonably in the past but are now unreadable and fix them.</p>
<p>On the positive side, core.git repository has has 40 files now which are focusing on correct
handling of floating tables (filename matching <code>floattable-|floating-table-</code>).  Also, there are
additional tests that quickly build a specific multi-page floating table in the memory and do some
operation on it, e.g.  delete the last row and assert what happens.</p>
<p>Here are some screenshots from the fixes this month:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-01-floattable-lost-good.png"><figcaption>Section break directly between floating tables</figcaption>
</figure>
</p>
<p>The first problem was that in case two floating tables were directly after each other, a section
break between them was lost. What you can see above is a successful transfer of the break
properties to the first paragraph on the next page, so the tables don't overlap but are laid out on
separate pages.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-02-floattable-split-1-bad.png"><figcaption>Incorrect split of a multi-page floating table</figcaption>
</figure>
</p>
<p>Looking through internal documents, a sample was found where a table with 2 rows was not split, even
if the previous page would have enough space for the first row. This is the old, bad layout.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-02-floattable-split-2-good.png"><figcaption>Correct split of a multi-page floating table</figcaption>
</figure>
</p>
<p>And this is how it looks after the fix.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-05-floattable-lost-2-tables-bad.png"><figcaption>2 floating tables are lost</figcaption>
</figure>
</p>
<p>The rest of the screenshots are from a complex internal document, which has 4 pages, but in total
contains 11 floating tables. First I focused on getting correct rendering of this in Writer for
DOCX. All the problems were not visible previously, as non-floating tables can't overlap, so bad
formatting problems did not cause problems in practice. The first subset (public reproducer) had 3
tables in it, but Writer only rendered one of them.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-05-floattable-lost-2-tables-good.png"><figcaption>Normal table and 2 floating tables are fixed</figcaption>
</figure>
</p>
<p>After fixing the problem, both lost tables are now there.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-07-floattable-overlap-bad.png"><figcaption>Unwanted overlap of two floating tables</figcaption>
</figure>
</p>
<p>The next case is about overlapping tables: the table is there, but the anchor positions are so
close that the content overlaps and it's hard or impossible to read the text.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-08-floattable-overlap-good.png"><figcaption>Fixed overlap of two floating tables</figcaption>
</figure>
</p>
<p>And this is how it looks after the fix.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-09-floattable-nested-bad.png"><figcaption>Bad handling of nested floating tables</figcaption>
</figure>
</p>
<p>The next trouble is with nested floating tables: in case all inner tables are inline, then the table
above the images will require more space then requested and that will lead to overlapping text
later.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-12-floattable-nested-better.png"><figcaption>Better handling of nested floating tables</figcaption>
</figure>
</p>
<p>The first fix is to make these inner tables also float if requested in the file format (but not
split for now, to develop incrementally). This helps, but the position of the inner table's anchor
is still incorrect.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-13-floattable-nested-good.png"><figcaption>Good handling of nested floating tables</figcaption>
</figure>
</p>
<p>Finally the anchor position of the table is also correct: no intersecting borders, no overlapping
text, no unexpected need for lots of vertical space.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-15-floattable-loop-bad.png"><figcaption>Layout-loop for a floating table</figcaption>
</figure>
</p>
<p>The next problem was a layout loop, which was terminated by the built-in loop control in a way that
rendered text outside the table to show up inside the table.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-16-floattable-loop-good.png"><figcaption>Fixed layout-loop for a floating table</figcaption>
</figure>
</p>
<p>And here is the correct rendering. Note that in case a floating table's anchor is positioned with a
negative vertical offset, then it can happen that text before the table will be rendered below the
table. But this is intentional and also happens in Word.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-19-floattable-negative-vert-offset-bad.png"><figcaption>Bad handling of negative vertical offsets</figcaption>
</figure>
</p>
<p>The last problem for this blog post is the case when a large floating table is anchored in a
single-line paragraph. Now Writer insists that the anchored object and the anchor text is on the
same page, so even if there is space for the last table on a previous page, it moves the table to
the next page.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable5/2023-06-20-floattable-negative-vert-offset-good.png"><figcaption>Good handling of negative vertical offsets</figcaption>
</figure>
</p>
<p>And here is the correct rendering: all tables fitting the first page. Also note that the last table
is moved up, so while the document model order is "after-table-2-second table-3 after-table-3", the
rendered / layout order will be "table-3 after-table-2-second after-table-3" -- again,
intentionally.</p>
<p>And that's where we stand. Certainly more work is needed to fix some remaining unwanted overlapping
of floating tables, but we get there step by step.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/e2f90d1d0e51c68dd01c9968cdb7a3bbb5658613">tdf#103869 sw floattable: fix lost table right before a section break from DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/920e76f15b78398de62002e30002f4f8e0fee7c1">sw floattable: ignore keep-with-next for anchors of non-last split flys</a></li>
<li><a href="https://git.libreoffice.org/core/commit/01ad8ec4bb5425446e95dbada81de435646824b4">sw floattable: fix lost tables around a floating table from DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4c5438b2c447403194420b69311a81ea7d36e157">sw floattable, DOCX import: clean up not needed dmapper-level anchor insert</a></li>
<li><a href="https://git.libreoffice.org/core/commit/81a108770233825557c2dae5776d7417be017fb8">sw floattable, compat mode: handle lower margin of anchor for fly intersect</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b71a9bcc2e1b4541c14e8197b5b888ee92297a6e">sw floattable: import non-split inner floating tables from DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c374628126ad222be48d5d06857b7dc6b879f783">sw floattable: fix anchor position of inner floating table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/737d90b7b7cb03bb6128b74a32906b0391868830">sw floattable: fix handling of upper margin of anchor for fly intersect</a></li>
<li><a href="https://git.libreoffice.org/core/commit/01eff4a68b05dd4eeee94bc4b3b018059efa60d4">sw floattable: avoid layout loop for negative vert offset in MakePos()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2d0a4ef1d83b8de6cb133970c2c35ae706fb058e">sw floattable: fix negative vertical offset handling on page boundary</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (7.6).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable4.html">Multi-page floating tables in Writer: part 4</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 01 June 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 5 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has continued steps to handle tables that are both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable3.html">third post</a> for background.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>The previous post finished with crash testing: the interesting subset of that testing tool is to take
hundreds of thousands of documents and in the Writer case import them into a document model and
layout them. If any of this crashes, mark that for future investigation. In this post, we'll see
what else started to work during the past month.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The feature is enabled by default and now the DOCX/DOC/RTF import makes use of it if. This allows
stress-testing the layout code with complex user documents, hopefully with the found breakage fixed
before it would be released in a stable version.</p>
<p>On the positive side, core.git repository has has 37 files now which are focusing on correct
handling of floating tables (abbreviated as "floattables").  Also, there are additional tests that
quickly build a specific multi-page floating table in the memory and do some operation on it, e.g.
delete the last row and assert what happens.</p>
<p>Here are some screenshots from the effort so far:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable4/2023-05-03-floattable-multicol-good-nosplit.png"><figcaption>Floating table inside a multi-column section</figcaption>
</figure>
</p>
<p>The first case is about multi-column sections: in this case Word doesn't try to split them between
pages. What you can see on the screenshot is that Writer lays out content on the previous page so
that remaining space is left, but we don't try to split the table between the first and the second
page, even if there would be space on the first page and even if this means the table overlaps with
the second column, matching what Word does.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable4/2023-05-04-floattable-ui-disable-good.png"><figcaption>UI to disable split of a floating table</figcaption>
</figure>
</p>
<p>UI to enable split of floating tables were added quite early: this is a new checkbox on the frame
properties dialog. However, <em>disabling</em> the split of floating tables was broken, the already
created layout was not updated to properly move back "follow" fly frames from later pages to the
current page, which is now fixed.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable4/2023-05-15-floattable-ui-disable-chain-good.png"><figcaption>Chaining enabled, so no split frames</figcaption>
</figure>
</p>
<p>Writer already had a feature to split content in a frame into multiple frames, but that one required
creating those frames in the model explicitly, such chaining is a feature that is useful in other
use-cases and is parallel to multi-page floating tables. The UI now ensures that the user can split
frames only in case chaining is not used, to avoid confusion.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable4/2023-05-16-floattable-chain-ui-disable-good.png"><figcaption>Split enabled, so no chaining</figcaption>
</figure>
</p>
<p>This is now also true in the other way around: if split of a floating table is allowed, then we
disable the frame chaining UI to avoid trouble later.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable4/2023-05-23-floattable-crash-good-writer.png"><figcaption>The latest crashing document</figcaption>
</figure>
</p>
<p>At this point I went back to crashtesting &amp; crash bugreports, and the latest reported crash was for
a document that is visible on the above screenshot. This was a bit tricky: it required 3 fixes to
make it not crash and also a layout loop fix.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable4/2023-05-24-floattable-nosplit-compat-good-writer-odt.png"><figcaption>Disabling split of frames at a layout level</figcaption>
</figure>
</p>
<p>Next was a mini-feature: even if floating tables normally split across pages by default, Word has a
document-level compatibility switch to turn this split on or off by default, at a layout level.
Floating tables from RTF are not split by default, DOC and DOCX split them by default.</p>
<p>What you can see on this screenshot is that a DOCX document may have this flag enabled, and then you
allow splitting on the UI / at a document model level, but Writer may still decide to not split
them, to provide the correct layout.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable4/2023-05-26-floattable-overlap-bad.png"><figcaption>Overlapping floating tables</figcaption>
</figure>
</p>
<p>The previous post already mentioned the problem area of overlapping tables. A first step in this
direction is to fix this bug document with Arabic text and 2 overlapping tables, making them
unreadable.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable4/2023-05-30-floattable-overlap-good.png"><figcaption>Fixed overlap of floating tables</figcaption>
</figure>
</p>
<p>And in this case here is the fixed version, where reading the table now depends on your language
skills. :-)</p>
<p>In this case, the problem was a lost section break of type next page, when a section started with a
floating table, which is a corner-case.</p>
<p>And that's where we stand. Certainly more work is needed to fix more unwanted overlapping of
floating tables, but we get there step by step.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/1c99616f86f7d5b83b91edc225fc95fec227d710">sw floattable, crashtesting: fix PDF export of forum-mso-en3-26783.docx</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8c78361b05ba3cefe5b0f31f35113f7890fd2296">sw floattable: don't try to set various character properties as table property</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8c34ed6e8d62c5fe558b11bb91c5405e5bf2798e">sw floattable, crashtesting: fix PDF export of ooo9470-1.doc</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f7e1cdf951f7f9cbb5822c49b86ba8a77a2fa878">sw floattable: fix UI for turning fly split off</a></li>
<li><a href="https://git.libreoffice.org/core/commit/61f3c796702f725f2c65b53b79ab7e190d39b6b8">sw floattable: fix UI / property dialog for shape containing table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d9cd177b9b08d454882dd77ffeb825a184a1b540">sw floattable: disable UI if the frame is chained already</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a13264fc7578cbd3267065f4992ded9f7558ec7a">sw floattable: disable chain UI if the frame is allowed to split already</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4cb6e54a3dcdd771ef76bd98b58f0bf1c4be4c45">sw floattable: fix missing table join when moving master fly to next page</a></li>
<li><a href="https://git.libreoffice.org/core/commit/632f36cc972116cd8da8245590f74014c22532db">sw floattable: fix legacy max height of split flys with negative vert offset</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b47401e12d9c45386899df0aa26653bd26c9abd4">sw floattable: fix assert fail when object formatter gets the wrong anchor</a></li>
<li><a href="https://git.libreoffice.org/core/commit/807ad65661c122a33fccb4fd3453ef92c0e9129d">tdf#155002 sw floattable, split but not yet moved follow: fix GetNextFlyLeaf()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/08fa2903df1a7cf9a1647fcf967e4c8b57dad793">sw floattable: add a DoNotBreakWrappedTables compat flag</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f5dc52dc9a068fec3323c3089929a81675b0d1ba">sw floattable: handle <code>&lt;w:doNotBreakWrappedTables&gt;</code> in the DOCX filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/63de1ea465ef72ecb8d4a7dcdaf5e92ea875eb00">sw floattable: handle fDontBreakWrappedTables in the DOC filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d785d26a5599d3d546b96958b0f1c6d5ed777a0d">sw floattable: handle \nobrkwrptbl in the RTF filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2a380dba73d57f825128fbada91c7a9fe79e8a06">tdf#150769 sw floattable: fix lost PageDescName if section starts with a table</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (7.6).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable3.html">Multi-page floating tables in Writer: part 3</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 03 May 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 6 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has continued steps to handle tables that are both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable2.html">second post</a> for background.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>The previous post finished with cursor traversal: if a floating table is on both page 1 and page 2,
then you expect Writer to be able to move between the rows of the table, even if those are not on
the same page. In this post, we'll see what else started to work during the past month.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The feature is enabled by default and now the DOCX/DOC/RTF import makes use of it if. This allows
stress-testing the layout code with complex user documents, hopefully with the found breakage fixed
before it would be released in a stable version.</p>
<p>On the positive side, core.git repository has has 19 files now which are focusing on correct
handling of floating tables.  Also, there are additional tests that quickly build a specific
multi-page floating table in the memory and do some operation on it, e.g. delete the last row and
assert what happens.</p>
<p>Here are some screenshots from the effort so far:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-03-floattable-edit-3rd-row-delete-good.png"><figcaption>Editing of floating tables: delete the last row of a table with 3 rows</figcaption>
</figure>
</p>
<p>The first case is about editing: if a floating table had a first, middle and last page, then
deleting the last row of a table lead to incorrect layout, which is now fixed.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-04-floattable-follow-select-good.png"><figcaption>Selection &amp; dragging of split floating tables</figcaption>
</figure>
</p>
<p>An odd problem is that the vertical position of tables on non-first pages is generated by the
layout, which means that normal drag&amp;move to position them won't work, leading to annoying jumps.
This is now fixed by selecting the first (master) fly frame on click, and you can always reposition
that table (even vertically.)</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-12-floattable-ww8-bad.png"><figcaption>Bad binary DOC import</figcaption>
</figure>
</p>
<p>Once DOCX import/export was there, the next step is binary DOC import, which gives us access to a
larger corpus of test documents, to stress-test the layout code. This shows how the binary DOC
import looked before the work.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-13-floattable-ww8-good.png"><figcaption>Good binary DOC import</figcaption>
</figure>
</p>
<p>And this one shows how it works now.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-14-floattable-ww8-export-good.png"><figcaption>Good binary DOC export</figcaption>
</figure>
</p>
<p>DOC import is not enough, e.g. Collabora Online will save your documents automatically, so we
really want to export everything that is possible to import. Here is how good DOC export looks like
in Word.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-17-floattable-in-footer.png"><figcaption>In-footer floating table</figcaption>
</figure>
</p>
<p>At this point the first crashtest results arrived (we try to import about 280 thousand documents
and see what crashes). The first problem was floating tables in footers. Well, we should not try to
split such tables (even if they don't fit): adding one more page does not give us more footer space.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-18-floattable-rtf-bad.png"><figcaption>Bad RTF import</figcaption>
</figure>
</p>
<p>Similar to the DOC filter, RTF can express floating tables. Here is how we did a bad rendering of an
RTF document before.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-19-floattable-rtf-good.png"><figcaption>Good RTF import</figcaption>
</figure>
</p>
<p>And here is how we import it currently. The RTF control words are quite close to the binary DOC
markup semantically, just the syntax is different.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-20-floattable-rtf-export-bad.png"><figcaption>Bad RTF export</figcaption>
</figure>
</p>
<p>The RTF export side was also missing, as visible in Word, before the work.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-21-floattable-rtf-export-good.png"><figcaption>Good RTF export</figcaption>
</figure>
</p>
<p>And this is how the good RTF export result looks like in Word.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-24-floattable-in-section.png"><figcaption>Floating table in a section</figcaption>
</figure>
</p>
<p>Another crashtest find was that sometimes we map Word's continuous section breaks to Writer
sections, so we can't assume that tables are anchored directly in body frames. This is now fixed.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-25-floattable-table-row-keep.png"><figcaption>Correct handling of the TableRowKeep flag in floating tables</figcaption>
</figure>
</p>
<p>A related problem was that non-floating tables have a trick, that we call the TableRowKeep mode. If
this is on (which is the default for documents imported form Word), a table row will stick to the
next table row (we try to keep them on the same page) if the first cell's first paragraph in that
row has the "keep with next" paragraph property specified. It turns out, this should be ignored when
the table is floating.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-26-floattable-break-before.png"><figcaption>Page break before a floating table</figcaption>
</figure>
</p>
<p>A next problem was that some page breaks simply disappeared. It turns out that we need to transfer
the "break before" property from the table to the table anchor (paragraph) to get the desired
layout, since page breaks are generally ignored inside text frames.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-27-floattable-nested-nocrash.png"><figcaption>Handling of 2 times nested tables, middle one is floating</figcaption>
</figure>
</p>
<p>All combinations of nesting with floating tables is not yet handled, but at least we should not
crash when the user tries to do that. Here is 3 tables, nested in each other, the second table is
marked to be floating.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable3/2023-04-28-floattable-then-table.png"><figcaption>Handling of a floating table, immediately followed by an other table</figcaption>
</figure>
</p>
<p>The last fixed problem is when a floating table is immediately followed by an other, non-floating
table. Given that we try to anchor the floating table in the next paragraph, the layout could not
handle this previously, but now we ensure that each floating table is followed by a paragraph.</p>
<p>And that's where we stand. Hope to address all problems reported by crashtesting soon. Once that
happens, it may be possible to switch from bugfixing mode to feature mode again, e.g. better
handling of overlapping or nested tables could be done.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/1006fd848ba7c67927472e53df7f3b6f682fadfb">sw floattable: fix removal of empty master flys on master table removal</a></li>
<li><a href="https://git.libreoffice.org/core/commit/96df0ad0da6e8972a828721dac6b4ba7c69eba85">sw floattable: fix removal of last follow fly with a start/middle one</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ce3308a926f036b87515b8cd97d2b197063dc77a">tdf#61594 sw floattable: import floating tables as split flys by default</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c50bf5a5daaae3d40f89ea0784a75a8a571c208d">sw floattable: remove no longer needed DOCX import heuristics</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8f9523b3ef464731afed61a253c958644fca6335">sw floattable: don't try to set left margin as cell property</a></li>
<li><a href="https://git.libreoffice.org/core/commit/17367a67cd39109006060176b04bc2b174a17e48">sw floattable: restrict selection of follow flys</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ab639ae344704cd22318938cfeafbe954abcd2c0">sw floattable: limit the unfloat button to legacy ODF files</a></li>
<li><a href="https://git.libreoffice.org/core/commit/69fe424e426957545a30e1b912c933e1e7693100">sw floattable: unconditionally map DOC table pos props to SwFormatFlySplit</a></li>
<li><a href="https://git.libreoffice.org/core/commit/16b59cee44c7f728b2fe6d7b624c494f649ee79f">sw floattable, layout: don't split inside headers/footers</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2424fa9c601003a9778bbc3a9cf0f55d33ead6f1">sw floattable: fix CppunitTest_sw_ww8export's testTdf112346</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1ee5ae0eec2d1c673af6b8f18a2c36b4d1e7fb70">sw floattable: fix CppunitTest_sw_ww8export2's testTdf80635_marginLeft</a></li>
<li><a href="https://git.libreoffice.org/core/commit/eb65f881da9c63636bc07eca735fd2bc01854fd6">sw floattable: fix CppunitTest_sw_ww8export2's testTdf80635_marginRTL</a></li>
<li><a href="https://git.libreoffice.org/core/commit/115a4eb944f6a49def1ba8e826c3258389aeab10">sw floattable: fix CppunitTest_sw_ww8export2's testTdf80635_pageLeft</a></li>
<li><a href="https://git.libreoffice.org/core/commit/cfa463cc5446e72a06db5a457bf4d50d4173f31e">sw floattable: fix CppunitTest_sw_ww8export2's testTdf80635_pageRightRTL</a></li>
<li><a href="https://git.libreoffice.org/core/commit/61be351ac83acec75788d2f79a9038486163160f">sw floattable: import floating tables from DOC as split flys by default</a></li>
<li><a href="https://git.libreoffice.org/core/commit/6e8a89b762d625adc10227402de506c7a632e073">sw floattable: remove no longer needed DOC import heuristics</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a1c5f77d3ee7c9907c8247aa0e896e07fe9427b6">sw floattable, crashtesting: fix PDF export of forum-mso-de-117064.docx</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5c59d6f51f837639f1f0f24e154814136bbdfda9">sw floattable: remove no longer needed ImportFloatingTableAsSplitFly setting</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e0017ad2a5b008111b716c0814c5a0c5b0f1e05b">sw floattable, crashtesting: fix PDF export of fdo80989-1.docx</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3c2e4d454aaabcd61593e670a90638a185046539">sw floattable, crashtesting: fix PDF export of fdo72790-1.docx, part 1</a></li>
<li><a href="https://git.libreoffice.org/core/commit/9c23f533d6749e94971f04e18f1537472cac6b86">sw floattable, crashtesting: fix PDF export of fdo72790-1.docx, part 2</a></li>
<li><a href="https://git.libreoffice.org/core/commit/73bada774ef37efd5a4498ccc083b1358314557d">sw floattable, crashtesting: fix PDF export of fdo72790-1.docx, part 3</a></li>
<li><a href="https://git.libreoffice.org/core/commit/400d970f27078a93eab97ead8a6934a32272f549">sw floattable: DOCX import: m_bConvertedTable is now unused</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4b6b9411e4ac912817dd804782ad2054bc0d1660">sw floattable, crashtesting: fix PDF export of fdo72790-1.docx, part 4</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1795d5183d5371a24e8dcb15f8671c78b2c94665">sw floattable, crashtesting: fix PDF export of tdf114111-3.docx</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (7.6).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable2.html">Multi-page floating tables in Writer: part 2</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 03 April 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 6 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has the early steps to handle tables that are both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable.html">first post</a> for background.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>The previous post finished with split rows are now in a reasonable shape towards our journey to fix
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=61594">tdf#61594</a>. In this post, we'll see what
else is needed to get perfect rendering for that single document.</p>
<p>The plan is to iterate on that later, adding more and more incremental improvements &amp; fixes for this
feature.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The feature is still enabled by default, but the DOCX import only makes use of it if you set the
<code>SW_FORCE_FLY_SPLIT=1</code> environment variable. This allows playing with the feature even if there are
lots of known problems still.</p>
<p>On the positive side, core.git <code>sw/qa/core/layout/data/</code> has 12 files now which are rendered exactly
the way Word does. Also, there are additional tests that quickly build a specific multi-page
floating table in the memory and do some operation on it, e.g. delete the last row and assert what
happens.</p>
<p>Here are some screenshots from the effort so far:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-01-floattable-split-row-and-last-2pages-not-3pages-good.png"><figcaption>Split row and an additional one on 2 pages</figcaption>
</figure>
</p>
<p>Here the problem was that a normal row went to a next page after a split row. Now the document is
correctly of 2 pages, instead of the previous unwanted 3 pages.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-02-floattable-2cols-good.png"><figcaption>Floating table with multiple columns</figcaption>
</figure>
</p>
<p>Here the additional complexity was to have multiple columns on a table, since previously we always
had 1 column and 2 or more rows. Now these are also split correctly across pages.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-03-floattable-widow-orphan-bad.png"><figcaption>Incorrect widow control inside split floating tables</figcaption>
</figure>
</p>
<p>This is an incorrect table row split, because widow control is broken.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-07-floattable-widow-fixed.png"><figcaption>Fixed widow control inside split floating tables</figcaption>
</figure>
</p>
<p>And here is how it looks when it's working. That little line on page 2 is no longer alone.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-08-floattable-minimal-height-fixed.png"><figcaption>Working minimal height</figcaption>
</figure>
</p>
<p>Even better when the minimal height for non-first ("follow") table frames is working, as you can
notice that space between the last line and the table bottom border on page 2.</p>
<p>At this point, the bug document from the motivation section worked fine, apart from the workaround
that one has to re-save it in non-legacy mode in Word. So what's next? We need to instantly add a
legacy mode for the brand new (not even fully enabled) multi-page floating table feature, since
otherwise whatever we do, some DOCX files will be handled incorrectly.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-09-floattable-legacy-margin-bad.png"><figcaption>Legacy mode: bad margin</figcaption>
</figure>
</p>
<p>As it turns out, the core of the legacy mode is that the floating table is sometimes allowed to flow
into the footer / bottom margin area of the page, but not always. It's quite inconsistent, so one
can understand why this is no longer the default behavior. The above is the naive rendering, which
is logical, but incorrect.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-10-floattable-legacy-margin-good.png"><figcaption>Legacy mode: good margin</figcaption>
</figure>
</p>
<p>And this is the correct result in legacy mode. After a bit of experimenting, it seems one can flow into
the bottom margin area if the height of the table frame would fit the body frame, but some vertical
offset causes it to be pushed down.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-13-floattable-legacy-min-row-height-no-split-good.png"><figcaption>Legacy mode: minimal row height causes no row split</figcaption>
</figure>
</p>
<p>The final trick with legacy mode is to make sure that all tables (first one, middle ones, last one)
have the required minimal height, which can result in not splitting the row in case a part of that
would be less than the minimal height. E.g. a 3 cm minimal height means that a total height of 4 cm
(2cm + 2cm) is not enough for a split row.</p>
<p>With this, we reached the goal to render that given bug document perfectly (when compared to Word),
and the next step is to fix up breakage that would be caused by enabling by default.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-14-floattable-redline.png"><figcaption>Tracked changes in floating tables</figcaption>
</figure>
</p>
<p>The first problem was tracked changes support, which needs special care: as the importer
converts body text to table cells, we need to keep the tracked insert/delete text ranges correctly. This is
now working fine.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-16-floattable-inner-normal.png"><figcaption>Nested tables: the outer is floating</figcaption>
</figure>
</p>
<p>The next problem is around nested tables: a normal inner table inside a floating table was lost on
DOCX file open, now fixed.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-17-floattable-nested-bad.png"><figcaption>Nested tables: broken inner floating table</figcaption>
</figure>
</p>
<p>The other version is when a normal table has an inner floating table. This broke badly, the outer
table was not imported at all.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-20-floattable-nested-innerfloat-better.png"><figcaption>Nested tables: better inner floating table</figcaption>
</figure>
</p>
<p>And it's now better. The inner table is still not actually floating, but turns out that was never
working for DOCX files, so it's not a regression. Fine to revisit that only later.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-21-floattable-follow-pos-bad.png"><figcaption>Follow table: bad horizontal positioning</figcaption>
</figure>
</p>
<p>So far all the previous tables were aligned to the left. It turns out that the horizontal
positioning was bad in every other case for non-first tables, e.g. when you wanted to center them.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-22-floattable-follow-pos-fixed.png"><figcaption>Follow table: good horizontal positioning</figcaption>
</figure>
</p>
<p>And it's now fixed.</p>
<p>As a last fix for this post, let's look at traveling with the cursor:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable2/2023-03-23-floattable-cursor-traversal-good.png"><figcaption>Good cursor traversal</figcaption>
</figure>
</p>
<p>After fixing this, now you can use the up/down arrows to go from the A1 cell to A2 and back. The
cursor traversal code wasn't aware that the master/follow table frame was connected.</p>
<p>And that's where we stand. Hope to enable even the DOCX import bit by default soon.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/25a01778f998618d9a4d0de9da5784e0e60e3259">sw floattable: update layout when enabling fly split via UNO</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e32dfaf15563372ffae6e0da53998e20068ebf81">sw floattable: teach the UI about SwFormatFlySplit</a></li>
<li><a href="https://git.libreoffice.org/core/commit/34794e122fb4570376e712a7a356fc41620a46c7">sw floattable: don't leave body in SwFrame::GetNextFlyLeaf()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b9bf9bf9d1d1e0fb9eb765cd5060d611af7176df">sw floattable: fix vertical position of follow flys with rel orient = page</a></li>
<li><a href="https://git.libreoffice.org/core/commit/edaf6155496d452c67aa191c1d45a0328ef079e0">sw floattable: undefined behavior in SwFlyFrame::UpdateAttr_()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e66632b023ee1cf25a381536f53458f631964bb8">sw floattable: try to grow fly parent when trying section/table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/aac624d1e3cd6fc023e25fedbfe48ed330a308ec">sw floattable: clean up not needed scope in SwTextFormatter::FormatLine()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5d5dca66e17c90e20197d0d76113254b13ff0bb7">sw floattable: grow the print area as well in SwFlyFrame::Grow_()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/65dd1525e826006f78f86688032459dbd7ab4bb4">sw floattable: partially re-enable widow / orphan control in tables</a></li>
<li><a href="https://git.libreoffice.org/core/commit/78b1631e9649402e29c906c7023f55ed2cbe84f9">sw floattable: enable widow / orphan control in split rows</a></li>
<li><a href="https://git.libreoffice.org/core/commit/913b71dbe06c33773c4d779e00c6ec4b6a4af59f">sw floattable: ignore height of masters in lcl_CalcMinRowHeight()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/da2707a83f13cba98b22aba1ca6568dbbc4c5fd8">sw floattable: handle Word 2010 legacy mode in SwFlyFrame</a></li>
<li><a href="https://git.libreoffice.org/core/commit/baebe41647e4522a2d58f7a4eb392ceab66fc2c9">sw floattable: reject small(er than min height) row master at page bottom</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ee8e9b993595e728f827a5fe6ab1ae5fb1f6aaae">sw floattable, legacy: restrict height when using bottom margin area</a></li>
<li><a href="https://git.libreoffice.org/core/commit/90523e10ec053347719309403a4d8566da1dfc4a">sw floattable, legacy: also consier fly position when deciding the bottom</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d477fa8ac1b0d3ee81427217bbb5950278ab16db">sw floattable: unconditionally map <w:tblpPr> to SwFormatFlySplit</a></li>
<li><a href="https://git.libreoffice.org/core/commit/9a9ee21ec237eda5df6ea70bfa3bec07b44b4d21">sw floattable: fix redline import from DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/28325983db2f7613b94bc70ef920ba13ebe6d817">sw floattable: fix CppunitTest_sw_ooxmlexport10's testTdf8255</a></li>
<li><a href="https://git.libreoffice.org/core/commit/75249d502e83c10ec38ef8cc8ee58c6c877c6ee9">sw floattable: fix CppunitTest_sw_ooxmlexport10's testTdf99140</a></li>
<li><a href="https://git.libreoffice.org/core/commit/48818dd359fbf0f37e1b318de89ab2ea7d735f58">sw floattable: fix handling of nested non-floating tables at cell start</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8bc607225e6bc9ba343e2292f9185b6491108e44">sw floattable, CppunitTest_sw_ooxmlexport9: assert the layout in testTdf107889</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3911b23c89da02eca92a0069bf1035155b7fddae">sw floattable, CppunitTest_sw_ooxmlexport9: assert can-split in testTdf109063</a></li>
<li><a href="https://git.libreoffice.org/core/commit/28b16870553f436b8dd0f74894896136057402a3">sw floattable, CppunitTest_sw_ooxmlimport2: assert the layout in testTdf114217</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a1b935ca1bb6d48241e73e7206a367fe2b51f948">sw floattable: fix inner floating table inside normal outer table from DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2b7b272e28bf95c4ed85cb118eacf065fb6dca3c">sw floattable: limit the unfloat button to non-DOCX files</a></li>
<li><a href="https://git.libreoffice.org/core/commit/015da04a8f3e1368c6b9668ca22d7e320e1ecae6">sw floattable: fix current page number when editing document with a split fly</a></li>
<li><a href="https://git.libreoffice.org/core/commit/12a9009a1c19ee26c65fb44fc90f3432c88ab6a5">sw floattable: fix bad position of follow fly if anchor is positioned late</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3c3a47e911a7ee4d199fe96bd3003c7d9afa9deb">sw floattable: fix up/down cursor travel at fly boundary</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f6fbd9d5ff5b049112e6ca7a8943c156b3e4f411">sw floattable: remove empty follow flys on follow table removal</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (7.6).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable.html">Start of multi-page floating tables in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 01 March 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 5 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has the early steps to handle tables that are both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>As requested in <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=61594">tdf#61594</a> 10 year ago,
the use-case is that you can already have floating tables:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/fly.png"><figcaption>Table in a Writer text frame</figcaption>
</figure>
</p>
<p>And multi-page tables:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/multi-page.png"><figcaption>Multi-page table</figcaption>
</figure>
</p>
<p>And what we want is a combination of them, like this:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/floattable-more-wrap.png"><figcaption>Multi-page floating table</figcaption>
</figure>
</p>
<p>This is a quite complicated feature, since both floating objects and tables are complex, and this
combines them to create even more complexity.</p>
<p>However, such constructs are used in existing DOCX files and we're expected to correctly display
them.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The feature is enabled by default, but the DOCX import only makes use of it if you set the
<code>SW_FORCE_FLY_SPLIT=1</code> environment variable. This allows playing with the feature even if there are
lots of known problems still.</p>
<p>On the positive side, core.git <code>sw/qa/core/layout/data/</code> has 4 files now which are rendered exactly
the way Word does.</p>
<p>A bit of terminology: once a frame is split, the first element of the chain is called master, the
remaining frames are called follows.</p>
<p>Here are some screenshots from the journey so far:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/fly-nosplit.png"><figcaption>Not splitting Writer text frame</figcaption>
</figure>
</p>
<p>This is a fly frame with enough content that it doesn't fit the body frame. It should split, but fly
frames could not be split.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/fly-split-wip.png"><figcaption>Writer text frame kept inside the body frame</figcaption>
</figure>
</p>
<p>First try, just limit the height of the (master) fly frame, so at least it stays inside the body
frame. But now some content is not rendered.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/fly-split-2nd-buggy.png"><figcaption>Incorrect split of a text frame</figcaption>
</figure>
</p>
<p>Next try. Now have have 2 flys, but the second has zero height and the content of the second fly
leaks into the body of the second page.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/fly-split-bad-anchor-poc.png"><figcaption>Last version with bad anchoring</figcaption>
</figure>
</p>
<p>This one is better, but the position of the follow fly frame is bad, no actual wrapping happens.
Also, we assume that there are multiple paragraphs after the table, which will cause problems for
floating tables at the end of the document. So I reworked the anchoring code to split the anchor to
as many pages as necessary...</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/fly-anchor-text-bad.png"><figcaption>Duplicated anchor text</figcaption>
</figure>
</p>
<p>Which sounds good, but now the text around the anchor point is duplicated.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/fly-anchor-text-better.png"><figcaption>Less duplicated anchor text on the first page</figcaption>
</figure>
</p>
<p>Better, now the anchor text is gone in the master anchor, but still there is a misleading paragraph
marker.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/fly-anchor-text-good.png"><figcaption>Last text frame without a table</figcaption>
</figure>
</p>
<p>And now this looks reasonable. Fine, we have some minimal split flys, let's try it with tables
instead of just two paragraphs:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/multi-page-floating-table-dupetext.png"><figcaption>Floating table with duplicated anchor text</figcaption>
</figure>
</p>
<p>With a bit of work, the table's two rows can split, but again the text in the anchor is duplicated.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/floattable-bad-hori-pos.png"><figcaption>Bad horizontal position</figcaption>
</figure>
</p>
<p>Next try, now the anchor text is correct, but the horizontal position of the table is still bad, it
bleeds out towards the left margin area.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/floattable-good-hori-pos.png"><figcaption>Fixed horizontal position</figcaption>
</figure>
</p>
<p>And with more work, now this looks correct.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/floattable-good-vert-pos.png"><figcaption>Fixed vertical position</figcaption>
</figure>
</p>
<p>Let's add some vertical offset! That should be only applied on the first page, and now the follow
fly doesn't have that unwanted offset.</p>
<p>Now we have 2 documents that lay out correctly on 2 pages. Let's try 3 pages:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/floattable-3page-bad.png"><figcaption>Wanted 3 pages, have 2 pages</figcaption>
</figure>
</p>
<p>This falls apart, the 2nd and the 3rd row are both on page 2.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/floattable-3page-good.png"><figcaption>Correctly rendered 3 pages</figcaption>
</figure>
</p>
<p>After partitioning the fly frames to 3 categories (master, non-last follows, last follow), more
than 2 pages also work.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/floattable-row-split-writer-bad.png"><figcaption>Row split is not performed at all</figcaption>
</figure>
</p>
<p>This is a sample where the table has a single cell, so we need to split the (only) row, not just
split the table's rows. The first is harder. Currently we don't even try to split it.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/floattable-row-split-writer-bad2.png"><figcaption>Row split is performed, but the 2nd page's object has a bad position</figcaption>
</figure>
</p>
<p>Next try, now we split it, but the position of the follow fly is wrong.</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-floattable/floattable-row-split-writer-good.png"><figcaption>Row split with correct object positioning on all pages</figcaption>
</figure>
</p>
<p>Finally split of a single row inside multi-page floating tables also work. That's where we are.
Don't try to do anything too custom (like inserting a header or footer), those cases are still
known-broken.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/0bb90afaeb193181d7b98b79e962549d8a1dd85a">sw: add document model for multi-page fly frames</a></li>
<li><a href="https://git.libreoffice.org/core/commit/fd3d4d894d96f16a28d5b58c5bcf5a44fb83617f">sw: add UNO API for multi-page fly frames </a></li>
<li><a href="https://git.libreoffice.org/core/commit/bef6c5ca4edf55e64284d9dd264ba9a76476adab">sw: inherit SwFlyAtContentFrame from SwFlowFrame</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a6b64d02843d186485ff5c82106e6f9268a539c7">sw: add an SwFlyAtContentFrame ctor that creates a follow fly frame</a></li>
<li><a href="https://git.libreoffice.org/core/commit/66d235012c0c02db3b25f91a0fc981c66ed7388e">sw: add an initial SwFrame::GetNextFlyLeaf()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ed9d987e2ad8f6af554a5fc1f858ca48c6970446">sw: if the fly is to be split, then limit its growth in SwFlyFrame::Format()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b052ec2f2fbe0f3044ba824c064a280a5ee9cd7f">sw: introduce SwFlyFrame::IsFlySplitAllowed()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4c6c317e1743166ee772ab03413f0fa59c59f859">sw: call GetNextFlyLeaf() in SwFrame::GetLeaf()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8855813f8147f430348a32703b89dfb7b0793fee">sw: avoid unwanted initial content in split/follow fly frames</a></li>
<li><a href="https://git.libreoffice.org/core/commit/27fbab13557a75b5402c11a1697541edc124116a">sw: implement SwFrame::GetPrevFlyLeaf()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/6275bd9db475cb984ac153d06ed1ddadfa2fadb7">sw: handle split flys in SwTextFormatter::FormatLine()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ddfb800e60d98340c99c8013f6df3f2060687dd0">sw: fix anchoring in SwFrame::GetNextFlyLeaf()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d6b9529c4f63d1dd5c57db4f4912471cce2507d9">sw floattable: fix cid#1520800</a></li>
<li><a href="https://git.libreoffice.org/core/commit/25a16e7543965565a4227506003adc916deea500">sw floattable: fix cid#1520804</a></li>
<li><a href="https://git.libreoffice.org/core/commit/00b9b33334791079c2dc26b1ed4c123450cabf7d">sw: call FormatEmpty() in SwTextFrame::Format() for split fly masters</a></li>
<li><a href="https://git.libreoffice.org/core/commit/995198bfff4ae8abaf2129fe99d9f8ef899a4f25">sw floattable: handle table-in-fly in SwFrame::GetNextFlyLeaf()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1cf13b8b11e7c122631394e308b66b46ffaae718">sw floattable: improve handling of split flys in SwTextFrame::FormatEmpty()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7fb8b73ad320e32af130ceddec80a9ff08407eab">DOCX filter: fix horizontal pos of floattables with compat mode &gt;= 15</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2f0b16a6a9bfff1646b14412e5918b6d483b9cdc">sw floattable: limit vertical position for the follows of split flys</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3282508f8deeafd50f5af45ca0adf760efb114a3">sw floattable: add ImportFloatingTableAsSplitFly expert setting</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e11e1d48abedf17db40c069d9f37b4edcbcc09c4">sw floattable: it's fine to recalc the table in SwTabFrame::MakeAll()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7c9acfe5baef275f07c185c6fedf8b6d62d88637">sw floattable: fix handling of multiple splits, i.e. table over 3 or more pages</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b697ee5dc3c38806fc6f096364590e9e60256aeb">sw floattable: fix locking in SwTextFrame::Prepare()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e7be3b821cd42fdc9d8e51772b8202030d76497e">sw floatable: teach the DOCX filter about SwFormatFlySplit</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3a8ecbc70320151cb7dde7d8f89dee67a7c6e3e5">DOCX export: move the bulk of the table export code to a new file</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2da16ff9f018fae68c53a801e5a234dafc2ebcec">sw floattable: teach the ODT filter about SwFormatFlySplit</a></li>
<li><a href="https://git.libreoffice.org/core/commit/6068ae5df9da179e1d187e27117a9d761116f968">sw floattable: don't promise infinite growth in SwFlyFrame::Grow_()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7677e16217349a0a0e94edb6a90b00089432c6ce">sw floattable: allow extra space on top of child content in SwFlyFrame::Grow_()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f13eb476ea6620bc444d9533959fea78afe720c5">sw floattable: fix fly pos invalidation in follow anchor frames</a></li>
</ul>
<p>The design of the layout representation is documented in the <a href="https://github.com/libreoffice/core/blob/d25567e7e2fb96242b9bd4aca44df6f0287c2aa3/sw/source/core/attr/formatflysplit.cxx#L27-L44">SwFormatFlySplit
constructor</a>.</p>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (7.6).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-zotero-plumbing.html">Citation handling: plumbing in Writer for e.g. Zotero</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 06 February 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 5 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has a set of new automation commands and APIs that allow clients to build user interface
for citation handling that's more advanced than the default in-Writer bibliography support.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, see <a href="https://www.collaboraoffice.com/code-22-05-release-notes/">the CODE
release notes</a> for one possible way to
use this.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-zotero-plumbing/zotero.png"><figcaption>Citations and bibliography in Writer, using fieldmarks</figcaption>
</figure>
</p>
<p>Users frequently using scientific citations are probably familiar with the limits of Writer's
built-in bibliography support, and solutions like <a href="https://www.zotero.org/">Zotero</a> appeared (with a
LibreOffice extension included) to improve that situation.</p>
<p>This means that instead of storing all your scientific notes and data locally, you can store them on
a Zotero server, then work with that from anywhere, once you provide your credentials.</p>
<p>The trouble comes when you want to combine this with collaborative editing, which is provided by
Online, but you can't use the extension made for the desktop.</p>
<p>The above CODE release notes explains how an end user can use this feature, this post is meant to
document what new UNO commands and LOK APIs I added that serve as a backend for this. Especially the
UNO commands are also useful in other contexts, like in macros or other extensions.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Zotero can store citations using 3 markups in documents: fields (DOCX only), bookmarks (DOCX and
ODT) and finally reference marks / sections (ODT only). The added plumbing allows several operations
for all 3 cases, to work with existing documents using any of these markups.</p>
<p>The citation and the bibliography is handled the same way for fields (Writer's fieldmarks) and
bookmarks. The last case uses reference marks for citations, but sections for the bibliography.</p>
<p>The following operations are supported:</p>
<ul>
<li>
<p>create the citation / bibliography</p>
</li>
<li>
<p>read the object under the cursor</p>
</li>
<li>
<p>read all objects of a given type in the document</p>
</li>
<li>
<p>update the object under the cursor</p>
</li>
<li>
<p>update all objects of a given type in the document</p>
</li>
<li>
<p>delete all objects of a given type in the document</p>
</li>
</ul>
<p>Reading is only available to LOK clients, you need to call the
<a href="https://github.com/libreoffice/core/blob/1e92059fe95cc1ba31aab4a66926d55bc00d0684/include/LibreOfficeKit/LibreOfficeKit.hxx#L483-L492">getCommandValues()</a>
API. The rest is normal <a href="https://wiki.documentfoundation.org/Development/DispatchCommands">UNO
commands</a> that you can invoke from
document macros or extensions as well.</p>
<p>The added plumbing is the following:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Fieldmark</th>
<th>Bookmark</th>
<th>Refmark</th>
<th>Section</th>
</tr>
</thead>
<tbody>
<tr>
<td>Create</td>
<td>.uno:TextFormField</td>
<td>.uno:InsertBookmark</td>
<td>.uno:InsertField</td>
<td>.uno:InsertSection</td>
</tr>
<tr>
<td>Read</td>
<td>getCommandValues(".uno:TextFormField")</td>
<td>getCommandValues(".uno:Bookmark")</td>
<td>getCommandValues(".uno:Field")</td>
<td>None</td>
</tr>
<tr>
<td>Read all</td>
<td>getCommandValues(".uno:TextFormFields")</td>
<td>getCommandValues(".uno:Bookmarks")</td>
<td>getCommandValues(".uno:Fields")</td>
<td>getCommandValues(".uno:Sections")</td>
</tr>
<tr>
<td>Update</td>
<td>.uno:UpdateTextFormField</td>
<td>.uno:UpdateBookmark</td>
<td>.uno:UpdateField</td>
<td>None</td>
</tr>
<tr>
<td>Update all</td>
<td>.uno:TextFormFields</td>
<td>.uno:UpdateBookmarks</td>
<td>.uno:UpdateFields</td>
<td>.uno:UpdateSections</td>
</tr>
<tr>
<td>Delete all</td>
<td>.uno:DeleteTextFormFields</td>
<td>.uno:DeleteBookmarks</td>
<td>.uno:DeleteFields</td>
<td>.uno:DeleteSections</td>
</tr>
</tbody>
</table>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/1ff360c29c99a570bfe59c69d8f589d4f2b59135">sw: add new FieldType parameter for the .uno:TextFormField command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/6870c0c3385bf5d19e9c80bf973fca255ae38c08">sw: add new FieldCode parameter for the .uno:TextFormField command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1c2ef850db29beb369dcc89a58fc73416ecd9c5c">sw, .uno:TextFormField command: accept HTML in the FieldResult parameter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/24219cc1e9829f82a533667aef0f51b6a7df6fc2">sw lok, .uno:TextFormFields: expose field code of fieldmarks</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1e83197fdd4263ca4817a6ac16f274aaee3e66fd">comphelper: support property values arrays in JsonToPropertyValues()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7765b442e13048f857fd7ee49ced1731caee297e">sw: add a new .uno:TextFormFields UNO command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/12f434277bc424f01597be83020a569c84bbee5a">sw: hide TextFormFields from the customization dialog like</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5e8f6dcb8ce00d2d5e35b3cf5654187b3068276c">sw lok, .uno:SetDocumentProperties: expose value of custom document properties</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2c149dc9983317bce9116649270c3513adc35514">libreofficekit: add a way to invoke getCommandValues()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/afb362c60a18243621834dcf2b30672be6eed76f">sfx2: extend .uno:SetDocumentProperties to update custom doc props</a></li>
<li><a href="https://git.libreoffice.org/core/commit/fa82e151d80d15eeb6dfae434f1dbb3b68907188">sw, .uno:InsertBookmark: add a new BookmarkText parameter and accept HTML there</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c2bcbd36d1913dc1d5ca4bb64fa30740f17bf326">sw: split out some of the LOK parts of SwXTextDocument into a separate file</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e0bf2712aa9e240748534e3a7498d41c8eeeb9d7">sw, lok: implement a getCommandValues(Bookmarks)</a></li>
<li><a href="https://git.libreoffice.org/core/commit/724180ec495a696c79332653cb6fb52ecfbccc29">sw: add a new .uno:UpdateBookmarks UNO command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/16075474819696f920979969474aa8300f4af530">sw, field insert: handle the Content param for refmarks and accept HTML there</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a178a2ac6df8dc63a7ab8d4a19b90ae8a17baca4">sw UI: fix crash on inserting a fieldmark inside a fieldmark</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3585d0414ffe08890856e5c09f453b9f566323df">sw, lok: implement a getCommandValues(Fields)</a></li>
<li><a href="https://git.libreoffice.org/core/commit/babba472391d26aed68d7ac31c7a918c08e65256">sw, UpdateFields: add new TypeName, NamePrefix and Fields parameters</a></li>
<li><a href="https://git.libreoffice.org/core/commit/bb20dee2ef1b0804065e1cda2c834d257fdd90ed">sw lok: expose field type &amp; command of fieldmark under cursor</a></li>
<li><a href="https://git.libreoffice.org/core/commit/471804e251b4e15b37a10920bd4b88b40f97b227">sw update of refmarks: fix handling of ignored refmarks</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f83c1353b94fc7dec79d05ac45c11f40f497261d">sw: UpdateFieldContents: fix typos</a></li>
<li><a href="https://git.libreoffice.org/core/commit/337416dafb66ed8f930d2d69e83fae438fc85f3c">sw: add a new .uno:UpdateTextFormField UNO command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5a2ee5ba893b6b8f4e7fd6623b7f10faf0bda509">sw lok: get all refmarks: sort the refmarks array</a></li>
<li><a href="https://git.libreoffice.org/core/commit/dd775cd630c907bc7d8bcd6f57ffd3f66115a5ba">sw, .uno:InsertSection: add a new Content parameter and accept HTML there</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8336c61ba059551cb74df5ec53d2b45a3cf41814">sw: document FN_UPDATE_TEXT_FORMFIELD and FN_UPDATE_TEXT_FORMFIELDS</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2ddd41b420cea7f1b988f0b8acbca564b2811382">sw, lok: implement a getCommandValues(Sections)</a></li>
<li><a href="https://git.libreoffice.org/core/commit/913b399a73c4d6dfd2c9f5983f56f612f3262fa7">vcl ITiledRenderable: rename supportsCommandValues() to supportsCommand()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d2318503d559c3797965da777627e4ee45143043">sw, UpdateBookmarks: support renaming bookmarks</a></li>
<li><a href="https://git.libreoffice.org/core/commit/71a479afb7e9762de930361e6089e23ab8d4af74">sw: add a new .uno:UpdateSections command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c68d06dfa1498f862923eaddf3e5d247650a53d5">sw: add a new .uno:DeleteTextFormFields UNO command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/30f6793baa5529b0594407cd0caaf3a3cde3289c">sw: fix FN_UPDATE_TEXT_FORMFIELD typo</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4bcb66ec7b417fbe113267f2615e78fe47eb55ca">sw lok: expose name of bookmark under cursor</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ea208f6004770eb4b81d28e6930cd0c7bd5d8f12">sw: add a new .uno:UpdateBookmark UNO command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/200e2a3c28bdeec785ac389473f5fca6576071a0">sw, UpdateSections: remove not needed StateMethod</a></li>
<li><a href="https://git.libreoffice.org/core/commit/81f690ec0cb2a6dc0d6ca0f6de3adcc07eb7bc12">sw lok: expose name of refmark under cursor</a></li>
<li><a href="https://git.libreoffice.org/core/commit/60be9811555b935d6860157ebf26fac6b48327ac">sw, FN_DELETE_TEXT_FORMFIELDS: allow deleting all fieldmarks</a></li>
<li><a href="https://git.libreoffice.org/core/commit/04d50fa627faabb9211bd9fa9eb134599fb01982">sw: rename getBookmarkFor() to getInnerBookmarkFor()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/402ab3d145a1e8e123caabf4567aef7b6631fc3c">sw: add a new .uno:UpdateField UNO command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/40753de837b9776dd8b33e830be0cceef83f024a">sw: add a new .uno:DeleteBookmarks UNO command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1d6593dd799ff4eb931ffbb5338e4856fb87f77f">sw: add a new .uno:DeleteFields UNO command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2cf59dee9637dcb741806ce61e50b6be427dd7b8">sw, UpdateBookmark: address some minor performance nits</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0250d6c643f2866c4de7e3c943248ffda9205d05">sw, UpdateFieldContent: address a minor performance nit</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f41d42491528905594b9a36a3bf16998f309c702">sw: disable AutoUpdate for many new recent field/book/refmark UNO commands</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ceea8f3924f26d5f10adc41b9ea587c77c2fda74">sw: .uno:TextFormField: add new Wrapper parameter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/43d80906c8693ca27c5b3077fbaa259df4004924">sw: .uno:TextFormField: handle Endnote as a value for the Wrapper parameter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/91c0e64c2f4d67c6a1073a73b1e467a3b28f0e85">sw: rename getBookmarkFor() further to getOneInnermostBookmarkFor()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e9d5ccd5a0822969412dbddf0191e28703e72e82">sw, .uno:InsertField: add a new Wrapper parameter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/04d988d3c368fe07ae3c44c536a4513e424f104e">sw, .uno:InsertField: handle Endnote as a value for the Wrapper parameter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a5a1ea2f7d784c5c6c33f332ba61aceb7af3eca4">sw: add a new .uno:DeleteSections UNO command</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 22.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (7.6).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-number-portion.html">Improved number portion formatting in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 03 January 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Number portions generated when using lists/numberings/bullets in Writer now can have formatting
which is preserved in ODT files as well.</p>
<p>First, thanks <a href="https://www.docmosis.com/">Docmosis</a> for funding this work by
<a href="https://www.collaboraoffice.com/">Collabora</a>.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Word and DOCX files support explicit character properties for the paragraph marker, and these are
also used for the formatting of a number portion if the paragraph has one. This was already loaded
from / saved to DOCX, but it was lost when saving to ODT.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>First, we got a bug document, where the reference rendering and our rendering differed:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-number-portion/sw-number-portion-1.png"><figcaption>Reference (on the left) and our old (on the right) rendering, due to bookmarks</figcaption>
</figure>
</p>
<p>In this case, what happened was that part of the heading text was covered by a bookmark, so we first
created multiple character ranges (outside the bookmark, inside the bookmark), then as an
optimization we even unified them to be a single formatted character range, covering the entire
paragraph. This was a document model that is different from the bookmark-free version, where the
character formatting was set on the paragraph itself.</p>
<p>This was fixed at render time and at DOCX export time to consider both full-paragraph character
ranges and in-paragraph character properties. For a while, this looked like the entire story, since
this now looks good in Writer:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-number-portion/sw-number-portion-1good.png"><figcaption>Our new rendering, handling bookmarks</figcaption>
</figure>
</p>
<p>A bit later another, related bug was discovered. Given a reference document:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-number-portion/sw-number-portion-2-ref.png"><figcaption>Reference rendering of a second document</figcaption>
</figure>
</p>
<p>Just opening this DOCX file in Writer, it looked like this:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-number-portion/sw-number-portion-3-import.png"><figcaption>Old rendering in Writer</figcaption>
</figure>
</p>
<p>Note how the first number portion turned into bold! This was expected after the above layout change
to consider full-paragraph formatted character ranges, but it also meant that Word can have one
set of character formatting for the entire character range of a paragraph, and another for the
paragraph marker.</p>
<p>To make the problem worse, this second document was showing that even the ODT export/export feature
had problems, still:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-number-portion/sw-number-portion-4-odf.png"><figcaption>Old rendering in Writer after ODT save + load</figcaption>
</figure>
</p>
<p>The fix to solve all of the above was to undo the previous render / DOCX export change, then teach
the ODT export to explicitly save the paragraph marker formatting (as an empty span at the end of
the text node) to ODT, and also to load it back.</p>
<p>This means that now Writer can render the second document correctly, without breaking the first
document:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/sw-number-portion/sw-number-portion-5-good.png"><figcaption>New rendering in Writer</figcaption>
</figure>
</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<!-- s/\([^ ]\+\) \(.*\)/- [\2](https:\/\/git.libreoffice.org\/core\/commit\/\1)/g -->

<ul>
<li><a href="https://git.libreoffice.org/core/commit/e6907bc15cfa3c561d4aafbcc92eff291dc68cdd">sw, numbering portion format: consider full-para char formats as well</a></li>
<li><a href="https://git.libreoffice.org/core/commit/dfba56830288b381eaaaf6b8f9454834301497db">DOCX export, numbering portion format: consider full-para char formats as well</a></li>
<li><a href="https://git.libreoffice.org/core/commit/585d440df98ff3b967c191908ac2d4b2f7e29326">sw, numbering portion format: ignore char formats covering the entire paragraph</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3998b98749739b2c499ffc4d83188e1034b66750">sw: ODT import/export of DOCX's paragraph marker formatting</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4634a27dd6f762168b3d7820326611b20b7d385c">sw: fix ODT import of paragraph marker formatting</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 22.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (7.6).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/pdf-watermark.html">Improved watermark in the PDF export</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 05 December 2022</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>The PDF export now supports various additional properties for the optional PDF watermark.</p>
<p>First, thanks <a href="https://www.docmosis.com/">Docmosis</a> for funding this work by
<a href="https://www.collaboraoffice.com/">Collabora</a>.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>
<figure><img src="https://share.vmiklos.hu/blog/pdf-watermark/rotate-and-color.png"><figcaption>Rendering of a PDF watermark with custom rotation and color</figcaption>
</figure>
</p>
<p>When you hear the word "watermark", you probably have something like the above picture in mind.</p>
<p>Instead, what the PDF export had is more like a proof of concept:</p>
<p>
<figure><img src="https://share.vmiklos.hu/blog/pdf-watermark/default.png"><figcaption>Rendering of a PDF watermark with default settings</figcaption>
</figure>
</p>
<p>The request was to add new options to control the font size, font name, rotation angle and color of
the watermark, so in case an organization already has a given style of watermarks they prefer, our
PDF export can be adapted accordingly.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>First, now you can specify a custom color, e.g. gray (#7f7f7f), using:</p>
<div class="highlight"><pre><span></span><code><span class="err">soffice --convert-to pdf:writer_pdf_Export:&#39;{&quot;Watermark&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;draft&quot;}, &quot;WatermarkColor&quot;:{&quot;type&quot;:&quot;long&quot;,&quot;value&quot;:&quot;8355711&quot;}}&#39; test.odt</span>
</code></pre></div>

<p>
<figure><img src="https://share.vmiklos.hu/blog/pdf-watermark/color.png"><figcaption>Rendering of a PDF watermark with custom color</figcaption>
</figure>
</p>
<p>Then you can also customize the font size, in case the automatic size would not fit your needs,
using:</p>
<div class="highlight"><pre><span></span><code><span class="err">soffice --convert-to pdf:writer_pdf_Export:&#39;{&quot;Watermark&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;draft&quot;}, &quot;WatermarkFontHeight&quot;:{&quot;type&quot;:&quot;long&quot;,&quot;value&quot;:&quot;100&quot;}}&#39; test.odt</span>
</code></pre></div>

<p>
<figure><img src="https://share.vmiklos.hu/blog/pdf-watermark/font-size.png"><figcaption>Rendering of a PDF watermark with custom font size</figcaption>
</figure>
</p>
<p>Or perhaps you want a serif font, not a sans one:</p>
<div class="highlight"><pre><span></span><code><span class="err">soffice --convert-to pdf:writer_pdf_Export:&#39;{&quot;Watermark&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;draft&quot;}, &quot;WatermarkFontName&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;Times&quot;}}&#39; test.odt</span>
</code></pre></div>

<p>
<figure><img src="https://share.vmiklos.hu/blog/pdf-watermark/font-name.png"><figcaption>Rendering of a PDF watermark with custom font name</figcaption>
</figure>
</p>
<p>Finally you can have a custom rotate angle:</p>
<div class="highlight"><pre><span></span><code><span class="err">soffice --convert-to pdf:writer_pdf_Export:&#39;{&quot;Watermark&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;draft&quot;}, &quot;WatermarkRotateAngle&quot;:{&quot;type&quot;:&quot;long&quot;,&quot;value&quot;:&quot;450&quot;}}&#39; test.odt</span>
</code></pre></div>

<p>
<figure><img src="https://share.vmiklos.hu/blog/pdf-watermark/rotate.png"><figcaption>Rendering of a PDF watermark with custom rotation</figcaption>
</figure>
</p>
<p>Using these building blocks, you can also build combinations, the first screenshot above was created
using:</p>
<div class="highlight"><pre><span></span><code><span class="err">soffice --convert-to pdf:writer_pdf_Export:&#39;{&quot;Watermark&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;draft&quot;}, &quot;WatermarkRotateAngle&quot;:{&quot;type&quot;:&quot;long&quot;,&quot;value&quot;:&quot;450&quot;}, &quot;WatermarkColor&quot;:{&quot;type&quot;:&quot;long&quot;,&quot;value&quot;:&quot;8355711&quot;}}&#39; test.odt</span>
</code></pre></div>

<p>i.e. the configuration JSON is:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;Watermark&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;draft&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;WatermarkRotateAngle&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;long&quot;</span><span class="p">,</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;450&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;WatermarkColor&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;long&quot;</span><span class="p">,</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;8355711&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<!-- s/\([^ ]\+\) \(.*\)/- [\2](https:\/\/git.libreoffice.org\/core\/commit\/\1)/g -->

<ul>
<li><a href="https://git.libreoffice.org/core/commit/21c4749d0205d1ba90494edc2527ff9d11f86f87">Related: tdf#54053 PDF export: add UNO API to customize the watermark color</a></li>
<li><a href="https://git.libreoffice.org/core/commit/175e514c93b3696faa8c331c8b8f56e832ceb4c1">Related: tdf#54053 PDF export: add UNO API to customize the watermark font size</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d1dd9b9733511ff451e264169537c08fa14c574f">Related: tdf#54053 PDF export: add UNO API to customize the watermark font name</a></li>
<li><a href="https://git.libreoffice.org/core/commit/574db5efa9a2ab6d70faedf538be77a1eb8c597b">Related: tdf#54053 PDF export: add UNO API to customize the watermark rotation</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 22.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (7.5).</p>
  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/index2.html" class="button_accent">&larr; Older Posts</a>

</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>