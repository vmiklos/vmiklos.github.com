<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<meta name="description" content="What is Miklos hacking - Miklos' blog" />
<meta name="keywords" content="vmiklos, libereoffice, swig, git, python, hacking, bitlbee" />
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/index.rss" />
<link rel="stylesheet" href="/blog/xhtml11.css" type="text/css" />
<link rel="stylesheet" href="/blog/xhtml11-quirks.css" type="text/css" />
<link rel="stylesheet" href="/blog/layout.css" type="text/css" />
<title>What is Miklos hacking</title>
<!-- google analytics start -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24726997-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- google analytics end -->
</head>
<body>
<div id="layout-banner-box">
<div id="layout-banner">
  <div id="layout-title">vmiklos.hu</div>
  <div id="layout-description">shameless self-promoting website</div>
</div>
</div>
<div id="layout-menu-box">
<div id="layout-menu">
  <div>&#187;<a href="/">Root</a></div>
  <div>&#187;<a href="/blog/">Rejourn root</a></div>
  <div>&#187;<a href="http://planet.documentfoundation.org/">LibreOffice Community Blogs</a></div>
  <div>
    Search:<br/>
    <form action="http://www.google.com/cse" id="cse-search-box" target="_blank">
    <input type="hidden" name="cx" value="007336731492173318056:bik8fqvatno"/><input type="hidden" name="ie" value="UTF-8"/><input type="text" name="q" size="15"/><br/>
    <input type="submit" name="sa" value="&#187;"/></form>
  </div>
</div>

<div id="alltags-menu">
	Tags:
	<div>&#187;<a href="/blog/tags/hu.html">hu</a> (1201)</div>
	<div>&#187;<a href="/blog/tags/en.html">en</a> (563)</div>
	<div>&#187;<a href="/blog/tags/hacking.html">hacking</a> (416)</div>
	<div>&#187;<a href="/blog/tags/film.html">film</a> (286)</div>
	<div>&#187;<a href="/blog/tags/libreoffice.html">libreoffice</a> (114)</div>
	<div>&#187;<a href="/blog/tags/geek.html">geek</a> (82)</div>
	<div>&#187;<a href="/blog/tags/bringa.html">bringa</a> (60)</div>
	<div>&#187;<a href="/blog/tags/konyv.html">konyv</a> (44)</div>
	<div>&#187;<a href="/blog/tags/misc.html">misc</a> (37)</div>
	<div>&#187;<a href="/blog/tags/zene.html">zene</a> (32)</div>
	<div>&#187;<a href="/blog/tags/munka.html">munka</a> (28)</div>
	<div>&#187;<a href="/blog/tags/fun.html">fun</a> (27)</div>
	<div>&#187;<a href="/blog/tags/frugalware.html">frugalware</a> (23)</div>
	<div>&#187;<a href="/blog/tags/sieles.html">sieles</a> (7)</div>
	<div>&#187;<a href="/blog/tags/bitlbee.html">bitlbee</a> (5)</div>
	<div>&#187;<a href="/blog/tags/gsoc2009.html">gsoc2009</a> (4)</div>
	<div>&#187;<a href="/blog/tags/git.html">git</a> (3)</div>
	<div>&#187;<a href="/blog/tags/szinhaz.html">szinhaz</a> (3)</div>
	<div>&#187;<a href="/blog/tags/gsoc2008.html">gsoc2008</a> (3)</div>
	<div>&#187;<a href="/blog/tags/opensuse.html">opensuse</a> (3)</div>
	<div>&#187;<a href="/blog/tags/gsoc2011.html">gsoc2011</a> (2)</div>
	<div>&#187;<a href="/blog/tags/go-oo.html">go-oo</a> (2)</div>
	<div>&#187;<a href="/blog/tags/kde.html">kde</a> (1)</div>
	<div>&#187;<a href="/blog/tags/libwpd.html">libwpd</a> (1)</div>
	<div>&#187;<a href="/blog/tags/karacsony.html">karacsony</a> (1)</div>
	<div>&#187;<a href="/blog/tags/upc.html">upc</a> (1)</div>
	<div>&#187;<a href="/blog/tags/google.html">google</a> (1)</div>
	<div>&#187;<a href="/blog/tags/fail.html">fail</a> (1)</div>
	<div>&#187;<a href="/blog/tags/openstack.html">openstack</a> (1)</div>
	<div>&#187;<a href="/blog/tags/mdadm.html">mdadm</a> (1)</div>
	<div>&#187;<a href="/blog/tags/w3c.html">w3c</a> (1)</div>
	<div>&#187;<a href="/blog/tags/java.html">java</a> (1)</div>
	<div>&#187;<a href="/blog/tags/greasemonkey.html">greasemonkey</a> (1)</div>
	<div>&#187;<a href="/blog/tags/auto.html">auto</a> (1)</div>
	<div>&#187;<a href="/blog/tags/otrs.html">otrs</a> (1)</div>
	<div>&#187;<a href="/blog/tags/gsoc2010.html">gsoc2010</a> (1)</div>
	<div>&#187;<a href="/blog/tags/bme.html">bme</a> (1)</div>
	<div>&#187;<a href="/blog/tags/python.html">python</a> (1)</div>
	<div>&#187;<a href="/blog/tags/howto.html">howto</a> (1)</div>
	<div>&#187;<a href="/blog/tags/openoffice.html">openoffice</a> (1)</div>
	<div>&#187;<a href="/blog/tags/networking.html">networking</a> (1)</div>
	<div>&#187;<a href="/blog/tags/gpsbabel.html">gpsbabel</a> (1)</div>
	<div>&#187;<a href="/blog/tags/supybot.html">supybot</a> (1)</div>
	<div>&#187;<a href="/blog/tags/lcov.html">lcov</a> (1)</div>
	<div>&#187;<a href="/blog/tags/nyaralas.html">nyaralas</a> (1)</div>
</div>

</div>
<div id="layout-content-box">
<div id="layout-content">
<div id="header">
	<h1>What is Miklos hacking</h1>
</div>
<div id="preamble">
<div class="sectionbody">




<!-- Listing -->
<div class="ulist"><ul>
<li><p>Tuesday, 17 January 2017<br /><a href="/blog/hackweek-2016.html">Hack-(rest-of-the)-week at Collabora</a>
(<a href="/blog/hackweek-2016.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm1.staticflickr.com/726/32306648426_b4ee93f6a1_o.png" alt="https://farm1.staticflickr.com/726/32306648426_b4ee93f6a1_o.png" />
</div>
</div>
<div class="paragraph"><p>As mentioned in
<a href="https://mikekaganski.wordpress.com/2016/12/11/my-first-hack-rest-of-the-week-at-collabora/">the
blog post of Mike</a> already, last month we were allowed to hack on anything we
want in LibreOffice for a few days. I used this time to progress with 3
different topics.</p></div>
<div class="sect1">
<h2 id="_stepping_through_textboxes_using_the_keyboard">Stepping through TextBoxes using the keyboard</h2>
<div class="sectionbody">
<div class="paragraph"><p>Given that a Writer shape with a TextBox is internally two shapes, this needed
explicit support. After my
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=5d2c189aee5057d1533165c368227c9c4c49d330">TextBox
bugfix</a> it&#8217;s possible to have two such shapes in a document, and once you
select one of them, tab properly jumps between the two shapes; previously
nothing happened.</p></div>
<div class="paragraph"><p>What did happen is we tried to activate the TextBox of the selected shape,
which selected the shape itself, so at the end nothing happened.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_rtf_improvements">RTF improvements</h2>
<div class="sectionbody">
<div class="paragraph"><p>For some time it was already possible to import and export custom string
document properties from/to RTF, but just in case the value type of the
property was string. Now I extended support for these custom properties, so
also the remaining types are handled:
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=fc8c4606e0834cd2128a228c2c95fc7c8f9eb7b1">numbers</a>,
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=547de17fcb654e560a60d683c33482feeee84358">bools</a>,
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=51c400dc4cd6a88c01b245e41d0de737d4df4017">doubles</a>
and
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=07b0cde32a7eebce996b8c32aa58545e4ec15003">dates</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_xmlsec_patch_upstreaming">xmlsec patch upstreaming</h2>
<div class="sectionbody">
<div class="paragraph"><p>Last, I&#8217;ve started working on upstreaming
<code>external/libxmlsec/xmlsec1-noverify.patch.1</code>. xmlsec has no ability to
disable the verification of certificates (think of <code>curl -k</code> or <code>wget -k</code>), so
in LibreOffice currently we just patch out that code as we don&#8217;t need it. So I
wanted to add a new verification flag to avoid patching, but it turns out that
in the NSS case xmlsec didn&#8217;t do the verification, so as a first step I fixed
that instead in this <a href="https://github.com/lsh123/xmlsec/pull/72">xmlsec GitHub
pull request</a>. Now that it&#8217;s merged, the next step will be to add such a flag,
and then LibreOffice can get rid of the patch after the next xmlsec release.</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Tuesday, 20 December 2016<br /><a href="/blog/pades.html">PAdES support for PDF files in LibreOffice</a>
(<a href="/blog/pades.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm1.staticflickr.com/443/30919530974_5c5b3cb3a9_o.png">
<img src="https://farm1.staticflickr.com/443/30919530974_7ab3d132d8_z.jpg" alt="https://farm1.staticflickr.com/443/30919530974_7ab3d132d8_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Building on top of the previously mentioned
<a href="/blog/pdf-sign.html">signing of existing PDF files</a> work, one
more PDF feature coming in LibreOffice 5.3 is initial support for the PDF
Advanced Electronic Signatures (<a href="https://en.wikipedia.org/wiki/PAdES">PAdES</a>)
standard.  First, thanks to the Dutch Ministry of Defense in cooperation with
<a href="http://nouenoff.nl/">Nou&amp;Off</a> who made this work possible.</p></div>
<div class="sect1">
<h2 id="_results">Results</h2>
<div class="sectionbody">
<div class="paragraph"><p>PAdES is an extension of the ISO PDF signature with additional constraints, so
that it conforms to the requirements of the European eIDAS regulation, which
in turns makes it more likely that your signed PDF document will be actually
legally binding in many EU member states.</p></div>
<div class="paragraph"><p>The best way to check if LibreOffice produces such PDF signatures is to use a
PAdES validator. So far I found two of them:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://signatures-conformance-checker.etsi.org/">the ETSI one</a>, which
  requires registration and is a free web service
</p>
</li>
<li>
<p>
<a href="https://github.com/esig/dss/">Digital Signature Service</a> (DSS), which is an
  open source tool you can build, use and modify locally
</p>
</li>
</ul></div>
<div class="paragraph"><p>As it can be seen above, the PDF signature produced by LibreOffice 5.3 by
default conforms to the PAdES baseline spec.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation">Implementation</h2>
<div class="sectionbody">
<div class="paragraph"><p>I implemented the followings in LO to make this happen:</p></div>
<div class="ulist"><ul>
<li>
<p>
PDF signature creation now defaults to the stronger SHA-256 (instead of the
  previously used weaker SHA-1), and the PDF verifier understands SHA-256
</p>
</li>
<li>
<p>
the PDF signature creation now embeds the signing certificate into the
  PKCS#7 signature blob in the PDF, so the verifier can check not only the key
  used for the signing, but the actual certificate as well
</p>
</li>
<li>
<p>
the PDF signature import can now detect if such an embedded signing
  certificate is present in the signature or not
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Don&#8217;t get confused, LO does signature verification (checks if the digest
matches and validates the certificate) and now shows if the signing
certificate is present in the signature or not, but it doesn&#8217;t do more than
that, the above mentioned DSS tool is still superior when it comes to do a
full validation of a PAdES signature.</td>
</tr></table>
</div>
<div class="paragraph"><p>As usual, this works both with NSS and MS CryptoAPI. In the previous post I
noted that one task was easier with CryptoAPI. Here I experienced the
opposite: when writing the signing certificate hash, I could provide templates
to NSS on how the ASN.1 encoding of it should happen, and NSS did the actual
ASN.1 DER encoding for me. In the CryptoAPI case there is no such API, so I
had to do this encoding manually (see
<a href="https://github.com/LibreOffice/core/blob/master/vcl/source/gdi/pdfwriter_impl.cxx#L6202">CreateSigningCertificateAttribute()</a>),
which is obviously much more complicated.</p></div>
<div class="paragraph"><p>Another pain was that the DSS tool doesn&#8217;t really separate the validation of
the signature itself and of the certificate. The above screenshot was created
using a non-self-signed certificate, hence the unclear part in the signed-by
row.</p></div>
<div class="paragraph"><p>If you want to try these out yourself, get a
<a href="http://dev-builds.libreoffice.org/daily/">daily build</a> and feel free to play
with it. This work is part of both <code>master</code> or <code>libreoffice-5-3</code>, so those
builds are of interest. Happy testing! :-)</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Monday, 12 December 2016<br /><a href="/blog/pdf-sign.html">Signing existing PDF files in LibreOffice</a>
(<a href="/blog/pdf-sign.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm1.staticflickr.com/542/31208923460_e3d674d15f_o.png">
<img src="https://farm1.staticflickr.com/542/31208923460_2eb9bca147_z.jpg" alt="https://farm1.staticflickr.com/542/31208923460_2eb9bca147_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>TL;DR: see above&#8201;&#8212;&#8201;it&#8217;s now possible signing existing PDF files and also
verify those signatures in LibreOffice 5.3.</p></div>
<div class="sect1">
<h2 id="_the_problem">The problem</h2>
<div class="sectionbody">
<div class="paragraph"><p>LibreOffice already made it possible to digitally sign PDF files as part of
the PDF export, so in case you had e.g. ODF documents and exported them to
PDF, optionally a single digital signature could be added as part of the
export process. This is now much improved. First, thanks to the Dutch Ministry
of Defense in cooperation with <a href="http://nouenoff.nl/">Nou&amp;Off</a> who made this work
possible.</p></div>
<div class="paragraph"><p>A user can already use an other application to verify that signature or sign
an already existing PDF file. The idea is to allow doing these from inside
LibreOffice, directly.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results">Results</h2>
<div class="sectionbody">
<div class="paragraph"><p>As it can be seen above, now the Digital Signatures dialog not only works for
ODF and OOXML files, but also for PDF files. If the file has been signed, then
the dialog performs verifications of that signature. Signatures are also
verified on opening any signed PDF file.</p></div>
<div class="paragraph"><p>I&#8217;ve also extended the user interface a bit, so that signing an existing PDF
file is easy, similarly how exporting to PDF is easier than exporting to a
random other file format. There is now a new File &#8594; Digital signatures &#8594;
Sign exiting PDF menu item to open a PDF file for signing:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm1.staticflickr.com/30/31543378146_b33c2f0a83_o.png">
<img src="https://farm1.staticflickr.com/30/31543378146_b981a22ee0_z.jpg" alt="https://farm1.staticflickr.com/30/31543378146_b981a22ee0_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>When that happens the infobar has a dedicated button to open the Digital
Signatures dialog, and also going into editing mode triggers a warning dialog,
as going read-write is not needed to be able to sign a document:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm1.staticflickr.com/752/31543377356_d359124361_o.png">
<img src="https://farm1.staticflickr.com/752/31543377356_eaed7c2301_z.jpg" alt="https://farm1.staticflickr.com/752/31543377356_eaed7c2301_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>And that&#8217;s basically it, after you open a PDF file in Draw, you can do the
usual digital signature operations on the file, just like it already works for
previously supported file formats.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_details">Details</h2>
<div class="sectionbody">
<div class="paragraph"><p>What follows is something you can probably skip if you&#8217;re a user&#8201;&#8212;&#8201;however if
you&#8217;re a developer and you want to understand how the above is implemented,
then read on. ;-)</p></div>
<div class="sect2">
<h3 id="_pdf_tokenizer">PDF tokenizer</h3>
<div class="paragraph"><p>The signing feature in ODF/OOXML is implemented by working directly on the ZIP
storage in <code>xmlsecurity/</code>. This means that in the PDF case it&#8217;s necessary to
work on the PDF file directly, except that we had no such PDF tokenizer
ready to be used.</p></div>
<div class="paragraph"><p>Code under <code>xmlsecurity/source/pdfio/</code> now is such a tokenizer that can
extract info from PDF files and can also add incremental updates at the end of
the file, this way we can make sure adding a signature to a file won&#8217;t loose
existing content in the file. This is fundamentally different form the usual
load-edit-save workflow, when we convert the file into a document model, and
work on that.</p></div>
</div>
<div class="sect2">
<h3 id="_verification_of_signatures">Verification of signatures</h3>
<div class="paragraph"><p>Previously LO was only able to generate signatures, not verify them. I&#8217;ve
implemented PDF signature verification using both NSS and CryptoAPI, so all
Windows, Linux and macOS are covered. I have to admit that the initial verification
was much easier with CryptoAPI. Until I hit corner-cases, I could use an API
that&#8217;s well-documented and is higher level than NSS. (I don&#8217;t have to support
different hash types explicitly, for example.)</p></div>
<div class="paragraph"><p>When I added support for non-detached signatures, that changed the situation a bit:</p></div>
<div class="listingblock">
<div class="content">
<pre><code> 1 file changed, 15 insertions(+), 11 deletions(-)</code></pre>
</div></div>
<div class="paragraph"><p>was the NSS patch, and</p></div>
<div class="listingblock">
<div class="content">
<pre><code> 1 file changed, 104 insertions(+), 8 deletions(-)</code></pre>
</div></div>
<div class="paragraph"><p>was the CryptoAPI patch.</p></div>
</div>
<div class="sect2">
<h3 id="_signing_existing_files">Signing existing files</h3>
<div class="paragraph"><p>Signing an existing file means tokenizing a document, figuring out how an
incremental update should look like for that file, writing an incremental
update that has a placeholder for the actual signature (a PKCS#7 blob, where
the input is just the non-placeholder parts of the document as binary data), and
finally filling in the placeholder with the actual signature.</p></div>
<div class="paragraph"><p>For the last step, I could reuse code from the PDF export (modulo fixing bugs
like <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=99327">tdf#99327</a>).
For the other steps, the tokenizer remembers the input offset / length for the
given token, this way it&#8217;s relatively easy to create incremental updates. You
can add new objects or update new objects in such an incremental update, and
this source tracking feature allows copying even the unchanged parts of
updated objects verbatim.</p></div>
</div>
<div class="sect2">
<h3 id="_pdf_1_5">PDF 1.5+</h3>
<div class="paragraph"><p>Everything becomes a bit more complicated once I started to handle not only
LO-generated PDF-1.4, but also newer PDF versions. I think this is important,
as Adobe Acrobat creates PDF 1.6 by default today, which has a number of new
features (I think all of them were actually introduced in PDF-1.5) that
affects the tokenizer:</p></div>
<div class="ulist"><ul>
<li>
<p>
xref stream: instead of an ASCII xref table ("table of contents") at the end
  of the file, it&#8217;s now possible to write the binary equivalent of this as an
  xref stream. Because the binary version can describe more features we must
  also write an updated xref stream (and not an xref table) when the import
  already had an xref stream.
</p>
</li>
<li>
<p>
object streams: it&#8217;s now possible to write multiple objects inside the
  stream section of a single object in binary form. The tokenizer is necessary
  to be able to read these objects and also roundtripping (source tracking)
  should work not only with physical file offsets, but also inside such
  compressed streams where the offset is no longer just a number inside the
  input file. (It&#8217;s OK to write the updated objects outside object streams,
  still.)
</p>
</li>
<li>
<p>
stream predictors: this is a concept from the PNG format, but also used in
  PDF when compressing the xref stream. See the spec for the gory details, but
  in short it&#8217;s not enough that instead of plaintext you have to deal with
  binary compressed data, you also have to filter the data before actually
  parsing the file offsets, and the filter is defined not in terms of object IDs
  and file offsets, but in terms of adjacent pixels, since it&#8217;s documented in
  the PNG spec. :-) (To be close to the Adobe output, we also apply such
  predictors when writing compressed xref streams.)
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_user_interface">User Interface</h3>
<div class="paragraph"><p>In addition to be UI changes already mentioned above, one more improvement I
did is that now the Digital Signatures dialog has a new column to show the
signature type.  This is either XML-DSig (for ODF/OOXML) or PDF.</p></div>
</div>
<div class="sect2">
<h3 id="_testing">Testing</h3>
<div class="paragraph"><p>I&#8217;ve added an integration test in the existing
<code>CppunitTest_xmlsecurity_signing</code> to have coverage for the small new code that
calls into <code>xmlsecurity/</code> from <code>sfx2/</code> in case of PDF files. But fortunately
because all other code in <code>xmlsecurity/</code> was new, I could do unit testing in
<code>CppunitTest_xmlsecurity_pdfsigning</code> for the rest of the features.</p></div>
<div class="paragraph"><p>Needless to say that invoking the PDF tokenizer + signature creator/verifier
directly is <strong>much</strong> quicker than loading a full PDF file into Draw, just to see
the signature status. ;-)</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you want to try these out yourself, get a
<a href="http://dev-builds.libreoffice.org/daily/">daily build</a> and play with it! This
work is part of both <code>master</code> or <code>libreoffice-5-3</code>, so those builds are of
interest. Happy testing! :-)</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Saturday, 12 November 2016<br /><a href="/blog/devtalks.html">LibreOffice session at DevTalks Jr.</a>
(<a href="/blog/devtalks.html#disqus_thread">Comments</a>)
</p><p><div style="text-align: center; font-size: 0.6em;">
<img src="https://farm6.staticflickr.com/5687/30900149756_0abd3a3218_z.jpg"/>
<p>(via <a href="https://twitter.com/DevTalksRo/status/797429977968939008">DevTalksRo</a>)</p>
</div>
<div class="paragraph"><p>Today I gave a
<a href="https://speakerdeck.com/vmiklos/getting-involved-with-libreoffice-online-and-android">Getting
involved with LibreOffice Online and Android</a> session at
<a href="http://www.devtalks.ro/bucharest/devtalks-jr/">DevTalks Jr</a>, Bucharest. The
event had two tracks in parallel, with a total attendees of about 200
developers.</p></div>
<div class="paragraph"><p>Some photos I took after the event are <a href="https://www.flickr.com/photos/vmiklos/sets/72157675071819211/">available</a>.</p></div>
<div class="paragraph"><p>Thanks the organizers and sponsors for the great event! :-)</p></div>
</p><hr/></li>
<li><p>Monday, 10 October 2016<br /><a href="/blog/lo-insert-pdf-image.html">Insert PDF as image in LibreOffice 5.3</a>
(<a href="/blog/lo-insert-pdf-image.html#disqus_thread">Comments</a>)
</p><p><div class="sect1">
<h2 id="_results">Results</h2>
<div class="sectionbody">
<div class="paragraph"><p>LibreOffice 5.3 will add one more vector-based format that can be inserted as
an image into documents: PDF. First, thanks to <a href="http://pmg.be/">PMG</a> who made
this work possible. On the user interface you can now select PDF files when
you choose e.g. Writer&#8217;s Insert &#8594; Image option:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm6.staticflickr.com/5552/29583461353_0c2da79c8e_o.png">
<img src="https://farm6.staticflickr.com/5552/29583461353_02fc75dd7f_z.jpg" alt="https://farm6.staticflickr.com/5552/29583461353_02fc75dd7f_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>The first page of the PDF document will be shown, which is handy if the PDF
file is basically used as a vector image format.</p></div>
<div class="paragraph"><p>Similarly to the SVG feature, the original vector image is stored in the
document, but when saving to ODF, a replacement PNG file is also generated to
be backwards compatible with older ODF readers. The image context menu &#8594; Save
menu item allows to extract your original PDF data from the image, too:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm8.staticflickr.com/7501/30098334712_569ebbe55b_o.png">
<img src="https://farm8.staticflickr.com/7501/30098334712_535e16ea05_z.jpg" alt="https://farm8.staticflickr.com/7501/30098334712_535e16ea05_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>And that&#8217;s it, as long as you save your document in ODF, your PDF-as-an-image
will be kept without loosing any data. As usual, you can try this right now
with a 5.3 <a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
<div class="paragraph"><p>However, if you&#8217;re interested in how this is implemented, keep reading&#8230;</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_document_model">Document model</h2>
<div class="sectionbody">
<div class="paragraph"><p>The PDF image in the document model is really similar to how SVG is handled,
next to <code>Graphic::getSvgData()</code>, there is now a <code>Graphic::getPdfData()</code>.
This new member function exposes the original PDF data, otherwise the Graphic
is just a metafile.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_uno_api">UNO API</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <code>ReplacementGraphicURL</code> property of the image at an UNO level now exposes
the generated metafile for PDF images. This is implemented for both Draw and
Writer images, and is used by the ODF export filter.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_layout">Layout</h2>
<div class="sectionbody">
<div class="paragraph"><p>When the <code>Graphic</code> instance is rendered, the layout knows nothing about the
PDF data attached to the object, only parses the generated metafile. This way
the display of the PDF image works out of the box.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_filters">Filters</h2>
<div class="sectionbody">
<div class="paragraph"><p>First I&#8217;ve implemented a
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=878a860dff10bd91491d6c9f2f4e2308bfe4f0b2">PDF
import-as-graphic filter</a>, then the
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=7d76bb251e0c88ff17282a33b801a5d17a434af5">export
equivalent of it</a>. As you can see, the PDF import-as-graphic filter isn&#8217;t too
complicated, it completely reuses the existing "import PDF into Draw" filter,
it simply copies the first page of the resulting document model as a metafile.</p></div>
<div class="paragraph"><p>Second, once the graphic filters were working, I&#8217;ve also
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=d1c346ba848c54424d6ffa88df7a5ff6a3717430">improved</a>
the ODF import to recognize PDF data&#8201;&#8212;&#8201;the export side needed no explicit
work, once the <code>ReplacementGraphicURL</code> bits were in place.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_tests">Tests</h2>
<div class="sectionbody">
<div class="paragraph"><p>As mentioned above, the Draw and the Writer image implementation is separate,
so first I&#8217;ve added tests for ODT files in the <code>testEmbeddedPdf</code> of
<code>CppunitTest_sw_odfexport</code>, and then <code>SdExportTest::testEmbeddedPdf()</code> to
cover ODP files (and other ODF formats).  Second, the PDF part of the graphic
swapout/in code has a dedicated test in <code>GraphicObjectTest::testPdf()</code>, and
the UI&#8217;s "Save original PDF" feature has a new
<code>XOutdevTest::testPdfGraphicExport()</code> test.</p></div>
<div class="paragraph"><p>Oh, and if you intent to test this manually in a self-created build, make sure
to avoid <code>--disable-pdfimport</code>, otherwise this feature can&#8217;t work. ;-)</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Monday, 03 October 2016<br /><a href="/blog/sw-smallcaps-toolbar-button.html">Small capitals toolbar button in LibreOffice Writer</a>
(<a href="/blog/sw-smallcaps-toolbar-button.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm6.staticflickr.com/5235/29982452081_a9ca103f2f_o.png">
<img src="https://farm6.staticflickr.com/5235/29982452081_187d99dece_z.jpg" alt="https://farm6.staticflickr.com/5235/29982452081_187d99dece_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>It was <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=87914">requested</a> to
be able to set the small capitals character property via a toolbar button in
Writer, which was indeed not possible. Not only the toolbar button wasn&#8217;t
there, but the underlying UNO command was also missing (which you can use e.g.
from a macro to format the current selection).</p></div>
<div class="paragraph"><p>So my
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=d378cd2f766eeb1fd1c98f62c9ae6b5b59fd00f1">commit</a>
added a simple set of icons to the galaxy theme for the new toolbar button,
defined the new UNO command for Writer text and added it to Writer&#8217;s text
object bar, next to the upper case and lower case buttons (hidden by default).
One difference from those buttons is that those buttons perform a
transliteration, while this one really just sets a character property, you can
easily undo the property later if needed.</p></div>
<div class="paragraph"><p>Wrt. other icon themes, see
<a href="http://listarchives.libreoffice.org/global/design/msg07922.html">this mail</a>,
hopefully the design team can help there.</p></div>
<div class="paragraph"><p>As usual, you can try this right now with a 5.3
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
</p><hr/></li>
<li><p>Tuesday, 13 September 2016<br /><a href="/blog/clang-locon-brno-2k16.html">Using clang-based tools beyond loplugin LOCon lightning talk</a>
(<a href="/blog/clang-locon-brno-2k16.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/731c4bb5277c48d8acbba1c867ece856/clang-locon-brno-2k16.pdf">
<img src="https://farm9.staticflickr.com/8074/29618061316_308e7e9b30_z.jpg" alt="https://farm9.staticflickr.com/8074/29618061316_308e7e9b30_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>The last week I gave a
<a href="http://conference.libreoffice.org/2016/the-program/sept-9th-friday/">Using
clang-based tools beyond loplugin</a> lightning talk at LibreOffice conference
2016, on the last day. Click on the image to see all the slides.</p></div>
<div class="paragraph"><p>If you&#8217;re a vim or emacs user and you work with C++11 code, you probably
want to have a look at
<a href="http://clang.llvm.org/extra/clang-rename.html">clang-rename</a>,
<a href="http://clang.llvm.org/extra/include-fixer.html">include-fixer</a> and some editor
plugin exposing the power of libclang (like
<a href="https://valloric.github.io/YouCompleteMe/">YouCompleteMe</a> or
<a href="https://github.com/libclang-vim/libclang-vim">libclang-vim</a>), sometimes these
are really helpful.</p></div>
</p><hr/></li>
<li><p>Monday, 12 September 2016<br /><a href="/blog/rtf-locon-brno-2k16.html">A year in LibreOffice's RTF support LOCon talk</a>
(<a href="/blog/rtf-locon-brno-2k16.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/65dac04a99f146649b08cf66211469fd/rtf-locon-brno-2k16.pdf">
<img src="https://farm9.staticflickr.com/8004/29626765785_7f35c9bfd6_z.jpg" alt="https://farm9.staticflickr.com/8004/29626765785_7f35c9bfd6_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Last week I gave a
<a href="http://conference.libreoffice.org/2016/the-program/sept-8th-thursday/"> year in
LibreOffice&#8217;s RTF support</a> talk at LibreOffice conference 2016, in the
development track. Click on the image to see all the slides.</p></div>
<div class="paragraph"><p>I&#8217;ve also published a number of (mostly)
<a href="https://www.flickr.com/photos/vmiklos/albums/72157673517450165">sightseeing
pictures</a> based on wondering around in Brno before and after the conference.</p></div>
</p><hr/></li>
<li><p>Friday, 09 September 2016<br /><a href="/blog/collaborative-locon-brno-2k16.html">Collaborative editing using LibreOfficeKit LOCon talk</a>
(<a href="/blog/collaborative-locon-brno-2k16.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/035a8c526e5b4748a062a266cd4ffd94/collaborative-locon-brno-2k16.pdf">
<img src="https://farm9.staticflickr.com/8830/29558170685_8aa768ec84_z.jpg" alt="https://farm9.staticflickr.com/8830/29558170685_8aa768ec84_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Yesterday I gave a
<a href="http://conference.libreoffice.org/2016/the-program/sept-8th-thursday/">Collaborative
editing using LibreOfficeKit</a> talk at LibreOffice conference 2016, in the
development track. There were many interested parties&#8201;&#8212;&#8201;not a surprise, as
this is the power horse behind LibreOffice Online. :-)</p></div>
</p><hr/></li>
<li><p>Thursday, 08 September 2016<br /><a href="/blog/locon2016.html">Improved digital signature handling in LibreOffice LOCon talk</a>
(<a href="/blog/locon2016.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/d7946ac560054fcb9f9a3953f079d9a7/xmlsec-locon-brno-2k16.pdf">
<img src="https://farm9.staticflickr.com/8646/29432546522_585a16f89a_z.jpg" alt="https://farm9.staticflickr.com/8646/29432546522_585a16f89a_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Earlier today I gave a
<a href="http://conference.libreoffice.org/2016/the-program/sept-8th-thursday/">Improved
digital signature handling in LibreOffice</a> talk at LibreOffice conference
2016, in the development track. The room was well-crowded&#8201;&#8212;&#8201;seems this year
classification was a hot topic. ;-)</p></div>
<div class="paragraph"><p>Quite some pictures are now available <a href="https://twitter.com/libreoffice">on</a>
<a href="https://twitter.com/CollaboraOffice">Twitter</a>, don&#8217;t miss them.</p></div>
</p><hr/></li>
</ul></div>
<a href="/blog/archive.html">more &raquo;</a>
<script type="text/javascript">
var disqus_shortname = 'vmiklos';
(function () {
 var s = document.createElement('script'); s.async = true;
 s.src = '//vmiklos.disqus.com/count.js';
 (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

</div>
</div>
</div>
</div>
</body>
</html>
