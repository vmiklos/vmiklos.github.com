<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />


  <title>
    What is Miklos hacking
  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-continuous-endnotes2.html">Section-based continuous endnotes in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 03 June 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has much better support for continuous / inline endnotes (not on a separate page) in
Writer, enabled by default for DOCX files.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but the feature is
fully available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>As described in a <a href="https://vmiklos.hu/blog/sw-continuous-endnotes.html">previous post</a>, Writer already had
minimal support for not rendering endnotes on a separate endnote page, but it was not mature enough
to enable is by default for DOCX files.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>What changed from the previous "continuous endnotes" approach is that instead of trying to map
endnotes to footnotes, we now create a special endnotes section, which only exists at a layout level
(no section node is backing this one), and this hosts all endnotes at the end of the document. It
turns out this is a much more scalable technique, for example a stress-test with 72 endnotes over
several pages is now handled just fine.</p>
<p>Here are some screenshots:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-continuous-endnotes2/old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-continuous-endnotes2/old.png"><figcaption>Before: reference is red, Writer result is painted on top of it</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sw-continuous-endnotes2/new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-continuous-endnotes2/new.png"><figcaption>After: reference is red, Writer result is rendered on top of it</figcaption></figure></a></p>
<p>As you can see, there were various differences for this document, but the most problematic one was
that the entire endnote was missing from the (originally) last page, as it was rendered on a
separate page.</p>
<p>Now it's not only on the correct page, but also its position is correct: the endnote is after the
body text, while the footnote is at the bottom of the page, as expected. The second screenshot shows
~no red, which means there is ~no reference output, where the Writer output would be missing.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/90f19126fa405a0632eae4ee8525b66bbce12625">tdf#160984 sw continuous endnotes: introduce an endnote section</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8bae684c93bd23bbe98707ba9cf75d1a39427131">tdf#160984 sw continuous endnotes: add a way to find the endnote section start</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ab3416cad1dd4e706432f9b1a3592cec823c76b0">tdf#160984 sw continuous endnotes: fix testContinuousEndnotesMoveBackwards</a></li>
<li><a href="https://git.libreoffice.org/core/commit/9c7acbc937b3b341c10187b837e09cc20399f04e">tdf#160984 sw continuous endnotes: fix <code>CppunitTest_sw_layoutwriter3</code></a></li>
<li><a href="https://git.libreoffice.org/core/commit/6885dcd7ec7b82a946d8344bfc27a3e88eecc44a">tdf#160984 sw continuous endnotes: switch to a section-based layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/82dd81a9d2049ac95535880fc67c1867f90e1427">tdf#161083 sw continuous endnotes: fix layout with a section at doc end</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d74fb6b571304b41c13b7a6dcdd2b853bfca7210">tdf#160984 sw continuous endnotes, DOC import: enable this unconditionally</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1ae5ea3f78cca11ba18f2dd1a06f875263336a3b">tdf#160984 sw continuous endnotes: enable DOCX import</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d1ddd136a1b0e452492464d58715eaec144fd811">tdf#160984 sw continuous endnotes: fix the endnote container's top margin</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f1d0b4e34a1f467e9f54baa7ac31ca28fdae3efb">tdf#160984 sw continuous endnotes: fix the endnote separator position</a></li>
<li><a href="https://git.libreoffice.org/core/commit/755f3bebd96ec7ae43b1dcf247f907b9c15c1995">tdf#160984 sw continuous endnotes: fix the endnote separator length</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3f2d0414686a8f9a042413c47c4c8ffa5d61f436">tdf#160984 sw continuous endnotes: fix crash on loading forum-mso-en-7731.docx</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2d2dd56e0b2dc708f1f758d7fc9a1263ff09b83c">tdf#160984 sw continuous endnotes: DOCX: import <code>&lt;w:endnotePr&gt;</code> pos == sectEnd</a></li>
<li><a href="https://git.libreoffice.org/core/commit/566c7017a84e3d573de85a6d986b81d3f59de0fa">tdf#160984 sw continuous endnotes: DOCX: export of <code>&lt;w:endnotePr&gt;</code> pos == sectEnd</a></li>
<li><a href="https://git.libreoffice.org/core/commit/6450159e0e7c5fac9c998087e99f3fec602ff84d">tdf#160984 sw continuous endnotes: fix the endnote continuation separator len</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8f3e11dc9a4b3fd9ad1985d88b241df7bcb66fec">tdf#160984 sw continuous endnotes: hide not functional UI in this mode</a></li>
</ul>
<p>The tracking bug was <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=160984">tdf#160984</a>.</p>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraoffice.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (24.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/cool-clipboard-copy.html">Improved copy & paste in Collabora Online: the copy side</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 03 May 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 4 minutes</p>
  </div>
  <div class="article_text">
    <p><a href="https://www.collaboraoffice.com/">Collabora Online</a> now uses the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API">Clipboard
API</a> if it's available in the used
browser, getting rid of many annoying dialogs.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>The <a href="https://vmiklos.hu/blog/sc-clipboard-paste.html">paste side</a> was covered by an earlier post, but in
short, if you're on Chrome (or Safari), you won't see the "can't paste" dialog:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-paste-bad.png"><figure><img src="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-paste-bad.png"><figcaption>"Can't paste" dialog in COOL 23.05</figcaption></figure></a></p>
<p>Also you won't see a "Can't paste special" dialog:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-pastespecial-bad.png"><figure><img src="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-pastespecial-bad.png"><figcaption>"Can't paste special" dialog in COOL 23.05</figcaption></figure></a></p>
<p>Wouldn't it be nice to improve the copy side in a similar way?</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The primary reason why we needed similar, annoying dialogs for copy in the past is that the
clipboard API was synchronous but the network API is async. This means that writing to the clipboard
("copy") is only possible with data that we have in the browser when the copy is executed. This is a
problem, since in general we don't have data for your selection in the browser.</p>
<p>With the Clipboard API, the copy side can be improved as well. Instead of always fetching the HTML
for a simple selection (even if you don't copy) and having a three step copy for complex selections,
async clipboard write is now possible. This gets us rid of the "You need to download" dialog:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-copy-bad1.png"><figure><img src="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-copy-bad1.png"><figcaption>"You need to download" dialog in COOL 23.05</figcaption></figure></a></p>
<p>Also it eliminates the "Download completed dialog:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-copy-bad2.png"><figure><img src="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-copy-bad2.png"><figcaption>"Download completed" dialog in COOL 23.05</figcaption></figure></a></p>
<p>Instead, we still need to nominally write to the clipboard in the special keyboard or click context
initiating the copy (Chrome doesn't require this, Safari does), but the written object can be a
callback that will do the network operation for us.</p>
<p>Unfortunately it's hard to screenshot the new code, since part of the result is that all these
dialogs are now eliminated, copy &amp; paste just works. :-)</p>
<p>Note that this can be used also in Firefox, but first you need to set
<code>dom.events.asyncClipboard.clipboardItem</code> to <code>true</code> in <code>about:config</code>.</p>
<p>The last part was to adapt tests to this new world, because previously it was handy to just create a
selection and assert what would be copied to the clipboard as HTML, but now we don't download the
HTML anymore every time you create a selection.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://github.com/CollaboraOnline/online/commit/25342ed3172d3689309ed0833bdd2d3248818c56">Related: cool#8648 clipboard: extract parseClipboard() from Control.DownloadProgress.js</a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/ea8202268ce4aa772a6e89cb58508d862b5e82d7">Related: cool#8648 clipboard: use JSON when requesting HTML only</a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/75251f9496f44f8678e43c1525719e5e4cc3b6ee">cool#8648 clipboard: try to use navigator.clipboard.write()</a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/286cd1ccf7f354e212bef4f02f4b51c50e37800c">cool#8648 clipboard: fix <code>desktop/writer/copy_paste_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/803df018daf8575674ad4483d181f9c65fddd842">cool#8648 clipboard: fix <code>desktop/calc/clipboard_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/635a45aac07c58a14d4dce38145fd28eea3ae04d">cool#8648 clipboard: fix <code>desktop/writer/undo_redo_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/b3f2c690d8c610bffd2584b8d02b095bb144ed16">cool#8648 clipboard: fix <code>desktop/writer/track_changes_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/91c702e42012b59f7747a0cfb1a1394cbcc180ff">cool#8648 clipboard: fix <code>most of desktop/writer/top_toolbar_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/1f0aec8f19ddb6053f48625fabdf19d8e59049bb">cool#8648 clipboard: fix insert hyperlink dialog</a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/56adf9983e60ad6259b28e2a24fa2c1b67209c56">cool#8648 clipboard: fix <code>desktop/writer/table_operation_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/1e4afce8a193de2d307737f029f5a9096582ec7b">cool#8648 clipboard: fix <code>desktop/writer/searchbar_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/406dad2128a2a5daa8f24e4728560bbdccbcd1e7">cool#8648 clipboard: fix <code>desktop/writer/notebookbar_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/359e7eca6772dd0daf6b7dcfb5bc6e9b628510fc">cool#8648 clipboard: fix <code>desktop/writer/editable_area_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/770feebf1318d8f4ab4bd68d13957cfaf6aee74d">cool#8648 clipboard: fix <code>desktop/impress/undo_redo_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/c10cc6d8b8b6fb60a3a1248d0f8d73ce37af5a17">cool#8648 clipboard: fix <code>desktop/impress/delete_objects_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/7f9c80988153b88c3ffb4a490c1f9d2d3da2ed39">cool#8648 clipboard: fix <code>desktop/calc/undo_redo_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/e396df494cab6f88dfa0d51b91d44a35db8dd7f1">cool#8648 clipboard: fix <code>desktop/calc/top_toolbar_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/5bf298243f5c1b6621cbb237d40358d5c411ec67">cool#8648 clipboard: fix <code>desktop/calc/searchbar_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/a8d4a3e8592d3fcdd8a9007b49613a3fa5f58bf3">cool#8648 clipboard: fix <code>desktop/calc/searchbar_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/67d38b64a4af4fc949ea19388a996f3818a4b03d">cool#8648 clipboard: fix <code>desktop/calc/focus_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/25b377efb44bcde58df160edabc486eecfc73144">cool#8648 clipboard: fix <code>desktop/calc/delete_objects_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/3c9272c1bf3b2f6cf14edb8a590d8f3fb7ab7d02">cool#8648 clipboard: fix <code>desktop/calc/autofilter_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/fdb1f8c7fc101a75a7a90ad6b06cfb3a417ffab4">cool#8648 clipboard: fix <code>desktop/calc/cell_appearance_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/4c5adb70e6946d8d9e01bf8d7b45744b02f1310b">cool#8648 clipboard: fix <code>mobile/calc/apply_font_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/0c21b6e833de9aa257313ad3b514564c6209139f">cool#8648 clipboard: fix <code>mobile/calc/autofilter_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/a5d05f23647df8987f053dd7e7b7d42e9bc15a0c">cool#8648 clipboard: fix <code>mobile/calc/bottom_toolbar_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/2b37f2113f71d13d8c3bbd29f248713cb88e865d">cool#8648 clipboard: fix <code>mobile/calc/cell_appearance_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/a12bcd3fb0b990566a8f2be0a4de2c2bff5236a1">cool#8648 clipboard: fix <code>mobile/calc/delete_objects_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/3a1dd02dd15a184d4a54b28a84bf9079b6934029">cool#8648 clipboard: fix <code>mobile/calc/insertion_wizard_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/9ea5add21752c234145e6d78c4ceb56c06e1b4e5">cool#8648 clipboard: fix <code>mobile/calc/searchbar_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/283b5a1637121d00f5d41d2067f2221fde1d14ff">cool#8648 clipboard: fix <code>mobile/calc/spellchecking_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/027a87157bd723d79ef2329d1cd7e41ade2e01e9">cool#8648 clipboard: fix <code>mobile/impress/delete_objects_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/ad737657c6c3fe37e703587b869aba100a9228e6">cool#8648 clipboard: fix <code>mobile/impress/impress_focus_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/1dc4bae0c96462c18a14ce634675b6f898926c8b">cool#8648 clipboard: fix <code>mobile/impress/insertion_wizard_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/04a6af39cfb6949eab23c041656c05f7dfc026ef">cool#8648 clipboard: fix <code>mobile/impress/spellchecking_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/a2db31f4378f5561b19afb53150e9ef0871f2e74">cool#8648 clipboard: fix <code>mobile/writer/apply_font_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/9cca40deda7df20d72d6f96e5b91fa71ced89312">cool#8648 clipboard: fix <code>mobile/writer/delete_objects_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/ad22a9f017b15658d90a50c011e5bcf8c2c64b87">cool#8648 clipboard: fix <code>mobile/writer/insert_formatting_mark_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/a91036247b79403a6d8af9fec559de4cbc76045b">cool#8648 clipboard: fix <code>mobile/impress/insertion_wizard_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/82dc3e1a46908c1306360cd335243d4345e842b0">cool#8648 clipboard: fix <code>mobile/writer/track_changes_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/9b95bf829fefba288ff296c57e4323356e673ded">cool#8648 clipboard: fix <code>mobile/writer/table_properties_spec.js</code></a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/28e51d58f446bb081a9630672f0b410b1e385886">cool#8648 clipboard: stop fetching the clipboard on text selection create in tests</a></li>
<li><a href="https://github.com/CollaboraOnline/online/commit/24109be2e3889a45cfa90f0fa0cfce827a17f53b">cool#8648 clipboard: fix idle tests</a></li>
</ul>
<p>The tracking issue was <a href="https://github.com/CollaboraOnline/online/issues/8648">cool#8648</a>.</p>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraoffice.com/code/">try
the development edition</a>.</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sc-clipboard-paste.html">Improve copy&paste in Calc and elsewhere</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 04 April 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Calc now supports much better copy&amp;paste when you transfer data between Google Sheets and Calc.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but the feature is
fully available in desktop Calc as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>First, Collabora Online was using the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/execCommand">deprecated</a>
<code>document.execCommand()</code> API to paste text, which is problematic, as the "paste" button on the
toolbar can't behave the same way as pressing Ctrl-V on the keyboard.</p>
<p>Second, it turns out Google Sheets came up with some additional HTML attributes to represent
spreadsheet data in HTML in a much better way, and Calc HTML import/export had no support for this,
while this is all fixable.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>In short, Collabora Online now uses the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Clipboard/read">Clipboard
API</a> to read from the system
clipboard -- this has to be supported by the
<a href="https://sdk.collaboraonline.com/docs/advanced_integration.html#allow-the-clipboard-permission-query">integration</a>,
and Calc's HTML filter now support the subset of the Google Sheets markup I figured out so far. This
subset is also
<a href="https://sdk.collaboraonline.com/docs/advanced_integration.html#spreadsheet-html-extensions">documented</a>.</p>
<p>Note that the default behavior is that the new Clipboard API is available in Chrome/Safari, but not
in Firefox.</p>
<p>For the longer version, here are some screenshots:</p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-15-cool-clipboard-popup.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-15-cool-clipboard-popup.png"><figcaption>We used to show a popup when you clicked on the paste button on the notebookbar</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-18-cool-clipboard-image-paste.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-18-cool-clipboard-image-paste.png"><figcaption>The new paste code in action, handling an image</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-31-sc-html-import-text-bad.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-31-sc-html-import-text-bad.png"><figcaption>Import from Google Sheets to Calc: text is auto-converted to a number, bad</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-01-sc-html-import-text-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-01-sc-html-import-text-good.png"><figcaption>Import from Google Sheets to Calc: text is no longer auto-converted to a number, good</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-02-sc-html-import-celledit-fix.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-02-sc-html-import-celledit-fix.png"><figcaption>HTML import into an active cell edit, only RTF was working there previously</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-07-sc-html-paste-text-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-07-sc-html-paste-text-good.png"><figcaption>Paste from Google Sheets to Calc: text is no longer auto-converted to a number, good</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-08-sc-html-paste-boolean-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-08-sc-html-paste-boolean-good.png"><figcaption>Paste from Google Sheets to Calc: booleans are now also preserved</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-09-sc-html-paste-numfmt-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-09-sc-html-paste-numfmt-good.png"><figcaption>Paste from Google Sheets to Calc: number formats are now also preserved</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-12-sc-html-paste-formula-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-12-sc-html-paste-formula-good.png"><figcaption>Paste from Google Sheets to Calc: formulas are now also preserved</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-13-sc-html-paste-singlecell-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-13-sc-html-paste-singlecell-good.png"><figcaption>Paste from Google Sheets to Calc: also handling a single cell</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-14-sc-html-copy-text-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-14-sc-html-copy-text-good.png"><figcaption>Copy from Calc to Google Sheets: text is now handled, no longer auto-converted to a number</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-15-sc-html-copy-bool-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-15-sc-html-copy-bool-good.png"><figcaption>Copy from Calc to Google Sheets: booleans are now handled</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-20-cool-cross-origin-iframe-clipboard-bad.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-20-cool-cross-origin-iframe-clipboard-bad.png"><figcaption>Cross-origin iframes also block clipboard access, now fixed</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-01-sc-html-copy-formatted-number-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-01-sc-html-copy-formatted-number-good.png"><figcaption>Copy from Calc to Google Sheets: number formats are now also preserved</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-04-sc-html-copy-formula-good.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-04-sc-html-copy-formula-good.png"><figcaption>Copy from Calc to Google Sheets: formulas are now also preserved</figcaption></figure></a></p>
<p><a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-08-cool-plain-text-copy.png"><figure><img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-08-cool-plain-text-copy.png"><figcaption>Copy from COOL Writer to a text editor: much better result, new one on the right hand side</figcaption></figure></a></p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/e6e5660b726ecf3b0c39b277568568973b43c9f0">tdf#159483 sc HTML import: handle data-sheets-value attribute for the text case</a></li>
<li><a href="https://git.libreoffice.org/core/commit/543e52481e764b8e0eea6cf0123a77cf492bdf8e">tdf#159483 sc HTML paste: handle data-sheets-value here, too</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f8c95cf93ce9ab8b9b78f3af03411d0cc2e195ba">tdf#159483 sc HTML import: handle data-sheets-value attribute for the bool case</a></li>
<li><a href="https://git.libreoffice.org/core/commit/789964785a61daab5f8065f006dd7aaf843c7236">tdf#159483 sc HTML import: handle data-sheets-value attribute for the num case</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7812adb2ed11a3e08be24d3f2f94d14bfd740c55">tdf#159483 sc HTML paste: handle data-sheets-formula attribute</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c0da56cb3e9f9678cae7142dee03fb706a2aebd9">tdf#159483 sc HTML paste: handle data-sheets- attributes on a span</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4e2a4fbeb7c44cc47b3cf803cbcc6cba63b3d481">tdf#159483 sc HTML export: handle data-sheets-value attribute for the text case</a></li>
<li><a href="https://git.libreoffice.org/core/commit/411158832462b1077a8f5dc6379f2056f2338249">tdf#159483 sc HTML copy: handle data-sheets-value attribute for the bool case</a></li>
<li><a href="https://git.libreoffice.org/core/commit/17581e684ca701bfd96ed2bf16aa14c3903b74d4">tdf#159483 sc HTML copy: handle data-sheets-value attribute for the num case</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2efe362c99a9fa6e9a71b9b675b025c64b6c7f9d">tdf#159483 sc HTML copy: handle data-sheets-formula attribute</a></li>
</ul>
<p>The tracking issue on the Online side was <a href="https://github.com/CollaboraOnline/online/issues/8023">cool#8023</a>.</p>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 24.04 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-legal-numbering.html">Legal numbering in Writer: DOC and RTF support</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 01 March 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now supports legal numbering for two more formats: DOC and RTF (ODT and DOCX were working
already.)</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, done as a
<a href="https://vmiklos.hu/blog/sw-content-controls3.html">HackWeek</a> project, but the feature is fully available in
desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Legal numbering is a way to influence the number format of values inherited in a multi-level
numbering. Say, the outer numbering uses Roman numerals and the inner numbering uses X.Y as the number
format, but the inner level wants to display the outer values as Arabic numerals. If this is wanted
(and guessing from the name, sometimes lawyers do want this), then the inner number portion will
expand to values like "2.01" instead of "II.01", while the outer number portions will remain values
like "II".</p>
<p>Mike did <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=150408">80% of the work</a>, what you can
see here is just the RTF/DOC filters.</p>
<p>Picking a smaller feature task like this looked like a good idea, since I wanted to spend some of
the time on regression fixing around last year's multi-page floating table project.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>For (binary) DOC, the relevant detail is the <code>fLegal</code> bit in the <code>LVLF</code> structure. Here is the
result:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-legal-numbering/2024-02-29-writer-legal-numbering-doc.png"><figure><img src="https://share.vmiklos.hu/blog/sw-legal-numbering/2024-02-29-writer-legal-numbering-doc.png"><figcaption>Improved handling of legal numbering from DOC: old, new and reference rendering</figcaption></figure></a></p>
<p>It shows how the outer "II" gets turned into "2", while it remained "II" in the past. This works for
both loading and saving.</p>
<p>The same feature is now handled in the RTF filter as well. There the relevant detail is the
<code>\levellegal</code> control word, which has an odd 1 default value (the default is usually 0). Here is the
result:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-legal-numbering/2024-02-29-writer-legal-numbering-rtf.png"><figure><img src="https://share.vmiklos.hu/blog/sw-legal-numbering/2024-02-29-writer-legal-numbering-rtf.png"><figcaption>Improved handling of legal numbering from RTF: old, new and reference rendering</figcaption></figure></a></p>
<p>It shows that the RTF filter is up to speed with the DOC one by now.</p>
<p>As for the multi-page floating tables, I looked at
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=158986">tdf#158986</a> and
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=158801">tdf#158801</a>.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/397d72e582c725d162c7e0b819dc6c0bb62e42b0">Related: tdf#158986 sw floattable: fix unexpected page break with sections</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b7c4c4d45f44a26283678f3dc32982b3a728c614">tdf#158986 sw floattable: fix RTF import of table followed by \sect</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a73b3994fb6a2cc10b2d65cbaad201762610cecc">Related: tdf#150408 DOC filter: handle legal numbering</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e8487bedb20a429565b4a0e4bd2d6806cc603b7f">Related: tdf#150408 RTF filter: handle legal numbering</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c98ff922831f56253af2a050b8e07cfc89b7a387">Related: tdf#158986 sw floattable, RTF import: use more setNeedPar()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/186de7178c6065e1de13fd216b46ac9b716e44c5">tdf#158801 sw floattable: fix crash with headers and interactive editing</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 24.04 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/multi-view-programming-challenges.html">Fixing multi-view programming challenges in Calc and elsewhere</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 06 February 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>This post describes some challenges around having multiple views of one opened document in
LibreOffice core, when those views belong to LOK views, representing different users, with their
own language, locale and other view settings.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful for
all clients of the LOK API.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>LOK views are meant to represent separate users, so we need to make sure that when a user sets their
preferences and trigger an action, then the response to that action goes to the correct view, with
the correct view settings.</p>
<p>This is different from the desktop LibreOffice use-case, where multiple windows are still meant to
share the same user name, language, undo stack and so on.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>In this post, I would like to present 4 small improvements that recently happened to the LOK API to
provide this wanted separation of views.</p>
<p>The first was an <a href="https://github.com/CollaboraOnline/online/issues/7853">issue</a> where two users were
editing the same document, one busily typing and the other clicked on a link in Calc. What could
happen sometimes is the link popup appeared for the user who typed, not for the user who clicked on
the link:</p>
<p><a href="https://share.vmiklos.hu/blog/multi-view-programming-challenges/2023-12-18-cool-calc-hyprelink-bad-view.png"><figure><img src="https://share.vmiklos.hu/blog/multi-view-programming-challenges/2023-12-18-cool-calc-hyprelink-bad-view.png"><figcaption>Link popup is actually on the left, should be on the right, now fixed</figcaption></figure></a></p>
<p>This specific problem can be fixed by making sure that link click callbacks are invoked
synchronously (while the clicking view is still active) and not later, when the current view may or
may not be the correct one.</p>
<p>It turns out the same problem (async command dispatch) affects not only hyperlinks, but many other
cases as well, where we want to stay async, for example, when one dialog would invoke another
dialog, like the Calc conditional format -&gt; add dialog:</p>
<p><a href="https://share.vmiklos.hu/blog/multi-view-programming-challenges/2024-01-02-cool-calc-condformat-wrong-view.png"><figure><img src="https://share.vmiklos.hu/blog/multi-view-programming-challenges/2024-01-02-cool-calc-condformat-wrong-view.png"><figcaption>Calc conditional format add dialog appearing on the left, should be on the right, now fixed</figcaption></figure></a></p>
<p>There you don't want to change async commands into sync commands, because that may mean spinning the
main loop inside a dialog, resulting in nested main loops. This can be fixed by making sure that
async commands to be dispatched (sfx2 hints in general) are processed in a way that the current view
at dispatch &amp; processing is the same, which is now the case.</p>
<p>The third problem was around wrong language &amp; locale in the status bar:</p>
<p><a href="https://share.vmiklos.hu/blog/multi-view-programming-challenges/2024-01-04-cool-calc-statusbar-wrong-lang.png"><figure><img src="https://share.vmiklos.hu/blog/multi-view-programming-challenges/2024-01-04-cool-calc-statusbar-wrong-lang.png"><figcaption>Unexpected English strings in localized statubar UI, now fixed</figcaption></figure></a></p>
<p>This is not simply a problem of missing translation, the trouble was that the status bar update is
also async and by the time the update happened, the locale of the view on the left was used, for a
string that appears on the right.</p>
<p>The way to fix this is to perform the update of toolbars/statusbar/etc (in general: SfxBindings) in
a way that the language at job schedule time and at UI string creation time is the same.</p>
<p>The last problem was quite similar, still about bad language on the UI, but this time on the
sidebar:</p>
<p><a href="https://share.vmiklos.hu/blog/multi-view-programming-challenges/2024-01-09-cool-calc-sidebar-wrong-lang.png"><figure><img src="https://share.vmiklos.hu/blog/multi-view-programming-challenges/2024-01-09-cool-calc-sidebar-wrong-lang.png"><figcaption>Unexpected English strings in localized sidebar UI, now fixed</figcaption></figure></a></p>
<p>This is similar to the statusbar case, but the sidebar has its own executor for its async jobs, so
that needed a fix similar to what the statusbar already had, now done.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/e83309d97d0bbad131a7fdfd365fb6122d6f415b">cool#7853 sc lok: fix bad view id on hyperlink click</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ee7ca8e4ea8ed93655f99e77a9e77032ac830c46">cool#7865 sfx2 lok: fix bad view id on async command dispatch</a></li>
<li><a href="https://git.libreoffice.org/core/commit/51d8a2ef54751403fa707816e27ddb4e7faa8231">cool#7492 sfx2 lok: fix bad view id / statusbar string on async binding update</a></li>
<li><a href="https://git.libreoffice.org/core/commit/fb7b0b944741e4efae8d92a6e305036aff906c7a">cool#7492 sfx2 lok: just set language/locale on async binding update</a></li>
<li><a href="https://git.libreoffice.org/core/commit/aaf6ce108e91b1504befe19afcee471e3316ae7a">cool#7492 sfx2 lok: set language/locale on async sidebar update</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get the latest Collabora Online Development Edition 23.05 and try it out yourself right now:
<a href="https://www.collaboraoffice.com/code/quick-tryout-nextcloud-docker/">try the development edition</a>.
Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF's next release too (24.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable11.html">Multi-page floating tables in Writer: tables wrapping tables</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 03 January 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>This post is part of a series to describe how Writer now gets a feature to handle tables that are
both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable10.html">10th post</a> for the previous part.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Previous posts described the hardest part of multi-page floating tables: making sure that text can
wrap around them and they can split across pages. In this part, we'll look at a case where that
content is not just text, but the wrapping content itself is also a table.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Regarding testing of the floating table feature in general, the core.git repository has 92 files now
which are focusing on correct handling of floating tables (filenames matching
<code>floattable-|floating-table-</code>). This doesn't count cases where the document model is built using C++
code in the memory and then we assert the result of some operation.</p>
<p>Here are some screenshots from the improvements this month:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable11/2023-12-01-floattable-click-correct.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable11/2023-12-01-floattable-click-correct.png"><figcaption>Improved click handling near the first page of a floating table</figcaption></figure></a></p>
<p>The first screenshot shows a situation where the mouse cursor is near the right edge of the first
page of a floating table. What used to happen is we found this position close to the invisible
anchor of the floating table on that page, then corrected this position to be at the real anchor on
the last page. In short, the user clicked on one page and we jumped to the last page. This is now
fixed, we notice that part of the floating table is close to the click position and we correct the
cursor to be at the closest position inside the table's content.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable11/2023-12-05-floattable-tablewrap.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable11/2023-12-05-floattable-tablewrap.png"><figcaption>A floating table, wrapped by an inline table: old, new and reference rendering</figcaption></figure></a></p>
<p>The next screenshot shows a floating table where the content wrapping around the table happens to be
an inline table. You can see how such wrapping didn't happen in the past, and the new rendering is
close to the reference now.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/f461853b11439c4e485a79174d34735395e5bf52">sw floattable: fix finding the nearest text in split flys on mouse click</a></li>
<li><a href="https://git.libreoffice.org/core/commit/868140fcc1311259b9d5f666637b33d226511a53">tdf#60558 sw floattable: allow wrap of table on the right of a floattable</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0746d13365139c356eb9d297a358c486bf47d6fb">sw floattable: fix split of anchor text in 2nd half of the paragraph</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d852e27ed205c1a60de0979b80f3861bf93c44ae">sw floattable: fix split of anchor text at para start</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5fec60b4732bdbdb681be08e43a9be47c3bfb320">sw floattable: fix outdated text frame portions after split</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4e8895d3d86db3776c56070c395cd727fd4b9101">sw floattable: disable UI to enable this when anchored inside TextBox</a></li>
<li><a href="https://git.libreoffice.org/core/commit/164fb25f7b2db7d833d6d0f28e49c5cac68426b3">tdf#158686 sw floattable: fix print preview crash</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable10.html">Multi-page floating tables in Writer: UI improvements</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 04 December 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>This post is part of a series to describe how Writer now gets a feature to handle tables that are
both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable9.html">9th post</a> for the previous part.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Previous posts described the hardest part of multi-page floating tables: reading them from
documents, so we layout and render them. In this part, you can read about UI improvements when it
comes to creating, updating and deleting them in Writer.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Regarding testing of the floating table feature in general, the core.git repository has 89 files now which are focusing on correct
handling of floating tables (filenames matching <code>floattable-|floating-table-</code>). This doesn't count
cases where the document model is built using C++ code in the memory and then we assert the result
of some operation.</p>
<p>Here are some screenshots from the improvements this month:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable10/2023-11-13-floattable-lok-insert-ui.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable10/2023-11-13-floattable-lok-insert-ui.png"><figcaption>Improved insertion of floating tables</figcaption></figure></a></p>
<p>The first screenshot shows that the underlying LibreOffice Insert Frame dialog is now async
(compatible with collaborative editing) and is now exposed in the Collabora Online notebookbar.</p>
<p>There were other improvements as well, so in case you select a whole table and insert a new frame,
the result is close to what the DOCX import creates to floating tables. This includes a default
frame width that matches the table width, and also disabling frame borders, since the table can
already have one.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable10/2023-11-21-floattable-lok-edit-delete-ui.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable10/2023-11-21-floattable-lok-edit-delete-ui.png"><figcaption>Unfloating a floating table</figcaption></figure></a></p>
<p>The next screenshot shows an inserted floating table, where the context menu allows updating the
properties of an already inserted floating table, and also allows to delete ("unfloat") it.</p>
<p>Several of these changes are shared improvements between LibreOffice and Collabora Online, so
everyone benefits. For example, inserting a frame when a whole table was selected also cleared the
undo stack, which is now fixed. Or unfloating table was only possible if some part of the table was
clipped, but now this is always possible to do.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/35925357f86e01612df28a092d71b6e216195636">sw floattable: make Insert Frame dialog async and mark it as a jsdialog</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0bf60e32c0ac2bf79fad6c29c39c6f6a3f9ce8e8">tdf#99822 sw floattable: testcase for objects from different cells</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4f1121255ebac035a439d242b47c2f81124418c3">sw floattable, insert UI: fix default frame width when inserting a new one</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0ecb69d53864b582eb59533729ada01d85d383e6">sw floattable, insert UI: inherit fly width from selected table width</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e306352b9ddd8bddfc37f0cfaac078d9260650d6">sw floattable, insert UI: allow direct creation of floating tables</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8d973c5b9405bfa6964d3dfebd0017fd60ec3eca">sw floattable, insert UI: default to at-char for non-split flys</a></li>
<li><a href="https://git.libreoffice.org/core/commit/6c761fa3b40d296444681d8d2f991e5a6b7e5b71">sw floattable, insert UI: fix missing undo/redo</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c1a535ee2db757b2e40683dc918cbad8b7429cfa">sw floattable, insert UI: fix unexpected border and spacing</a></li>
<li><a href="https://git.libreoffice.org/core/commit/bda066a77f4167bf83c0167afb6998c2890e60e0">sw floattable: link ODF proposal</a></li>
<li><a href="https://git.libreoffice.org/core/commit/47d824dd167eb34b08e5aec7141d2d9e6e996b34">tdf#157911 sw floattable: fix inconsistent inferred bottom border on split</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2f42d8acd2d06f848c9e680c42a0f7834a9a641f">sw floattable, delete UI: fix unfloat button for cant-split frames</a></li>
<li><a href="https://git.libreoffice.org/core/commit/871ca5dd73b34086fad1e57d4697f43a6739a11d">sw floattable, delete UI: add an uno command to unfloat frame from context menu</a></li>
<li><a href="https://git.libreoffice.org/core/commit/45a4ed02281a7a8ca52fccf626c792e417c8ef1c">sw floattable, delete UI: fix undo/redo</a></li>
<li><a href="https://git.libreoffice.org/core/commit/223d2fac61e061478721a7a4a89b1362f5037d8f">sw floattable: fix crash by trying harder to split tables</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b1b0cc1b0bb473155b5b089199ca99bb1dc40e42">sw floattable: add per-frame wrap-on-all-pages mode</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a596070f8ac11ed0cd22baf55704037a6b8d9c4d">sw floattable, per-frame wrap-on-all-pages mode: add UNO API</a></li>
<li><a href="https://git.libreoffice.org/core/commit/272c3548c4d2362eb737947c8cbb017e2d55aae1">sw floattable, per-frame wrap-on-all-pages mode: add layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7f58b57b47e6642cb9a7aeac48915b30148042d2">sw floattable, per-frame wrap-on-all-pages mode: add ODT filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ce2fc5eb29b4e252993b549dee002fa8948c8386">tdf#158341 sw floattable: fix layout loop when fly is below the body frame</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable9.html">Multi-page floating tables in Writer: wrap on all pages</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 07 November 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>This post is part of a series to describe how Writer now gets a feature to handle tables that are
both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable8.html">8th post</a> for the previous part.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Multi-page floating tables always wrapped their anchor text only on the last page, to be compatible
with Word's default behavior. There is a special flag in DOCX files to wrap on all pages, though. In
this part, you can read about handling of this flag in Writer.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Regarding testing of the floating table feature in general, the core.git repository has 84 files now which are focusing on correct
handling of floating tables (filenames matching <code>floattable-|floating-table-</code>). This doesn't count
cases where the document model is built using C++ code in the memory and then we assert the result
of some operation.</p>
<p>Here are some screenshots from the fixes this month:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable9/2023-10-03-floattable-nested3.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable9/2023-10-03-floattable-nested3.png"><figcaption>Old, new and reference rendering of a 3 nested, multi-page floating tables</figcaption></figure></a></p>
<p>The first screenshot shows a case where multi-page floating tables are nested. For this document, we
not only have an inner and an out table, but we also have a middle one, giving us 3 nesting tables.
Some of the inner table frames had a bad position, leading to overlapping text, now fixed.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable9/2023-10-16-floattable-wraponallpages.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable9/2023-10-16-floattable-wraponallpages.png"><figcaption>Old, new and reference rendering of wrapping on all pages</figcaption></figure></a></p>
<p>The next screenshot shows the case where the magic <code>allowTextAfterFloatingTableBreak</code> flag is set.
We used to wrap content of the anchor only on the last page, unconditionally. Now we either wrap on
the last page (default) or on all pages (when this flag is present).</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable9/2023-10-24-floattable-overlap.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable9/2023-10-24-floattable-overlap.png"><figcaption>Old, new and reference rendering of overlapping floating tables.</figcaption></figure></a></p>
<p>The last screenshot shows a document full of floating tables. These used to be inline ones, and then
they could not overlap by definition, but now extra effort was needed to position them in a way that
no overlap happens between the tables. Now our render result matches Word.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/695390b08799af34b393c81c834d615bea330d89">tdf#126449 sw floattable: fix too small height of non-last anchors</a></li>
<li><a href="https://git.libreoffice.org/core/commit/89a75cd194371002247d0138e759835bc673f7b0">tdf#126449 sw floattable: DOC import: handle inner floating table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2d6f48d53674ee85179ec8cee8648830207200a2">sw floattable, crashtesting: fix PDF export of fdo56210-3.docx</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d530651e4e70febb1046727e85a8edcda610d722">crashtesting: fix PDF export of fdo45193-1.docx</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4a5fb05d5e2448453477ce14862a8cf9846ecb49">tdf#157571 sw floattable: fix incorrect blank space after table-in-shape</a></li>
<li><a href="https://git.libreoffice.org/core/commit/6b9378154f9b504b9e924fe4565df444786e7d73">sw floattable, crashtesting: fix PDF export of ooo91654-1.doc</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5b9249e950165015ba57cc2c0503381df9751bf6">sw floattable: add an AllowTextAfterFloatingTableBreak compat flag</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7d7ca347fafa7a06094b00e8fb0d0452c4c81366">sw floattable, wrap on all pages: add layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/33ade4171a1a443fd24e6463a9eaa279f7d778bb">sw floattable, wrap on all pages: add DOCX filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/626fe9ab5ebebc4ef36e35f4aa597c03a3564d22">tdf#157573 sw floattable: fix incorrect lack of left margin after table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/65f508b44ecbc20c8bd5172d1656639f686730ff">tdf#157573 sw floattable: add missing testcase</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8e03dfd6a4bff4eabf779ace9b758b49cf80f8ba">tdf#157590 sw floattable: avoid hang in the nested + row span case</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5e7f7917fd589f661982d481a45bf84337e4c03c">sw floattable: remove now unused FloattableNomargins compat flag</a></li>
<li><a href="https://git.libreoffice.org/core/commit/612629f4a81acd7b851b7eccc97aba9a5915d13c">tdf#155040 sw floattable, RTF: fix table is overlapped by subsequent inline one</a></li>
<li><a href="https://git.libreoffice.org/core/commit/9704f61982360ce35983a61cca3fd00bbdf51ab6">tdf#155682 sw floattable: fix DOCX with big pictures causes endless loop</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d6527f127622f23ac529ce667fac5ff69ea33ea4">Related: tdf#157590 sw floattable: avoid a bit of not needed work</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8ad82fc115a337604c064d37adfffcc81440248e">sw floattable: fix nullptr deref in TableManager::endLevel()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/435f1aadf7dd8087a8997924bedfccff0f496ba2">tdf#99822 sw floattable: allow nomimal overlap of objects from different cells</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable8.html">Multi-page floating tables in Writer: nested tables</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 03 October 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 4 minutes</p>
  </div>
  <div class="article_text">
    <p>This post is part of a series to describe how Writer now gets a feature to handle tables that are
both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable7.html">seventh post</a> for the previous part.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Multi-page floating tables and nested tables could not be combined so far. Instead we tried to lay
out the outer table on multiple pages and all inner tables were still limited to a single page. In
this part, you can read about removing this limitation.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Regarding testing, the core.git repository has 73 files now which are focusing on correct
handling of floating tables (filenames matching <code>floattable-|floating-table-</code>). This doesn't count
cases where the document model is built using C++ code in the memory and then we assert the result
of some operation.</p>
<p>Here are some screenshots from the fixes this month:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable8/2023-09-08-floattable-nested.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable8/2023-09-08-floattable-nested.png"><figcaption>Old, new and reference rendering of a floating inner table in a floating outer table from DOCX.</figcaption></figure></a></p>
<p>The first screenshot shows a case where not only a single floating table is split across pages, but
also the table's only cell hosts an inner multi-page floating table. This is more complicated at a
layout level, because we can't just move part of the table to a next page, which has no parts of the
outer table yet.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable8/2023-09-15-floattable-nested-cellstart.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable8/2023-09-15-floattable-nested-cellstart.png"><figcaption>Old, new and reference rendering of nested, multi-page floating table at cell start.</figcaption></figure></a></p>
<p>The next screenshot shows a case where the inner floating table starts at the cell start of the
outer table. The DOCX import case needed addition effort to get working, because as soon as the
inner floating table's content is moved to the floating frame from the body text, the reference to
the cell start at the outer table level was invalidated and the whole table conversion failed.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable8/2023-09-18-floattable-nested-cellstarts.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable8/2023-09-18-floattable-nested-cellstarts.png"><figcaption>Old, new and reference rendering of multiple inner floating tables starting at cell start of an outer floating table.</figcaption></figure></a></p>
<p>This screenshot shows a bug where multiple inner floating tables started at the cell start of the
outer table. Handling this correctly on our end had to ensure that each (potentially multi-page)
floating table gets its own unique anchor point, and this can be combined with nesting, with the "at
cell start" special case on top of it. Once all three can be combined, a real-world documents
gets its table instead of just having the content the of the table in the body text.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable8/2023-09-21-floattable-move-master.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable8/2023-09-21-floattable-move-master.png"><figcaption>Old, new and reference rendering of moving the table start to a new page.</figcaption></figure></a></p>
<p>The last screenshot shows an editing session where we keep inserting new paragraphs at the start of
the document, so new items are created at the end of the fly chain as needed, and old items are
deleted at the start of the fly chain as needed. We had a bug here so that the content we wanted to
move forward was inserted at the end of the document, leading to a weird selection that started at the
document end and continued on a previous page. Now this works correctly: once the first page is full
of empty paragraphs, the second page hosts the first row and half of the second row. The third page then
can host the second half of the second row and the third row.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/7d4213b9f0253b323750acceca8f4edb9d1a7fc5">Related: tdf#156318 sw floattable: fix handling of vert orient == top</a></li>
<li><a href="https://git.libreoffice.org/core/commit/401c175d1bbe3c64e5dd96e3b23779999271cfb1">tdf#156318 sw floattable: fix follow text flow handling on interactive edit</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d29c1a90ae77dde7c87c51f21e859fa254f23e01">sw floattable, nesting: fix layout crash</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3aa3f0a1638a8d8006955b62bb647526768be3d8">sw floattable, nesting: fix position of the inner follow table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/facdac2443d50339f81415d09c1869d19dded7bf">sw floattable, nesting: fix PDF export</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e20bacc209a8e8483209cb4ec51c9e0b55423cdb">sw floattable, nesting: fix overlap support</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2887e6b8edbb4fdb093515a3a68269ed40e42116">sw floattable, nesting: fix DOCX export</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5127b1961b762643d47a26704556fd9b8664c6fc">sw floattable, nesting: add DOCX import</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d50e5d6d53c94124f825758a74e186b934fc2a4e">Related: tdf#55160 sw floattable, nested DOCX exp: fix inner tbl at cell start</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2d43c34333076fad092f0cdc0f60f81580acdbee">Related: tdf#55160 sw floattable, nested DOCX imp: fix inner tbl at cell start</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a33316afa4a20499159b8c900e56658512deb74a">tdf#55160 sw floattable, nested DOCX imp: fix inner tables at cell start</a></li>
<li><a href="https://git.libreoffice.org/core/commit/cf2be3754b4c48382a61e044209c077bf59c72f2">tdf#157005 sw floattable: fix missing format of next row in follow fly</a></li>
<li><a href="https://git.libreoffice.org/core/commit/cfe9c68a7a19dd77d1fcbde3a7dd75730634becc">tdf#157119 sw floattable: fix moving master of split fly to next page</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b8521d969ab5be4fc947e467d4afe969f9d3b563">tdf#157263 sw floattable: prefer join over split after moving fwd</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c86d6111525f09e895483c7c4919a4b9a5dbd9b9">Related: tdf#126449 sw floattable: fix bad join of inline tbl with inner fly</a></li>
<li><a href="https://git.libreoffice.org/core/commit/25b8fdd3b939a221ba00ca37fbf89adaf893aab7">sw floattable: maintain the invariant that fly height is at least MINFLY</a></li>
<li><a href="https://git.libreoffice.org/core/commit/83abd141bf41c1c8a1d4e5a894b235c842da2a07">Related: tdf#126449 sw floattable: fix bad position of in-table follow fly</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable7.html">Multi-page floating tables in Writer: overlap control, border and footnotes</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 01 September 2023</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 4 minutes</p>
  </div>
  <div class="article_text">
    <p>This post is part of a series to describe how Writer now gets a feature to handle tables that are
both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable6.html">sixth post</a> for the previous part.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>The current post features sub-tasks for the multi-page floating table work that is around an
explicit table overlap control that Word has (and Writer lacked so far), compatible border rendering
of split tables and having footnotes in floating tables, which was not working previously.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Regarding testing, the core.git repository has 60 files now which are focusing on correct
handling of floating tables (filename matching <code>floattable-|floating-table-</code>). This doesn't count
cases where the document model is built using C++ code in the memory and then we assert the result
of some operation.</p>
<p>Here are some screenshots from the fixes this month:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-02-floattable-edit-dummy-text.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-02-floattable-edit-dummy-text.png"><figcaption>Old, new and reference rendering after expanding an autotext.</figcaption></figure></a></p>
<p>The first screenshot shows a case where the anchor paragraph of a floating table had some autotext
(e.g. "dt", which stands for dummy text), and pressing the relevant shortcut (F3) expands that
autotext with the actual content. This includes changing the anchor position of the floating table,
which lead to overlapping text. (A multi-page floating table has multiple anchors, we have to make
sure we don't set all of them to the new value as-is.)</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-10-floattable-overlap-never.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-10-floattable-overlap-never.png"><figcaption>Old, new and reference rendering of tables with the overlap=never markup.</figcaption></figure></a></p>
<p>The next screenshot shows a case where two tables are positioned in a way that they would overlap.
Word has a flag that asks the layout to still re-position the second table so the overlap doesn't
happen, and now Writer supports this as well.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-16-floattable-duplicated.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-16-floattable-duplicated.png"><figcaption>Old, new and reference rendering of duplicated anchor text.</figcaption></figure></a></p>
<p>This screenshot shows a bug where the anchor text on the first page was also duplicated on the
second page. Now we properly start the anchor text on the last page of the floating table, like Word
does.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-21-floattable-split-border.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-21-floattable-split-border.png"><figcaption>Old, new and reference rendering of a multi-page floating table with borders.</figcaption></figure></a></p>
<p>What you can see is a floating table that has 2 pages, but simply a split of the table would result
in no bottom border on the first page and no top border for the second, like perhaps you would
expect it, matching Word. This is now fixed, the layout infers the border style in those cases
correctly.</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-24-floattable-footnote.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable7/2023-08-24-floattable-footnote.png"><figcaption>Old, new and reference rendering of a footnote in a floating table.</figcaption></figure></a></p>
<p>The last screenshot shows a mini-feature: it was possible to float tables and to have footnotes in
tables, but not both at the same time. The screenshot shows a case where a floating table is
needed, so a specific paragraph is <em>above</em> the table. But we couldn't float the table, because
it had a footnote and that would be lost as-is. Now you can have a correct position for that
paragraph and the footnote is there as well, at the same time.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/2b401b7c0322d9ff972d252208ebe9a77913778d">tdf#156350 sw floattable: fix bad additional draw:frame in ODT with layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/073072f0a3abacfe4f9cc920b8138d7abc84db70">tdf#156260 sw floattable: avoid overlapping flys on anchor change</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b6a22e2be79cd874c7526107a6793fae692620dc">tdf#156260 sw floattable: avoid moving text from the last anchor to its precede</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f151ba5ebc8662d5459eacb1c5d6f01a4c826f26">sw floattable: simplify collecting frames at node with layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/107de1a2c6882213cf0ef6783417302f43cdada0">tdf#156349 sw floattable: fix caption insert for tables inside split fly frames</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c545a0729e89ee2e8f14534b77422cc9eb4eb7cf">sw floattable, crashtesting: fix PDF export of tdf73201-1.docx</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0d571ff8079f858a5650bf6cbb38296d22cc58e1">tdf#156589 sw floattable: fix follow fly moving inside a table on the next page</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d3a0ff741f5a7ff0dcec301e5b34ee9d638acf98">sw floattable: import w:tblOverlap w:val="never" from DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/905962db870e9d1cf1dcf3bd1be44c347cddafe1">sw floattable: handle AllowOverlap==false in the layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5af44a176d2a738dd7523713202aeee27c5578b6">sw floattable: export w:tblOverlap w:val=never to DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d44af60677740b151305799a4325d0f0699fce66">sw floattable: handle AllowOverlap==false in the DOC filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/68c8466dd80e7a964e1377ee3e0308dc449fbf2d">sw floattable: handle AllowOverlap==false in the RTF filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1cf29168840f84c2e946e2678b99988e83503c96">tdf#156682 sw floattable: fix missing del of master anchor para por on split</a></li>
<li><a href="https://git.libreoffice.org/core/commit/53798fef2cc0b5b0b9706081a4af5ceca964a41b">Related: tdf#156351 sw floattable: fix missing top border in follow table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/08aea5526c75ff4c5385e960bd940f10ffa19cd5">tdf#156351 sw floattable: fix missing bottom border in master table</a></li>
<li><a href="https://git.libreoffice.org/core/commit/56da1d30afe48cc4acd79567052a575e81f8c7a0">tdf#77760 sw floattable: add support for footnotes, doc model</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f8e1a62f944e5358fe498008b4ff8701f1e190a0">tdf#77760 sw floattable: add support for footnotes, layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/178421a6c719dac9c16f220b76292fec16a53f60">tdf#77760 sw floattable: add support for footnotes, DOCX import</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2e1ddc8aeb0a92cc43ef4b7dc4762cd50a6b7fbc">sw floattable: don't split if anchored inside a footnote</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c7b59c9484ae6ff88cd8d7017aeb83b02e212c9c">tdf#77760 sw floattable: add support for footnotes, DOC import</a></li>
<li><a href="https://git.libreoffice.org/core/commit/739597df38dcaab0460482e3bc3f18f2471d43ab">tdf#77760 sw floattable: add support for footnotes, UI</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a snapshot / demo of Collabora Office 23.05 and try it out yourself right now: <a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try the
unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.2).</p>
  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/index2.html" class="button_accent">&larr; Older Posts</a>

</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>