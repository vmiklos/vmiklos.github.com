<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<meta name="description" content="What is Miklos hacking - Miklos' blog" />
<meta name="keywords" content="vmiklos, libereoffice, swig, git, python, hacking, bitlbee" />
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://vmiklos.hu/blog/index.rss" />
<link rel="stylesheet" href="/blog/xhtml11.css" type="text/css" />
<link rel="stylesheet" href="/blog/xhtml11-quirks.css" type="text/css" />
<link rel="stylesheet" href="/blog/layout.css" type="text/css" />
<title>What is Miklos hacking</title>
<!-- google analytics start -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24726997-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- google analytics end -->
</head>
<body>
<div id="layout-banner-box">
<div id="layout-banner">
  <div id="layout-title">vmiklos.hu</div>
  <div id="layout-description">shameless self-promoting website</div>
</div>
</div>
<div id="layout-menu-box">
<div id="layout-menu">
  <div>&#187;<a href="/">Root</a></div>
  <div>&#187;<a href="/blog/">Rejourn root</a></div>
  <div>&#187;<a href="http://planet.documentfoundation.org/">LibreOffice Community Blogs</a></div>
  <div>
    Search:<br/>
    <form action="http://www.google.com/cse" id="cse-search-box" target="_blank">
    <input type="hidden" name="cx" value="007336731492173318056:bik8fqvatno"/><input type="hidden" name="ie" value="UTF-8"/><input type="text" name="q" size="15"/><br/>
    <input type="submit" name="sa" value="&#187;"/></form>
  </div>
</div>

<div id="alltags-menu">
	Tags:
	<div>&#187;<a href="/blog/tags/hu.html">hu</a> (1201)</div>
	<div>&#187;<a href="/blog/tags/en.html">en</a> (515)</div>
	<div>&#187;<a href="/blog/tags/hacking.html">hacking</a> (416)</div>
	<div>&#187;<a href="/blog/tags/film.html">film</a> (286)</div>
	<div>&#187;<a href="/blog/tags/geek.html">geek</a> (82)</div>
	<div>&#187;<a href="/blog/tags/libreoffice.html">libreoffice</a> (66)</div>
	<div>&#187;<a href="/blog/tags/bringa.html">bringa</a> (60)</div>
	<div>&#187;<a href="/blog/tags/konyv.html">konyv</a> (44)</div>
	<div>&#187;<a href="/blog/tags/misc.html">misc</a> (37)</div>
	<div>&#187;<a href="/blog/tags/zene.html">zene</a> (32)</div>
	<div>&#187;<a href="/blog/tags/munka.html">munka</a> (28)</div>
	<div>&#187;<a href="/blog/tags/fun.html">fun</a> (27)</div>
	<div>&#187;<a href="/blog/tags/frugalware.html">frugalware</a> (23)</div>
	<div>&#187;<a href="/blog/tags/sieles.html">sieles</a> (7)</div>
	<div>&#187;<a href="/blog/tags/bitlbee.html">bitlbee</a> (5)</div>
	<div>&#187;<a href="/blog/tags/gsoc2009.html">gsoc2009</a> (4)</div>
	<div>&#187;<a href="/blog/tags/git.html">git</a> (3)</div>
	<div>&#187;<a href="/blog/tags/szinhaz.html">szinhaz</a> (3)</div>
	<div>&#187;<a href="/blog/tags/gsoc2008.html">gsoc2008</a> (3)</div>
	<div>&#187;<a href="/blog/tags/opensuse.html">opensuse</a> (3)</div>
	<div>&#187;<a href="/blog/tags/gsoc2011.html">gsoc2011</a> (2)</div>
	<div>&#187;<a href="/blog/tags/go-oo.html">go-oo</a> (2)</div>
	<div>&#187;<a href="/blog/tags/kde.html">kde</a> (1)</div>
	<div>&#187;<a href="/blog/tags/libwpd.html">libwpd</a> (1)</div>
	<div>&#187;<a href="/blog/tags/karacsony.html">karacsony</a> (1)</div>
	<div>&#187;<a href="/blog/tags/upc.html">upc</a> (1)</div>
	<div>&#187;<a href="/blog/tags/google.html">google</a> (1)</div>
	<div>&#187;<a href="/blog/tags/fail.html">fail</a> (1)</div>
	<div>&#187;<a href="/blog/tags/openstack.html">openstack</a> (1)</div>
	<div>&#187;<a href="/blog/tags/mdadm.html">mdadm</a> (1)</div>
	<div>&#187;<a href="/blog/tags/w3c.html">w3c</a> (1)</div>
	<div>&#187;<a href="/blog/tags/java.html">java</a> (1)</div>
	<div>&#187;<a href="/blog/tags/greasemonkey.html">greasemonkey</a> (1)</div>
	<div>&#187;<a href="/blog/tags/auto.html">auto</a> (1)</div>
	<div>&#187;<a href="/blog/tags/otrs.html">otrs</a> (1)</div>
	<div>&#187;<a href="/blog/tags/gsoc2010.html">gsoc2010</a> (1)</div>
	<div>&#187;<a href="/blog/tags/bme.html">bme</a> (1)</div>
	<div>&#187;<a href="/blog/tags/python.html">python</a> (1)</div>
	<div>&#187;<a href="/blog/tags/howto.html">howto</a> (1)</div>
	<div>&#187;<a href="/blog/tags/openoffice.html">openoffice</a> (1)</div>
	<div>&#187;<a href="/blog/tags/networking.html">networking</a> (1)</div>
	<div>&#187;<a href="/blog/tags/gpsbabel.html">gpsbabel</a> (1)</div>
	<div>&#187;<a href="/blog/tags/supybot.html">supybot</a> (1)</div>
	<div>&#187;<a href="/blog/tags/lcov.html">lcov</a> (1)</div>
	<div>&#187;<a href="/blog/tags/nyaralas.html">nyaralas</a> (1)</div>
</div>

</div>
<div id="layout-content-box">
<div id="layout-content">
<div id="header">
	<h1>What is Miklos hacking</h1>
</div>
<div id="preamble">
<div class="sectionbody">




<!-- Listing -->
<div class="ulist"><ul>
<li><p>Saturday, 24 January 2015<br /><a href="/blog/perfect-ww8-comment-import.html">Perfect WW8 comment import</a>
(<a href="/blog/perfect-ww8-comment-import.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>TL;DR: Import of annotated text ranges from binary DOC format was a problem
for quite some time, now it should be as good as it always was in the
ODT/DOCX/RTF filter.</p></div>
<div class="paragraph"><p>Longer version: the import of annotation marks from binary DOC was never
perfect. My
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=7907cc0ef9751d553014bd3bab49be9e7fc31bca">initial
implementation</a> had a somewhat hidden, but important shortcoming, in the form
of a "Don&#8217;t support ranges affecting multiple SwTxtNode for now." comment. The
underlying problem was that annotation marks have a start and end position,
and this is described as an offset into the piece table (so the unit was a
character position, CP) in the binary DOC format, while in Writer, we work
with document model positions (text node and content indexes, SwPosition), and it isn&#8217;t
trivial to map between these two.</p></div>
<div class="paragraph"><p><a href="http://zolnaitamas.blogspot.com/">Tam√°s</a> somewhat
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=f2945255df273404ee2457dcf761cb8f334b732b">improved</a>
this homegrown CP &#8594; SwPosition mapping code, but was still far from perfect. Here is an example. This is how <a href="http://people.freedesktop.org/~vmiklos/2015/perfect-ww8-comment-import.doc">this demo document</a> looks like now in LibreOffice Writer:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s0/">
<img src="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s800/" alt="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>And this is how it looked like before the end of last year:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s0/">
<img src="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s800/" alt="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>Notice how "Start" is commented and it wasn&#8217;t before. Which one is correct? Here is the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s0/">
<img src="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s800/" alt="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>The reason is that the document has fields and tables, and the homegrown CP &#8594;
SwPosition mapping did not handle this. A much better approach is to handle
the mapping as we do it for bookmarks: even if at the end annotation marks and
bookmarks are entires in <code>sw::mark::MarkManager</code>, it&#8217;s possible to set the
start position as a character attribute during import (since mapping the
<em>current</em> CP to the current SwPosition is easy) and when we know both the
start and end, delete the character attribute and turn it into a mark manager
entry. That&#8217;s exactly what I&#8217;ve done. The first screenshot is the result of 3
changes:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=271722d923610d128a358528e64d7233641ea0dc">add
  a annotationmark-start character attribute</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=677fdd4fa235466649911042577bc4980d42deb6">tokenize
  the annitationmark start and end structures from binary DOC</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=0ec0ec267986644084baaa5bda5ba917dc5744df">handle
  annotation marks via the character attribute added in the first change</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Hopefully this makes LibreOffice not only
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=b1cd83c625a2afeb9da43cc9745d79c01963c797">avoid
crashing</a> on such complex annotated contents, but also puts and end to the
long story of "annotation marks from binary DOC" problems.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Just like how C++11 perfect forwarding isn&#8217;t perfect&#8201;&#8212;&#8201;if you think
it is, see "Familiarize yourself with perfect forwarding failure cases." in
<a href="http://scottmeyers.blogspot.hu/2014/08/near-final-draft-of-effective-modern-c.html">this
post of Scoot</a>&#8201;&#8212;&#8201;the above changes may still not result in a truly perfect
import result of DOC annotation marks. But I think the #1 problem in this area
is now solved. :-)</td>
</tr></table>
</div>
</p><hr/></li>
<li><p>Saturday, 10 January 2015<br /><a href="/blog/export-validation.html">Export validation as a new year's resolution</a>
(<a href="/blog/export-validation.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>TL;DR: If you touch the ODF and/or OOXML filters in LibreOffice, please use
the <code>--with-export-validation</code> configure option after you ran the
<a href="https://gerrit.libreoffice.org/gitweb?p=dev-tools.git;a=blob;f=export-validation/setup.sh;hb=HEAD">setup.sh</a>
script.</p></div>
<div class="paragraph"><p><a href="https://mmohrhard.wordpress.com/">Markus Mohrhard</a> did an excellent job with
adding the <code>--with-export-validation</code> build switch to LibreOffice. It does the
following:</p></div>
<div class="ulist"><ul>
<li>
<p>
it validates every Calc and Impress zipped XML document (both ODF and
  OOXML) produced during the build by export filters
</p>
</li>
<li>
<p>
it does the same for Writer, except there only a subset of documents are
  validated
</p>
</li>
</ul></div>
<div class="paragraph"><p>One remaining <a href="https://bugs.freedesktop.org/show_bug.cgi?id=84600">problem</a> was
that it required setting up both
<a href="http://incubator.apache.org/odftoolkit/conformance/ODFValidator.html">odfvalidator</a>
and <a href="https://code.google.com/p/officeotron/">officeotron</a>, neither of them are
standard GNU projects but Java beasts. So even if I and a number of other
developers do use this option, it happens from time to time that we need to
fix new validation regressions, as others don&#8217;t see the problem; and even if
we point it out, it&#8217;s hard to reproduce for the author of the problematic
commit.</p></div>
<div class="paragraph"><p>This has just changed, all you need is to get <code>export-validation/setup.sh</code>
from <a href="https://gerrit.libreoffice.org/gitweb?p=dev-tools.git">dev-tools.git</a>, and run it like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>./setup.sh ~/svn /opt/lo/bin</code></pre>
</div></div>
<div class="paragraph"><p>I.e. the first parameter is a working directory and the second is a directory
that&#8217;s writable by you and is already in your path. And then wait a bit&#8230; ODF
validator uses maven as a build system, so how much you have to wait depends
on how much of the maven dependencies you already have in your local cache&#8230;
it&#8217;s typically 5 to 15 minutes.</p></div>
<div class="paragraph"><p>Once it&#8217;s done, you can add <code>--with-export-validation</code> to your autogen.input
and then toplevel <code>make</code> will invoke odfvalidator and officeotron for the
above mentioned documents.</p></div>
<div class="paragraph"><p>The new year is here, if you don&#8217;t have a new year&#8217;s resolution yet&#8201;&#8212;&#8201;or if
you hate those, but you&#8217;re willing to adopt a new habit from time to time&#8201;&#8212;&#8201;then please consider <code>--with-export-validation</code>, so that such regressions can
be detected before you publish your changes. Thanks! ;-)</p></div>
</p><hr/></li>
<li><p>Saturday, 27 December 2014<br /><a href="/blog/cloud.html">Fixing the cloud problem</a>
(<a href="/blog/cloud.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-0aWZ5rvDWI4/VJ3tCCh9wcI/AAAAAAAAFHA/A1P8Un5ksrw/s0/">
<img src="https://lh3.googleusercontent.com/-0aWZ5rvDWI4/VJ3tCCh9wcI/AAAAAAAAFHA/A1P8Un5ksrw/s400/" alt="https://lh3.googleusercontent.com/-0aWZ5rvDWI4/VJ3tCCh9wcI/AAAAAAAAFHA/A1P8Un5ksrw/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>TL;DR: see above‚Äâ--‚Äâa number of preset shapes are now rendered correctly at
any scale factors, where previously rendering problems occurred.</p></div>
<div class="paragraph"><p><a href="https://bugs.freedesktop.org/show_bug.cgi?id=87448">fdo#87448</a> has a reproducer
document that shows rendering errors with the scaled cloud preset shape
definition. At first I thought that the OOXML spec has wrong definition for
this shape type, but that turned out to be not the case. What was a problem is
our implementation of the drawingML arcTo command. This implementation defines
how we render such arcs as polygons when the shape is to be painted, and given
that LibreOffice has native support for the drawingML arcTo / ODF G command,
this implementation is invoked during rendering, it&#8217;s not an import/export
problem.</p></div>
<div class="paragraph"><p>The rendering result looked like this before:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-tYg4cifemAs/VJ3tCEHtf9I/AAAAAAAAFG8/WzioMo1AkMA/s0/">
<img src="https://lh3.googleusercontent.com/-tYg4cifemAs/VJ3tCEHtf9I/AAAAAAAAFG8/WzioMo1AkMA/s400/" alt="https://lh3.googleusercontent.com/-tYg4cifemAs/VJ3tCEHtf9I/AAAAAAAAFG8/WzioMo1AkMA/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>The cloud is drawn using a set of moveTo and arcTo commands. MoveTo is easier,
as it uses explicit coordinates, but arcTo is more complex. It has 4
parameters: the height and width of a "circle", and the start / end angle of
an arc on that circle. (Of course if height and width do not equal, than
that&#8217;s no longer a circle&#8230; ;-) ) The problem is that due to this, the
distance vector between the arc&#8217;s start and end points is implicit&#8201;&#8212;&#8201;so if
something is miscalculated, errors are nicely added to each other as more and
more arcs are drawn. This is especially a problem if you later return to the
end of an earlier arc using moveTo: if arcTo has some problem, then it&#8217;ll be
clearly visible.</p></div>
<div class="paragraph"><p>After
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=20f8006e21943b08f1f152e4a0359c9ebe4786f2">fixing
UNO ARCANGLETO</a> to only take care of scaling / translation only after counting
the actual arc, we started to produce correct end points for the arcs and
shapes started to appear correctly at any scale factor, yay! :-)</p></div>
<div class="paragraph"><p>One remaining problem was how to test this from cppunit, in the above commit I
exported the shape to a metafile, and then I could use Toma≈æ's excellent
MetafileXmlDump to assert that the end of an arc (implicit location) and the
parameters of a moveTo command (explicit location) equal&#8201;&#8212;&#8201;when they do not,
that&#8217;s what your eyes call a "rendering problem".</p></div>
</p><hr/></li>
<li><p>Saturday, 29 November 2014<br /><a href="/blog/libvisio-setup.html">Document Liberation Project hacking experience</a>
(<a href="/blog/libvisio-setup.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>As someone who usually hacks on LibreOffice, external import filters produced
by the Document Liberation Project cut both ways: they are great, as they deal
with obscure formats and we get them for free, OTOH hacking such code is more
complex than the usual LO code. I recently contributed a few patches to
<a href="http://cgit.freedesktop.org/libreoffice/libvisio/commit/?id=2060d364bc0f7df97b864bf01fc5a27da12061c3">libvisio</a>
and
<a href="http://sourceforge.net/p/libwpd/libodfgen/ci/fb43d79e12ce132fc127cc0481ff5a6bdbcd1afe/">libodfgen</a>,
but before I was able to do actual code changes, I had to set up a number of
repositories and configure them to talk to each other&#8201;&#8212;&#8201;this post describes one
possible setup that suited my needs.</p></div>
<div class="sect1">
<h2 id="_building_blocks">Building blocks</h2>
<div class="sectionbody">
<div class="paragraph"><p>DLP&#8217;s central project is librevenge and everything builds on top of that,
either by calling it or called by it. In case the task is to turn VSDX files
into ODG ones, it looks like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-cxQ9QnWmyAo/VHoyKdHXSAI/AAAAAAAAFAY/Rqqr8xPorNM/s0/">
<img src="https://lh3.googleusercontent.com/-cxQ9QnWmyAo/VHoyKdHXSAI/AAAAAAAAFAY/Rqqr8xPorNM/s400/" alt="https://lh3.googleusercontent.com/-cxQ9QnWmyAo/VHoyKdHXSAI/AAAAAAAAFAY/Rqqr8xPorNM/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>libvisio can build a librevenge document model from Visio files (more on the
various librevenge-based libraries
<a href="http://davetardon.wordpress.com/2014/05/06/writing-import-libraries-with-librevenge-part-i-getting-started/">here</a>),
libodfgen can generate ODF output from such document models (one other
possibility would be e.g.
<a href="http://sourceforge.net/projects/libepubgen/">libepubgen</a>), and the
writerperfect module provides kind of a controller for the remaining modules,
e.g. for our purpose, a vsd2odg binary.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_alternatives_considered">Alternatives considered</h2>
<div class="sectionbody">
<div class="paragraph"><p>One possibility is to build LibreOffice, use <code>--with-system-libvisio</code> and
similar switches, then clone the repos, install them system-wide (possibly
with your modifications), and then you can test your changes just with
building the various libs, without changing your LO build (more
<a href="http://fridrich.blogspot.hu/2012/01/fosdem-2012-how-to-make-best-of-it-and.html">here</a>).
The drawback is that this way you pollute your system with unstable versions
of those libs.</p></div>
<div class="paragraph"><p>An other possibility is to build LibreOffice as usual, and then use the
<a href="https://wiki.documentfoundation.org/Development/Patching_External_Libraries">external
libraries patching mechanism</a> to hack on the code. The drawback is that you
have to work without git on the code, and also you can only work with a
released version.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_pkg_config_approach">The pkg-config approach</h2>
<div class="sectionbody">
<div class="paragraph"><p>So here is what I did to avoid the above mentioned drawbacks: all DLP projects
use pkg-config to find the required libraries, so you can configure them in a
way that allows building as a user, avoid installing them at all, and still
execute vsd2odg using the libs with your changes. Here is how to do it:</p></div>
<div class="ulist"><ul>
<li>
<p>
librevenge:
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>git clone git://git.code.sf.net/p/libwpd/librevenge</code><br />
<code>cd librevenge</code><br />
<code>./autogen.sh</code><br />
<code>./configure --enable-debug</code><br />
<code>make</code></p></div>
<div class="ulist"><ul>
<li>
<p>
libvisio:
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>git clone git://gerrit.libreoffice.org/libvisio</code><br />
<code>cd libvisio</code><br />
<code>./autogen.sh</code><br />
<code>./configure REVENGE_CFLAGS="-I/home/vmiklos/git/libreoffice/librevenge/inc" REVENGE_LIBS="-L/home/vmiklos/git/libreoffice/librevenge/src/lib/.libs/ -lrevenge-0.0" REVENGE_GENERATORS_CFLAGS="-I/home/vmiklos/git/libreoffice/librevenge/inc" REVENGE_GENERATORS_LIBS="-L/home/vmiklos/git/libreoffice/librevenge/src/lib/.libs/ -lrevenge-generators-0.0" REVENGE_STREAM_CFLAGS="-I/home/vmiklos/git/libreoffice/librevenge/inc" REVENGE_STREAM_LIBS="-L/home/vmiklos/git/libreoffice/librevenge/src/lib/.libs/ -lrevenge-stream-0.0" --enable-debug</code><br />
<code>make</code></p></div>
<div class="ulist"><ul>
<li>
<p>
libodfgen:
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>git clone git://git.code.sf.net/p/libwpd/libodfgen</code><br />
<code>cd libodfgen</code><br />
<code>./autogen.sh</code><br />
<code>./configure REVENGE_CFLAGS="-I/home/vmiklos/git/libreoffice/librevenge/inc" REVENGE_LIBS="-L/home/vmiklos/git/libreoffice/librevenge/src/lib/.libs/ -lrevenge-0.0" REVENGE_STREAM_CFLAGS="-I/home/vmiklos/git/libreoffice/librevenge/inc" REVENGE_STREAM_LIBS="-L/home/vmiklos/git/libreoffice/librevenge/src/lib/.libs/ -lrevenge-stream-0.0" --enable-debug</code><br />
<code>make</code></p></div>
<div class="ulist"><ul>
<li>
<p>
writerperfect:
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>git clone git://git.code.sf.net/p/libwpd/writerperfect</code><br />
<code>cd writerperfect</code><br />
<code>./autogen.sh</code><br />
<code>./configure REVENGE_CFLAGS="-I/home/vmiklos/git/libreoffice/librevenge/inc" REVENGE_LIBS="-L/home/vmiklos/git/libreoffice/librevenge/src/lib/.libs/ -lrevenge-0.0" REVENGE_STREAM_CFLAGS="-I/home/vmiklos/git/libreoffice/librevenge/inc" REVENGE_STREAM_LIBS="-L/home/vmiklos/git/libreoffice/librevenge/src/lib/.libs/ -lrevenge-stream-0.0" ODFGEN_CFLAGS="-I/home/vmiklos/git/libreoffice/libodfgen/inc" ODFGEN_LIBS="-L/home/vmiklos/git/libreoffice/libodfgen/src/.libs -lodfgen-0.1 -lrevenge-0.0 -lrevenge-stream-0.0" VISIO_CFLAGS="-I/home/vmiklos/git/libreoffice/libvisio/inc" VISIO_LIBS="-L/home/vmiklos/git/libreoffice/libvisio/src/lib/.libs -lvisio-0.1 -lrevenge-0.0" --enable-debug --with-libvisio</code><br /></p></div>
<div class="paragraph"><p>Of course, replace <code>/home/vmiklos/git/libreoffice/</code> with any other directory
you like, just be consistent. ;-)</p></div>
<div class="paragraph"><p>Now you can hack on any of these libraries, you just need to build your
changes, and then vsd2odg will produce a flat ODG that you can quickly test
with any ODF processor, like LibreOffice. One remaining trick (in case you&#8217;re
not an autotools expert) is that vsd2odg is a libtool shell script, not a
binary. If you still want to run the underlying binary in gdb, here is how you
can do that:</p></div>
<div class="paragraph"><p><code>libtool --mode=execute gdb --args vsd2odg /home/vmiklos/git/libreoffice/test.vsdx</code></p></div>
<div class="paragraph"><p>In case the above considered two alternatives are not sufficient for your
purposes, then I hope you find this setup useful. ;-)</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Sunday, 26 October 2014<br /><a href="/blog/kasa.html">K√°sa</a>
(<a href="/blog/kasa.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-_vm--J4931U/VE0TDPtzt5I/AAAAAAAAE4w/MzrG6VYGuWo/s0/">
<img src="https://lh5.googleusercontent.com/-_vm--J4931U/VE0TDPtzt5I/AAAAAAAAE4w/MzrG6VYGuWo/s400/" alt="https://lh5.googleusercontent.com/-_vm--J4931U/VE0TDPtzt5I/AAAAAAAAE4w/MzrG6VYGuWo/s400/" />
</a>
</div>
</div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>A v√≠zben j√≥. Ez nagyon hamar tudatosult bennem, √©s a mai napig a v√≠z a kedvenc
k√∂zegem. Megnyugtat. Magabiztoss√° tesz. Otthon vagyok benne.  Ha beugrom √©s
elmer√ºl√∂k, megsz≈±nik minden m√°s. Csak a v√≠z van, √©s √©n meg a csend.  Simogat√≥
csend. De a k√ºlvil√°g akkor sem jut el hozz√°m, ha f√∂lj√∂v√∂k. A v√≠zben m√°s
tudat√°llapotba ker√ºl√∂k.</p></div>
</div>
<div class="attribution">
&#8212; M. Kiss Csaba - K√°s√°s Tam√°s: K√°sa avagy egy p√≥l√≥s vil√°gszt√°r √©let√©nek els≈ë harminchat √©ve
</div></div>
<div class="paragraph"><p>(<a href="http://bookline.hu/product/home.action?id=116270&amp;type=22">bookline</a>, de a
lira.hu is
<a href="http://www.lira.hu/hu/ekonyv/tortenelem-1/eletrajzok/kasa-avagy-egy-polos-vilagsztar-eletenek-elso-harminchat-eve-ekonyv-epub-mobi-1">√°rulja</a>
DRM-mentes ebookban)</p></div>
</p><hr/></li>
<li><p>Saturday, 25 October 2014<br /><a href="/blog/yellow-pig.html">The yellow border around the pig</a>
(<a href="/blog/yellow-pig.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-IhaYMXbDVyo/VEufBghNiHI/AAAAAAAAE4g/8n2DuQ_Edeo/s0/">
<img src="https://lh3.googleusercontent.com/-IhaYMXbDVyo/VEufBghNiHI/AAAAAAAAE4g/8n2DuQ_Edeo/s400/" alt="https://lh3.googleusercontent.com/-IhaYMXbDVyo/VEufBghNiHI/AAAAAAAAE4g/8n2DuQ_Edeo/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>It turns out LibreOffice&#8217;s RTF and DOCX import filter ignored borders around Writer
pictures. Given that this
<a href="https://bugs.freedesktop.org/show_bug.cgi?id=85179">worked</a> in the RTF case in
the past, it&#8217;s a bit amusing that now the very same commit implements a new
feature for the DOCX case and at the same time fixes a regression in the RTF
filter. Code sharing FTW! :-)</p></div>
</p><hr/></li>
<li><p>Friday, 10 October 2014<br /><a href="/blog/a-grand-budapest-hotel.html">A Grand Budapest Hotel</a>
(<a href="/blog/a-grand-budapest-hotel.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-zqusYBTQOVw/VDgwVzNttGI/AAAAAAAAE2A/_N58DlMJ2mk/s0/">
<img src="https://lh5.googleusercontent.com/-zqusYBTQOVw/VDgwVzNttGI/AAAAAAAAE2A/_N58DlMJ2mk/s400/" alt="https://lh5.googleusercontent.com/-zqusYBTQOVw/VDgwVzNttGI/AAAAAAAAE2A/_N58DlMJ2mk/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>V√©gre egy film ami nem romantikus v√≠gj√°t√©k, nem h√°bor√∫s dr√°ma √©s m√©g nem is
b√°ntam meg a r√°sz√°nt id≈ët. Persze nem is v√©letlen√ºl kapott 10-b≈ël 8.2 pontot.
;-)</p></div>
<div class="paragraph"><p>(<a href="http://www.imdb.com/title/tt2278388/">imdb</a>, <a href="http://www.youtube.com/watch?v=1Fg5iWmQjwk">trailer</a>)</p></div>
</p><hr/></li>
<li><p>Saturday, 20 September 2014<br /><a href="/blog/upc-port-forward.html">UPC vs port forwarding</a>
(<a href="/blog/upc-port-forward.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p><a href="http://en.wikipedia.org/wiki/UPC_Broadband">UPC</a> traditionally had a setup
consisting of a cable modem providing internet access to a single computer,
and then it was up to the users if they use that access to really connect to a
computer or to a router, providing wireless access and so on.  It seems, these
days they are more after actually <em>encouraging</em> people to use their
subscription on multiple devices&#8201;&#8212;&#8201;possibly that way it&#8217;s easier to sell
larger packages (like 60 MBit/s download rate instead of 30 MBit/s, etc).  One
fallout from this move is that they started to replace modems with a
combination of modems and routers, in this case this is an
<a href="http://www.ubeeinteractive.com/products/cable/evw3226">Ubee EVW3226</a>, with the
brand removed. I wanted to try out if this new device could replace my
previous router or not&#8201;&#8212;&#8201;so far it seems to be good enough, though there was
one pitfall, hence this post.</p></div>
<div class="paragraph"><p>It&#8217;s possible to define a range of IP addresses to be used for DHCP purposes,
though you can&#8217;t serve fixed IP addresses based on the MAC address of the
clients. Given that my home network isn&#8217;t that large, I can tolerate that: as
long as there is a range that can be safely used for fixed addresses, I can
configure that manually.  It&#8217;s also possible to do port forwarding, e.g.
redirecting the incoming ssh traffic to a given address&#8201;&#8212;&#8201;except you can&#8217;t do
both at the same time: you can&#8217;t redirect traffic to an address that&#8217;s not
known (served via DHCP) to the router. Which is a shame, the #1 use case for
port forwarding is to redirect traffic to a home-server that will then also
have a fixed IP internally&#8230;</p></div>
<div class="paragraph"><p>So here is a hack that allowed me to still do this: set the start of the range
of the DHCP served IP&#8217;s exactly to the address of the (to be used in future
as) fixed address, e.g. 192.168.0.5. Connect with one client, so that the
address will be <em>known</em> to the router. Then add the port-forwarding rule,
finally set the DHCP range back to its original value (in my case I use
192.168.0.1..99 for fixed addresses and 100+ for dynamic purposes). It&#8217;s a
stupid trick, but it works&#8230; ;-)</p></div>
</p><hr/></li>
<li><p>Monday, 08 September 2014<br /><a href="/blog/locon2014-bern.html">LibreOffice Conference 2014, Bern</a>
(<a href="/blog/locon2014-bern.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://picasaweb.google.com/104737754628780823336/20140907_Bern#6056624255300189730">
<img src="https://lh3.googleusercontent.com/-JCMeo2opMG4/VA1zq7suviI/AAAAAAAACo8/HXP5IrRC1pw/s400/" alt="https://lh3.googleusercontent.com/-JCMeo2opMG4/VA1zq7suviI/AAAAAAAACo8/HXP5IrRC1pw/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>This year&#8217;s LibreOffice conference was held in Bern, Switzerland. Links to my slides:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://speakerdeck.com/vmiklos/inconsistencies-fixed-in-writer">Inconsistencies Fixed in Writer</a>
</p>
</li>
<li>
<p>
<a href="https://speakerdeck.com/vmiklos/proudly-breaking-your-toolchain">Proudly breaking your toolchain</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>During the sessions I also had some time to hack on the followings:</p></div>
<div class="ulist"><ul>
<li>
<p>
RTF export: added support for custom wrap polygon of Writer pictures
</p>
</li>
<li>
<p>
fixed <a href="https://bugs.freedesktop.org/show_bug.cgi?id=82067">fdo#82067</a>
  FILEOPEN: RTF images not in correct position
</p>
</li>
<li>
<p>
fixed <a href="https://bugs.freedesktop.org/show_bug.cgi?id=82078">fdo#82078</a>
  FILEOPEN: RTF bold text spilling over to non-bold text
</p>
</li>
<li>
<p>
fixed <a href="http://bugzilla.abisource.com/show_bug.cgi?id=10039">abi#10039</a> crasher
  on RTF export of page-anchored pictures
</p>
</li>
</ul></div>
<div class="paragraph"><p>Regarding the number of attendees, draw your own conclusions from the
<a href="https://www.dropbox.com/sc/45n18v60ckztv63/AABg9ka54ueqFCGft1V54eTYa">group
picture</a>&#8201;&#8212;&#8201;probably around 300 attendees, counting all days.</p></div>
<div class="paragraph"><p>Thanks for the organizers for this beautiful event&#8201;&#8212;&#8201;and also the sponsors!
:-)</p></div>
<div class="paragraph"><p>My pictures are available
<a href="https://picasaweb.google.com/104737754628780823336/20140907_Bern">here</a> (and I
also made a <a href="http://vmiklos.hu/panoramas/bern.html">panorama</a>).</p></div>
</p><hr/></li>
<li><p>Thursday, 28 August 2014<br /><a href="/blog/ooxmltok.html">Cleanup of ooxmltok in LibreOffice</a>
(<a href="/blog/ooxmltok.html#disqus_thread">Comments</a>)
</p><p><div style="text-align: center; font-size: 0.6em;">
<img src="https://lh4.googleusercontent.com/-GipHI6c2dSM/U_8TTB9IzUI/AAAAAAAAExA/LVMQpNezkus/s400/"/>
<p>(via <a href="https://www.flickr.com/photos/aigle_dore/7356881428/">aigle_dore</a>)</p>
</div>
<div class="paragraph"><p>In June, we
<a href="http://article.gmane.org/gmane.comp.documentfoundation.libreoffice.qa/7272">decided</a>
to get rid of XSLT usage in writerfilter, the module responsible for RTF and
DOCX import in LibreOffice. As usual with cleaning up mess, this took time
(about two months), but I&#8217;m now happy to say that I&#8217;m mostly done with this.
:-)</p></div>
<div class="paragraph"><p>See <a href="http://vmiklos.hu/blog/doctok.html">the doctok blog post</a> for some
background, the topic here was to clean up the OOXML tokenizer, that is that
building block that turns a zipped XML document into a token stream.</p></div>
<div class="paragraph"><p>The following problems are now solved:</p></div>
<div class="ulist"><ul>
<li>
<p>
Part of the module was generated code, the generator was implemented mostly
  in XSLT, but some bits were written in Perl and sed. About 4200 lines of
  XSLT code is now rewritten in Python, in about 1300 lines.
</p>
</li>
<li>
<p>
Given that we have much more developers who speak Python, compared to XSLT,
  nontrivial changes are now much easier in the generator: Jan Holesovsky
  <a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=c74de6c2e29a16fb4a458816cd17fa678edd16e7">cleaned
  up</a> <code>boost::unordered_map</code> usage at places where we depended on the order of
  elements. (Yes, you read it correctly, that was the situation up till now!)
  This also helps reducing the size of the resulting writerfilter shared library.
</p>
</li>
<li>
<p>
The input of the code generator was the large <code>model.xml</code> file, and
  generator scripts only extracted interesting information from it, so if you
  mistyped something, you got no error messages, just silent failures. I&#8217;ve
  removed quite some XML elements and attributes from it which were parsed by
  none of the generator scripts and written a
  <a href="http://opengrok.libreoffice.org/xref/core/writerfilter/documentation/ooxml/model.rng">relax-ng
  schema</a> for the remaining markup. Validating against this schema is part of
  the default build, so no more typos without a build failure. ;-)
  (The schema also contains quite some documentation, finally.)
</p>
</li>
<li>
<p>
A gperf hash of all possible OOXML elements / attribute names were
  duplicated in writerfilter, even if that information was already available
  from the oox module. This is now fixed, reducing the size of the shared
  library even further.
</p>
</li>
<li>
<p>
Also, both oox and writerfilter had a list of namespace URL&#8217;s, mapping them
  to an integer enumeration, and when the two lists didn&#8217;t match, Bad Things
  happened (read: usually resulted in a crash.) This is the past, I&#8217;ve
  refactored writerfilter to use the same namespace alias names as oox, and this
  allowed to get rid of the writerfilter copy of the namespace alias list. So in
  the future, if new namespaces have to added, only oox has to be extended.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Oh and the bonus feature: I&#8217;ve implemented a script called
<a href="http://opengrok.libreoffice.org/xref/core/writerfilter/qa/ooxml/watch-generated-code.sh">watch-generated-code.sh</a>,
which can record a good state of the generated code, and then compare later
generated results against that, so that refactoring of the generator can now be
performed in a safe way: you can change the generator in any way to make it
better, and still avoid accidental output changes. :-) This is particularly
useful, as it only diffs the end result of the whole generation process (cxx
and hxx files), not temporarily files, which are OK to change, as long as the
end result is the same.</p></div>
<div class="paragraph"><p>As a conclusion, here are sizes of a stripped dbgutil version of the
writerfilter shared library, from the libreoffice-4-3-branch-point and today&#8217;s
master:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ git checkout oldest
HEAD is now at b3130c8... 2014-05-21
vmiklos@o9010:~/git/libreoffice/daily$ ls -lh opt/program/libwriterfilterlo.so
-rwxr-xr-x 1 vmiklos users 8,3M aug   28 14:00 opt/program/libwriterfilterlo.so
$ git checkout master
Switched to branch 'master'
vmiklos@o9010:~/git/libreoffice/daily$ ls -lh opt/program/libwriterfilterlo.so
-rwxr-xr-x 1 vmiklos users 6,1M aug   28 14:01 opt/program/libwriterfilterlo.so</code></pre>
</div></div>
<div class="paragraph"><p>Again, the 8,3MB &#8594; 6,1MB size reduction is mostly thanks to Kendy&#8217;s map cleanups + the
duplicated gperf hash going away. :-)</p></div>
</p><hr/></li>
</ul></div>
<a href="/blog/archive.html">more &raquo;</a>
<script type="text/javascript">
var disqus_shortname = 'vmiklos';
(function () {
 var s = document.createElement('script'); s.async = true;
 s.src = 'http://disqus.com/forums/vmiklos/count.js';
 (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

</div>
</div>
</div>
</div>
</body>
</html>
