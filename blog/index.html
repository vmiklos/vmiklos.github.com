<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />


  <title>
    What is Miklos hacking
  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-clearing-breaks.html">Clearing breaks in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 04 April 2022</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 4 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Writer now supports what we call clearing breaks: a new property on line breaks which controls where
to put the next line in case the line break is at the end of a line which intersects with an
anchored object. This feature improves compatibility with the DOCX and HTML formats.</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/all-new.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/all-new.png" />
</div>
<div class="title">Figure 1. Word-style "all" clearing in Writer, new result.</div>
</div>
<div class="paragraph"><p>First, thanks to <a href="https://dapsi.ngi.eu/">NGI DAPSI</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/eu.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/eu.png" />
</div>
<div class="title">Figure 2. This project has received funding from the European Unionâ€™s Horizon 2020 research and innovation programme under grant agreement No 871498</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Word users expect to be able to import their documents to Writer and experience high fidelity
rendering: this means Writer has to support clearing breaks, which instruct the layout to put the
next line after a line break not necessarily at the next available vertical position, but perhaps
the next line should "just down" to the next full line, or perhaps just do this partially. (Jump
down to the next line, so no anchored object causes an additional indentation on the left or right
side.)</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results">Results</h2>
<div class="sectionbody">
<div class="paragraph"><p>The easiest case is the "none" clearing break, i.e. when it&#8217;s not actually clearing. This looks like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/none-new.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/none-new.png" />
</div>
<div class="title">Figure 3. Word-style not clearing break, new result.</div>
</div>
<div class="paragraph"><p>This is just a plain line break, and there are no changes here. It used to look like this in the past as well:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/none-old.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/none-old.png" />
</div>
<div class="title">Figure 4. Word-style not clearing break, old result.</div>
</div>
<div class="paragraph"><p>And both match the reference rendering:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/none-ref.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/none-ref.png" />
</div>
<div class="title">Figure 5. Word-style not clearing break, reference.</div>
</div>
<div class="paragraph"><p>Now, what&#8217;s more interesting is the "all" clearing break, when the next line is placed in a way that
it&#8217;s a full line. Figure 1 already shows how it now looks like in Writer. Here is how it used to
look like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/all-old.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/all-old.png" />
</div>
<div class="title">Figure 6. Word-style "all" clearing break, old result.</div>
</div>
<div class="paragraph"><p>Finally you can compare that with the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/all-ref.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/all-ref.png" />
</div>
<div class="title">Figure 7. Word-style "all" clearing break, reference.</div>
</div>
<div class="paragraph"><p>This is the most interesting case, and Word still provides UI to insert such breaks, so it
frequently appears in documents out there. But there are two other cases, still. The "left" clearing
break "jumps down", below anchored objects on the left. Here is how it looks now in Writer:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/left-new.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/left-new.png" />
</div>
<div class="title">Figure 8. Word-style "left" clearing break, new result</div>
</div>
<div class="paragraph"><p>And this is how it used to look like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/left-old.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/left-old.png" />
</div>
<div class="title">Figure 9. Word-style "left" clearing break, old result</div>
</div>
<div class="paragraph"><p>Finally you can compare that with the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/left-ref.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/left-ref.png" />
</div>
<div class="title">Figure 10. Word-style "left" clearing break, reference</div>
</div>
<div class="paragraph"><p>The last case is the mirror of this, when the "right" clearing break "jumps down", below anchored
objects on the right. Here is how it looks now in Writer:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/right-new.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/right-new.png" />
</div>
<div class="title">Figure 11. Word-style "right" clearing break, new result</div>
</div>
<div class="paragraph"><p>And this is how it used to look like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/right-old.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/right-old.png" />
</div>
<div class="title">Figure 12. Word-style "right" clearing break, old result</div>
</div>
<div class="paragraph"><p>Finally you can compare that with the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/right-ref.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/right-ref.png" />
</div>
<div class="title">Figure 13. Word-style "right" clearing break, reference</div>
</div>
<div class="paragraph"><p>Other than the layout, there is also user interface for this in both LibreOffice and Collabora Online:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-clearing-break/ui.png" alt="https://share.vmiklos.hu/blog/sw-clearing-break/ui.png" />
</div>
<div class="title">Figure 14. Insert break dialog in Collabora Online, with a new option for clearing breaks</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the high-level problem was addressed by a series of incremental commits:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/130687">https://gerrit.libreoffice.org/c/core/+/130687</a> sw clearing breaks: add document model
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/130741">https://gerrit.libreoffice.org/c/core/+/130741</a> sw clearing breaks: add UNO API to insert this
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/130818">https://gerrit.libreoffice.org/c/core/+/130818</a> sw clearing breaks: add UNO API to insert this with custom clear / char props
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/130903">https://gerrit.libreoffice.org/c/core/+/130903</a> sw clearing breaks: include this in the UNO API text portion enum
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/130961">https://gerrit.libreoffice.org/c/core/+/130961</a> sw clearing breaks: initial layout support
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131093">https://gerrit.libreoffice.org/c/core/+/131093</a> sw clearing breaks: fix rendering of the line break char itself
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131167">https://gerrit.libreoffice.org/c/core/+/131167</a> sw clearing breaks: add DOCX import
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131231">https://gerrit.libreoffice.org/c/core/+/131231</a> sw clearing breaks: add DOCX export
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131297">https://gerrit.libreoffice.org/c/core/+/131297</a> sw clearing breaks: fix layout when the line is empty
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131346">https://gerrit.libreoffice.org/c/core/+/131346</a> sw clearing breaks: add ODF export
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131645">https://gerrit.libreoffice.org/c/core/+/131645</a> sw clearing breaks: add ODF import
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131697">https://gerrit.libreoffice.org/c/core/+/131697</a> sw clearing breaks: add DOC import
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131732">https://gerrit.libreoffice.org/c/core/+/131732</a> sw clearing breaks: add DOC export
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131886">https://gerrit.libreoffice.org/c/core/+/131886</a> sw clearing breaks: add RTF filter
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131924">https://gerrit.libreoffice.org/c/core/+/131924</a> sw clearing breaks: add HTML filter
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/131958">https://gerrit.libreoffice.org/c/core/+/131958</a> sw clearing breaks: add plain text export
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/132024">https://gerrit.libreoffice.org/c/core/+/132024</a> sw clearing breaks: add insert UI
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/132093">https://gerrit.libreoffice.org/c/core/+/132093</a> sw clearing breaks: add clearing indicator during rendering
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/132162">https://gerrit.libreoffice.org/c/core/+/132162</a> sw clearing breaks: add layout support for the left and right cases
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/132317">https://gerrit.libreoffice.org/c/core/+/132317</a> sw clearing breaks: link ODF proposal
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>You can get a snapshot / demo of Collabora Office 2022 and try it out yourself right now:
<a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF&#8217;s next release too (7.4).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-page-table-para-border.html">Word-style border fixes in Writer: pages, tables and paragraphs</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 08 March 2022</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Writer now has a set of improvements to better render Word-style borders around pages, tables and
paragaphs. This required adjusting how we perform automatic mirroring and also to make sure that
clipping is done the Word way.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://www.docmosis.com/">Docmosis</a> and <a href="https://www.tubitak.gov.tr/en">TUBITAK</a> who
made this work by <a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Word users expect to able to import their documents to Writer and experience high fidelity
rendering: this means Writer has to support the way page / table / paragraph borders are painted
according to the OOXML model as well. This is all done conditionally, so existing ODF documents are
left unchanged.</p></div>
<div class="paragraph"><p>This is a set of 5 bugfixes, requested by multiple of our customers.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results">Results</h2>
<div class="sectionbody">
<div class="paragraph"><p>First let&#8217;s look at the new render result for page borders:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-page-table-para-border/page-border-new.png" alt="https://share.vmiklos.hu/blog/sw-page-table-para-border/page-border-new.png" />
</div>
<div class="title">Figure 1. Word-style page borders, new result</div>
</div>
<div class="paragraph"><p>And this is how it used to look like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-page-table-para-border/page-border-old.png" alt="https://share.vmiklos.hu/blog/sw-page-table-para-border/page-border-old.png" />
</div>
<div class="title">Figure 2. Word-style page borders, old result</div>
</div>
<div class="paragraph"><p>Finally you can compare that with the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-page-table-para-border/page-border-ref.png" alt="https://share.vmiklos.hu/blog/sw-page-table-para-border/page-border-ref.png" />
</div>
<div class="title">Figure 3. Word-style page borders, reference</div>
</div>
<div class="paragraph"><p>What you can see here is that the page has a double border: the outer line is thick and the inner
line is thin. The right and bottom border was incorrect as our result was the opposite of the
reference.</p></div>
<div class="paragraph"><p>Second, let&#8217;s look at the new render result for table borders:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-page-table-para-border/table-border-new.png" alt="https://share.vmiklos.hu/blog/sw-page-table-para-border/table-border-new.png" />
</div>
<div class="title">Figure 4. Word-style table borders, new result</div>
</div>
<div class="paragraph"><p>And this is how it used to look like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-page-table-para-border/table-border-old.png" alt="https://share.vmiklos.hu/blog/sw-page-table-para-border/table-border-old.png" />
</div>
<div class="title">Figure 5. Word-style table borders, old result</div>
</div>
<div class="paragraph"><p>Finally you can compare that with the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-page-table-para-border/table-border-ref.png" alt="https://share.vmiklos.hu/blog/sw-page-table-para-border/table-border-ref.png" />
</div>
<div class="title">Figure 6. Word-style table borders, reference</div>
</div>
<div class="paragraph"><p>You can notice a number of problems here:</p></div>
<div class="ulist"><ul>
<li>
<p>
the inner horizontal line at the top table was overrunning, it was even painted between the two
  lines of the outer double border
</p>
</li>
<li>
<p>
the middle table shows how the vertical thick and thin lines of the outer double border was
  reversed
</p>
</li>
<li>
<p>
the bottom table shows how the horizontal tick inner border was not consistent
</p>
</li>
</ul></div>
<div class="paragraph"><p>The new render result properly clips the inner border lines, so they don&#8217;t intersect outer borders,
and the border mirroring (similar to the page borders) is now correct for table borders as well.</p></div>
<div class="paragraph"><p>Third, let&#8217;s look at the new render result for paragraph borders:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-page-table-para-border/para-border-new.png" alt="https://share.vmiklos.hu/blog/sw-page-table-para-border/para-border-new.png" />
</div>
<div class="title">Figure 7. Word-style paragraph borders, new result</div>
</div>
<div class="paragraph"><p>And this is how it used to look like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-page-table-para-border/para-border-old.png" alt="https://share.vmiklos.hu/blog/sw-page-table-para-border/para-border-old.png" />
</div>
<div class="title">Figure 8. Word-style paragraph borders, old result</div>
</div>
<div class="paragraph"><p>Finally you can compare that with the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-page-table-para-border/para-border-ref.png" alt="https://share.vmiklos.hu/blog/sw-page-table-para-border/para-border-ref.png" />
</div>
<div class="title">Figure 9. Word-style paragraph borders, reference</div>
</div>
<div class="paragraph"><p>What&#8217;s visible here is that some paragraph inside the table cell had borders defined, but due to how
the reference clips these borders, this border was not visible. That unexpected border is now also
omitted in Writer.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the high-level problem was addressed by a series of bugfix changes.</p></div>
<div class="paragraph"><p>For the page border:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/129281">https://gerrit.libreoffice.org/c/core/+/129281</a> sw: fix swapped inner vs outer border for Word-style right/bottom page borders
</p>
</li>
</ul></div>
<div class="paragraph"><p>For the table border:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/128053">https://gerrit.libreoffice.org/c/core/+/128053</a> sw: fix too long inner borders intersecting with outer borders for Word cells
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/128289">https://gerrit.libreoffice.org/c/core/+/128289</a> sw: fix swapped inner vs outer border for Word-style left table borders
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/128383">https://gerrit.libreoffice.org/c/core/+/128383</a> sw: fix swapped inner vs outer border for Word-style bottom table borders
</p>
</li>
</ul></div>
<div class="paragraph"><p>For the paragraph border:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/128569">https://gerrit.libreoffice.org/c/core/+/128569</a> sw: fix unexpected paragraph border inside table cells
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>You can get a snapshot / demo of Collabora Office and try it out yourself right now:
<a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF&#8217;s next release too (7.4).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/pdf-convert-to.html">Improved PDF export options in the command-line and in Online</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 08 February 2022</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>The LibreOffice Technology now has much better support for creating custom PDF exports of documents:
options available in the interactive PDF export options dialog are now also possible to set from the
command-line, and also when using the document conversion feature of
<a href="https://www.collaboraoffice.com/document-conversion/">Collabora Online</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>I was working on a regression that only happens if you export the second and third pages of a
document to PDF. While investigating, I needed a quick way to trigger the problematic code-path, and
clicking through a dialog is not convenient.</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/pdf-convert-to/pdf-export-partial.png" alt="https://share.vmiklos.hu/blog/pdf-convert-to/pdf-export-partial.png" />
</div>
<div class="title">Figure 1. UI to specify a partial export to PDF</div>
</div>
<div class="paragraph"><p>The PDF export in LibreOffice has a lot of options, but those are only available from extension code
(using the UNO API) or from the UI dialog. The idea was to expose much of this to the <code>soffice
--convert-to</code> command as well, and if we&#8217;re at it, also to the <code>/cool/convert-to</code> endpoint of
Online.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here are a few examples to show the possibilities:</p></div>
<div class="ulist"><ul>
<li>
<p>
Skip the first page of a Draw document:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>soffice --convert-to 'pdf:draw_pdf_Export:{"PageRange":{"type":"string","value":"2-"}}' test.odg</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Add watermark:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>soffice --convert-to 'pdf:draw_pdf_Export:{"TiledWatermark":{"type":"string","value":"draft"}}' test.odg</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Encrypt the output:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>soffice --convert-to 'pdf:draw_pdf_Export:{"EncryptFile":{"type":"boolean","value":"true"},"DocumentOpenPassword":{"type":"string","value":"secret"}}' test.odg</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
We default to PDF 1.6, perhaps you want to write PDF 1.5:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>soffice --convert-to 'pdf:draw_pdf_Export:{"SelectPdfVersion":{"type":"long","value":"15"}}' test.odg</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Sign the PDF:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>soffice --convert-to 'pdf:draw_pdf_Export:{"SignPDF":{"type":"boolean","value":"true"},"SignCertificateSubjectName":{"type":"string","value":"CN=..."}}' test.odg</code></pre>
</div></div>
<div class="paragraph"><p>And the best is that the same also works in Online, e.g.:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>curl -k -F "data=@3page.odg" -F "format=pdf" -F "options={\"PageRange\":{\"type\":\"string\",\"value\":\"2-\"}}" https://localhost:9980/cool/convert-to &gt; out.pdf</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/128643">https://gerrit.libreoffice.org/c/core/+/128643</a> <em>tdf#141340 PDF export: fix hyperlinks on the wrong
  page with page num range</em> was the use-case that initially motivated to add the feature.
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/128709">https://gerrit.libreoffice.org/c/core/+/128709</a> <em>comphelper: move JsonToPropertyValues() from
  desktop/</em> was grounding work to use the "convert JSON to a string-any map" functionality we
  already had in core.git, as part of the LOK API.
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/128849">https://gerrit.libreoffice.org/c/core/+/128849</a> <em>PDF export: allow setting filter data keys from
  the cmdline</em> is the actual improvement to the PDF exporter
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/128970">https://gerrit.libreoffice.org/c/core/+/128970</a> <em>desktop lok, export options: allow passing through
  a JSON string as-is</em> is a tweak to let the LOK API also use this
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/129387">https://gerrit.libreoffice.org/c/core/+/129387</a> <em>filter: allow PDF export to sign from the cmdline</em>
  added the PDF signing as a string option, since referring to a certificate object from the command-line
  was not possible
</p>
</li>
<li>
<p>
<a href="https://github.com/CollaboraOnline/online/pull/4069">https://github.com/CollaboraOnline/online/pull/4069</a> <em>wsd, convert-to: allow specifying filter
  options as JSON</em> implemented the Online side
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>You can get a snapshot / demo of Collabora Office and try it out yourself right now:
<a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF&#8217;s next release too (7.4).</p></div>
<div class="paragraph"><p>For the Online side, see the <a href="https://www.collaboraoffice.com/code/">CODE</a> page, the feature is
present in the current release (2021).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sd-theme-shape-text.html">Start of document themes in Impress: shape text</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 06 January 2022</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 5 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Impress now has the start of document theme support: it is possible to define a document theme on
master pages and you can refer to the theme colors from shape text (including effects).</p></div>
<div class="paragraph"><p>First, thanks to our partner <a href="https://www.suse.com/">SUSE</a> for working with
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>PowerPoint users can attach a set of colors (and fonts, formattings) to master pages, and then refer
to these in shape text, shape fill, shape geometry. You can even make the original color lighter and
darker. These effects are preserved when you change the theme colors.</p></div>
<div class="paragraph"><p>This is a larger feature, this blog post shows how theme colors can be defined and how to refer to
those colors from Impress shape text. The rest of the feature is to be done in follow-up steps.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here is a demo that shows how it works:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://youtu.be/4QeN58AkuxE">
<img src="https://share.vmiklos.hu/blog/sd-theme-shape-text/sd-theme-shape-text.png" alt="https://share.vmiklos.hu/blog/sd-theme-shape-text/sd-theme-shape-text.png" />
</a>
</div>
<div class="title">Figure 1. Demo of theme support in Impress shape text</div>
</div>
<div class="paragraph"><p>In other words, it consists of 2 parts on the UI:</p></div>
<div class="ulist"><ul>
<li>
<p>
You can define theme colors once you click on "Master View" in Impress, and then select the Slide
  &#8594; Slide properties menu item, and there choosing the new Theme tab. You can e.g. make "accent1"
  blue, "accent2" orange, and so on.
</p>
</li>
<li>
<p>
Then you can refer to these theme colors. Select some shape text, and then either use Format &#8594;
  Character &#8594; Font effects &#8594; Font color &#8594; Theme colors or use the sidebar to set the font color.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This later shows a grid of colors: each column is one theme color and then the column offers various
lighter and darker variants of the color.</p></div>
<div class="paragraph"><p>And the important bit: if you later change theme colors, then the color of shape text (using theme
colors) is updated, even the effects (lighter or darker variants) are preserved.</p></div>
<div class="paragraph"><p>To set expectations, this only works for shape text for now, and only in Impress, as a start.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the high-level problem was addressed by a series of small changes. The first step was to
upstream work by <a href="https://tomazvajngerl.blogspot.com/">TomaÅ¾ Vajngerl</a> and <a href="https://quwex.com/">Sarper
Akdemir</a> from the <code>feature/themesupport2</code> feature branch:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125296">https://gerrit.libreoffice.org/c/core/+/125296</a> Theme color and tint/shade attribute for SvxColorItem
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125304">https://gerrit.libreoffice.org/c/core/+/125304</a> Support reading back theme color from an ooxml document
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125313">https://gerrit.libreoffice.org/c/core/+/125313</a> make colorsets work outside of styles and with direct formatting
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125394">https://gerrit.libreoffice.org/c/core/+/125394</a> expose the SvxColorItem theme related uno for draw/impress
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125404">https://gerrit.libreoffice.org/c/core/+/125404</a> implement initial pptx theme color import
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125414">https://gerrit.libreoffice.org/c/core/+/125414</a> rename getSchemeName getSchemeIndex to remove ambiguity
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125426">https://gerrit.libreoffice.org/c/core/+/125426</a> implement color tint or shade import for pptx
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125436">https://gerrit.libreoffice.org/c/core/+/125436</a> introduce XColorSetsManager interface
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125477">https://gerrit.libreoffice.org/c/core/+/125477</a> import pptx color schemes as color sets
</p>
</li>
</ul></div>
<div class="paragraph"><p>The rest of the work was to go through the usual stages of document model, UNO API, rendering,
ODP/PPTX filter and UI work to complete the work started on the branch:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125532">https://gerrit.libreoffice.org/c/core/+/125532</a> PPTX import: handle &lt;a:clrScheme name="&#8230;"&gt;
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125651">https://gerrit.libreoffice.org/c/core/+/125651</a> PPTX: implement native handling of &lt;a:clrScheme&gt; children
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125684">https://gerrit.libreoffice.org/c/core/+/125684</a> PPTX import: implement native handling of a color&#8217;s luminance modulation
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125749">https://gerrit.libreoffice.org/c/core/+/125749</a> PPTX import: implement native handling of a color&#8217;s luminance offset
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126011">https://gerrit.libreoffice.org/c/core/+/126011</a> tools Color: implement MSO-style luminance modulation/offset filter
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126082">https://gerrit.libreoffice.org/c/core/+/126082</a> svx: update objects of pages of a master page when the theme changes
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126164">https://gerrit.libreoffice.org/c/core/+/126164</a> PPTX export: write the theme for the master pages from the doc model
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126215">https://gerrit.libreoffice.org/c/core/+/126215</a> PPTX export: handle theme colors from the doc model for shape text
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126270">https://gerrit.libreoffice.org/c/core/+/126270</a> svx: consider color effects when updating objects for theme changes
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126400">https://gerrit.libreoffice.org/c/core/+/126400</a> PPTX export: handle theme color of shape text with effects
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126466">https://gerrit.libreoffice.org/c/core/+/126466</a> ODP export: write the theme of a master page
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126502">https://gerrit.libreoffice.org/c/core/+/126502</a> ODP import: handle theme of master pages
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126566">https://gerrit.libreoffice.org/c/core/+/126566</a> ODP import/export: refer to theme from shape text color
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126722">https://gerrit.libreoffice.org/c/core/+/126722</a> ODP import/export: refer to theme from shape text color with effects
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126798">https://gerrit.libreoffice.org/c/core/+/126798</a> sd: add initial theme UI for master slides
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126850">https://gerrit.libreoffice.org/c/core/+/126850</a> sd theme: add UI to set/get the name of a color set
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126905">https://gerrit.libreoffice.org/c/core/+/126905</a> sd theme: add UI to set individual colors of a color set
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126994">https://gerrit.libreoffice.org/c/core/+/126994</a> sd theme: add a "theme" palette to the color picker
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/127135">https://gerrit.libreoffice.org/c/core/+/127135</a> sd theme: allow setting the color&#8217;s theme index in the chardlg
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/127211">https://gerrit.libreoffice.org/c/core/+/127211</a> sd theme: allow setting color effects in the chardlg
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/127304">https://gerrit.libreoffice.org/c/core/+/127304</a> sd theme: allow setting color effects in the sidebar
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>You can get a snapshot / demo of Collabora Office and try it out yourself right now:
<a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF&#8217;s next release too (7.4).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-ole-update.html">Writer embedded objects: reliably update object previews</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 15 December 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Embedded objects in Writer consist of a native data part and a preview part. Until now, there was no
way to force the update of the preview part in case it was empty.</p></div>
<div class="paragraph"><p>Now the Tools &#8594; Update &#8594; Update all menu item updates such previews as well. This is especially
useful if you manipulate the ZIP/XML document directly to insert native data, then load it into
Writer to generate a preview.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://vector.com/">Vector</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Update all menu item already updates all sorts of generated content: fields, table of contents,
charts, the document layout, but not the preview of embedded objects. You could work this around by
double-clicking on the embedded object to re-generate the preview, but doing this manually for a
larger document is not efficient. This is especially useful for hand-crafted documents which have
proper native data, but no preview image yet.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here is how an embedded object without a preview looks like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-ole-update/old.png" alt="https://share.vmiklos.hu/blog/sw-ole-update/old.png" />
</div>
<div class="title">Figure 1. Writer embedded object with no preview</div>
</div>
<div class="paragraph"><p>Now using the Update all menu item turns a sample document into this preview:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-ole-update/new.png" alt="https://share.vmiklos.hu/blog/sw-ole-update/new.png" />
</div>
<div class="title">Figure 2. Writer embedded object with a preview</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p><a href="https://gerrit.libreoffice.org/c/core/+/126253">sw: update previews of OLE objects on
"update all"</a> is the change implementing this small feature. It works by:</p></div>
<div class="ulist"><ul>
<li>
<p>
Iterating over the frame formats ("special" formats) of the document
</p>
</li>
<li>
<p>
Filter out shapes
</p>
</li>
<li>
<p>
Filter out objects which are only reachable from the undo stack
</p>
</li>
<li>
<p>
Filter out objects which are not embedded ("OLE") objects
</p>
</li>
<li>
<p>
Once we have access to the OLE node, jump to its <code>SwOLEObj</code>, then to its <code>svt::EmbeddedObjectRef</code>,
  which knows how to re-calculate the preview bitmap
</p>
</li>
<li>
<p>
Finally notify the OLE node that the preview was updated, so the necessary repaint can happen
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.4).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-linked-styles.html">Start of linked paragraph and character styles in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 12 November 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Writer now has the start of linked character and paragraph styles. This improves DOCX compatibility,
extends ODT and it&#8217;ll improve the style previews and the UI in the future, hopefully.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://www.docmosis.com/">Docmosis</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Word allows linking paragraph and character styles together, which means only the paragraph one will
be present on the UI. Such a split has benefits if you customize the character properties on the UI
and later you want to update the paragraph properties from a template, for example.</p></div>
<div class="paragraph"><p>This is frequent markup in DOCX files, because Word defaults to splitting out the character
properties of a <code>Test</code> paragraph style into a <code>Test Char</code> character style on editing.</p></div>
<div class="paragraph"><p>Saving the document in Writer and then viewing it in Word lead to loosing these links, so their
style pickers started to show unwanted <code>Test Char</code> rows.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>We used to preserve such linking information when doing DOCX &#8594; DOCX conversion for a while, since
about 2013. But such preservation was in-memory, so if you saved the document to ODT, then such
information was lost. This approach also lacked a real document model, which is necessary to
incrementally build this feature into a complete solution.</p></div>
<div class="paragraph"><p>Here is how the style picker in Word looks like now, after a DOCX &#8594; ODT &#8594; DOCX pipeline:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-linked-styles/new.png" alt="https://share.vmiklos.hu/blog/sw-linked-styles/new.png" />
</div>
<div class="title">Figure 1. Word&#8217;s style picker, new output: no unwanted additional character styles</div>
</div>
<div class="paragraph"><p>Here is how this used to look like before the new changes (note the <code>Heading 1 Char</code> line between
<code>Heading</code> and <code>Index</code>):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-linked-styles/old.png" alt="https://share.vmiklos.hu/blog/sw-linked-styles/old.png" />
</div>
<div class="title">Figure 2. Word&#8217;s style picker, old output: unwanted additional character styles</div>
</div>
<div class="paragraph"><p>And here is how the input document looks like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-linked-styles/ref.png" alt="https://share.vmiklos.hu/blog/sw-linked-styles/ref.png" />
</div>
<div class="title">Figure 3. Word&#8217;s style picker, reference output: no unwanted additional character styles</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122595">sw: paragraph styles: add doc model &amp; UNO
  API for a linked character style</a> added the document model and API support
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122681">sw: paragraph styles: add DOCX filter for
  a linked character style</a> added the DOCX filter
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122753">sw: paragraph styles: add ODT filter for a
  linked character style</a> added the ODT filter
</p>
</li>
</ul></div>
<div class="paragraph"><p>Just to set expectations, this is currently an invisible feature, but unlike the old approach from 8
years ago, this one can be extended into a full feature, incrementally. It also survives ODT
roundtrips.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.3).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sd-table-transparent-shadow.html">Transparent shadow for tables from PPTX in Impress</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 22 October 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Impress is now able to correctly render shadows for table shapes, even if the shadow itself or the
fill of the table cells have transparency. The result is now compatible with PowerPoint.</p></div>
<div class="paragraph"><p>First, thanks to our partner <a href="https://www.suse.com/">SUSE</a> for working with
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>We got a PPTX document, which has a table shape with pink background and a blurry shadow. Impress
rendered a red background, making the text hard to read.</p></div>
<div class="paragraph"><p>The request was to improve the shadow rendering to be PowerPoint-compatible and in general correctly
support transparency when it comes to table cell fills and table shadows.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>The table shadow now looks like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/new.png" alt="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/new.png" />
</div>
<div class="title">Figure 1. New render result in Impress</div>
</div>
<div class="paragraph"><p>Matching the reference rendering:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/ref.png" alt="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/ref.png" />
</div>
<div class="title">Figure 2. Reference render result</div>
</div>
<div class="paragraph"><p>While background was red previously:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/old.png" alt="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/old.png" />
</div>
<div class="title">Figure 3. Old render result in Impress</div>
</div>
<div class="paragraph"><p>You can see that not only the background in the top center cell is pink now, but the blurry table
shadow is still correct.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the high-level problem was addressed by a series of fixes:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122349">tdf#144091 svx: fix unwanted blur of shadow from
  table cell fill</a>
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122532">Related: tdf#144091 svx: fix interaction of transp
  cell fill and transp shadow</a>
  (<a href="https://git.libreoffice.org/core/+/00fa364a2403dc23a786d3f91fde06e10b3a4a9a/svx/source/sdr/primitive2d/sdrdecompositiontools.cxx#629">key
  part</a>)
</p>
</li>
</ul></div>
<div class="paragraph"><p>With these, it&#8217;s now possible to add transparency to both table cell fills and to table shadows, and
the rendering will take both into account, correctly.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>You can get a snapshot / demo of Collabora Office and try it out yourself right now:
<a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF&#8217;s next release too (7.3).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-parastyle-listlevel.html">Start of list level support in Writer paragraph styles</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 29 September 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Writer now has the start of list level support in Writer paragraph styles. This improves ODT and
DOCX compatibility, and it&#8217;ll improve the style previews and the UI in the future.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://www.docmosis.com/">Docmosis</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>A paragraph might have an associated list in Writer and that list can have multiple levels. This is
direct formatting. When it comes to paragraph styles, referring to a list was already possible, but
defining a custom list level was not.</p></div>
<div class="paragraph"><p>Loosing this information in Word documents was quite annoying, and it turned out that ODF also has
markup for this, just LibreOffice didn&#8217;t implement it.</p></div>
<div class="paragraph"><p>This work is currently done for the document model, scripting API and file filters: style previews &amp;
UI still needs finishing.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Writer can at the moment preserve list level info from ODT and DOCX files. Here is how a file written
by Writer looks like in Word:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-parastyle-listlevel/parastyle-listlevel.png" alt="https://share.vmiklos.hu/blog/sw-parastyle-listlevel/parastyle-listlevel.png" />
</div>
<div class="title">Figure 1. Writer exporting a paragraph style with list level info</div>
</div>
<div class="paragraph"><p>You can see that the style preview in Word takes the list level into account. Doing the same and
applying the list level as part of applying the paragraph style on the Writer UI is still future work.</p></div>
<div class="paragraph"><p>Thanks to Justin Luth who did the follow-up work to adapt the DOC filter accordingly, and also doing
other related fixes.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/121141">tdf#137363 DOCX filter: don&#8217;t loose
  &lt;w:ilvl w:val="&#8230;"&gt; of paragraph styles</a> added document model, API and DOCX import/export support
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/121515">Related: tdf#137363 ODT import: handle
  style:list-level="&#8230;" for para styles</a> added ODT import/export support
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.3).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sd-groupshape-unshare.html">Unshare shape properties for the same type before insertion in Impress</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 30 August 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Shape properties were shared by shape type (e.g. shared between group shapes) before insertion into
a document model in Impress. This is now fixed: the property names and types are still shared to
help performance, but their values are no longer shared. This helps matching the user expectation
that separate opened documents don&#8217;t share information with each other.</p></div>
<div class="paragraph"><p>First, thanks to our partner <a href="https://www.suse.com/">SUSE</a> for working with
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>I was working on a testcase for
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=132696">tdf#132696</a> when I noticed that the
existing CppunitTest_oox_drawingml testsuite runs fine before my changes, also a newly added
testGroupShapeSmartArt testcase runs fine in isolation, but if I run the whole testsuite, then it
breaks.</p></div>
<div class="paragraph"><p>Further investigation revealed that in case testGroupShapeSmartArt is executed first, then testTdf131082 fails. This means:</p></div>
<div class="ulist"><ul>
<li>
<p>
the first document is opened
</p>
</li>
<li>
<p>
the first document is closed
</p>
</li>
<li>
<p>
the second document is opened
</p>
</li>
<li>
<p>
the second document is saved
</p>
</li>
</ul></div>
<div class="paragraph"><p>And at this point information from the first document is leaked to the second document, even if the
first document was already closed by the time we performed the save. It turns out the root cause was
<a href="https://bz.apache.org/ooo/show_bug.cgi?id=114206">i#114206</a> (reported in 2010), i.e. group shapes
shared their property values till they got inserted to the document model. The first document import
did not consume pending SmartArt properties on a to-be-inserted group shape, the second import was
looking for pending properties, found them. And then the second document&#8217;s save wrote those pending
properties to the file, leading to this unexpected leak.</p></div>
<div class="paragraph"><p>Here is how the first document looks like, containing the blue rectangles (a SmartArt):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-groupshape-unshare/first.png" alt="https://share.vmiklos.hu/blog/sd-groupshape-unshare/first.png" />
</div>
<div class="title">Figure 1. First document with a SmartArt</div>
</div>
<div class="paragraph"><p>Here is how the second document looks like, without a SmartArt:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-groupshape-unshare/second.png" alt="https://share.vmiklos.hu/blog/sd-groupshape-unshare/second.png" />
</div>
<div class="title">Figure 2. Second document after loading, no SmartArt</div>
</div>
<div class="paragraph"><p>And here is how the second document looks, after saving to PPTX and reloading:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-groupshape-unshare/second-saved.png" alt="https://share.vmiklos.hu/blog/sd-groupshape-unshare/second-saved.png" />
</div>
<div class="title">Figure 3. Second document after reloading, with a SmartArt</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <a href="https://git.libreoffice.org/core/commit/c6f25506b02fbd2a087b7e790283921bf8550206">fix</a> is to
split out part of <code>SvxItemPropertySet</code> to a separate class, so that we can keep sharing
<code>SvxItemPropertySet</code> between multiple instances of the same shape type (describing the name and type
of the various properties), while introducing a new <code>SvxItemPropertySetUsrAnys</code> that is specific to
each not-yet-inserted shape. This way each pending shape is independent, and in case they are not
inserted to the document model later, that results in no side-effects.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.3).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sc-xlsx-button-macro.html">Calc buttons with macros: better XLSX support</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 22 July 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Embedding macros to Calc documents and invoking them by clicking on buttons is a common use-case.
There was also decent support for importing these from XLSX (XLSM to be precise), but the export
side was not on par with the binary XLS export.</p></div>
<div class="paragraph"><p>Calc now got a series of incremental improvements to map our form controls (buttons in particular)
to OOXML&#8217;s form controls, especially when macros are assigned to such buttons.</p></div>
<div class="paragraph"><p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but the feature is
fully available in desktop Calc as well.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Excel has both
<a href="https://support.microsoft.com/en-us/office/assign-a-macro-to-a-form-or-a-control-button-d58edd7d-cb04-4964-bead-9c72c843a283">form
controls and ActiveX controls</a>, and
<a href="https://gerrit.libreoffice.org/c/core/+/94161">tdf#106181 XLSX export: output form controls</a>
last year started adding support for form control export to XLSX.</p></div>
<div class="paragraph"><p>Hoping that this will be mostly shared drawingML export code fixing (benefiting DOCX and PPTX as
well), it seemed reasonable to assume that we can improve button handling from the "it&#8217;s lost" state
to "it&#8217;s good enough" with some effort.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now Excel shows the button and you can click on it:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sc-xlsx-button-macro/new.png" alt="https://share.vmiklos.hu/blog/sc-xlsx-button-macro/new.png" />
</div>
<div class="title">Figure 1. Excel consuming our XLSM output with a button and a macro</div>
</div>
<div class="paragraph"><p>While it used to just refuse our export result:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sc-xlsx-button-macro/old.png" alt="https://share.vmiklos.hu/blog/sc-xlsx-button-macro/old.png" />
</div>
<div class="title">Figure 2. Excel refusing bad XLSM output</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the end goal was reached via a set of incremental commits:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118085">sc: don&#8217;t require ctrl-click when clicking
  on internal links of shapes</a> was a UX problem, users don&#8217;t finding Ctrl-click
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118168">XLSX export: improve handling of checkbox
  (form controls)</a> was an improvement to the existing checkbox export code, probably today&#8217;s Excel is just more strict in what it accepts
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118219">XLSX export: handle button form controls</a>
  adds the initial button support
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118401">XLSX import: fix handling of named ranges
  referring to PathMissing sheets</a> fixes an import problem around named ranges and external references
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118485">XLSX export: handle macros on button form
  controls</a> adds the macro bits of buttons
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118600">XSLX export, button form control: fix
  handling of no macros</a> is a fixup for non-macro buttons
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.3).</p></div>
</div>
</div>

  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/index2.html" class="button_accent">&larr; Older Posts</a>

</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>