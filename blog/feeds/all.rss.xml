<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"><channel><title>What is Miklos hacking</title><link>https://vmiklos.hu/blog/</link><description></description><lastBuildDate>Wed, 04 Dec 2024 11:34:30 +0100</lastBuildDate><item><title>Editeng RTF export: fixing a lost paragrpah style</title><link>https://vmiklos.hu/blog/editeng-rtf-export-lost-para-style.html</link><description>&lt;p&gt;Impress shape text doesn't have much support for styles, e.g. the default UI in Writer gives you a
paragraph style dropdown, and you don't get the same in Impress. Still, a paragraph style is
attached to bullets based on their outline level, and Impress has a View → Outline menu item to give
you that styled text you can copy. Pasting that to Writer started to lose styles recently and it's
now fixed to work again.&lt;/p&gt;
&lt;p&gt;This work is primarily for &lt;a href="https://www.collaboraonline.com/"&gt;Collabora Online&lt;/a&gt;, but the feature is
available in desktop Impress as well.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As described in a &lt;a href="https://git.libreoffice.org/core/commit/70d1bd6ee0eba9d6661cd6280566f77a87f2d068"&gt;previous
commit&lt;/a&gt;, I had a
case where lots of not needed paragraph styles were exported to RTF in case an Impress document had
enough master pages. The idea was to only export actually used paragraph styles, to avoid wasting
CPU power.&lt;/p&gt;
&lt;p&gt;Turns out filtering out paragraph styles has to happen at two locations:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;in the style table to assign an index to a paragraph style&lt;/li&gt;
&lt;li&gt;when referring to those styles&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The problem was that unused styles were removed from the style table, but not from the style → index
mapping, so as soon as you had both used and unused paragraph styles, the declared and the referred
style indexes didn't match anymore.&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Here is a sample paste result in Writer, where you can see that the text doesn't have a custom
paragraph style:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/editeng-rtf-export-lost-para-style/old.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/editeng-rtf-export-lost-para-style/old.png"&gt;&lt;figcaption&gt;Bugdoc: old Writer paste&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;And here is the same paste, now with paragraph styles restored:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/editeng-rtf-export-lost-para-style/new.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/editeng-rtf-export-lost-para-style/new.png"&gt;&lt;figcaption&gt;Bugdoc: new Writer paste&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;As you can see, now the pasted text has paragraph styles.&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;The bugfix commit was &lt;a href="https://git.libreoffice.org/core/commit/c8b607b7c0096c58dc5187262bf0133dee728d50"&gt;editeng RTF export: fix broken offsets into the para style table&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The tracking bug was &lt;a href="https://bugs.documentfoundation.org/show_bug.cgi?id=163883"&gt;tdf#163883&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a development edition of Collabora Online 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraonline.com/code/"&gt;try
the development edition&lt;/a&gt;.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Wed, 04 Dec 2024 11:34:30 +0100</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-12-04:/blog/editeng-rtf-export-lost-para-style.html</guid><category>libreoffice</category><category>en</category></item><item><title>Handling page captures for Writer TextBoxes</title><link>https://vmiklos.hu/blog/sw-textbox-capture.html</link><description>&lt;p&gt;Writer TextBoxes provide the user with shapes that can have complex geometry and complex content.
There is also a feature to capture shapes inside page boundaries: now the two features interact with
each other better.&lt;/p&gt;
&lt;p&gt;This work is primarily for &lt;a href="https://www.collaboraonline.com/"&gt;Collabora Online&lt;/a&gt;, but the feature is
available in desktop Writer as well.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As described in a &lt;a href="https://vmiklos.hu/blog/textbox.html"&gt;previous post&lt;/a&gt;, Writer implements the TextBox
feature with a pair of objects: a Draw shape (with complex geometry) and a (hidden) Writer TextFrame,
providing complex content. To avoid wrapping problems, the underlying TextFrame always has its wrap
type set to "through", i.e. text may wrap around the Draw shape, but the hidden TextFrame is always
ignored during text wrapping.&lt;/p&gt;
&lt;p&gt;In most cases this provides the expected behavior, because the user sees one object, so wrapping
around at most one object is not surprising.&lt;/p&gt;
&lt;p&gt;However, there is also an other feature, that shapes may be captured inside page frames: if their
position would be outside the page frame, Writer corrects this, so they are not off-page. This also
makes sense, so it can't happen that your document has a shape that is hard to find, due to a silly
position.&lt;/p&gt;
&lt;p&gt;The trouble comes when these two are combined: the Draw shape's position gets adjusted to be
captured inside the page frame, but the TextFrame's wrap type is "through", and objects with this
wrap type are an exception from the capturing mechanism, so the position of the two shapes get out
of sync.&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The problem is now solved by improving the layout, so in case the TextFrame is actually part of a
Draw shape + TextFrame pair (forming a TextBox), then we calculate the effective wrap type of the
TextFrame based on the wrap type of its Draw shape, so either both objects are captured or none,
which results in consistent render result.&lt;/p&gt;
&lt;p&gt;Here is a sample document where all margins are configured to be equal, but capturing corrected the
Draw shape (and not the TextFrame):&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-textbox-capture/old.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-textbox-capture/old.png"&gt;&lt;figcaption&gt;Bugdoc: old Writer render&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;And here is the same document, with consistent positioning:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-textbox-capture/new.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-textbox-capture/new.png"&gt;&lt;figcaption&gt;Bugdoc: new Writer render&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;As you can see, now the rendered margins actually equal, as wanted.&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;The bugfix commit was &lt;a href="https://git.libreoffice.org/core/commit/c8549fa3204802daec8597ba0f9f4f7ef23d5cd2"&gt;sw textbox: capture fly when its draw object is captured&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The tracking bug was &lt;a href="https://bugs.documentfoundation.org/show_bug.cgi?id=138711"&gt;tdf#138711&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a development edition of Collabora Online 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraonline.com/code/"&gt;try
the development edition&lt;/a&gt;.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Fri, 08 Nov 2024 08:58:46 +0100</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-11-08:/blog/sw-textbox-capture.html</guid><category>libreoffice</category><category>en</category></item><item><title>Per-paragraph semi-transparent shape text in Impress</title><link>https://vmiklos.hu/blog/sd-semi-transparent-text2.html</link><description>&lt;p&gt;The SVG export in Impress now supports a per-paragraph setting to handle semi-transparent shape
text, while previously this was only possible to control at a per-shape level.&lt;/p&gt;
&lt;p&gt;This work is primarily for &lt;a href="https://www.collaboraonline.com/"&gt;Collabora Online&lt;/a&gt;, but the feature is
available in desktop Impress as well.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As described in a &lt;a href="https://vmiklos.hu/blog/sd-semi-transparent-text.html"&gt;previous post&lt;/a&gt;, Impress already
had the capability to have semi-transparent shape text, but the SVG export of this for the case when
not all paragraphs have the same setting was broken.&lt;/p&gt;
&lt;p&gt;Transparency in SVG can be described as a property of a group (&lt;code&gt;&amp;lt;g style="opacity: 0.5"&amp;gt;...&amp;lt;/g&amp;gt;&lt;/code&gt;)
and it can be also a property of the text (&lt;code&gt;&amp;lt;tspan fill-opacity="0.5"&amp;gt;...&amp;lt;/tspan&amp;gt;&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;The SVG export works with the metafile of the shape, so when looking for meta actions, it tries to
guess if the transparency will be for text: if so, it needs to use the &lt;code&gt;tspan&lt;/code&gt; markup, otherwise
going with the &lt;code&gt;g&lt;/code&gt; markup is OK.&lt;/p&gt;
&lt;p&gt;What happened here is that meta action for a normal text started, so the SVG export assumed the text
is not semi-transparent, but later the second line was still transparent, so we started a group
element, and this resulted in a not even well-formed XML output.&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The relevant part of the test document is simple: just 3 paragraphs, the second one is
semi-transparent (and also has a bullet, as an extra):&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-1input.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-1input.png"&gt;&lt;figcaption&gt;Bugdoc: original Impress render&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Once this was exported to SVG, this resulted in a non-well-formed XML, so you got this error in a
web browser:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-2bad.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-2bad.png"&gt;&lt;figcaption&gt;Bugdoc: old SVG render&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Once tweaking the transparency mask writer to check if text started already, we get the correct SVG
render:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-3good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-3good.png"&gt;&lt;figcaption&gt;Bugdoc: new SVG render&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;The bugfix commit was &lt;a href="https://git.libreoffice.org/core/commit/0a89d65e6bb7be293c1a7b4615a08292701694dc"&gt;SVG export: fix handling of semi-transparent text inside a
list&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The tracking bug was &lt;a href="https://bugs.documentfoundation.org/show_bug.cgi?id=162782"&gt;tdf#162782&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a development edition of Collabora Online 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraonline.com/code/"&gt;try
the development edition&lt;/a&gt;.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Fri, 04 Oct 2024 08:22:01 +0200</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-10-04:/blog/sd-semi-transparent-text2.html</guid><category>libreoffice</category><category>en</category></item><item><title>Improved interactivity for LOK clients in Writer's layout</title><link>https://vmiklos.hu/blog/sw-anyinput-lok.html</link><description>&lt;p&gt;Writer now has support for doing partial layout passes when LOK clients have pending events, which
sometimes improves interactivity a lot.&lt;/p&gt;
&lt;p&gt;This work is primarily for &lt;a href="https://www.collaboraonline.com/"&gt;Collabora Online&lt;/a&gt;, but the feature is
useful for any LOK clients.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;I recently worked with a document that has relatively simple structure, but it has 300 pages, and
most of the content is part of a numbered list. Pasting a simple string (like an URL) into the end
of a paragraph resulted in a short, but annoying hang. It turns out we updated Writer's layout for
all the 300 pages before the content was repainted on the single visible page. In theory, you
could reorder events, so you first calculate the first page, you paint the first page, then you
calculate the remaining 299 pages. Is this possible in practice? Let's try!&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The relevant part of the test document is simple: just an empty numbered paragraph, so we can paste
somewhere:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-anyinput-lok/paste.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-anyinput-lok/paste.png"&gt;&lt;figcaption&gt;Bugdoc: empty paragraph, part of a numbered list and then pasting an URL there&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This is a good sample, because pasting into a numbered list requires invalidating all list items in that
list, since possibly the paste operation created a new list item, and then the number portion has to
be updated for all items in the rest of the list. So if you paste into a numbered list, you need to
re-calculate the entire document if all the document is just a numbered list.&lt;/p&gt;
&lt;p&gt;The first problem was that Writer tracks its visible area, but LOK needs two kinds of visible areas.
The first kind decides if invalidations are interesting for part of the document area. LOK wants to
get all invalidations, so in case we cache some document content in the client that is near the
visible area, we need to know when to throw away that cache.  On the other hand, we want to still
track the actually visible viewport of the client, so we can prioritize visible vs hidden parts of
the document. Writer in LOK mode thought that all parts of the document are a priority, but this
could improved by taking the client's viewport into account.&lt;/p&gt;
&lt;p&gt;The second problem was that even if Writer had two layout passes (first is synchronous, for the
visible area; second is async, for the rest of the document), both passes were performed before
allowing a LOK client to request tiles for the issued invalidations.&lt;/p&gt;
&lt;p&gt;This is now solved by a new &lt;code&gt;registerAnyInputCallback()&lt;/code&gt; API, which allows the LOK client to signal if
it has pending events (e.g. unprocessed callbacks, tiles to be painted) or it's OK for Writer layout
to finish its idle job first.&lt;/p&gt;
&lt;p&gt;The end result for pasting a URL into this 300 pages document, when measuring end-to-end (from
sending the paste command to getting the first updated tile) is a decrease in response time, from
963 ms to 14 ms.&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;As usual, the high-level problem was addressed by a series of small changes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/e1e77b313c9fe0fff814384a67de415e33c8b27f"&gt;cool#9735 sw lok: take LOK vis area into account when deciding idle layout&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/a22fe103e7a26270b7213448c570400a563c18ba"&gt;Related: cool#9735 vcl lok: add an AnyInput() callback&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/41aec3e9a088ad4e99e43e033c7653e2c25a85ba"&gt;Related: cool#9735 sw lok: handle the AnyInput() callback during idle layout&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/3974af7dca82f887dfdfe88f087583508c19e7ab"&gt;sfx2: fix crash in SfxObjectShell::IsHelpDocument()&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The tracking issue for this problem was
&lt;a href="https://github.com/CollaboraOnline/online/issues/9735"&gt;cool#9735&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a development edition of Collabora Online 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraonline.com/code/"&gt;try
the development edition&lt;/a&gt;.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Tue, 03 Sep 2024 08:08:13 +0200</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-09-03:/blog/sw-anyinput-lok.html</guid><category>libreoffice</category><category>en</category></item><item><title>Improved font fallback in the DOCX import of Writer</title><link>https://vmiklos.hu/blog/sw-improved-font-falback.html</link><description>&lt;p&gt;Writer now has improved support for font fallback when you open a DOCX file that refers to fonts
which are not available currently.&lt;/p&gt;
&lt;p&gt;This work is primarily for &lt;a href="https://www.collaboraoffice.com/"&gt;Collabora Online&lt;/a&gt;, but the feature is
fully available in desktop Writer as well.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Font embedding is meant to solve the problems around missing fonts, but you can also find documents
with stub embedded fonts that are to be ignored and our code didn't have any sanity check on such
fonts, leading to unexpected glyph-level fallbacks. Additionally, once font-level fallback happened,
we didn't take the font style (e.g. sans vs serif) into account, which is expected to work when
finding a good replacement for the missing font.&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Here is how to the original rendering looked like:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-improved-font-falback/old.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-improved-font-falback/old.png"&gt;&lt;figcaption&gt;Bugdoc, before: ugly glyph-level fallback&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Once the handler for the embedded fonts in ODT/DOCX was improved to ignore stub fonts where even
basic glyphs were not available, the result was a bit more consistent, but still bad. Here is a
different document to show the problem:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-improved-font-falback/first.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-improved-font-falback/first.png"&gt;&lt;figcaption&gt;Bugdoc, first improvement: no glyph fallback but the result is sans&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Note how now we used the same font, but the glyphs are always sans, not serif. So the final step was
to import the font type from DOCX and consider that while deciding font fallback:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-improved-font-falback/second.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-improved-font-falback/second.png"&gt;&lt;figcaption&gt;Bugdoc, second improvement: no glyph fallback and the result is sans / serif&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;With this, we ignore stub embedded fonts from DOCX, we import the font type and in general font
fallback on Linux takes the font type into account while deciding font fallback.&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;As usual, the high-level problem was addressed by a series of small changes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/a9f3c11375525a7708378dd3648febc40db1ad20"&gt;tdf#162002 DOCX import: ignore subsetted embedded fonts for editing&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/09da7fd9cec9b36f2e09c1105a9263b83e2c66e4"&gt;tdf#162002 DOCX import, font embed: only discard subset fonts with few glyphs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/6dfac38bacd449c64a13363797b56aff49cf8f52"&gt;tdf#162072 vcl, fontconfig: consider font-family-generic for substitute&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/d06de2e049761b7b9e8a95f17557d309812f7acc"&gt;Related: tdf#162072 DOCX import: handle font family for characters&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/ef1870810ec8c069e26538fd7626ad0656bed276"&gt;tdf#162280 vcl: consider font family type for glyph caching&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a development edition of Collabora Online 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraoffice.com/code/"&gt;try
the development edition&lt;/a&gt;.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (24.8).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Wed, 07 Aug 2024 09:05:24 +0200</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-08-07:/blog/sw-improved-font-falback.html</guid><category>libreoffice</category><category>en</category></item><item><title>Fixing handling of line object transformations in the DOCX import of Writer</title><link>https://vmiklos.hu/blog/sw-drawingml-line-transform.html</link><description>&lt;p&gt;Writer now has improved support for toplevel line shapes when you import those from DOCX.&lt;/p&gt;
&lt;p&gt;This work is primarily for &lt;a href="https://www.collaboraoffice.com/"&gt;Collabora Online&lt;/a&gt;, but the feature is
fully available in desktop Writer as well.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As described in a &lt;a href="https://vmiklos.hu/blog/lo-writer-drawingml-shape-improvements.html"&gt;post from 2014&lt;/a&gt;,
Writer reads the drawingML markup for shapes in DOCX files, including line shapes. While
investigating a simple-looking problem around a horizontal vs vertical line, it turns out that there
is a deeper issue here, and it looks like now have proper fix for this bug.&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Imagine that your company template has a nice footer in two columns, and the content in the columns
are separated by a vertical line shape, but when you open your DOCX in Writer, it crosses the text
of that footer instead:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-drawingml-line-transform/diff-old.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-drawingml-line-transform/diff-old.png"&gt;&lt;figcaption&gt;Bugdoc, before: reference is red, Writer result is painted on top of it&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;While researching how line shapes are represented in our document model and how ODT import works, it
turned out that the proper way to create a line shape is to only consider size / scaling when it
comes to the individual points of the line, everything else (e.g. position / translation) should go
to the transform matrix of the shape, then the render result will be as expected:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-drawingml-line-transform/diff-new.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-drawingml-line-transform/diff-new.png"&gt;&lt;figcaption&gt;Bugdoc, after: reference is red, Writer result is painted on top of it&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;It was also interesting to see that this also improved other, existing test documents, e.g. core.git
&lt;code&gt;sw/qa/extras/ooxmlimport/data/line-rotation.docx&lt;/code&gt; looked like this before:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/line-rotation-diff-old.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-drawingml-line-transform/line-rotation-diff-old.png"&gt;&lt;figcaption&gt;3 rotated lines, before: reference is red, Writer result is painted on top of it&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;And the same fix makes it perfect:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/line-rotation-diff-new.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-drawingml-line-transform/line-rotation-diff-new.png"&gt;&lt;figcaption&gt;3 rotated lines, after: reference is red, Writer result is painted on top of it&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Just stick to the rule: scaling goes to the points -- translation, rotation and horizontal shear
goes to the shape.&lt;/p&gt;
&lt;p&gt;For now, this is only there for toplevel Writer lines, but in-groupshape and Calc/Impress lines
could also follow this technique if there is a practical need.&lt;/p&gt;
&lt;p&gt;The "after" screenshots show ~no red, which means there is ~no reference output, where the Writer
output would be missing.&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;The bugfix commit was &lt;a href="https://git.libreoffice.org/core/commit/6c09c85ec384e88c89bff0817e7fe9889d7ed68e"&gt;tdf#161779 DOCX import, drawingML: fix handling of translation for
lines&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The tracking bug was &lt;a href="https://bugs.documentfoundation.org/show_bug.cgi?id=161779"&gt;tdf#161779&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a development edition of Collabora Online 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraoffice.com/code/"&gt;try
the development edition&lt;/a&gt;.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (24.8).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Tue, 09 Jul 2024 14:46:01 +0200</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-07-09:/blog/sw-drawingml-line-transform.html</guid><category>libreoffice</category><category>en</category></item><item><title>Section-based continuous endnotes in Writer</title><link>https://vmiklos.hu/blog/sw-continuous-endnotes2.html</link><description>&lt;p&gt;Writer now has much better support for continuous / inline endnotes (not on a separate page) in
Writer, enabled by default for DOCX files.&lt;/p&gt;
&lt;p&gt;This work is primarily for &lt;a href="https://www.collaboraoffice.com/"&gt;Collabora Online&lt;/a&gt;, but the feature is
fully available in desktop Writer as well.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As described in a &lt;a href="https://vmiklos.hu/blog/sw-continuous-endnotes.html"&gt;previous post&lt;/a&gt;, Writer already had
minimal support for not rendering endnotes on a separate endnote page, but it was not mature enough
to enable is by default for DOCX files.&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;What changed from the previous "continuous endnotes" approach is that instead of trying to map
endnotes to footnotes, we now create a special endnotes section, which only exists at a layout level
(no section node is backing this one), and this hosts all endnotes at the end of the document. It
turns out this is a much more scalable technique, for example a stress-test with 72 endnotes over
several pages is now handled just fine.&lt;/p&gt;
&lt;p&gt;Here are some screenshots:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-continuous-endnotes2/old.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-continuous-endnotes2/old.png"&gt;&lt;figcaption&gt;Before: reference is red, Writer result is painted on top of it&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-continuous-endnotes2/new.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-continuous-endnotes2/new.png"&gt;&lt;figcaption&gt;After: reference is red, Writer result is rendered on top of it&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;As you can see, there were various differences for this document, but the most problematic one was
that the entire endnote was missing from the (originally) last page, as it was rendered on a
separate page.&lt;/p&gt;
&lt;p&gt;Now it's not only on the correct page, but also its position is correct: the endnote is after the
body text, while the footnote is at the bottom of the page, as expected. The second screenshot shows
~no red, which means there is ~no reference output, where the Writer output would be missing.&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;As usual, the high-level problem was addressed by a series of small changes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/90f19126fa405a0632eae4ee8525b66bbce12625"&gt;tdf#160984 sw continuous endnotes: introduce an endnote section&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/8bae684c93bd23bbe98707ba9cf75d1a39427131"&gt;tdf#160984 sw continuous endnotes: add a way to find the endnote section start&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/ab3416cad1dd4e706432f9b1a3592cec823c76b0"&gt;tdf#160984 sw continuous endnotes: fix testContinuousEndnotesMoveBackwards&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/9c7acbc937b3b341c10187b837e09cc20399f04e"&gt;tdf#160984 sw continuous endnotes: fix &lt;code&gt;CppunitTest_sw_layoutwriter3&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/6885dcd7ec7b82a946d8344bfc27a3e88eecc44a"&gt;tdf#160984 sw continuous endnotes: switch to a section-based layout&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/82dd81a9d2049ac95535880fc67c1867f90e1427"&gt;tdf#161083 sw continuous endnotes: fix layout with a section at doc end&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/d74fb6b571304b41c13b7a6dcdd2b853bfca7210"&gt;tdf#160984 sw continuous endnotes, DOC import: enable this unconditionally&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/1ae5ea3f78cca11ba18f2dd1a06f875263336a3b"&gt;tdf#160984 sw continuous endnotes: enable DOCX import&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/d1ddd136a1b0e452492464d58715eaec144fd811"&gt;tdf#160984 sw continuous endnotes: fix the endnote container's top margin&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/f1d0b4e34a1f467e9f54baa7ac31ca28fdae3efb"&gt;tdf#160984 sw continuous endnotes: fix the endnote separator position&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/755f3bebd96ec7ae43b1dcf247f907b9c15c1995"&gt;tdf#160984 sw continuous endnotes: fix the endnote separator length&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/3f2d0414686a8f9a042413c47c4c8ffa5d61f436"&gt;tdf#160984 sw continuous endnotes: fix crash on loading forum-mso-en-7731.docx&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/2d2dd56e0b2dc708f1f758d7fc9a1263ff09b83c"&gt;tdf#160984 sw continuous endnotes: DOCX: import &lt;code&gt;&amp;lt;w:endnotePr&amp;gt;&lt;/code&gt; pos == sectEnd&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/566c7017a84e3d573de85a6d986b81d3f59de0fa"&gt;tdf#160984 sw continuous endnotes: DOCX: export of &lt;code&gt;&amp;lt;w:endnotePr&amp;gt;&lt;/code&gt; pos == sectEnd&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/6450159e0e7c5fac9c998087e99f3fec602ff84d"&gt;tdf#160984 sw continuous endnotes: fix the endnote continuation separator len&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/8f3e11dc9a4b3fd9ad1985d88b241df7bcb66fec"&gt;tdf#160984 sw continuous endnotes: hide not functional UI in this mode&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The tracking bug was &lt;a href="https://bugs.documentfoundation.org/show_bug.cgi?id=160984"&gt;tdf#160984&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a development edition of Collabora Online 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraoffice.com/code/"&gt;try
the development edition&lt;/a&gt;.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (24.8).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Mon, 03 Jun 2024 16:26:52 +0200</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-06-03:/blog/sw-continuous-endnotes2.html</guid><category>libreoffice</category><category>en</category></item><item><title>Improved copy &amp; paste in Collabora Online: the copy side</title><link>https://vmiklos.hu/blog/cool-clipboard-copy.html</link><description>&lt;p&gt;&lt;a href="https://www.collaboraoffice.com/"&gt;Collabora Online&lt;/a&gt; now uses the &lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API"&gt;Clipboard
API&lt;/a&gt; if it's available in the used
browser, getting rid of many annoying dialogs.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The &lt;a href="https://vmiklos.hu/blog/sc-clipboard-paste.html"&gt;paste side&lt;/a&gt; was covered by an earlier post, but in
short, if you're on Chrome (or Safari), you won't see the "can't paste" dialog:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-paste-bad.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-paste-bad.png"&gt;&lt;figcaption&gt;"Can't paste" dialog in COOL 23.05&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Also you won't see a "Can't paste special" dialog:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-pastespecial-bad.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-pastespecial-bad.png"&gt;&lt;figcaption&gt;"Can't paste special" dialog in COOL 23.05&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Wouldn't it be nice to improve the copy side in a similar way?&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The primary reason why we needed similar, annoying dialogs for copy in the past is that the
clipboard API was synchronous but the network API is async. This means that writing to the clipboard
("copy") is only possible with data that we have in the browser when the copy is executed. This is a
problem, since in general we don't have data for your selection in the browser.&lt;/p&gt;
&lt;p&gt;With the Clipboard API, the copy side can be improved as well. Instead of always fetching the HTML
for a simple selection (even if you don't copy) and having a three step copy for complex selections,
async clipboard write is now possible. This gets us rid of the "You need to download" dialog:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-copy-bad1.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-copy-bad1.png"&gt;&lt;figcaption&gt;"You need to download" dialog in COOL 23.05&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Also it eliminates the "Download completed dialog:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-copy-bad2.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/cool-clipboard-copy/2024-05-02-copy-bad2.png"&gt;&lt;figcaption&gt;"Download completed" dialog in COOL 23.05&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Instead, we still need to nominally write to the clipboard in the special keyboard or click context
initiating the copy (Chrome doesn't require this, Safari does), but the written object can be a
callback that will do the network operation for us.&lt;/p&gt;
&lt;p&gt;Unfortunately it's hard to screenshot the new code, since part of the result is that all these
dialogs are now eliminated, copy &amp;amp; paste just works. :-)&lt;/p&gt;
&lt;p&gt;Note that this can be used also in Firefox, but first you need to set
&lt;code&gt;dom.events.asyncClipboard.clipboardItem&lt;/code&gt; to &lt;code&gt;true&lt;/code&gt; in &lt;code&gt;about:config&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The last part was to adapt tests to this new world, because previously it was handy to just create a
selection and assert what would be copied to the clipboard as HTML, but now we don't download the
HTML anymore every time you create a selection.&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;As usual, the high-level problem was addressed by a series of small changes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/25342ed3172d3689309ed0833bdd2d3248818c56"&gt;Related: cool#8648 clipboard: extract parseClipboard() from Control.DownloadProgress.js&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/ea8202268ce4aa772a6e89cb58508d862b5e82d7"&gt;Related: cool#8648 clipboard: use JSON when requesting HTML only&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/75251f9496f44f8678e43c1525719e5e4cc3b6ee"&gt;cool#8648 clipboard: try to use navigator.clipboard.write()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/286cd1ccf7f354e212bef4f02f4b51c50e37800c"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/writer/copy_paste_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/803df018daf8575674ad4483d181f9c65fddd842"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/calc/clipboard_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/635a45aac07c58a14d4dce38145fd28eea3ae04d"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/writer/undo_redo_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/b3f2c690d8c610bffd2584b8d02b095bb144ed16"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/writer/track_changes_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/91c702e42012b59f7747a0cfb1a1394cbcc180ff"&gt;cool#8648 clipboard: fix &lt;code&gt;most of desktop/writer/top_toolbar_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/1f0aec8f19ddb6053f48625fabdf19d8e59049bb"&gt;cool#8648 clipboard: fix insert hyperlink dialog&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/56adf9983e60ad6259b28e2a24fa2c1b67209c56"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/writer/table_operation_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/1e4afce8a193de2d307737f029f5a9096582ec7b"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/writer/searchbar_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/406dad2128a2a5daa8f24e4728560bbdccbcd1e7"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/writer/notebookbar_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/359e7eca6772dd0daf6b7dcfb5bc6e9b628510fc"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/writer/editable_area_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/770feebf1318d8f4ab4bd68d13957cfaf6aee74d"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/impress/undo_redo_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/c10cc6d8b8b6fb60a3a1248d0f8d73ce37af5a17"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/impress/delete_objects_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/7f9c80988153b88c3ffb4a490c1f9d2d3da2ed39"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/calc/undo_redo_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/e396df494cab6f88dfa0d51b91d44a35db8dd7f1"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/calc/top_toolbar_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/5bf298243f5c1b6621cbb237d40358d5c411ec67"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/calc/searchbar_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/a8d4a3e8592d3fcdd8a9007b49613a3fa5f58bf3"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/calc/searchbar_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/67d38b64a4af4fc949ea19388a996f3818a4b03d"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/calc/focus_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/25b377efb44bcde58df160edabc486eecfc73144"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/calc/delete_objects_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/3c9272c1bf3b2f6cf14edb8a590d8f3fb7ab7d02"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/calc/autofilter_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/fdb1f8c7fc101a75a7a90ad6b06cfb3a417ffab4"&gt;cool#8648 clipboard: fix &lt;code&gt;desktop/calc/cell_appearance_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/4c5adb70e6946d8d9e01bf8d7b45744b02f1310b"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/calc/apply_font_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/0c21b6e833de9aa257313ad3b514564c6209139f"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/calc/autofilter_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/a5d05f23647df8987f053dd7e7b7d42e9bc15a0c"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/calc/bottom_toolbar_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/2b37f2113f71d13d8c3bbd29f248713cb88e865d"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/calc/cell_appearance_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/a12bcd3fb0b990566a8f2be0a4de2c2bff5236a1"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/calc/delete_objects_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/3a1dd02dd15a184d4a54b28a84bf9079b6934029"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/calc/insertion_wizard_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/9ea5add21752c234145e6d78c4ceb56c06e1b4e5"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/calc/searchbar_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/283b5a1637121d00f5d41d2067f2221fde1d14ff"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/calc/spellchecking_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/027a87157bd723d79ef2329d1cd7e41ade2e01e9"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/impress/delete_objects_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/ad737657c6c3fe37e703587b869aba100a9228e6"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/impress/impress_focus_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/1dc4bae0c96462c18a14ce634675b6f898926c8b"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/impress/insertion_wizard_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/04a6af39cfb6949eab23c041656c05f7dfc026ef"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/impress/spellchecking_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/a2db31f4378f5561b19afb53150e9ef0871f2e74"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/writer/apply_font_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/9cca40deda7df20d72d6f96e5b91fa71ced89312"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/writer/delete_objects_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/ad22a9f017b15658d90a50c011e5bcf8c2c64b87"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/writer/insert_formatting_mark_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/a91036247b79403a6d8af9fec559de4cbc76045b"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/impress/insertion_wizard_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/82dc3e1a46908c1306360cd335243d4345e842b0"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/writer/track_changes_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/9b95bf829fefba288ff296c57e4323356e673ded"&gt;cool#8648 clipboard: fix &lt;code&gt;mobile/writer/table_properties_spec.js&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/28e51d58f446bb081a9630672f0b410b1e385886"&gt;cool#8648 clipboard: stop fetching the clipboard on text selection create in tests&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/CollaboraOnline/online/commit/24109be2e3889a45cfa90f0fa0cfce827a17f53b"&gt;cool#8648 clipboard: fix idle tests&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The tracking issue was &lt;a href="https://github.com/CollaboraOnline/online/issues/8648"&gt;cool#8648&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a development edition of Collabora Online 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraoffice.com/code/"&gt;try
the development edition&lt;/a&gt;.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Fri, 03 May 2024 08:19:04 +0200</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-05-03:/blog/cool-clipboard-copy.html</guid><category>collabora-online</category><category>en</category></item><item><title>Improve copy&amp;paste in Calc and elsewhere</title><link>https://vmiklos.hu/blog/sc-clipboard-paste.html</link><description>&lt;p&gt;Calc now supports much better copy&amp;amp;paste when you transfer data between Google Sheets and Calc.&lt;/p&gt;
&lt;p&gt;This work is primarily for &lt;a href="https://www.collaboraoffice.com/"&gt;Collabora Online&lt;/a&gt;, but the feature is
fully available in desktop Calc as well.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;First, Collabora Online was using the
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/execCommand"&gt;deprecated&lt;/a&gt;
&lt;code&gt;document.execCommand()&lt;/code&gt; API to paste text, which is problematic, as the "paste" button on the
toolbar can't behave the same way as pressing Ctrl-V on the keyboard.&lt;/p&gt;
&lt;p&gt;Second, it turns out Google Sheets came up with some additional HTML attributes to represent
spreadsheet data in HTML in a much better way, and Calc HTML import/export had no support for this,
while this is all fixable.&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In short, Collabora Online now uses the &lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/Clipboard/read"&gt;Clipboard
API&lt;/a&gt; to read from the system
clipboard -- this has to be supported by the
&lt;a href="https://sdk.collaboraonline.com/docs/advanced_integration.html#allow-the-clipboard-permission-query"&gt;integration&lt;/a&gt;,
and Calc's HTML filter now support the subset of the Google Sheets markup I figured out so far. This
subset is also
&lt;a href="https://sdk.collaboraonline.com/docs/advanced_integration.html#spreadsheet-html-extensions"&gt;documented&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Note that the default behavior is that the new Clipboard API is available in Chrome/Safari, but not
in Firefox.&lt;/p&gt;
&lt;p&gt;For the longer version, here are some screenshots:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-15-cool-clipboard-popup.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-15-cool-clipboard-popup.png"&gt;&lt;figcaption&gt;We used to show a popup when you clicked on the paste button on the notebookbar&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-18-cool-clipboard-image-paste.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-18-cool-clipboard-image-paste.png"&gt;&lt;figcaption&gt;The new paste code in action, handling an image&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-31-sc-html-import-text-bad.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-01-31-sc-html-import-text-bad.png"&gt;&lt;figcaption&gt;Import from Google Sheets to Calc: text is auto-converted to a number, bad&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-01-sc-html-import-text-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-01-sc-html-import-text-good.png"&gt;&lt;figcaption&gt;Import from Google Sheets to Calc: text is no longer auto-converted to a number, good&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-02-sc-html-import-celledit-fix.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-02-sc-html-import-celledit-fix.png"&gt;&lt;figcaption&gt;HTML import into an active cell edit, only RTF was working there previously&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-07-sc-html-paste-text-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-07-sc-html-paste-text-good.png"&gt;&lt;figcaption&gt;Paste from Google Sheets to Calc: text is no longer auto-converted to a number, good&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-08-sc-html-paste-boolean-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-08-sc-html-paste-boolean-good.png"&gt;&lt;figcaption&gt;Paste from Google Sheets to Calc: booleans are now also preserved&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-09-sc-html-paste-numfmt-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-09-sc-html-paste-numfmt-good.png"&gt;&lt;figcaption&gt;Paste from Google Sheets to Calc: number formats are now also preserved&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-12-sc-html-paste-formula-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-12-sc-html-paste-formula-good.png"&gt;&lt;figcaption&gt;Paste from Google Sheets to Calc: formulas are now also preserved&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-13-sc-html-paste-singlecell-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-13-sc-html-paste-singlecell-good.png"&gt;&lt;figcaption&gt;Paste from Google Sheets to Calc: also handling a single cell&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-14-sc-html-copy-text-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-14-sc-html-copy-text-good.png"&gt;&lt;figcaption&gt;Copy from Calc to Google Sheets: text is now handled, no longer auto-converted to a number&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-15-sc-html-copy-bool-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-15-sc-html-copy-bool-good.png"&gt;&lt;figcaption&gt;Copy from Calc to Google Sheets: booleans are now handled&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-20-cool-cross-origin-iframe-clipboard-bad.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-02-20-cool-cross-origin-iframe-clipboard-bad.png"&gt;&lt;figcaption&gt;Cross-origin iframes also block clipboard access, now fixed&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-01-sc-html-copy-formatted-number-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-01-sc-html-copy-formatted-number-good.png"&gt;&lt;figcaption&gt;Copy from Calc to Google Sheets: number formats are now also preserved&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-04-sc-html-copy-formula-good.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-04-sc-html-copy-formula-good.png"&gt;&lt;figcaption&gt;Copy from Calc to Google Sheets: formulas are now also preserved&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-08-cool-plain-text-copy.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sc-clipboard-paste/2024-03-08-cool-plain-text-copy.png"&gt;&lt;figcaption&gt;Copy from COOL Writer to a text editor: much better result, new one on the right hand side&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;As usual, the high-level problem was addressed by a series of small changes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/e6e5660b726ecf3b0c39b277568568973b43c9f0"&gt;tdf#159483 sc HTML import: handle data-sheets-value attribute for the text case&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/543e52481e764b8e0eea6cf0123a77cf492bdf8e"&gt;tdf#159483 sc HTML paste: handle data-sheets-value here, too&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/f8c95cf93ce9ab8b9b78f3af03411d0cc2e195ba"&gt;tdf#159483 sc HTML import: handle data-sheets-value attribute for the bool case&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/789964785a61daab5f8065f006dd7aaf843c7236"&gt;tdf#159483 sc HTML import: handle data-sheets-value attribute for the num case&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/7812adb2ed11a3e08be24d3f2f94d14bfd740c55"&gt;tdf#159483 sc HTML paste: handle data-sheets-formula attribute&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/c0da56cb3e9f9678cae7142dee03fb706a2aebd9"&gt;tdf#159483 sc HTML paste: handle data-sheets- attributes on a span&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/4e2a4fbeb7c44cc47b3cf803cbcc6cba63b3d481"&gt;tdf#159483 sc HTML export: handle data-sheets-value attribute for the text case&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/411158832462b1077a8f5dc6379f2056f2338249"&gt;tdf#159483 sc HTML copy: handle data-sheets-value attribute for the bool case&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/17581e684ca701bfd96ed2bf16aa14c3903b74d4"&gt;tdf#159483 sc HTML copy: handle data-sheets-value attribute for the num case&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/2efe362c99a9fa6e9a71b9b675b025c64b6c7f9d"&gt;tdf#159483 sc HTML copy: handle data-sheets-formula attribute&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The tracking issue on the Online side was &lt;a href="https://github.com/CollaboraOnline/online/issues/8023"&gt;cool#8023&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a snapshot / demo of Collabora Office 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/"&gt;try the
unstable snapshot&lt;/a&gt;.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.8).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Thu, 04 Apr 2024 09:50:39 +0200</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-04-04:/blog/sc-clipboard-paste.html</guid><category>libreoffice</category><category>en</category></item><item><title>Legal numbering in Writer: DOC and RTF support</title><link>https://vmiklos.hu/blog/sw-legal-numbering.html</link><description>&lt;p&gt;Writer now supports legal numbering for two more formats: DOC and RTF (ODT and DOCX were working
already.)&lt;/p&gt;
&lt;p&gt;This work is primarily for &lt;a href="https://www.collaboraoffice.com/"&gt;Collabora Online&lt;/a&gt;, done as a
&lt;a href="https://vmiklos.hu/blog/sw-content-controls3.html"&gt;HackWeek&lt;/a&gt; project, but the feature is fully available in
desktop Writer as well.&lt;/p&gt;
&lt;h2 id="motivation"&gt;Motivation&lt;a class="headerlink" href="#motivation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Legal numbering is a way to influence the number format of values inherited in a multi-level
numbering. Say, the outer numbering uses Roman numerals and the inner numbering uses X.Y as the number
format, but the inner level wants to display the outer values as Arabic numerals. If this is wanted
(and guessing from the name, sometimes lawyers do want this), then the inner number portion will
expand to values like "2.01" instead of "II.01", while the outer number portions will remain values
like "II".&lt;/p&gt;
&lt;p&gt;Mike did &lt;a href="https://bugs.documentfoundation.org/show_bug.cgi?id=150408"&gt;80% of the work&lt;/a&gt;, what you can
see here is just the RTF/DOC filters.&lt;/p&gt;
&lt;p&gt;Picking a smaller feature task like this looked like a good idea, since I wanted to spend some of
the time on regression fixing around last year's multi-page floating table project.&lt;/p&gt;
&lt;h2 id="results-so-far"&gt;Results so far&lt;a class="headerlink" href="#results-so-far" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;For (binary) DOC, the relevant detail is the &lt;code&gt;fLegal&lt;/code&gt; bit in the &lt;code&gt;LVLF&lt;/code&gt; structure. Here is the
result:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-legal-numbering/2024-02-29-writer-legal-numbering-doc.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-legal-numbering/2024-02-29-writer-legal-numbering-doc.png"&gt;&lt;figcaption&gt;Improved handling of legal numbering from DOC: old, new and reference rendering&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;It shows how the outer "II" gets turned into "2", while it remained "II" in the past. This works for
both loading and saving.&lt;/p&gt;
&lt;p&gt;The same feature is now handled in the RTF filter as well. There the relevant detail is the
&lt;code&gt;\levellegal&lt;/code&gt; control word, which has an odd 1 default value (the default is usually 0). Here is the
result:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://share.vmiklos.hu/blog/sw-legal-numbering/2024-02-29-writer-legal-numbering-rtf.png"&gt;&lt;figure&gt;&lt;img src="https://share.vmiklos.hu/blog/sw-legal-numbering/2024-02-29-writer-legal-numbering-rtf.png"&gt;&lt;figcaption&gt;Improved handling of legal numbering from RTF: old, new and reference rendering&lt;/figcaption&gt;&lt;/figure&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;It shows that the RTF filter is up to speed with the DOC one by now.&lt;/p&gt;
&lt;p&gt;As for the multi-page floating tables, I looked at
&lt;a href="https://bugs.documentfoundation.org/show_bug.cgi?id=158986"&gt;tdf#158986&lt;/a&gt; and
&lt;a href="https://bugs.documentfoundation.org/show_bug.cgi?id=158801"&gt;tdf#158801&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="how-is-this-implemented"&gt;How is this implemented?&lt;a class="headerlink" href="#how-is-this-implemented" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you would like to know a bit more about how this works, continue reading... :-)&lt;/p&gt;
&lt;p&gt;As usual, the high-level problem was addressed by a series of small changes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/397d72e582c725d162c7e0b819dc6c0bb62e42b0"&gt;Related: tdf#158986 sw floattable: fix unexpected page break with sections&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/b7c4c4d45f44a26283678f3dc32982b3a728c614"&gt;tdf#158986 sw floattable: fix RTF import of table followed by \sect&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/a73b3994fb6a2cc10b2d65cbaad201762610cecc"&gt;Related: tdf#150408 DOC filter: handle legal numbering&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/e8487bedb20a429565b4a0e4bd2d6806cc603b7f"&gt;Related: tdf#150408 RTF filter: handle legal numbering&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/c98ff922831f56253af2a050b8e07cfc89b7a387"&gt;Related: tdf#158986 sw floattable, RTF import: use more setNeedPar()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://git.libreoffice.org/core/commit/186de7178c6065e1de13fd216b46ac9b716e44c5"&gt;tdf#158801 sw floattable: fix crash with headers and interactive editing&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="want-to-start-using-this"&gt;Want to start using this?&lt;a class="headerlink" href="#want-to-start-using-this" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;You can get a snapshot / demo of Collabora Office 24.04 and try it out yourself right now: &lt;a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/"&gt;try the
unstable snapshot&lt;/a&gt;.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF's next release too (24.8).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Miklos Vajna</dc:creator><pubDate>Fri, 01 Mar 2024 08:46:39 +0100</pubDate><guid isPermaLink="false">tag:vmiklos.hu,2024-03-01:/blog/sw-legal-numbering.html</guid><category>libreoffice</category><category>en</category></item></channel></rss>