<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />


  <title>
    What is Miklos hacking
&ndash; Tag: en  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
&gt; Tag: en
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sd-theme-shape-text.html">Start of document themes in Impress: shape text</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 06 January 2022</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 5 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Impress now has the start of document theme support: it is possible to define a document theme on
master pages and you can refer to the theme colors from shape text (including effects).</p></div>
<div class="paragraph"><p>First, thanks to our partner <a href="https://www.suse.com/">SUSE</a> for working with
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>PowerPoint users can attach a set of colors (and fonts, formattings) to master pages, and then refer
to these in shape text, shape fill, shape geometry. You can even make the original color lighter and
darker. These effects are preserved when you change the theme colors.</p></div>
<div class="paragraph"><p>This is a larger feature, this blog post shows how theme colors can be defined and how to refer to
those colors from Impress shape text. The rest of the feature is to be done in follow-up steps.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here is a demo that shows how it works:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://youtu.be/4QeN58AkuxE">
<img src="https://share.vmiklos.hu/blog/sd-theme-shape-text/sd-theme-shape-text.png" alt="https://share.vmiklos.hu/blog/sd-theme-shape-text/sd-theme-shape-text.png" />
</a>
</div>
<div class="title">Figure 1. Demo of theme support in Impress shape text</div>
</div>
<div class="paragraph"><p>In other words, it consists of 2 parts on the UI:</p></div>
<div class="ulist"><ul>
<li>
<p>
You can define theme colors once you click on "Master View" in Impress, and then select the Slide
  &#8594; Slide properties menu item, and there choosing the new Theme tab. You can e.g. make "accent1"
  blue, "accent2" orange, and so on.
</p>
</li>
<li>
<p>
Then you can refer to these theme colors. Select some shape text, and then either use Format &#8594;
  Character &#8594; Font effects &#8594; Font color &#8594; Theme colors or use the sidebar to set the font color.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This later shows a grid of colors: each column is one theme color and then the column offers various
lighter and darker variants of the color.</p></div>
<div class="paragraph"><p>And the important bit: if you later change theme colors, then the color of shape text (using theme
colors) is updated, even the effects (lighter or darker variants) are preserved.</p></div>
<div class="paragraph"><p>To set expectations, this only works for shape text for now, and only in Impress, as a start.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the high-level problem was addressed by a series of small changes. The first step was to
upstream work by <a href="https://tomazvajngerl.blogspot.com/">Toma≈æ Vajngerl</a> and <a href="https://quwex.com/">Sarper
Akdemir</a> from the <code>feature/themesupport2</code> feature branch:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125296">https://gerrit.libreoffice.org/c/core/+/125296</a> Theme color and tint/shade attribute for SvxColorItem
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125304">https://gerrit.libreoffice.org/c/core/+/125304</a> Support reading back theme color from an ooxml document
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125313">https://gerrit.libreoffice.org/c/core/+/125313</a> make colorsets work outside of styles and with direct formatting
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125394">https://gerrit.libreoffice.org/c/core/+/125394</a> expose the SvxColorItem theme related uno for draw/impress
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125404">https://gerrit.libreoffice.org/c/core/+/125404</a> implement initial pptx theme color import
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125414">https://gerrit.libreoffice.org/c/core/+/125414</a> rename getSchemeName getSchemeIndex to remove ambiguity
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125426">https://gerrit.libreoffice.org/c/core/+/125426</a> implement color tint or shade import for pptx
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125436">https://gerrit.libreoffice.org/c/core/+/125436</a> introduce XColorSetsManager interface
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125477">https://gerrit.libreoffice.org/c/core/+/125477</a> import pptx color schemes as color sets
</p>
</li>
</ul></div>
<div class="paragraph"><p>The rest of the work was to go through the usual stages of document model, UNO API, rendering,
ODP/PPTX filter and UI work to complete the work started on the branch:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125532">https://gerrit.libreoffice.org/c/core/+/125532</a> PPTX import: handle &lt;a:clrScheme name="&#8230;"&gt;
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125651">https://gerrit.libreoffice.org/c/core/+/125651</a> PPTX: implement native handling of &lt;a:clrScheme&gt; children
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125684">https://gerrit.libreoffice.org/c/core/+/125684</a> PPTX import: implement native handling of a color&#8217;s luminance modulation
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/125749">https://gerrit.libreoffice.org/c/core/+/125749</a> PPTX import: implement native handling of a color&#8217;s luminance offset
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126011">https://gerrit.libreoffice.org/c/core/+/126011</a> tools Color: implement MSO-style luminance modulation/offset filter
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126082">https://gerrit.libreoffice.org/c/core/+/126082</a> svx: update objects of pages of a master page when the theme changes
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126164">https://gerrit.libreoffice.org/c/core/+/126164</a> PPTX export: write the theme for the master pages from the doc model
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126215">https://gerrit.libreoffice.org/c/core/+/126215</a> PPTX export: handle theme colors from the doc model for shape text
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126270">https://gerrit.libreoffice.org/c/core/+/126270</a> svx: consider color effects when updating objects for theme changes
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126400">https://gerrit.libreoffice.org/c/core/+/126400</a> PPTX export: handle theme color of shape text with effects
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126466">https://gerrit.libreoffice.org/c/core/+/126466</a> ODP export: write the theme of a master page
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126502">https://gerrit.libreoffice.org/c/core/+/126502</a> ODP import: handle theme of master pages
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126566">https://gerrit.libreoffice.org/c/core/+/126566</a> ODP import/export: refer to theme from shape text color
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126722">https://gerrit.libreoffice.org/c/core/+/126722</a> ODP import/export: refer to theme from shape text color with effects
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126798">https://gerrit.libreoffice.org/c/core/+/126798</a> sd: add initial theme UI for master slides
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126850">https://gerrit.libreoffice.org/c/core/+/126850</a> sd theme: add UI to set/get the name of a color set
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126905">https://gerrit.libreoffice.org/c/core/+/126905</a> sd theme: add UI to set individual colors of a color set
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/126994">https://gerrit.libreoffice.org/c/core/+/126994</a> sd theme: add a "theme" palette to the color picker
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/127135">https://gerrit.libreoffice.org/c/core/+/127135</a> sd theme: allow setting the color&#8217;s theme index in the chardlg
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/127211">https://gerrit.libreoffice.org/c/core/+/127211</a> sd theme: allow setting color effects in the chardlg
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/127304">https://gerrit.libreoffice.org/c/core/+/127304</a> sd theme: allow setting color effects in the sidebar
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>You can get a snapshot / demo of Collabora Office and try it out yourself right now:
<a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF&#8217;s next release too (7.4).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-ole-update.html">Writer embedded objects: reliably update object previews</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 15 December 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Embedded objects in Writer consist of a native data part and a preview part. Until now, there was no
way to force the update of the preview part in case it was empty.</p></div>
<div class="paragraph"><p>Now the Tools &#8594; Update &#8594; Update all menu item updates such previews as well. This is especially
useful if you manipulate the ZIP/XML document directly to insert native data, then load it into
Writer to generate a preview.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://vector.com/">Vector</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Update all menu item already updates all sorts of generated content: fields, table of contents,
charts, the document layout, but not the preview of embedded objects. You could work this around by
double-clicking on the embedded object to re-generate the preview, but doing this manually for a
larger document is not efficient. This is especially useful for hand-crafted documents which have
proper native data, but no preview image yet.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here is how an embedded object without a preview looks like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-ole-update/old.png" alt="https://share.vmiklos.hu/blog/sw-ole-update/old.png" />
</div>
<div class="title">Figure 1. Writer embedded object with no preview</div>
</div>
<div class="paragraph"><p>Now using the Update all menu item turns a sample document into this preview:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-ole-update/new.png" alt="https://share.vmiklos.hu/blog/sw-ole-update/new.png" />
</div>
<div class="title">Figure 2. Writer embedded object with a preview</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p><a href="https://gerrit.libreoffice.org/c/core/+/126253">sw: update previews of OLE objects on
"update all"</a> is the change implementing this small feature. It works by:</p></div>
<div class="ulist"><ul>
<li>
<p>
Iterating over the frame formats ("special" formats) of the document
</p>
</li>
<li>
<p>
Filter out shapes
</p>
</li>
<li>
<p>
Filter out objects which are only reachable from the undo stack
</p>
</li>
<li>
<p>
Filter out objects which are not embedded ("OLE") objects
</p>
</li>
<li>
<p>
Once we have access to the OLE node, jump to its <code>SwOLEObj</code>, then to its <code>svt::EmbeddedObjectRef</code>,
  which knows how to re-calculate the preview bitmap
</p>
</li>
<li>
<p>
Finally notify the OLE node that the preview was updated, so the necessary repaint can happen
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.4).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-linked-styles.html">Start of linked paragraph and character styles in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 12 November 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Writer now has the start of linked character and paragraph styles. This improves DOCX compatibility,
extends ODT and it&#8217;ll improve the style previews and the UI in the future, hopefully.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://www.docmosis.com/">Docmosis</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Word allows linking paragraph and character styles together, which means only the paragraph one will
be present on the UI. Such a split has benefits if you customize the character properties on the UI
and later you want to update the paragraph properties from a template, for example.</p></div>
<div class="paragraph"><p>This is frequent markup in DOCX files, because Word defaults to splitting out the character
properties of a <code>Test</code> paragraph style into a <code>Test Char</code> character style on editing.</p></div>
<div class="paragraph"><p>Saving the document in Writer and then viewing it in Word lead to loosing these links, so their
style pickers started to show unwanted <code>Test Char</code> rows.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>We used to preserve such linking information when doing DOCX &#8594; DOCX conversion for a while, since
about 2013. But such preservation was in-memory, so if you saved the document to ODT, then such
information was lost. This approach also lacked a real document model, which is necessary to
incrementally build this feature into a complete solution.</p></div>
<div class="paragraph"><p>Here is how the style picker in Word looks like now, after a DOCX &#8594; ODT &#8594; DOCX pipeline:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-linked-styles/new.png" alt="https://share.vmiklos.hu/blog/sw-linked-styles/new.png" />
</div>
<div class="title">Figure 1. Word&#8217;s style picker, new output: no unwanted additional character styles</div>
</div>
<div class="paragraph"><p>Here is how this used to look like before the new changes (note the <code>Heading 1 Char</code> line between
<code>Heading</code> and <code>Index</code>):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-linked-styles/old.png" alt="https://share.vmiklos.hu/blog/sw-linked-styles/old.png" />
</div>
<div class="title">Figure 2. Word&#8217;s style picker, old output: unwanted additional character styles</div>
</div>
<div class="paragraph"><p>And here is how the input document looks like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-linked-styles/ref.png" alt="https://share.vmiklos.hu/blog/sw-linked-styles/ref.png" />
</div>
<div class="title">Figure 3. Word&#8217;s style picker, reference output: no unwanted additional character styles</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122595">sw: paragraph styles: add doc model &amp; UNO
  API for a linked character style</a> added the document model and API support
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122681">sw: paragraph styles: add DOCX filter for
  a linked character style</a> added the DOCX filter
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122753">sw: paragraph styles: add ODT filter for a
  linked character style</a> added the ODT filter
</p>
</li>
</ul></div>
<div class="paragraph"><p>Just to set expectations, this is currently an invisible feature, but unlike the old approach from 8
years ago, this one can be extended into a full feature, incrementally. It also survives ODT
roundtrips.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.3).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sd-table-transparent-shadow.html">Transparent shadow for tables from PPTX in Impress</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 22 October 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Impress is now able to correctly render shadows for table shapes, even if the shadow itself or the
fill of the table cells have transparency. The result is now compatible with PowerPoint.</p></div>
<div class="paragraph"><p>First, thanks to our partner <a href="https://www.suse.com/">SUSE</a> for working with
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>We got a PPTX document, which has a table shape with pink background and a blurry shadow. Impress
rendered a red background, making the text hard to read.</p></div>
<div class="paragraph"><p>The request was to improve the shadow rendering to be PowerPoint-compatible and in general correctly
support transparency when it comes to table cell fills and table shadows.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>The table shadow now looks like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/new.png" alt="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/new.png" />
</div>
<div class="title">Figure 1. New render result in Impress</div>
</div>
<div class="paragraph"><p>Matching the reference rendering:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/ref.png" alt="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/ref.png" />
</div>
<div class="title">Figure 2. Reference render result</div>
</div>
<div class="paragraph"><p>While background was red previously:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/old.png" alt="https://share.vmiklos.hu/blog/sd-table-transparent-shadow/old.png" />
</div>
<div class="title">Figure 3. Old render result in Impress</div>
</div>
<div class="paragraph"><p>You can see that not only the background in the top center cell is pink now, but the blurry table
shadow is still correct.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the high-level problem was addressed by a series of fixes:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122349">tdf#144091 svx: fix unwanted blur of shadow from
  table cell fill</a>
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/122532">Related: tdf#144091 svx: fix interaction of transp
  cell fill and transp shadow</a>
  (<a href="https://git.libreoffice.org/core/+/00fa364a2403dc23a786d3f91fde06e10b3a4a9a/svx/source/sdr/primitive2d/sdrdecompositiontools.cxx#629">key
  part</a>)
</p>
</li>
</ul></div>
<div class="paragraph"><p>With these, it&#8217;s now possible to add transparency to both table cell fills and to table shadows, and
the rendering will take both into account, correctly.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>You can get a snapshot / demo of Collabora Office and try it out yourself right now:
<a href="https://www.collaboraoffice.com/collabora-office-latest-snapshot/">try unstable snapshot</a>.  Collabora
intends to continue supporting and contributing to LibreOffice, the code is merged so we expect all
of this work will be available in TDF&#8217;s next release too (7.3).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-parastyle-listlevel.html">Start of list level support in Writer paragraph styles</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 29 September 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Writer now has the start of list level support in Writer paragraph styles. This improves ODT and
DOCX compatibility, and it&#8217;ll improve the style previews and the UI in the future.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://www.docmosis.com/">Docmosis</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>A paragraph might have an associated list in Writer and that list can have multiple levels. This is
direct formatting. When it comes to paragraph styles, referring to a list was already possible, but
defining a custom list level was not.</p></div>
<div class="paragraph"><p>Loosing this information in Word documents was quite annoying, and it turned out that ODF also has
markup for this, just LibreOffice didn&#8217;t implement it.</p></div>
<div class="paragraph"><p>This work is currently done for the document model, scripting API and file filters: style previews &amp;
UI still needs finishing.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Writer can at the moment preserve list level info from ODT and DOCX files. Here is how a file written
by Writer looks like in Word:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-parastyle-listlevel/parastyle-listlevel.png" alt="https://share.vmiklos.hu/blog/sw-parastyle-listlevel/parastyle-listlevel.png" />
</div>
<div class="title">Figure 1. Writer exporting a paragraph style with list level info</div>
</div>
<div class="paragraph"><p>You can see that the style preview in Word takes the list level into account. Doing the same and
applying the list level as part of applying the paragraph style on the Writer UI is still future work.</p></div>
<div class="paragraph"><p>Thanks to Justin Luth who did the follow-up work to adapt the DOC filter accordingly, and also doing
other related fixes.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/121141">tdf#137363 DOCX filter: don&#8217;t loose
  &lt;w:ilvl w:val="&#8230;"&gt; of paragraph styles</a> added document model, API and DOCX import/export support
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/121515">Related: tdf#137363 ODT import: handle
  style:list-level="&#8230;" for para styles</a> added ODT import/export support
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.3).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sd-groupshape-unshare.html">Unshare shape properties for the same type before insertion in Impress</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 30 August 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Shape properties were shared by shape type (e.g. shared between group shapes) before insertion into
a document model in Impress. This is now fixed: the property names and types are still shared to
help performance, but their values are no longer shared. This helps matching the user expectation
that separate opened documents don&#8217;t share information with each other.</p></div>
<div class="paragraph"><p>First, thanks to our partner <a href="https://www.suse.com/">SUSE</a> for working with
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>I was working on a testcase for
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=132696">tdf#132696</a> when I noticed that the
existing CppunitTest_oox_drawingml testsuite runs fine before my changes, also a newly added
testGroupShapeSmartArt testcase runs fine in isolation, but if I run the whole testsuite, then it
breaks.</p></div>
<div class="paragraph"><p>Further investigation revealed that in case testGroupShapeSmartArt is executed first, then testTdf131082 fails. This means:</p></div>
<div class="ulist"><ul>
<li>
<p>
the first document is opened
</p>
</li>
<li>
<p>
the first document is closed
</p>
</li>
<li>
<p>
the second document is opened
</p>
</li>
<li>
<p>
the second document is saved
</p>
</li>
</ul></div>
<div class="paragraph"><p>And at this point information from the first document is leaked to the second document, even if the
first document was already closed by the time we performed the save. It turns out the root cause was
<a href="https://bz.apache.org/ooo/show_bug.cgi?id=114206">i#114206</a> (reported in 2010), i.e. group shapes
shared their property values till they got inserted to the document model. The first document import
did not consume pending SmartArt properties on a to-be-inserted group shape, the second import was
looking for pending properties, found them. And then the second document&#8217;s save wrote those pending
properties to the file, leading to this unexpected leak.</p></div>
<div class="paragraph"><p>Here is how the first document looks like, containing the blue rectangles (a SmartArt):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-groupshape-unshare/first.png" alt="https://share.vmiklos.hu/blog/sd-groupshape-unshare/first.png" />
</div>
<div class="title">Figure 1. First document with a SmartArt</div>
</div>
<div class="paragraph"><p>Here is how the second document looks like, without a SmartArt:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-groupshape-unshare/second.png" alt="https://share.vmiklos.hu/blog/sd-groupshape-unshare/second.png" />
</div>
<div class="title">Figure 2. Second document after loading, no SmartArt</div>
</div>
<div class="paragraph"><p>And here is how the second document looks, after saving to PPTX and reloading:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sd-groupshape-unshare/second-saved.png" alt="https://share.vmiklos.hu/blog/sd-groupshape-unshare/second-saved.png" />
</div>
<div class="title">Figure 3. Second document after reloading, with a SmartArt</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <a href="https://git.libreoffice.org/core/commit/c6f25506b02fbd2a087b7e790283921bf8550206">fix</a> is to
split out part of <code>SvxItemPropertySet</code> to a separate class, so that we can keep sharing
<code>SvxItemPropertySet</code> between multiple instances of the same shape type (describing the name and type
of the various properties), while introducing a new <code>SvxItemPropertySetUsrAnys</code> that is specific to
each not-yet-inserted shape. This way each pending shape is independent, and in case they are not
inserted to the document model later, that results in no side-effects.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.3).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sc-xlsx-button-macro.html">Calc buttons with macros: better XLSX support</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 22 July 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Embedding macros to Calc documents and invoking them by clicking on buttons is a common use-case.
There was also decent support for importing these from XLSX (XLSM to be precise), but the export
side was not on par with the binary XLS export.</p></div>
<div class="paragraph"><p>Calc now got a series of incremental improvements to map our form controls (buttons in particular)
to OOXML&#8217;s form controls, especially when macros are assigned to such buttons.</p></div>
<div class="paragraph"><p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but the feature is
fully available in desktop Calc as well.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Excel has both
<a href="https://support.microsoft.com/en-us/office/assign-a-macro-to-a-form-or-a-control-button-d58edd7d-cb04-4964-bead-9c72c843a283">form
controls and ActiveX controls</a>, and
<a href="https://gerrit.libreoffice.org/c/core/+/94161">tdf#106181 XLSX export: output form controls</a>
last year started adding support for form control export to XLSX.</p></div>
<div class="paragraph"><p>Hoping that this will be mostly shared drawingML export code fixing (benefiting DOCX and PPTX as
well), it seemed reasonable to assume that we can improve button handling from the "it&#8217;s lost" state
to "it&#8217;s good enough" with some effort.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now Excel shows the button and you can click on it:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sc-xlsx-button-macro/new.png" alt="https://share.vmiklos.hu/blog/sc-xlsx-button-macro/new.png" />
</div>
<div class="title">Figure 1. Excel consuming our XLSM output with a button and a macro</div>
</div>
<div class="paragraph"><p>While it used to just refuse our export result:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sc-xlsx-button-macro/old.png" alt="https://share.vmiklos.hu/blog/sc-xlsx-button-macro/old.png" />
</div>
<div class="title">Figure 2. Excel refusing bad XLSM output</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the end goal was reached via a set of incremental commits:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118085">sc: don&#8217;t require ctrl-click when clicking
  on internal links of shapes</a> was a UX problem, users don&#8217;t finding Ctrl-click
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118168">XLSX export: improve handling of checkbox
  (form controls)</a> was an improvement to the existing checkbox export code, probably today&#8217;s Excel is just more strict in what it accepts
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118219">XLSX export: handle button form controls</a>
  adds the initial button support
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118401">XLSX import: fix handling of named ranges
  referring to PathMissing sheets</a> fixes an import problem around named ranges and external references
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118485">XLSX export: handle macros on button form
  controls</a> adds the macro bits of buttons
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/118600">XSLX export, button form control: fix
  handling of no macros</a> is a fixup for non-macro buttons
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.3).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-line-height.html">Writer line heights: removing a 16bit limit</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 10 June 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Line heights in Writer are typically defined in points on the UI (e.g. 12pt), though they are
measured in twips internally (1 point is 20 twips). This height was stored in a 16bit unsigned
integer, so the maximum allowed height was 65536 twips, around 116 cm.</p></div>
<div class="paragraph"><p>Now we track line heights with 32 bits ints, so this limitation is practically removed.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://vector.com/">Vector</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Once you insert an image to a Writer document, you can customize its anchor type. The as-char
anchor type is handy if you don&#8217;t want text to flow around the image. This has the side effect that
a large image significantly increases the nominal height of a line. The problematic document had an
image height of 118.9 cm (46.81 inch), so the unsigned integer used to represent its height wrapped
around, leading to an incorrect layout.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now it looks like the way you would expect it:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-line-height/sw-line-height.png" alt="https://share.vmiklos.hu/blog/sw-line-height/sw-line-height.png" />
</div>
<div class="title">Figure 1. Writer as-char image with height that is larger than 65k twips</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the end goal was reached via a set of incremental commits:</p></div>
<div class="ulist"><ul>
<li>
<p>
The very first integer truncation was found using gdb, manually. At that point it was clear that
  some tool to catch the problematic places would accelerate development. First
  <a href="https://gerrit.libreoffice.org/c/core/+/115948">sw: replace most static_cast&lt;sal_uInt16&gt;()
  calls with o3tl::narrowing()</a> prepared Writer code so that sanitizers can flag the interesting code
  locations when using <code>-fsanitize=implicit-unsigned-integer-truncation
  -fsanitize=implicit-signed-integer-truncation</code>. This is important, as conversion with
  <code>static_cast&lt;&gt;</code> counts as an explicit integer conversion, and sanitizers can&#8217;t flag such
  conversions.
</p>
</li>
<li>
<p>
Then <a href="https://gerrit.libreoffice.org/c/core/+/115873">sw: allow the height of a line to be
  larger than 65536 twips</a> took care of the height part.
</p>
</li>
<li>
<p>
Finally <a href="https://gerrit.libreoffice.org/c/core/+/116835">sw: allow the width of a line
  portion to be larger than 65536 twips</a> fixed the width part.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.2).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-bibliography-page.html">Bibliography improvements in LibreOffice Writer: refer to a specific page</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 05 May 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>The bibliography feature in Writer allows authors of e.g. scientific papers to track sources: first
you can insert bibliography entry fields, then at the end you can generate a bibliography table
automatically.</p></div>
<div class="paragraph"><p>Writer recently gained <a href="https://vmiklos.hu/blog/sw-bibliography.html">two improvements in this area</a>, and
now there is one more: the ability to refer to a specific page of a (potentially long) source.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://ulakbim.tubitak.gov.tr/en">TUBITAK ULAKBIM</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>The same feature in normal HTML linking / citation is well-known: you can place anchors in your
document and then links can refer to not only to your page, but also can set the fragment part of
the URL to jump to a specific section directly. E.g.
<a href="https://vmiklos.hu/blog/sw-bibliography.html#_motivation">this link</a> will jump to the "Motivation"
section of the above referred previous post.</p></div>
<div class="paragraph"><p>Wouldn&#8217;t it be nice if you could also jump to a specific page of a scientific PDF?</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>You can add such references by choosing the Insert &#8594; Table of Contents and Index &#8594; Bibliography
Entry menu item.  Set Bibliography Source to Document Content and press the New button. The
appearing dialog now has widgets to set a specific page number:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-bibliography-page/page.png" alt="https://share.vmiklos.hu/blog/sw-bibliography-page/page.png" />
</div>
<div class="title">Figure 1. Refer to a specic page of a bibliography source, user interface</div>
</div>
<div class="paragraph"><p>This is then stored in the URL by setting its fragment to <code>page=...</code>, and typically PDF readers
understand this syntax, so when you click on the URL, the PDF will open exactly on the cited page.</p></div>
<div class="paragraph"><p>This also works the other way around: URLs with such syntax are presented to the user with the
dedicated widget to see, edit or delete the page number of the URL.</p></div>
<div class="paragraph"><p>Finally, if you refer to different pages of the same source, the bibliography text generator detects
this and lists the source in the bibliography only once.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="paragraph"><p>As usual, the high-level problem was addressed by a series of incremental development steps:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/111653">sw bibliography, refer to a page: strip
  URLs in the bibliography table</a> improved the bibliography table generator to not show page fragments
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/111761">sw bibliography, refer to a page:
  de-duplicate bibliography table URLs</a> merged the idendical sources to a single entry in the bibliography
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/112400">sw bibliography, refer to a page: make the
  biblio field clickable</a> allows opening the URL-with-page by clicking on the bibliography entry field
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/112981">sw bibliography, refer to a page: add open
  hyperlink context menu</a> implemented the context menu, in case you prefer to avoid ctrl-click for hyperlink opening
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/113035">sw bibliography, refer to a page: add PDF
  export links</a> improved the PDF export to have clickable bibliography entry fields
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/114059">sw bibliography, refer to a page: fix
  biblio field relative URLs</a> added support for relative URLs, in case the edited document and
  referred PDFs are in the same directory, next to each other
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/114104">sw bibliography, refer to a page: also
  de-duplicate relative URLs</a> made the relative URL and bibliography table row merging work together
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/114380">sw bibliography, refer to a page: edit the
  page number of individual entries</a> allows editing just a single bibliography entry field for page
  number purposes, since in other cases it makes sense to update all fields of the same source (e.g.
  correcting a spelling mistake in an author name)
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/c/core/+/114443">sw bibliography, refer to a page: add
  dedicate widget to show the page number</a>,
  <a href="https://gerrit.libreoffice.org/c/core/+/114664">sw bibliography, refer to a page: save
  edited page number</a> and <a href="https://gerrit.libreoffice.org/c/core/+/114750">sw bibliography,
  refer to a page: add insert/delete UI</a> add support for creating, showing, editing and deleting page
  numbers of such URLs on the user interface
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.2).</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-merged-border.html">Improving borders of merged table cells in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 14 April 2021</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Writer now has better
<a href="https://git.libreoffice.org/core/commit/66ac8e60896f6306bed8fbb34606fd14474f19ce">support</a> for
Word-compatible border rending when it comes to vertically merged cells in tables.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://www.docmosis.com/">Docmosis</a> who made this work by
<a href="https://www.collaboraoffice.com/">Collabora</a> possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Both Word and Writer allow specifying borders for any kind of table cells. When the user creates a
vertically merged cell, there is a covering cell and there is one or more covered table cells.</p></div>
<div class="paragraph"><p>The Writer approach is to render the cell borders according to the properties of the covering cell.
This has the benefit that each edge of the table cell has a single border style (e.g. dashed or
hairline).</p></div>
<div class="paragraph"><p>The Word approach is to render the cell borders as if there would be no vertical merge, according to
the properties of the covered cell. This has the benefit that merging the content of cells
vertically doesn&#8217;t change the border rendering, but it also requires more complex code for painting.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>Writer can now detect that your tables originate from Word formats and render table borders the Word way in that case.</p></div>
<div class="paragraph"><p>Here is how the new rendering result look like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-merged-border/new.png" alt="https://share.vmiklos.hu/blog/sw-merged-border/new.png" />
</div>
<div class="title">Figure 1. Writer rendering in compatibility mode, new output</div>
</div>
<div class="paragraph"><p>And here is how it used to look like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-merged-border/old.png" alt="https://share.vmiklos.hu/blog/sw-merged-border/old.png" />
</div>
<div class="title">Figure 2. Writer rendering in compatibility mode, old output</div>
</div>
<div class="paragraph"><p>And finally the reference rendering is:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://share.vmiklos.hu/blog/sw-merged-border/ref.png" alt="https://share.vmiklos.hu/blog/sw-merged-border/ref.png" />
</div>
<div class="title">Figure 3. Writer rendering in compatibility mode, reference output</div>
</div>
<div class="paragraph"><p>You can see that the B4 and B5 cells are covered, they had some unwanted border on their left side
and this is now gone.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_is_this_implemented">How is this implemented?</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you would like to know a bit more about how this works, continue reading&#8230; :-)</p></div>
<div class="ulist"><ul>
<li>
<p>
First, some building blocks were introduced: <code>SwCellFrame::GetCoveredCellInRow()</code> can look up a
  covered cell in a certain row, provided that this cell covers it
</p>
</li>
<li>
<p>
Building on top of this, <code>SwCellFrame::GetCoveredCells()</code> can provide a list of cell frames which
  are covered by the current cell, due to vertical merge. This is needed, because previously the
  layout didn&#8217;t have to consider properties of covered cells, so while the document model had this
  information, it was not visible to the layout in a convenient way
</p>
</li>
<li>
<p>
Using the above functionality, <code>SwTabFramePainter::Insert()</code> can suppress painting of certain
  border lines in Word compatibility mode
</p>
</li>
<li>
<p>
Finally, the code change can be covered with a test by recording the rendering and asserting the
  vertical positions of border points: we can check that all the positions belong to the 1st, 2nd or
  3rd rows, and not to a row below them
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_want_to_start_using_this">Want to start using this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Collabora intends to continue supporting and contributing to LibreOffice, the code is merged so we
expect all of this work will be available in TDF&#8217;s
<a href="http://dev-builds.libreoffice.org/daily/master/">next release</a> (7.2).</p></div>
</div>
</div>

  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/tag/en5.html" class="button_accent">&larr; Older Posts</a>

<a href="https://vmiklos.hu/blog/tag/en3.html" class="button_accent">Newer Posts &rarr;</a>
</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>