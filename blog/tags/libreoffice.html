<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<meta name="description" content="What is Miklos hacking - Tags: libreoffice - Miklos' blog" />
<meta name="keywords" content="vmiklos, libereoffice, swig, git, python, hacking, bitlbee" />
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/index.rss" />
<link rel="stylesheet" href="/blog/xhtml11.css" type="text/css" />
<link rel="stylesheet" href="/blog/xhtml11-quirks.css" type="text/css" />
<link rel="stylesheet" href="/blog/layout.css" type="text/css" />
<title>What is Miklos hacking - Tags: libreoffice</title>
<!-- google analytics start -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24726997-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- google analytics end -->
</head>
<body>
<div id="layout-banner-box">
<div id="layout-banner">
  <div id="layout-title">vmiklos.hu</div>
  <div id="layout-description">shameless self-promoting website</div>
</div>
</div>
<div id="layout-menu-box">
<div id="layout-menu">
  <div>&#187;<a href="/">Root</a></div>
  <div>&#187;<a href="/blog/">Rejourn root</a></div>
  <div>&#187;<a href="http://planet.documentfoundation.org/">LibreOffice Community Blogs</a></div>
  <div>
    Search:<br/>
    <form action="http://www.google.com/cse" id="cse-search-box" target="_blank">
    <input type="hidden" name="cx" value="007336731492173318056:bik8fqvatno"/><input type="hidden" name="ie" value="UTF-8"/><input type="text" name="q" size="15"/><br/>
    <input type="submit" name="sa" value="&#187;"/></form>
  </div>
</div>


</div>
<div id="layout-content-box">
<div id="layout-content">
<div id="header">
	<h1>What is Miklos hacking - Tags: libreoffice</h1>
</div>
<div id="preamble">
<div class="sectionbody">




<!-- Listing -->
<div class="ulist"><ul>
<li><p>Friday, 04 May 2018<br /><a href="/blog/image-lazy-read.html">Lazy reading images from Microsoft formats in LibreOffice</a>
</p><p><div class="paragraph"><p>I worked on improving document load performance of Microsoft formats in
general, and DOC/DOCX in particular in LibreOffice recently. First, thanks to
<a href="https://www.documentfoundation.org/">TDF</a> and users that support the foundation
by providing donations for funding <a href="https://www.collaboraoffice.com/">Collabora</a>
to make this possible.</p></div>
<div class="paragraph"><p>I built on top of the
<a href="https://tomazvajngerl.blogspot.com/2018/04/improving-image-handling-in-libreoffice.html">great
work of Tomaz</a>, focusing on these secondary, but important formats.</p></div>
<div class="paragraph"><p>The idea is that if you load an Microsoft binary or OOXML file, it should not
be necessary to parse all images at load time, it&#8217;s enough to lazy read it
when we first render e.g. a Writer page containing that image.</p></div>
<div class="paragraph"><p>The focus here was documents containing large images. I tested with an
<a href="https://www.theverge.com/2012/1/25/2732264/nasas-64-megapixel-photo-of-earth">Earth
photo</a> of size 8000x8000 pixels from NASA, making little modifications to it,
so each picture has a different checksum, embedding them into a binary DOC file.</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm1.staticflickr.com/980/41838412652_c1cbefcfc1_o.png" alt="https://farm1.staticflickr.com/980/41838412652_c1cbefcfc1_o.png" />
</div>
</div>
<div class="paragraph"><p>I measured the time from the <code>soffice</code> process startup to rendering the first
page. We defer the work of loading most images now, as you can see on the
chart. In contrast, we used to decompress all images on file import in the
past. This means the new cost for e.g. 4 images is 37% of the original.</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.1), or you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</p><hr/></li>
<li><p>Tuesday, 10 April 2018<br /><a href="/blog/hamburg2018.html">LibreOffice Hamburg Hackfest 2018</a>
</p><p><div style="text-align: center; font-size: 0.6em;">
<img src="https://farm1.staticflickr.com/873/27489617988_4c2ce3fd59_z.jpg"/>
<p>(via <a href="https://twitter.com/Sweet5hark/status/982560887927197696">Sweet5hark</a>)</p>
</div>
<div class="paragraph"><p>I arrived home from Hamburg yesterday where I participated in the
<a href="https://wiki.documentfoundation.org/Hackfest/Hamburg2018">LibreOffice hackfest</a>
over the weekend as a mentor.  First, thanks to The Document Foundation&#8201;&#8212;&#8201;and
all the <a href="https://www.libreoffice.org/donate">donors</a> for funding Collabora to
make this possible.</p></div>
<div class="paragraph"><p>There were a few topics I mentored:</p></div>
<div class="ulist"><ul>
<li>
<p>
Patrick was interested fixing
  <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=116486">tdf#116486</a>,
  which required some background knowledge on the Writer document model and
  layout, so we explored the relevant details together towards providing an
  actual patch for the bug.
</p>
</li>
<li>
<p>
Nithin wanted to fix
  <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=112384">tdf#112384</a>,
  which turned out to be an ideal task for a hackfest. On one hand, the scope is
  limited so that you can implement this mini-feature over a weekened. On the
  other hand, it required touching various parts of Writer (UI, document model,
  UNO API, ODF filter), so it allowed seeing the process of adding a new
  feature. The <a href="https://gerrit.libreoffice.org/52561">patch</a> is merged to master.
</p>
</li>
<li>
<p>
Linus looked for a task that is relatively easy, still useful, we looked at
  <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=42949">tdf#42949</a>, and he
  identified and removed a number of unused includes himself. This should
  especially help with slow incremental builds. Again, the
  <a href="https://gerrit.libreoffice.org/52594">patch</a> is already in master.
</p>
</li>
<li>
<p>
Zdeněk (raal) wanted to write a uitest for
  <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=106280">tdf#106280</a> so we
  were figuring out together how to select images from pyuno and how to avoid
  using graphic URLs in uitests in general.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The full list of achievements is
<a href="https://wiki.documentfoundation.org/Hackfest/Hamburg2018#Achievements">on the
wiki</a>, if you were at the hackfest and you did not contribute to that section,
please write a line about what did you hack on. :-)</p></div>
<div class="paragraph"><p>Finally, thanks for the organizers and the sponsors of the hackfest, it was a
really great event!</p></div>
</p><hr/></li>
<li><p>Friday, 02 March 2018<br /><a href="/blog/odt-xhtml-performance.html">Optimizing ODT ↔ XHTML conversion performance for simple documents</a>
</p><p><div class="paragraph"><p>I worked on improving the ODT ↔ XHTML conversion performance for simple
documents in LibreOffice recently.  First, thanks to
<a href="https://vector.com/">Vector</a> for funding
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
<div class="sect1">
<h2 id="_odt_8594_xhtml_conversion">ODT &#8594; XHTML conversion</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4605/26697712598_2ace3f45a3_o.png" alt="https://farm5.staticflickr.com/4605/26697712598_2ace3f45a3_o.png" />
</div>
</div>
<div class="paragraph"><p>The focus here was <strong>really</strong> simple documents, like just one sentence with
minimal formatting. The use-case is to have thousands of these simple
documents, only a minority containing complex formatting, the rest is just
that simple.</p></div>
<div class="paragraph"><p>Performance work usually focuses on one specific complex feature, e.g. lots of
bookmarks, lots of document-level user-defined metadata, and so on&#8201;&#8212;&#8201;this way
there were room for improvements when it comes to trivial documents.</p></div>
<div class="paragraph"><p>I managed to reduce the cost of the conversion to the <em>fifth of the original</em>
cost in both directions&#8201;&#8212;&#8201;the chart above shows the impact of my work for
the ODT &#8594; XHTML direction. The steps that helped:</p></div>
<div class="ulist"><ul>
<li>
<p>
Recognize <code>XHTML</code> as a value for the <code>FilterOptions</code> key in the <code>HTML
  (StarWriter)</code> export filter, this way avoid the need to go via XSLT, which
  would be expensive.
</p>
</li>
<li>
<p>
Add a new <code>NoFileSync</code> flag to the <code>frame::XStorable::storeToURL()</code> API, so
  that if you know you&#8217;ll read the result after the conversion finished, you
  can avoid an expensive <code>fsync()</code> call for each and every file, which helps
  HDDs a lot, while means no overhead for SSDs.
</p>
</li>
<li>
<p>
If you know your input format already, then specifying an explicit
  <code>FilterName</code> key for the <code>frame::XComponentLoader::loadComponentFromURL()</code>
  API helps not spending time to detect the file format you already know.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Note that the XHTML mode for the Writer HTML export is still a work in
progress, but it already produces valid output for such simple documents.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_xhtml_8594_odt_conversion">XHTML &#8594; ODT conversion</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4608/39674632615_de78265c7f_o.png" alt="https://farm5.staticflickr.com/4608/39674632615_de78265c7f_o.png" />
</div>
</div>
<div class="paragraph"><p>The chart above shows the results of my work for the XHTML &#8594; ODT direction.
The steps to get to the final reduced cost were:</p></div>
<div class="ulist"><ul>
<li>
<p>
The new <code>NoFileSync</code> flag, as mentioned previously.
</p>
</li>
<li>
<p>
A new <code>NoThumbnail</code> flag, which is useful if the ODT will be part of a next
  step in the pipeline and you know that the thumbnail image won&#8217;t be used anyway.
</p>
</li>
<li>
<p>
The default table autoformat definitions in Writer are now
  <a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=53ef918a6839c8d587dec1bb635e6b39397c53d0">lazy-loaded</a>.
  (This is my favorite one, you don&#8217;t have to opt-in for this, so everyone
  benefits.)
</p>
</li>
<li>
<p>
A new <code>HiddenForConversion</code> flag for
  <code>frame::XComponentLoader::loadComponentFromURL()</code>, which means we don&#8217;t lay
  out the UI elements (toolbars, sidebar, status bar, etc.) when we know the
  purpose of the document load is only to save the document model in an other
  format.
</p>
</li>
</ul></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.1), or you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Sunday, 04 February 2018<br /><a href="/blog/fosdem2018.html">EPUB export in LibreOffice Writer FOSDEM talk</a>
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/540497a4ac8443d2a42c92dd0ee1d298/epub-fosdem-brussels-2k18.pdf">
<img src="https://farm5.staticflickr.com/4613/39363415464_1ed88d85f3_z.jpg" alt="https://farm5.staticflickr.com/4613/39363415464_1ed88d85f3_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Yesterday I gave an
<a href="https://fosdem.org/2018/schedule/event/ode_epub_export/">EPUB export in
LibreOffice Writer FOSDEM</a> talk at FOSDEM 2018, in the
<a href="https://fosdem.org/2018/schedule/track/open_document_editors/">Open document
editors developer room</a>. The room was well-crowded&#8201;&#8212;&#8201;perhaps because the next
talk was about LibreOffice/Collabora Online. ;-)</p></div>
<div class="paragraph"><p>Quite some other slides will be available on
<a href="http://planet.documentfoundation.org/">Planet</a> I expect, don&#8217;t miss them.</p></div>
</p><hr/></li>
<li><p>Thursday, 11 January 2018<br /><a href="/blog/epub3-improvements-2.html">EPUB3 export improvements in Libreoffice Writer, take two</a>
</p><p><div class="paragraph"><p>I worked on improving the EPUB3 export filter in LibreOffice further recently.
First, thanks to <a href="http://nouenoff.nl/">Nou&amp;Off</a> in cooperation with a customer
who made this work possible. Since the
<a href="/blog/epub3-improvements.html">previous blog entry</a> there have been a
number of improvements around a next set of topics.</p></div>
<div class="sect1">
<h2 id="_cover_images">Cover images</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4760/38920770224_b247fa89c4_o.png" alt="https://farm5.staticflickr.com/4760/38920770224_b247fa89c4_o.png" />
</div>
</div>
<div class="paragraph"><p>It is now possible to specify a cover image for the exported EPUB file. Given
that a cover image is not naturally part of the Writer document model, I introduced the
concept of a media directory for the EPUB export. The media directory is a
directory next to the source file, with the &lt;file name without extension&gt;
name. If that directory contains a file named cover.svg (or .gif, .jpg, .png),
the exporter will automatically use it. Otherwise you can customize this
default.</p></div>
<div class="paragraph"><p>The picture shows two EPUB files in <a href="http://readium.org/">Readium</a> with
different cover images.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_improved_metadata_support">Improved metadata support</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4603/38920770174_142950782e_o.png" alt="https://farm5.staticflickr.com/4603/38920770174_142950782e_o.png" />
</div>
</div>
<div class="paragraph"><p>It&#8217;s quite frequent that you are technically author of a document, but the
logical author of the book is somebody else. Same for the date of the book,
and so on. So the EPUB export dialog now has support for overwriting the
defaults coming from the Writer document model. For mass-conversion of
documents it&#8217;s possible to place a &lt;file name without extension&gt;.xmp file in
the media directory and <a href="http://www.adobe.com/devnet/xmp.html">XMP</a> metadata
from that file will also overwrite metadata coming from the document model.</p></div>
<div class="paragraph"><p>The picture shows the extended EPUB export options dialog.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_footnotes_and_image_popups">Footnotes and image popups</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4612/38920770144_e90e2a8e92_o.png" alt="https://farm5.staticflickr.com/4612/38920770144_e90e2a8e92_o.png" />
</div>
</div>
<div class="paragraph"><p>I&#8217;ve added support for footnotes. As a special case of this, image popups on
images and text is now supported. This works by placing a relative link on a
text portion or on an image, and placing an image with the same name (e.g. in
high resolution) in the media directory. In this case the EPUB export will
bundle the image from the media directory inside the EPUB file and clicking on
the text or image will open the bundled image in a popup (or in some other
container, depending on how your reader interprets footnotes).</p></div>
<div class="paragraph"><p>The picture shows such a popup in Microsoft Edge.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_fixed_layout">Fixed layout</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4604/38920770104_108465bda1_o.png" alt="https://farm5.staticflickr.com/4604/38920770104_108465bda1_o.png" />
</div>
</div>
<div class="paragraph"><p>The EPUB3 fixed layout is quite similar to PDF, just it is built on top of
XHTML and SVG. Possible use-cases for this can be:</p></div>
<div class="ulist"><ul>
<li>
<p>
exporting a document where presenting the content as reflowable text would
  be misleading (e.g. comic books), but the publisher of the book only works
  with EPUB (reflowable or fixed layout, but no PDF)
</p>
</li>
<li>
<p>
printing (again, in case for some reason you want to avoid PDF)
</p>
</li>
</ul></div>
<div class="paragraph"><p>These might be very specific situations, but luckily supporting them is not
too complex. I implemented an approach very similar to the PDF export, where
we export individual pages of the Writer document&#8217;s layout as a metafile, and
then consume that&#8201;&#8212;&#8201;this time with the SVG export. Building on top of the
existing Writer layout and SVG export means the hard work is really done by
these components, the EPUB fixed layout export just puts these together.</p></div>
<div class="paragraph"><p>The picture shows a Writer document with a table of contents containing page
numbers, a header and a footer in Readium.</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.1), or you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Tuesday, 05 December 2017<br /><a href="/blog/epub3-improvements.html">EPUB3 export improvements in Libreoffice Writer</a>
</p><p><div class="paragraph"><p>I worked on improving the EPUB3 export filter in LibreOffice recently. First,
thanks to <a href="http://nouenoff.nl/">Nou&amp;Off</a> in cooperation with a customer who made
this work possible. Since the <a href="/blog/basic-epub3-export.html">previous blog
entry</a> there have been a number of improvements around 4 topics.</p></div>
<div class="sect1">
<h2 id="_improved_links">Improved links</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4540/38847800651_d5271ced3a_o.png" alt="https://farm5.staticflickr.com/4540/38847800651_d5271ced3a_o.png" />
</div>
</div>
<div class="paragraph"><p>The character properties of link text is now handled correctly, in the above
example you can see that the text is red, and this comes from a character
style.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_improved_table_support">Improved table support</h2>
<div class="sectionbody">
<div class="paragraph"><p>Previously the support for tables was there just to not loose content, now all
kinds cell, row and table properties are handled correctly. A few samples</p></div>
<div class="ulist"><ul>
<li>
<p>
custom cell width:
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4566/38847800611_38b8483d7f_o.png" alt="https://farm5.staticflickr.com/4566/38847800611_38b8483d7f_o.png" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
custom row height:
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4580/38847800521_26285a9152_o.png" alt="https://farm5.staticflickr.com/4580/38847800521_26285a9152_o.png" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
row span:
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4540/38847800461_359651bc3d_o.png" alt="https://farm5.staticflickr.com/4540/38847800461_359651bc3d_o.png" />
</div>
</div>
<div class="paragraph"><p>So the table support should be now decent, covering row and column spanning
and various cell border properties.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_improved_image_support">Improved image support</h2>
<div class="sectionbody">
<div class="paragraph"><p>Previously only the simplest as-character anchoring was supported. Now much
more cases are handled. Two examples:</p></div>
<div class="ulist"><ul>
<li>
<p>
image borders:
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4541/24975193838_94818bd1ed_o.png" alt="https://farm5.staticflickr.com/4541/24975193838_94818bd1ed_o.png" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
image with a caption:
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4568/24975193608_83239bf287_o.png" alt="https://farm5.staticflickr.com/4568/24975193608_83239bf287_o.png" />
</div>
</div>
<div class="paragraph"><p>This includes various wrap types (to the extent HTML5 allows representing ODF
wrap types).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_font_embedding">Font embedding</h2>
<div class="sectionbody">
<div class="paragraph"><p>If the user chooses to embed fonts (via File &#8594; Properties &#8594; Font &#8594; Embed),
then the EPUB export now handles this. Here is a custom font that is typically
not available:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4561/38847800811_613d6fbbd2_o.png" alt="https://farm5.staticflickr.com/4561/38847800811_613d6fbbd2_o.png" />
</div>
</div>
<div class="paragraph"><p>(The screenshot is from the Calibre ebook reader.)</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.1), or you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Friday, 10 November 2017<br /><a href="/blog/basic-epub3-export.html">Basic EPUB3 export in Libreoffice</a>
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4577/37588898064_117dc4a933_o_d.png" alt="https://farm5.staticflickr.com/4577/37588898064_117dc4a933_o_d.png" />
</div>
</div>
<div class="paragraph"><p>I worked on a new EPUB3 export filter in LibreOffice recently. First, thanks
to <a href="http://nouenoff.nl/">Nou&amp;Off</a> in cooperation with a customer who made this
work possible.  The current state is that basic features work nicely to the
extent that the filter is probably usable for most books (they typically
mostly have just text with minimal formatting), so this post aims to explain
the architecture, how the various pieces fit together.</p></div>
<div class="paragraph"><p>The above picture shows the building blocks. The idea is that nominally EPUB
is a complete export filter, but instead of doing all the work, we offload
various sub-tasks to other modules:</p></div>
<div class="ulist"><ul>
<li>
<p>
First we invoke the existing (flat) ODT export, so we can work with ODF
  instead of with the UNO API directly. This will be useful in the next step.
</p>
</li>
<li>
<p>
Then we feed the SAX events from the ODT export to a new librevenge text
  export. Given that the librevenge API is really close to ODF (and xmloff/
  has quite some code to map the UNO API to ODF), here it pays off to work with
  ODF and not with the UNO API directly.
</p>
</li>
<li>
<p>
The librevenge text export talks to a librevenge generator, which is
  David Tardon&#8217;s excellent
  <a href="https://sourceforge.net/projects/libepubgen/">libepubgen</a> in this case.
</p>
</li>
<li>
<p>
Finally libepubgen calls back to LibreOffice, and our package code does the
  ZIP compression.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The setup is a bit complicated, but it has a number of advantages:</p></div>
<div class="ulist"><ul>
<li>
<p>
Instead of reinventing the wheel, LO and DLP now shares code, libepubgen is
  now a dependency of LibreOffice.
</p>
</li>
<li>
<p>
libepubgen doesn&#8217;t bring its own ZIP writer code, it can nicely reuse our
  existing one.
</p>
</li>
<li>
<p>
This is a great opportunity to finally write an ODT&#8594;librevenge bridge, so
  other DLP-based export libs can be added in the future (e.g.
  <a href="https://sourceforge.net/projects/librvngabw/">librvngabw</a>).
</p>
</li>
<li>
<p>
If we ever want to export to EPUB from Draw/Impress, libepubgen will help us
  there as well.
</p>
</li>
</ul></div>
<div class="paragraph"><p>As a user, here is a list of features you can expect working:</p></div>
<div class="ulist"><ul>
<li>
<p>
plain text should work fine (formatting may be lost, but content should be
  fine)
</p>
</li>
<li>
<p>
table of contents, as long as you properly use headings or you separate
  chapters by page breaks
</p>
</li>
<li>
<p>
export options: EPUB3 vs EPUB2, split on headings vs page breaks
</p>
</li>
<li>
<p>
basic set of character and paragraph properties should work
</p>
</li>
</ul></div>
<div class="paragraph"><p>During development I regularly used
<a href="https://github.com/IDPF/epubcheck">epubcheck</a>, so hopefully the export result
is usually valid.</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.0), or you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</p><hr/></li>
<li><p>Friday, 13 October 2017<br /><a href="/blog/pdf-locon-rome-2k17.html">A year in LibreOffice’s PDF support LOCon talk</a>
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/71ba628d90704fa9aa06c985d0c5a344/pdf-locon-rome-2k17.pdf">
<img src="https://farm5.staticflickr.com/4468/37421553870_e33fe6329d_z.jpg" alt="https://farm5.staticflickr.com/4468/37421553870_e33fe6329d_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p><a href="http://conference.libreoffice.org/2017/the-program-2/oct-13th-friday/">A year
in LibreOffice’s PDF support</a> was a talk I gave today at LibreOffice
conference 2017. Given that this was one of the last talks at the whole
conference, thanks to the ones who still did not go home, but listened. :-)</p></div>
</p><hr/></li>
<li><p>Wednesday, 11 October 2017<br /><a href="/blog/code-structure-locon-rome-2k17.html">LibreOffice: Code Structure LOCon talk</a>
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/69a6d9f8e5a14a948b27796b4c73ae11/beginners-structure-locon-rome-2k17.pdf">
<img src="https://farm5.staticflickr.com/4457/37000772213_017693764a_z.jpg" alt="https://farm5.staticflickr.com/4457/37000772213_017693764a_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Today I gave a
<a href="http://conference.libreoffice.org/2017/the-program-2/oct-11th-wednesday/">LibreOffice:
Code Structure</a> talk at LibreOffice conference 2017. These are an updated
version of Michael Meeks'
<a href="https://wiki.documentfoundation.org/Development/Code_Overview">original
slides</a>, it&#8217;s actually surprised me how many things changed since April 2016.
:-)</p></div>
</p><hr/></li>
<li><p>Monday, 25 September 2017<br /><a href="/blog/pdfium-pathsegment.html">pdfium path segment API for LibreOffice's test needs</a>
</p><p><div class="paragraph"><p>I recently
<a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=da705eff910f512623a689aaf28604270fb8f1c4">fixed</a>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=108963">tdf#108963</a>, which
is a PDF export bug&#8201;&#8212;&#8201;in case of highlighted and rotated text in e.g.
Impress, the highlight rectangle in the PDF export was not rotated.</p></div>
<div class="paragraph"><p>This is how the export result looked like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4341/37305427601_db1cfb697e_o.png" alt="https://farm5.staticflickr.com/4341/37305427601_db1cfb697e_o.png" />
</div>
</div>
<div class="paragraph"><p>And this is how it now looks like, after fixing:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4453/37258379126_b20fd39655_o.png" alt="https://farm5.staticflickr.com/4453/37258379126_b20fd39655_o.png" />
</div>
</div>
<div class="paragraph"><p>For a long time the PDF export filter had no tests at all; the current
approach I introduced is that we parse the PDF export result with pdfium,
which is an excellent PDF rendering library (I covered it in general in an
<a href="https://vmiklos.hu/blog/pdfium.html">earlier post</a>).</p></div>
<div class="paragraph"><p>So given that pdfium knows how that rectangle looks like, we should be able to
query the details of it from a test as well, correct? It depends. Yes, it&#8217;s
possible technically, but no, most of the pdfium functionality is actually not
exposed at its <a href="https://pdfium.googlesource.com/pdfium/+/master/public/">public API</a>.</p></div>
<div class="paragraph"><p>The current situation is that one could use <code>FPDF_LoadMemDocument()</code>,
<code>FPDF_LoadPage()</code> to get access to a PDF page, then <code>FPDFPage_CountObject()</code> and
<code>FPDFPage_GetObject()</code> to iterate over objects on a page. We can filter for the
relevant object by using <code>FPDFPageObj_GetType()</code> and <code>FPDFPath_GetFillColor()</code>,
that will give us the only path that has a yellow fill color.</p></div>
<div class="paragraph"><p>But getting more info about the geometry of the path isn&#8217;t really possible. As
a workaround I went with <code>FPDFPageObj_GetBounds()</code> for the test, but wouldn&#8217;t it
be nicer to get the individual segments (the objects that are the children of
a path) and then get coordinates and other properties of a segment? This is
what the recent API I added to pdfium now does. It provides the followings:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>FPDFPath_CountSegments()</code> gives you the number of segments of a path
</p>
</li>
<li>
<p>
<code>FPDFPath_GetPathSegment()</code> gives you a given segment, via a new
  <code>FPDF_PATHSEGMENT</code> opaque type
</p>
</li>
<li>
<p>
you can use <code>FPDFPathSegment_GetPoint()</code> to get the coordinates,
  <code>FPDFPathSegment_GetType()</code> to get the type (move to, line to, etc.) and
  <code>FPDFPathSegment_GetClose()</code> to see if the segment closes the current subpath
  of the path (or not)
</p>
</li>
</ul></div>
<div class="paragraph"><p>This means that after the next pdfium update in LibreOffice, PDF export tests
can nicely assert these properties of paths instead of dubious <em>bounding box
should be larger after rotation</em> assertions.</p></div>
</p><hr/></li>
</ul></div>
<a href="/blog/archive.html">more &raquo;</a>

</div>
</div>
</div>
</div>
</body>
</html>
