<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<meta name="description" content="What is Miklos hacking - Tags: libreoffice - Miklos' blog" />
<meta name="keywords" content="vmiklos, libereoffice, swig, git, python, hacking, bitlbee" />
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/index.rss" />
<link rel="stylesheet" href="/blog/xhtml11.css" type="text/css" />
<link rel="stylesheet" href="/blog/xhtml11-quirks.css" type="text/css" />
<link rel="stylesheet" href="/blog/layout.css" type="text/css" />
<title>What is Miklos hacking - Tags: libreoffice</title>
<!-- google analytics start -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24726997-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- google analytics end -->
</head>
<body>
<div id="layout-banner-box">
<div id="layout-banner">
  <div id="layout-title">vmiklos.hu</div>
  <div id="layout-description">shameless self-promoting website</div>
</div>
</div>
<div id="layout-menu-box">
<div id="layout-menu">
  <div>&#187;<a href="/">Root</a></div>
  <div>&#187;<a href="/blog/">Rejourn root</a></div>
  <div>&#187;<a href="http://planet.documentfoundation.org/">LibreOffice Community Blogs</a></div>
  <div>
    Search:<br/>
    <form action="http://www.google.com/cse" id="cse-search-box" target="_blank">
    <input type="hidden" name="cx" value="007336731492173318056:bik8fqvatno"/><input type="hidden" name="ie" value="UTF-8"/><input type="text" name="q" size="15"/><br/>
    <input type="submit" name="sa" value="&#187;"/></form>
  </div>
</div>


</div>
<div id="layout-content-box">
<div id="layout-content">
<div id="header">
	<h1>What is Miklos hacking - Tags: libreoffice</h1>
</div>
<div id="preamble">
<div class="sectionbody">




<!-- Listing -->
<div class="ulist"><ul>
<li><p>Monday, 25 September 2017<br /><a href="/blog/pdfium-pathsegment.html">pdfium path segment API for LibreOffice's test needs</a>
(<a href="/blog/pdfium-pathsegment.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>I recently
<a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=da705eff910f512623a689aaf28604270fb8f1c4">fixed</a>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=108963">tdf#108963</a>, which
is a PDF export bug&#8201;&#8212;&#8201;in case of highlighted and rotated text in e.g.
Impress, the highlight rectangle in the PDF export was not rotated.</p></div>
<div class="paragraph"><p>This is how the export result looked like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4341/37305427601_db1cfb697e_o.png" alt="https://farm5.staticflickr.com/4341/37305427601_db1cfb697e_o.png" />
</div>
</div>
<div class="paragraph"><p>And this is how it now looks like, after fixing:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4453/37258379126_b20fd39655_o.png" alt="https://farm5.staticflickr.com/4453/37258379126_b20fd39655_o.png" />
</div>
</div>
<div class="paragraph"><p>For a long time the PDF export filter had no tests at all; the current
approach I introduced is that we parse the PDF export result with pdfium,
which is an excellent PDF rendering library (I covered it in general in an
<a href="https://vmiklos.hu/blog/pdfium.html">earlier post</a>).</p></div>
<div class="paragraph"><p>So given that pdfium knows how that rectangle looks like, we should be able to
query the details of it from a test as well, correct? It depends. Yes, it&#8217;s
possible technically, but no, most of the pdfium functionality is actually not
exposed at its <a href="https://pdfium.googlesource.com/pdfium/+/master/public/">public API</a>.</p></div>
<div class="paragraph"><p>The current situation is that one could use <code>FPDF_LoadMemDocument()</code>,
<code>FPDF_LoadPage()</code> to get access to a PDF page, then <code>FPDFPage_CountObject()</code> and
<code>FPDFPage_GetObject()</code> to iterate over objects on a page. We can filter for the
relevant object by using <code>FPDFPageObj_GetType()</code> and <code>FPDFPath_GetFillColor()</code>,
that will give us the only path that has a yellow fill color.</p></div>
<div class="paragraph"><p>But getting more info about the geometry of the path isn&#8217;t really possible. As
a workaround I went with <code>FPDFPageObj_GetBounds()</code> for the test, but wouldn&#8217;t it
be nicer to get the individual segments (the objects that are the children of
a path) and then get coordinates and other properties of a segment? This is
what the recent API I added to pdfium now does. It provides the followings:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>FPDFPath_CountSegments()</code> gives you the number of segments of a path
</p>
</li>
<li>
<p>
<code>FPDFPath_GetPathSegment()</code> gives you a given segment, via a new
  <code>FPDF_PATHSEGMENT</code> opaque type
</p>
</li>
<li>
<p>
you can use <code>FPDFPathSegment_GetPoint()</code> to get the coordinates,
  <code>FPDFPathSegment_GetType()</code> to get the type (move to, line to, etc) and
  <code>FPDFPathSegment_GetClose()</code> to see if the segment closes the current subpath
  of the path (or not)
</p>
</li>
</ul></div>
<div class="paragraph"><p>This means that after the next pdfium update in LibreOffice, PDF export tests
can nicely assert these properties of paths instead of hacky <em>bounding box
should be larger after rotation</em> assertions.</p></div>
</p><hr/></li>
<li><p>Friday, 25 August 2017<br /><a href="/blog/sw-split-section-in-table.html">Split sections inside tables for LibreOffice Writer</a>
(<a href="/blog/sw-split-section-in-table.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>Tables and sections in LibreOffice Writer are both containers, and in some
cases it makes sense to have sections inside tables or tables inside sections.
(For example you can mark a group of paragraphs as read-only by including them
in a read-only section.) Tables in sections, split over multiple pages was
already working, but now it&#8217;s possible to have sections in tables split over
multiple pages as well.</p></div>
<div class="paragraph"><p>First, thanks <a href="https://www.escriba.de/en/">Escriba</a> who made this work possible.</p></div>
<div class="paragraph"><p>There were 3 parts of this work, you can read some details about them below.</p></div>
<div class="sect1">
<h2 id="_split_of_multi_line_paragraphs">Split of multi-line paragraphs</h2>
<div class="sectionbody">
<div class="paragraph"><p>The first goal was to handle the split of multi-line paragraphs inside
sections inside tables. Initially this looked like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4430/35957293074_cfeabe6a51_o.png" alt="https://farm5.staticflickr.com/4430/35957293074_cfeabe6a51_o.png" />
</div>
</div>
<div class="paragraph"><p>After commit
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=f991b842addddeada6dc45c4054deeca5aa7f17b">tdf#108524
sw: attempt to split section frames inside table cells</a> it looks like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4393/35957293014_ae8f210542_o.png" alt="https://farm5.staticflickr.com/4393/35957293014_ae8f210542_o.png" />
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_split_of_one_liner_paragraphs">Split of one-liner paragraphs</h2>
<div class="sectionbody">
<div class="paragraph"><p>Technically this is a situation different to the previous one, as split
paragraphs have a master (first) frame and one or more follow (non-first)
frames; and the previous stage only addressed the move of follow frames to
next pages. Initially such a document looked like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4360/35957292924_2af502ffc7_o.png" alt="https://farm5.staticflickr.com/4360/35957292924_2af502ffc7_o.png" />
</div>
</div>
<div class="paragraph"><p>After commit
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=f8a76d218305a56d15b82b9dac4fafa558872780">tdf#108524
sw: split section frames inside table cells, non-split text frames</a> it is laid
out as expected:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4399/35957292834_dc2ce35f85_o.png" alt="https://farm5.staticflickr.com/4399/35957292834_dc2ce35f85_o.png" />
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_merge_a_split_section">Merge a split section</h2>
<div class="sectionbody">
<div class="paragraph"><p>The last piece was moving paragraphs back to previous pages when there is
again space for them. Initially we did not use the newly available space:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4432/35982835413_99a65febe2_o.png" alt="https://farm5.staticflickr.com/4432/35982835413_99a65febe2_o.png" />
</div>
</div>
<div class="paragraph"><p>After commit
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=850bf99e7d1abcf2e0cce731b6715f87420d0ee6">tdf#108524
sw: handle sections inside tables in SwFrame::GetPrevSctLeaf()</a> the paragraph
is moved back properly:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4408/35982835283_1c2002254b_o.png" alt="https://farm5.staticflickr.com/4408/35982835283_1c2002254b_o.png" />
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_one_more_thing_8230">One more thing&#8230;</h2>
<div class="sectionbody">
<div class="paragraph"><p>Given that all code changes affect how sections in tables are handled in a
parent frame in general (which is a body frame in all the above pictures), the
same changes are also usable for other parent containers as well, e.g. linked
TextFrames. Here is how that looks like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4342/35982835353_25d609548d_o.png" alt="https://farm5.staticflickr.com/4342/35982835353_25d609548d_o.png" />
</div>
</div>
<div class="paragraph"><p>That&#8217;s it for now&#8201;&#8212;&#8201;as usual the commits are in master, so you can try this
right now with a 6.0 <a href="http://dev-builds.libreoffice.org/daily/master/">daily
build</a>. :-)</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Friday, 21 July 2017<br /><a href="/blog/mail-merge-writer-data-source.html">Mail merge Writer data source</a>
(<a href="/blog/mail-merge-writer-data-source.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>If you ever used the
<a href="https://help.libreoffice.org/Writer/Mail_Merge_Wizard">mail merge wizard</a> with
data sources, then you know how it works: it typically needs some kind of data
source (e.g. a Calc spreadsheet), a Writer document containing the email or
letter (that contains fields), and then mail merge can generate the
personalized documents for you.</p></div>
<div class="paragraph"><p>In case you have an existing document where you already have such data in a
Writer table, you had to somehow transfer it to one of the formats for which
there was a data source driver, and then you could use it inside mail merge.
I&#8217;ve now added a dedicated Writer driver in <code>connectivity/</code>, so picking up
data directly from Writer tables is now possible.</p></div>
<div class="paragraph"><p>If you are interested how this looks like, here is a demo (click on the image
to see the video):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://youtu.be/thasVxlF5Fo">
<img src="https://farm5.staticflickr.com/4298/36060010585_900a1c7f1c_o.png" alt="https://farm5.staticflickr.com/4298/36060010585_900a1c7f1c_o.png" />
</a>
</div>
</div>
<div class="paragraph"><p>That&#8217;s it for now&#8201;&#8212;&#8201;as usual the commits are in master, so you can try this
right now with a 6.0 <a href="http://dev-builds.libreoffice.org/daily/master/">daily
build</a>. :-)</p></div>
</p><hr/></li>
<li><p>Tuesday, 04 July 2017<br /><a href="/blog/system-xmlsec.html">Using LibreOffice with xmlsec from the system</a>
(<a href="/blog/system-xmlsec.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>LibreOffice uses a number of external libraries, and most of them can be
configured to use a bundled version or a system version. libxmlsec was an
exception previously (only the bundled version was usable), but LibreOffice
master (towards 6.0) doesn&#8217;t have this limitation anymore.</p></div>
<div class="paragraph"><p>Using a bundled version is a good choice in case:</p></div>
<div class="ulist"><ul>
<li>
<p>
you want to create self-contained binaries
</p>
</li>
<li>
<p>
you want to bisect a regression, where possibly the regression was
  introduced by upgrading one of the external libraries
</p>
</li>
<li>
<p>
the system (e.g. macOS, Windows) doesn&#8217;t provide the relevant library
</p>
</li>
</ul></div>
<div class="paragraph"><p>Using a system version is a good thing in case:</p></div>
<div class="ulist"><ul>
<li>
<p>
you want to work with the system, not against it (if a Linux distro already
  provides libxmlsec, why ship a duplicated copy inside LibreOffice?)
</p>
</li>
<li>
<p>
being able to use a system version means our bundled version does not have
  custom patches which affect the functionality of the library
</p>
</li>
<li>
<p>
not having custom patches also means upstream benefit from our submitted
  patches, these patches are reviewed by competent maintainers and upgrading
  the external is easier, as there is no patchset to rebase.
</p>
</li>
</ul></div>
<div class="paragraph"><p>With that in mind, let&#8217;s have a look what blocked using system-xmlsec in the past:</p></div>
<div class="ulist"><ul>
<li>
<p>
LibreOffice inherited a large patchset from OpenOffice.org, commit
  694a2c53810dec6d8e069d74baf51e6cdda91faa (2012-11-30) had 16 patches, with
  this scary diffstat:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code> 43 files changed, 5888 insertions(+), 1885 deletions(-)</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
I even increased this when I added the
  <a href="/blog/libreoffice-sha256-signatures.html">SHA256 patches</a>, as back then
  I wasn&#8217;t sure if it&#8217;ll be ever possible to upgrade to a newer libxmlsec
  version.
</p>
</li>
<li>
<p>
Step by step I got rid of most of these patches, either by upstreaming them
  or realizing they are no longer necessary. Upstreaming wasn&#8217;t always
  trivial, as for our purposes it was always easy to patch something, but for
  upstream non-compatible changes always have to be conditional. Today we have
  3 build-specific patches, 1 backport and 1 feature patch that is (at least)
  not necessary when signing / verifying documents with software-based
  certificates.
</p>
</li>
<li>
<p>
At the end
  <a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=9752eccdd06f6695ec4f173ea93cada65063d1f0">two</a>
  <a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=ab50f0b08b22af1e60a0b6ce5e7e8e7d1f665216">more</a>
  commits were necessary to support building against system-xmlsec, only adding
  minimal differences when using the system or the bundled xmlsec variants.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you are a Linux distro packager then <code>--with-system-libs</code> already implies
<code>--with-system-xmlsec</code>, so you probably don&#8217;t have to do anything. If you
build LO for static analysis (e.g. Coverity) then this should be also useful,
so not relevant issues in 3rd-party code don&#8217;t have to be ignored manually.</p></div>
</p><hr/></li>
<li><p>Wednesday, 31 May 2017<br /><a href="/blog/perugia2017.html">LibreOffice Perugia HackFest 2017</a>
(<a href="/blog/perugia2017.html#disqus_thread">Comments</a>)
</p><p><div style="text-align: center; font-size: 0.6em;">
<img src="https://farm5.staticflickr.com/4272/34874639921_ef2ce56d1c_z.jpg"/>
<p>(via <a href="https://twitter.com/ogervasi/status/868767747756503041">ogervasi</a>)</p>
</div>
<div class="paragraph"><p>Last weekend I attended the LibreOffice
<a href="https://wiki.documentfoundation.org/Hackfest/Perugia2017">Perugia</a> HackFest
2017, with the primary goal of mentoring students (together with
<a href="http://erack.org/blog/">Eike</a> and Christian): provided they manage to
contribute at least one non-trivial easy hack, they get university credits for
their work.</p></div>
<div class="paragraph"><p>I worked with <a href="https://gerrit.libreoffice.org/38160">Arianna</a>,
<a href="https://gerrit.libreoffice.org/38159">Claudio</a>,
<a href="https://gerrit.libreoffice.org/38161">Francesco</a> and
<a href="https://gerrit.libreoffice.org/38134">Gian</a>, all of them managed to
achieve something by the end of the third day.</p></div>
<div class="paragraph"><p>When I was not helping others, I also fixed a few bugs:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=107976">tdf#107976</a> sw: let a view handle multiple transferables
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=107837">tdf#107837</a> DOCX export: fix balanced multi-col section at doc end
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=107684">tdf#107684</a> DOCX export: fix duplicated &lt;w:outlineLvl&gt; element for styles
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=106950">tdf#106950</a> sw: support CharShadingValue property on paragraph styles
</p>
</li>
</ul></div>
<div class="paragraph"><p>Some photos I took during the event are <a href="https://www.flickr.com/photos/vmiklos/albums/72157681387507534">available</a>.</p></div>
<div class="paragraph"><p>Thanks the organizers for the great event, also kudos to
<a href="https://www.collaboraoffice.com/">Collabora</a>, Red Hat and TDF for allowing
mentors to come! :-)</p></div>
</p><hr/></li>
<li><p>Wednesday, 17 May 2017<br /><a href="/blog/xmlsec-lo54.html">xmlsec improvements in LibreOffice 5.4</a>
(<a href="/blog/xmlsec-lo54.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>This post summarizes the plumbing work around ODF/OOXML digital signatures
that I did on LibreOffice master after the 5.3 branch-off up to now. The big
thing is the
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=ad319fdfcaaa6092ea1ff76935e088c5122e0d2e">integration</a>
of the libxmlsec 1.2.24 release. Among other things, this contains 2 larger
changes that I contributed upstream triggered by the needs of LibreOffice:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <a href="/blog/xmlsec-nss-ecdsa.html">ECDSA-SHA256 feature</a> is something I
  already mentioned, but I did not bother to backport the SHA1 and the SHA256
  part, so those now arrived to LibreOffice as well.
</p>
</li>
<li>
<p>
xmlsec&#8217;s <code>XMLSEC_KEYINFO_FLAGS_X509DATA_DONT_VERIFY_CERTS</code> flag (while
  verifying signatures) was there, but its behavior was not clear (neither
  for <a href="https://github.com/lsh123/xmlsec/pull/78">nss</a> nor for
  <a href="https://github.com/lsh123/xmlsec/pull/79">mscrypto</a>). I&#8217;ve changed it to be in
  sync what you have in other commands to avoid certificate validation (like
  <code>wget -k</code> or <code>curl -k</code>), which means as a next step there will be one less
  xmlsec patch in LibreOffice that prevents us from using xmlsec from the system
  on Linux. (Adding tests also detected that in the nss case not using that flag
  also didn&#8217;t do verification by accident, this is now fixed as well.)
</p>
</li>
</ul></div>
<div class="paragraph"><p>After the release I also noticed that creating signatures on Windows
<a href="https://www.aleksey.com/pipermail/xmlsec/2017/010143.html">was broken</a>, this is
now fixed on xmlsec master and also backported to LibreOffice.</p></div>
<div class="paragraph"><p>All this is available in LibreOffice master, towards 5.4.</p></div>
</p><hr/></li>
<li><p>Tuesday, 18 April 2017<br /><a href="/blog/pdf-image-rountrip.html">Improved rountrip of PDF images in LibreOffice</a>
(<a href="/blog/pdf-image-rountrip.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>This is a follow-up to the <a href="/blog/pdfium.html">previous post</a> that
described how it is now possible to insert a PDF file as an image in
LibreOffice and export that back to PDF, while keeping the original PDF
contents. I&#8217;ve recently improved this feature so the resulting file is smaller
and the vector image can be viewed in more viewers. First, thanks to
<a href="http://www.pmg.be/">PMG</a> who made this work possible.</p></div>
<div class="paragraph"><p>Let&#8217;s look at the previously mentioned <em>front page of a magazine</em> sample when
it&#8217;s viewed in okular. (A KDE pdf viewer, i.e. something that&#8217;s not Adobe
Acrobat). The previously used <em>reference XObject</em> PDF markup is not handled by
it, so the bitmap fallback was displayed:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3947/34031939205_5315a9afb4_o.png" alt="https://farm4.staticflickr.com/3947/34031939205_5315a9afb4_o.png" />
</div>
</div>
<div class="paragraph"><p>Compare it with the new result:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2830/34031939425_24b9a126ee_o.png" alt="https://farm3.staticflickr.com/2830/34031939425_24b9a126ee_o.png" />
</div>
</div>
<div class="paragraph"><p>Notice the sharp text in the first line.</p></div>
<div class="paragraph"><p>Also the size of this sample is smaller now, since we don&#8217;t write a large
bitmap, and the not shown second page of the PDF image: 2 385 984 &#8594; 1 605 558
bytes (about one third of the output is avoided).</p></div>
<div class="paragraph"><p>Both techniques have pros and cons, here is a summary:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <em>reference XObject</em> approach allows you to preserve the full PDF data of
  the image: if it was of multiple pages, even that. Also, the LibreOffice
  code for this is simple: we just preserve a byte array&#8201;&#8212;&#8201;that can hardly go
  wrong. The problem is that no non-Acrobat PDF viewer implements this,
  including e.g. your printer most probably.
</p>
</li>
<li>
<p>
The new approach uses the tokenizer I originally wrote for
  <a href="/blog/pdf-sign.html">PDF signature verification</a> purposes&#8201;&#8212;&#8201;it extracts
  the page stream of the first page from the original file and uses it as a
  form XObject in the export result&#8201;&#8212;&#8201;this is the same as how e.g. <code>pdfcrop</code>
  works.  This markup is handled by almost all PDF viewers and also the
  resulting size is smaller, since the data of other pages is dropped and there
  is no fallback bitmap. The problem may be that this is a much more complex
  scenario, so it may go wrong (as usual, bugreports
  <a href="https://bugs.documentfoundation.org/enter_bug.cgi?product=LibreOffice">are
  welcome</a>).
</p>
</li>
</ul></div>
<div class="paragraph"><p>Nevertheless, the new approach seems like a much better default, so
LibreOffice no longer writes the <em>reference XObject</em> approach unless you
explicitly request it in the PDF export dialog.</p></div>
<div class="paragraph"><p>Some perhaps interesting details:</p></div>
<div class="ulist"><ul>
<li>
<p>
PDF page streams may be provided by multiple objects, but form XObjects must
  have a single stream, so it we handle the case when different parts of the
  page stream are compressed in different ways.
</p>
</li>
<li>
<p>
LibreOffice writes PDF-1.4 by default, in case you insert a PDF image that
  uses PDF-1.5+, we use pdfium to downgrade that markup to 1.4, and only
  then insert it.
</p>
</li>
<li>
<p>
Copying the page stream of the image is not enough, we also recursively copy
  all referenced objects from the source PDF, while rewriting all contained
  references, since the objects IDs in the old and new files differ. We also
  take care of proper scoping of named references in the resource dictionary, so
  you can use this feature recursively (insert a document as a PDF image, even
  if that document itself contains PDF images already). :-)
</p>
</li>
</ul></div>
<div class="paragraph"><p>All this is available in LibreOffice master, towards 5.4.</p></div>
</p><hr/></li>
<li><p>Monday, 20 March 2017<br /><a href="/blog/pdfium.html">LibreOffice now uses pdfium to render inserted PDF images</a>
(<a href="/blog/pdfium.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>pdfium is the rendering library used in Chromium&#8217;s pdf viewer. It&#8217;s based on
the foxit pdf renderer and its rendering quality is much better compared to
the pre-existing "convert PDF to ODG, then to an image" code when it comes to
just viewing a PDF file.  First, thanks to <a href="http://www.pmg.be/">PMG</a> who made
this work possible.</p></div>
<div class="paragraph"><p>Let&#8217;s look at a few samples that compare the old pdfimport rendering result
and the new pdfium-based one. One important feature is that embedded fonts are
handled. This is how this inserted PDF looked like previously:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3727/33163219940_3a2a3278a0_o.png" alt="https://farm4.staticflickr.com/3727/33163219940_3a2a3278a0_o.png" />
</div>
</div>
<div class="paragraph"><p>Compare it with the new result:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2927/33547029855_92c1a5150d_o.png" alt="https://farm3.staticflickr.com/2927/33547029855_92c1a5150d_o.png" />
</div>
</div>
<div class="paragraph"><p>Now let&#8217;s see the front page of a magazine, you can see 4 unexpected artifacts:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3948/33563793222_8a6b8e8a6b_z.jpg" alt="https://farm4.staticflickr.com/3948/33563793222_8a6b8e8a6b_z.jpg" />
</div>
</div>
<div class="paragraph"><p>New result:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2809/33547029645_de7cbcd800_z.jpg" alt="https://farm3.staticflickr.com/2809/33547029645_de7cbcd800_z.jpg" />
</div>
</div>
<div class="paragraph"><p>Finally a problem with pdfium was that LibreOffice got bitmaps from it, so in case you re-exported to PDF, the quality of these PDF images were worse than in the original PDF file. The PDF specification has a <em>reference XObject</em> feature that helps in this case: it allows the PDF export to still write the bitmap to the exported PDF, but in case the reader supports this feature, the vector-based original file will be shown, not the bitmap.</p></div>
<div class="paragraph"><p>Here is a simple hand-crafted star in a PDF file, as it looked initially:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2915/33163219680_30f63b4a82_z.jpg" alt="https://farm3.staticflickr.com/2915/33163219680_30f63b4a82_z.jpg" />
</div>
</div>
<div class="paragraph"><p>This is how it looks after LibreOffice&#8217;s PDF export learned to emit reference XObjects:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3933/33547029485_4f487bb26c_z.jpg" alt="https://farm4.staticflickr.com/3933/33547029485_4f487bb26c_z.jpg" />
</div>
</div>
<div class="paragraph"><p>All this is available in LibreOffice master, towards 5.4.</p></div>
</p><hr/></li>
<li><p>Monday, 13 March 2017<br /><a href="/blog/xmlsec-nss-ecdsa.html">ECDSA support in xmlsec-nss, bundled by LibreOffice</a>
(<a href="/blog/xmlsec-nss-ecdsa.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>Last month a
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=105983">LibreOffice
bugreport</a> was filed, as the ODF signature created with Hungarian citizen eID
cards is not something LibreOffice can verify. After a bit of research it
seemed that LibreOffice and NSS (what we use for crypto work on Linux/macOS)
is not a problem, but xmlsec&#8217;s NSS backend does not recognize ECDSA keys (RSA
or DSA keys work fine).</p></div>
<div class="paragraph"><p>The xmlsec improvements happened in these pull requests:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/lsh123/xmlsec/pull/81">prepare the xmlsec ECDSA tests</a>, so
  that they can test not only openssl, but NSS as well
</p>
</li>
<li>
<p>
<a href="https://github.com/lsh123/xmlsec/pull/83">add initial ECDSA support</a> (SHA256
  hashing only)
</p>
</li>
<li>
<p>
<a href="https://github.com/lsh123/xmlsec/pull/88">SHA1 support</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/lsh123/xmlsec/pull/89">SHA512 support</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/lsh123/xmlsec/pull/91">fix read of uninitialized memory</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>After this the xmlsec code looked good enough. I had to request an update of
the bugdoc in the TDF bug twice, as the signature itself looked also incorrect
initially:</p></div>
<div class="ulist"><ul>
<li>
<p>
an attribute type in the signature that had no official abbreviation was
  described as "UNDEF" instead of the dotted decimal form
</p>
</li>
<li>
<p>
<a href="https://tools.ietf.org/html/rfc3279#section-2.2.3">RFC3279</a> specifies that an
  ECDSA signature value in general should be ASN1-encoded in general, but
  <a href="https://tools.ietf.org/html/rfc4050#section-3.3">RFC4050</a> is specific to XML
  digital signatures and that one says it should <strong>not</strong> be ASN1-encoded. The
  bugdoc was initially ASN1-encoded.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Finally a warning still remains: while trying to parse the text of the
<code>&lt;X509IssuerName&gt;</code> element, the dotted decimal form is still not parsed (see
this <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1342137">NSS bugreport</a>). The
bug is confirmed on the mailing list, but no other progress have been made so
far.</p></div>
<div class="paragraph"><p>Oh, and of course: Windows is still untouched, there a bigger problem remains:
we use CryptoAPI (not CNG) there, and that does not support ECDSA at all.
Hooray for open-source libs where you can add such support yourself. ;-)</p></div>
</p><hr/></li>
<li><p>Thursday, 16 February 2017<br /><a href="/blog/pdf-video-export.html">LibreOffice PDF export now supports videos</a>
(<a href="/blog/pdf-video-export.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3924/32549564340_4d0990cfa4_o.png" alt="https://farm4.staticflickr.com/3924/32549564340_4d0990cfa4_o.png" />
</div>
</div>
<div class="paragraph"><p>PDF supports screen annotations, which means it&#8217;s possible to play embedded
and linked videos on top of a static image. Given that LibreOffice also
supports videos, it made sense to add support for this in our PDF export
filter. First, thanks to <a href="http://www.pmg.be/">PMG</a> who made this work possible. This
is currently added for Writer and Impress.</p></div>
<div class="sect1">
<h2 id="_linked_videos">Linked videos</h2>
<div class="sectionbody">
<div class="paragraph"><p>Linked videos are the situation when the video is not part of the document
itself, but it&#8217;s located somewhere else, e.g. a http:// location. This is
helpful if you want to email around a PDF file, and want to avoid sending
large files when it has video content.</p></div>
<div class="paragraph"><p><a href="https://bugs.documentfoundation.org/show_bug.cgi?id=104841">tdf#104841</a> is
about this situation, first I added support for
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=9d6a749bc664f1876c938afb9eba4adc9f6ee09a">linked
videos in Impress</a>, then
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=81aef113056270ce65f9dee5fe31b6f60617973c">also</a>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=0e71075bb7379af318482bb3abbb630c58db9ec9">in
Writer</a>.</p></div>
<div class="paragraph"><p>The result can be played using Adobe Acrobat Reader&#8201;&#8212;&#8201;for some reason okular
on Linux is a bit confused about http:// URLs, wants to convert them to
relative ones, and then fails as of today.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_embedded_videos">Embedded videos</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2666/32115175413_ec6f64243a_z.jpg" alt="https://farm3.staticflickr.com/2666/32115175413_ec6f64243a_z.jpg" />
</div>
</div>
<div class="paragraph"><p><a href="https://bugs.documentfoundation.org/show_bug.cgi?id=105093">tdf#105093</a> is the
embedded video case, this is handy in case you want to create an entirely
self-contained PDF, where even the video content is inside the PDF file as an
embedded file.</p></div>
<div class="paragraph"><p>After
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=4ad249af88d15f2c8a09f0721a59d82718fcc201">Impress
support</a> (and a trick around
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=64d80d22851a38eb3f320f4e2b2bdf875da4d8b4">Draw
vs Impress shapes</a>) the
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=46153bdcf2f89e88607dfb0dd0003108796424e9">Writer
part</a> wasn&#8217;t too complicated.</p></div>
<div class="paragraph"><p>Regarding the situation around various video containers and codecs, the above
code is quite agnostic. :-) On the LibreOffice side all we require is to be
able to extract a key frame from the video to provide a preview image, so e.g.
on Linux the support depends on what gstreamer plugins you have installed. The
video content is written to the PDF file as-is, so again if it will work in
the PDF reader is up to the reader&#8217;s codec support. On Linux e.g. okular uses
vlc for video playback, so the range of supported formats is quite wide.  The
same is true on Windows, what I personally tested is LibreOffice&#8217;s VLC backend
and the embedded QuickTime player in Acrobat Reader.</p></div>
<div class="paragraph"><p>All of this is available on LibreOffice master towards 5.4.</p></div>
</div>
</div>
</p><hr/></li>
</ul></div>
<a href="/blog/archive.html">more &raquo;</a>
<script type="text/javascript">
var disqus_shortname = 'vmiklos';
(function () {
 var s = document.createElement('script'); s.async = true;
 s.src = '//vmiklos.disqus.com/count.js';
 (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

</div>
</div>
</div>
</div>
</body>
</html>
