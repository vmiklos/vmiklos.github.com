<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<meta name="description" content="What is Miklos hacking - Tags: en - Miklos' blog" />
<meta name="keywords" content="vmiklos, libereoffice, swig, git, python, hacking, bitlbee" />
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://vmiklos.hu/blog/index.rss" />
<link rel="stylesheet" href="/blog/xhtml11.css" type="text/css" />
<link rel="stylesheet" href="/blog/xhtml11-quirks.css" type="text/css" />
<link rel="stylesheet" href="/blog/layout.css" type="text/css" />
<title>What is Miklos hacking - Tags: en</title>
<!-- google analytics start -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24726997-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- google analytics end -->
</head>
<body>
<div id="layout-banner-box">
<div id="layout-banner">
  <div id="layout-title">vmiklos.hu</div>
  <div id="layout-description">shameless self-promoting website</div>
</div>
</div>
<div id="layout-menu-box">
<div id="layout-menu">
  <div>&#187;<a href="/">Root</a></div>
  <div>&#187;<a href="/blog/">Rejourn root</a></div>
  <div>&#187;<a href="http://planet.documentfoundation.org/">LibreOffice Community Blogs</a></div>
  <div>
    Search:<br/>
    <form action="http://www.google.com/cse" id="cse-search-box" target="_blank">
    <input type="hidden" name="cx" value="007336731492173318056:bik8fqvatno"/><input type="hidden" name="ie" value="UTF-8"/><input type="text" name="q" size="15"/><br/>
    <input type="submit" name="sa" value="&#187;"/></form>
  </div>
</div>


</div>
<div id="layout-content-box">
<div id="layout-content">
<div id="header">
	<h1>What is Miklos hacking - Tags: en</h1>
</div>
<div id="preamble">
<div class="sectionbody">




<!-- Listing -->
<div class="ulist"><ul>
<li><p>Wednesday, 16 July 2014<br /><a href="/blog/textbox.html">TextBox: complex LibreOffice Writer content inside shapes</a>
(<a href="/blog/textbox.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh6.googleusercontent.com/-Aq8Uxzw0bys/U8ZXkDbzhfI/AAAAAAAAEiQ/2pvZlSkHTsc/s0/">
<img src="https://lh6.googleusercontent.com/-Aq8Uxzw0bys/U8ZXkDbzhfI/AAAAAAAAEiQ/2pvZlSkHTsc/s400/" alt="https://lh6.googleusercontent.com/-Aq8Uxzw0bys/U8ZXkDbzhfI/AAAAAAAAEiQ/2pvZlSkHTsc/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>TL;DR: see above&#8201;&#8212;&#8201;it&#8217;s now possible to have complex Writer content (charts,
tracked changes, tables, fields, etc.) inside drawinglayer shapes, yay! :-)</p></div>
<div class="sect1">
<h2 id="_the_problem">The problem</h2>
<div class="sectionbody">
<div class="paragraph"><p>Writer in LibreOffice 4.3 can have two kind of shapes: drawinglayer ones or
Writer TextFrames. (Let&#8217;s ignore OLE objects and Writer pictures for now.)
Drawinglayer shapes can be triangles (non-rectangular), rectangles can have
rounded corners and so on, but shape text is handled by editeng&#8201;&#8212;&#8201;the same
engine that is used for Impress shapes or Calc cells. OTOH a Writer TextFrame
can contain anything that is supported by Writer (Writer fields, styles,
tables, etc.), but its drawing capabilities are quite limited: no triangle,
rounded corners, etc. Together with <a href="http://www.cloudon.com/">CloudOn</a>, we
thought the best would be to be able to have both, and started to use the
"shape with TextBox" term for this feature.</p></div>
<div class="paragraph"><p>A user can already sort of to do this by creating a drawinglayer shape, then a
Writer TextFrame, and by setting the properties of the Writer TextFrame
(position, size, etc) to appear as if the TextFrame would be the shape text of
the drawinglayer shape.  The idea is to tie these two objects together, so the
(UI and API) user sees them as a single object.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results">Results</h2>
<div class="sectionbody">
<div class="paragraph"><p>I&#8217;m providing here a few screenshots. Above, you can see <a href="http://cgit.freedesktop.org/libreoffice/core/tree/sw/qa/extras/odfexport/data/textbox-rounded-corners.odt">an ODF document</a>
having a rectangle with rounded corners, still containing a table.</p></div>
<div class="paragraph"><p>Given that OOXML has this feature since its birth, I&#8217;m also showing <a href="http://people.freedesktop.org/~vmiklos/2014/textbox/">a few DOCX
documents</a>, which are now handled far better:</p></div>
<div class="ulist"><ul>
<li>
<p>
chart inside a left arrow callout:
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh4.googleusercontent.com/-s5ABCN9pchc/U8ZXfLV5eKI/AAAAAAAAEh4/uxpwBVIcJRU/s0/">
<img src="https://lh4.googleusercontent.com/-s5ABCN9pchc/U8ZXfLV5eKI/AAAAAAAAEh4/uxpwBVIcJRU/s400/" alt="https://lh4.googleusercontent.com/-s5ABCN9pchc/U8ZXfLV5eKI/AAAAAAAAEh4/uxpwBVIcJRU/s400/" />
</a>
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
tracked changes inside a cloud callout:
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh6.googleusercontent.com/-AzHF9r3PMgY/U8ZXhbZuXOI/AAAAAAAAEiA/58FsbrkumcM/s0/">
<img src="https://lh6.googleusercontent.com/-AzHF9r3PMgY/U8ZXhbZuXOI/AAAAAAAAEiA/58FsbrkumcM/s400/" alt="https://lh6.googleusercontent.com/-AzHF9r3PMgY/U8ZXhbZuXOI/AAAAAAAAEiA/58FsbrkumcM/s400/" />
</a>
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
SmartArt inside a snip diagonal corner rectangle:
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-_1-RYPfLX2w/U8ZXi6XNEhI/AAAAAAAAEiI/irEHHeoxRXU/s0/">
<img src="https://lh3.googleusercontent.com/-_1-RYPfLX2w/U8ZXi6XNEhI/AAAAAAAAEiI/irEHHeoxRXU/s400/" alt="https://lh3.googleusercontent.com/-_1-RYPfLX2w/U8ZXi6XNEhI/AAAAAAAAEiI/irEHHeoxRXU/s400/" />
</a>
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
Table of Contents inside a pentagon:
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-aBD1Rbv4-DU/U8ZXlV2vxSI/AAAAAAAAEiY/atjjnYGDQyw/s0/">
<img src="https://lh3.googleusercontent.com/-aBD1Rbv4-DU/U8ZXlV2vxSI/AAAAAAAAEiY/atjjnYGDQyw/s400/" alt="https://lh3.googleusercontent.com/-aBD1Rbv4-DU/U8ZXlV2vxSI/AAAAAAAAEiY/atjjnYGDQyw/s400/" />
</a>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_details">Details</h2>
<div class="sectionbody">
<div class="paragraph"><p>What follows is something you can probably skip if you&#8217;re a user&#8201;&#8212;&#8201;however if
you&#8217;re a developer and you want to understand how the above is implemented,
then read on. ;-)</p></div>
<div class="sect2">
<h3 id="_situation_in_4_3">Situation in 4.3</h3>
<div class="paragraph"><p>From the drawinglayer point of view: <code>SwDoc</code> contains an <code>SdrModel</code>
(<code>SwDoc::GetOrCreateDrawModel()</code>), which contains a single <code>SdrPage</code>
(<code>SdrModel::GetPage()</code>)&#8201;&#8212;&#8201;Draw/Impress contain multiple sdr pages. The
<code>SdrPage</code> contains the shapes: e.g. a triangle is an <code>SdrObjCustomShape</code>. For
TextFrames, a placeholder object called <code>SwVirtFlyDrawObj</code> is added to the
draw page.</p></div>
<div class="paragraph"><p>The writer-specific properties of an <code>SdrObject</code> is stored as an <code>SwFrmFmt</code>
object, an <code>SwFrmFmt</code> array is a member of <code>SwDoc</code> ("frame format table"). The
anchor position and the node index of the frame contents counts as a property.</p></div>
<div class="paragraph"><p>At UNO level, a single <code>DrawPage</code> object is part of the Component (opened
document), which abstracts away the internal <code>SdrPage</code>.</p></div>
<div class="paragraph"><p>For TextFrames, the UNO API works exactly the same way, except that the
implementation stores all properties of the TextFrame in the <code>SwFrmFmt</code> (and
some properties are different, compared to a drawinglayer shape).</p></div>
<div class="paragraph"><p>One remaining detail is how the shape text is represented. In case of
drawinglayer shapes, this is provided by editeng: internally an <code>EditTextObject</code>
provides a container for paragraphs, at UNO API level <code>SvxUnoTextContent</code>
provides an interface that presents paragraphs and their text portions.</p></div>
<div class="paragraph"><p>For TextFrames, the contents of the frames is stored in a special section in
the Writer text node array (in the 3rd toplevel section, while the 5th
toplevel section is used for body text), that&#8217;s how it can contain anything
that&#8217;s a valid Writer body text. An offset into this node array of the
"content" property of the <code>SwFrmFmt</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_document_model">Document model</h3>
<div class="paragraph"><p>At a document model level, we need a way to describe that an <code>SdrObject</code>
(provided by svx) has an associated TextFrame (provided by sw). svx can&#8217;t
depend on sw, but in the <code>SwFrmFmt</code> of the SdrObject, we can use the so far
unused <code>RES_CNTNT</code> ("content") property to point to a TextFrame content.</p></div>
<div class="paragraph"><p>So behind the scenes the UNO API and the UI does the following when
turning on the TextBox bit for a drawinglayer shape:</p></div>
<div class="ulist"><ul>
<li>
<p>
creates a TextFrame
</p>
</li>
<li>
<p>
connects the <code>SdrObject</code> to the TextFrame
</p>
</li>
</ul></div>
<div class="paragraph"><p>Also, every property of the TextFrame depends on the properties of the
<code>SdrObject</code>, think of the followings:</p></div>
<div class="ulist"><ul>
<li>
<p>
position / size is the largest rectangle that fits inside the shape
</p>
</li>
<li>
<p>
borders are disabled
</p>
</li>
<li>
<p>
background is transparent
</p>
</li>
</ul></div>
<div class="paragraph"><p>Finding the largest rectangle that fits inside the shape is probably the most
interesting here, it&#8217;s implemented in <code>SwTextBoxHelper::getTextRectangle()</code>,
which uses <code>SdrObjCustomShape::GetTextBounds()</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_uno_api">UNO API</h3>
<div class="paragraph"><p>The UNO API hides the detail that the TextFrame and the <code>SdrObject</code> are in
fact two objects. To get there, the followings are done:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>SwXShape</code> is modified, so that in the TextBox case not editengine, but the
  attached TextFrame is accessed when <code>getText()</code> is invoked.
  This was a bit tricky, as <code>SwXShape</code> doesn&#8217;t have an explicit <code>getText()</code>
  implementation: it overrides <code>queryInterface()</code> instead (see
  <code>SwTextBoxHelper::queryInterface()</code>).
</p>
</li>
<li>
<p>
<code>SwXDrawPage</code> (its <code>XEnumerationAccess</code> and <code>XIndexAccess</code>) is modified to
  ignore TextFrames in the TextBox case
</p>
</li>
<li>
<p>
<code>SwXTextPortionEnumeration</code> is modified to ignore TextFrames in the TextBox case
</p>
</li>
<li>
<p>
<code>SwXText::insertTextContent()</code> and <code>SwXText::appendTextContent()</code> is
  modified to handle the TextBox case
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_layout">Layout</h3>
<div class="paragraph"><p>This was the easiest part: the "merge TextFrame and <code>SdrObj</code> into a shape with
TextBox" approach ensured that that we use existing layout features here, no
major effort was necessary here.</p></div>
<div class="paragraph"><p>One interesting detail here was the positioning of as-character anchored
shapes having TextBoxes, that&#8217;s now handled in <code>SwFlyCntPortion::SetBase()</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_filters">Filters</h3>
<div class="paragraph"><p>The primary point of this feature is to improve Word (and in particular DOCX)
compatibility, and of course I wanted to update ODF as necessary as well.</p></div>
<div class="paragraph"><p>Regarding the new feature, I did the followings:</p></div>
<div class="ulist"><ul>
<li>
<p>
DOCX import now avoids setting service name from original to
  <code>css.text.TextFrame</code> in case shape has shape text
</p>
</li>
<li>
<p>
DOCX export now handles the TextBox case: reads Writer text instead of
  editeng text as necessary
</p>
</li>
<li>
<p>
ODF export now adds a
  <a href="https://wiki.documentfoundation.org/Development/ODF_Implementer_Notes#List_of_LibreOffice_ODF_extensions">new
  optional boolean attribute</a> to make export of the TextBox case possible
</p>
</li>
<li>
<p>
ODF import now handles the new attribute and act accordingly
</p>
</li>
</ul></div>
<div class="paragraph"><p>Note that regarding backwards compatibility, we keep supporting
editengine-based text as well. This has the best of two worlds:</p></div>
<div class="ulist"><ul>
<li>
<p>
existing ODF documents are unchanged, but
</p>
</li>
<li>
<p>
the TextBox feature is enabled unconditionally in DOCX import to avoid
  formatting loss
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_user_interface">User Interface</h3>
<div class="paragraph"><p>I took care of the followings:</p></div>
<div class="ulist"><ul>
<li>
<p>
the context menu of shapes now provides an item to add / remove a TextBox
  to/from a shape
</p>
</li>
<li>
<p>
when moving or resizing a shape, the TextBox properties are updated
  as well
</p>
</li>
<li>
<p>
when the shape is deleted, the associated TextBox is also
  deleted
</p>
</li>
<li>
<p>
editing individual TextBox properties is no longer possible, since they
  depend on the shape properties
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you want to try these out yourself, get a
<a href="http://dev-builds.libreoffice.org/daily/">daily build</a> and play with it! If
something goes wrong, report it to us in the
<a href="https://www.libreoffice.org/get-help/bug/">Bugzilla</a>, so we can try fix it
before 4.4 gets branched off. Last, but not at least, thanks for
<a href="http://www.cloudon.com/">CloudOn</a> for funding these improvements! :-)</p></div>
</div>
</div>
</p><hr/></li>
<li><p>Tuesday, 08 July 2014<br /><a href="/blog/lo-writer-training-2014.html">Updated Writer training slides</a>
(<a href="/blog/lo-writer-training-2014.html#disqus_thread">Comments</a>)
</p><p><div style="text-align: center; font-size: 0.6em;">
<img src="https://lh4.googleusercontent.com/-qJiiajLRZ7A/U7vLBcDzbBI/AAAAAAAAEf0/mo6E4QbfVWU/s400/"/>
<p>(via <a href="https://www.flickr.com/photos/michaeljosh/4382953112/">michaeljosh</a>)</p>
</div>
<div class="paragraph"><p>Last year I
<a href="https://speakerdeck.com/vmiklos/libreoffice-writer-training">published</a> some
Writer training slides, which are hopefully a useful extension to in-tree
documentation like
<a href="http://cgit.freedesktop.org/libreoffice/core/tree/sw/README">sw/README</a> and
<a href="http://cgit.freedesktop.org/libreoffice/core/tree/sw/qa/extras/README">sw/qa/extras/README</a>.</p></div>
<div class="paragraph"><p>Last week I reviewed those slides and realized that some of them are outdated. So here comes an updated version:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://speakerdeck.com/vmiklos/writer-training-number-1-2014">first part</a>,
  up to, but not including layout
</p>
</li>
<li>
<p>
<a href="https://speakerdeck.com/vmiklos/writer-training-number-2-2014">second part</a>,
  starting from the layout
</p>
</li>
</ul></div>
<div class="paragraph"><p>The intention is that these build nicely on top of Michael&#8217;s
<a href="https://people.gnome.org/~michael/blog/2013-07-26.html">generic intro</a> slides,
and with that, the reader can have a good "big picture" understanding of the
code base. For the gory details, you always need to read the code anyway. ;-)</p></div>
</p><hr/></li>
<li><p>Thursday, 19 June 2014<br /><a href="/blog/cluc2014.html">CLUC 2014 Conference</a>
(<a href="/blog/cluc2014.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerdeck.com/vmiklos/4-dot-3">
<img src="https://lh4.googleusercontent.com/-8H5VKexBW1Q/U6Kz9kfXv7I/AAAAAAAAEX8/GVuWhXuueUs/s400/" alt="https://lh4.googleusercontent.com/-8H5VKexBW1Q/U6Kz9kfXv7I/AAAAAAAAEX8/GVuWhXuueUs/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>I&#8217;ve arrived home yesterday from Zagreb where I
<a href="http://2014.dorscluc.org/en/keynotes/#miklos">gave a keynote</a> at CLUC 2014
<a href="http://2014.dorscluc.org/en/conference-schedule/">on Tuesday</a>.</p></div>
<div class="paragraph"><p>Here are a few talks I enjoyed:</p></div>
<div class="ulist"><ul>
<li>
<p>
Dave Whiteland&#8217;s <a href="https://www.mysociety.org/">mysociety.org</a> talk
</p>
</li>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/Harald_Welte">Harald Welte</a>'s
  <a href="http://osmocom.org/">osmocom.org</a> talk
</p>
</li>
<li>
<p>
Elizabeth Krumbach Joseph&#8217;s <a href="http://openstack.org">OpenStack</a> talk (explaining
  how do they use gerrit, git-review and related tools)
</p>
</li>
</ul></div>
<div class="paragraph"><p>I also took a <a href="http://vmiklos.hu/panoramas/zagreb.html">panorama</a> and some
pictures, available
<a href="https://picasaweb.google.com/104737754628780823336/20140619_Zagrab">here</a>,
including photos of some speakers.</p></div>
<div class="paragraph"><p>Thanks Elizabeth for the above photo, and also to the organizers of the
conference, it was a great one! ;-)</p></div>
</p><hr/></li>
<li><p>Sunday, 08 June 2014<br /><a href="/blog/groupshape-changetracking.html">Improved handling of track changes in groupshape text</a>
(<a href="/blog/groupshape-changetracking.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>Shapes in Writer are provided by LibreOffice&#8217;s drawing layer&#8201;&#8212;&#8201;they are
independent from the normal Writer paragraphs. Given that the drawing layer
does not support tracking changes, just Writer&#8217;s "native" paragraphs, fully
featured tracked changes in real shape text would be quite some work. In case
of ODF, the markup describes tracked changes in a way, so that in case the
reader does not support tracking changes, it can at least read the normal and
inserted text, i.e. the current version.</p></div>
<div class="paragraph"><p>This is exactly what I
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=e6300f83d08fd959596551dcd660eb0fbfb248a6">implemented</a>
in the DOCX import filter now:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-8q4PA4ru1KE/U5RZB7SxKdI/AAAAAAAAETs/6_avZ3q04T0/s0/">
<img src="https://lh5.googleusercontent.com/-8q4PA4ru1KE/U5RZB7SxKdI/AAAAAAAAETs/6_avZ3q04T0/s400/" alt="https://lh5.googleusercontent.com/-8q4PA4ru1KE/U5RZB7SxKdI/AAAAAAAAETs/6_avZ3q04T0/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>Previously we just ignored both inserted and deleted text, so if you had
content which was all either deleted or inserted, you ended up having no shape
text at all (can be tested using e.g.
<a href="http://cgit.freedesktop.org/libreoffice/core/tree/sw/qa/extras/ooxmlimport/data/groupshape-trackedchanges.docx">this
test document</a>):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh4.googleusercontent.com/-NQOH4joafZA/U5RZBjGVO5I/AAAAAAAAETo/3WGNKc3j80c/s0/">
<img src="https://lh4.googleusercontent.com/-NQOH4joafZA/U5RZBjGVO5I/AAAAAAAAETo/3WGNKc3j80c/s400/" alt="https://lh4.googleusercontent.com/-NQOH4joafZA/U5RZBjGVO5I/AAAAAAAAETo/3WGNKc3j80c/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>To be fair, the reference layout looks like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh6.googleusercontent.com/-hyCX0lGuEck/U5RZBn27CbI/AAAAAAAAET0/91WKFnyEhQ0/s0/">
<img src="https://lh6.googleusercontent.com/-hyCX0lGuEck/U5RZBn27CbI/AAAAAAAAET0/91WKFnyEhQ0/s400/" alt="https://lh6.googleusercontent.com/-hyCX0lGuEck/U5RZBn27CbI/AAAAAAAAET0/91WKFnyEhQ0/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>I still hope to fix that as well one day, but the above fix is something we&#8217;ll already provide in 4.3. :-)</p></div>
</p><hr/></li>
<li><p>Sunday, 18 May 2014<br /><a href="/blog/supybot-otrs.html">OTRS plugin for Supybot</a>
(<a href="/blog/supybot-otrs.html#disqus_thread">Comments</a>)
</p><p><div class="paragraph"><p>OTRS is quite different to Bugzilla (what we use for upstream LibreOffice
development for quite some time). On the plus side, e.g. it has strong support
for multiple customers. OTOH, it deals with tickets instead of bugs, and sadly
it doesn&#8217;t have a single identifier for tickets. It has a ticket <em>number</em>
(which by default even includes the date), which is searchable, and it has a
ticket <em>ID</em>, which is used for URL&#8217;s.</p></div>
<div class="paragraph"><p>In case of Bugzilla, you can easily lookup "bug#12345" in Firefox. Create a
bookmark with the following properties:</p></div>
<div class="ulist"><ul>
<li>
<p>
Location: <a href="https://localhost/bugzilla/show_bug.cgi?id=%s">https://localhost/bugzilla/show_bug.cgi?id=%s</a>
</p>
</li>
<li>
<p>
Keyword: bug
</p>
</li>
</ul></div>
<div class="paragraph"><p>and then you can just copy&amp;paste bug#12345 to Firefox, replace the # with a
space, and Firefox will do the right thing.</p></div>
<div class="paragraph"><p>Unfortunately (due to the above detailed reasons), this is not possible with
OTRS. So I decided to write a Supybot plugin that can notice "bug#12345" on an
IRC channel, and give you the clickable URL (after finding out the ticket ID
from the ticket number).</p></div>
<div class="paragraph"><p>The result is available
<a href="https://github.com/vmiklos/vmexam/tree/master/python/supybot-otrs">on GitHub</a>,
it looks like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>09:58 &lt; vmiklos&gt; bug#1000068
09:58 &lt; supybot&gt; https://localhost/otrs/index.pl?Action=AgentTicketZoom;TicketID=73</code></pre>
</div></div>
<div class="paragraph"><p>Given that I found no relevant hits when
<a href="https://www.google.com/search?q=supybot+%22otrs%22">searching</a> for <em>supybot
otrs</em>, I hope this code may be useful for others as well.</p></div>
<div class="paragraph"><p>Thanks to James Scott for his
<a href="https://github.com/scottjab/supybot-youtube">YouTube</a> plugin that helped to
quickly figure out the relevant Supybot API&#8217;s.</p></div>
</p><hr/></li>
<li><p>Wednesday, 02 April 2014<br /><a href="/blog/improved-relative-sized-textframes-in-libreoffice.html">Improved support for text frames with relative sizes in LibreOffice Writer</a>
(<a href="/blog/improved-relative-sized-textframes-in-libreoffice.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh6.googleusercontent.com/-YDWSLjQcV1U/UzxP5AJhnyI/AAAAAAAAEIo/8uurEY7s90k/s0/">
<img src="https://lh6.googleusercontent.com/-YDWSLjQcV1U/UzxP5AJhnyI/AAAAAAAAEIo/8uurEY7s90k/s400/" alt="https://lh6.googleusercontent.com/-YDWSLjQcV1U/UzxP5AJhnyI/AAAAAAAAEIo/8uurEY7s90k/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>When using text frames in Writer, you can always choose if you set an absolute
size for it or you set a relative one. Oddly enough, in case of relative
sizes, it wasn&#8217;t entirely clear what 100% percent means. With a bit of
<a href="https://help.libreoffice.org/Writer/Type#Relative">searching</a>, the help says
"it&#8217;s the page text area", which in practice means the page size, excluding
the margins.</p></div>
<div class="paragraph"><p>And that&#8217;s where the problem lies: in many cases (importing foreign formats,
cover page of a document, etc.) you want to have a textframe which is 100%
wide, compared to the full page size, including margins. It was already
possible previously to work this around by manually specifying the same size
what was used for page size, but that&#8217;s ugly, you duplicate the setting at two
places.</p></div>
<div class="paragraph"><p>As you can see on the above screenshot, in LibreOffice 4.3, I now implemented
this as a new option, you can choose what 100% means for both width and
height. File filters are also updated accordingly: in case of ODF an
<a href="https://wiki.documentfoundation.org/Development/ODF_Implementer_Notes#LibreOffice_ODF_extensions">extension</a>
is proposed, and also DOCX and RTF filters are updated, where the file format
already supported this feature.</p></div>
<div class="paragraph"><p>For the curious ones, the feature is in <code>master</code> for almost two months now,
but I only implemented my favorite part&#8201;&#8212;&#8201;RTF filter&#8201;&#8212;&#8201;only last week,
that&#8217;s the "news" here. ;-)</p></div>
<div class="paragraph"><p>If you want to try these out yourself, get a
<a href="http://dev-builds.libreoffice.org/daily/">daily build</a> and play with it! If
something goes wrong, report it to us in the
<a href="https://www.libreoffice.org/get-help/bug/">Bugzilla</a>, so we can try fix it
before 4.3 gets branched off. Last, but not at least, thanks for
<a href="http://www.cloudon.com/">CloudOn</a> for funding this improvement! :-)</p></div>
</p><hr/></li>
<li><p>Saturday, 22 March 2014<br /><a href="/blog/docx-import-progressbar-in-libreoffice.html">DOCX import progressbar in LibreOffice Writer</a>
(<a href="/blog/docx-import-progressbar-in-libreoffice.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-sW_Ccet7HMU/Uy2hcmf7ZsI/AAAAAAAAEHg/IGwPJI6h6vE/w643-h518-no/">
<img src="https://lh5.googleusercontent.com/-sW_Ccet7HMU/Uy2hcmf7ZsI/AAAAAAAAEHg/IGwPJI6h6vE/s400/" alt="https://lh5.googleusercontent.com/-sW_Ccet7HMU/Uy2hcmf7ZsI/AAAAAAAAEHg/IGwPJI6h6vE/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>I&#8217;m sure in this case a few words are worth more than the above picture, so
let me describe what you see above. :-)</p></div>
<div class="paragraph"><p>In case of opening an ODT, DOC or RTF document in LibreOffice Writer, you
already got some feedback on where the importer is, in case the process needed
more time than what you feel "instant". However, this wasn&#8217;t supported for
DOCX.  According to <code>git blame</code>, I added this to my todo on 2012-10-29, and a
few months later also a
<a href="https://bugs.freedesktop.org/show_bug.cgi?id=58044">bugreport</a> was opened,
requesting the same, but up to yesterday, nothing changed.  However, now I&#8217;ve
implemented this on master, it&#8217;ll be part of the 4.3 release.</p></div>
<div class="paragraph"><p>Back to where I started, what you actually see there is when LibreOffice is in
the middle of the import process of the Holy Bible in DOCX format, which takes
around 12 seconds on my machine. One could say that speed up quite acceptable
for that amount of data, but with a progressbar, it&#8217;s definitely better. ;-)</p></div>
</p><hr/></li>
<li><p>Sunday, 09 March 2014<br /><a href="/blog/doctok.html">Death of doctok in LibreOffice</a>
(<a href="/blog/doctok.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-IumGq3jzNdI/UxxG3Deg6QI/AAAAAAAAEFY/Ij7oMS7YyoY/s809/">
<img src="https://lh5.googleusercontent.com/-IumGq3jzNdI/UxxG3Deg6QI/AAAAAAAAEFY/Ij7oMS7YyoY/s300/" alt="https://lh5.googleusercontent.com/-IumGq3jzNdI/UxxG3Deg6QI/AAAAAAAAEFY/Ij7oMS7YyoY/s300/" />
</a>
</div>
</div>
<div class="paragraph"><p>Last year in September we
<a href="http://lists.freedesktop.org/archives/libreoffice/2013-September/055976.html">decided</a>
to get rid of the writerfilter-based DOC tokenizer, and I volunteered to
actually do this. As cleanups in general have a low priority, I only
progressed with this slowly, though yesterday I completed it, that&#8217;s why I&#8217;m
writing this post. :-)</p></div>
<div class="paragraph"><p>Some background: the writerfilter module is responsible for RTF and DOCX
import in Writer. As the above picture shows, the currently used DOC import is
independent from it, and there was also an <em>other</em> DOC import filter, that was
in writerfilter which was disabled at runtime. As I don&#8217;t like duplication, I
examined the state of the two filters, and the linked minutes mail details
how we decided that the old filter will stay, and we&#8217;ll get rid of the
writerfilter one. It&#8217;s just a matter of deleting that code, right? :-) That&#8217;s
what I thought first. But then I had to realize that the architecture of
writerfilter is a bit more complex:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-vBMsCsYLRZE/UxxG3PsuI2I/AAAAAAAAEFc/Ly8sQ0ydY1A/s831/">
<img src="https://lh3.googleusercontent.com/-vBMsCsYLRZE/UxxG3PsuI2I/AAAAAAAAEFc/Ly8sQ0ydY1A/s400/" alt="https://lh3.googleusercontent.com/-vBMsCsYLRZE/UxxG3PsuI2I/AAAAAAAAEFc/Ly8sQ0ydY1A/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>It has the following components:</p></div>
<div class="ulist"><ul>
<li>
<p>
the dmapper (domain mapper), that handles all the nasty complexities of
  mapping Word concepts to Writer concepts (think of e.g. sections ↔ page
  styles)
</p>
</li>
<li>
<p>
one tokenizer for each (RTF, DOCX, DOC) format
</p>
</li>
</ul></div>
<div class="paragraph"><p>The traffic between the tokenizers and dmapper is called tokens. Naturally
it&#8217;s not enough that tokenizers send and dmapper receives these tokens, they
should be <em>defined</em> somewhere as well. And that&#8217;s where I realized this work
will take a bit more time: instead of having a single token definition,
actually the ooxml tokenizer defined its own grammar, and doctok also defined
two <em>additional</em> grammars. And of course dmapper had to handle all of that.
;-) Given that OOXML is a superset of the DOC/RTF format, it makes sense to
just use the ooxml grammar, and get rid of the other two.</p></div>
<div class="paragraph"><p>Especially that&#8201;&#8212;&#8201;by now you probably found this out&#8201;&#8212;&#8201;if I wanted to kill
doctok, I had to kill the sprm and rtf grammars as well. Otherwise just
removing doctok would break the RTF and DOCX import as well, as those also
used the rtf/sprm grammars.</p></div>
<div class="paragraph"><p>So at the end, the cleaned up architecture now looks like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-Iki8jKN61vE/UxxG3FaQc2I/AAAAAAAAEFQ/hWFsR20qB5o/s813/">
<img src="https://lh5.googleusercontent.com/-Iki8jKN61vE/UxxG3FaQc2I/AAAAAAAAEFQ/hWFsR20qB5o/s400/" alt="https://lh5.googleusercontent.com/-Iki8jKN61vE/UxxG3FaQc2I/AAAAAAAAEFQ/hWFsR20qB5o/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>And that has multiple advantages:</p></div>
<div class="ulist"><ul>
<li>
<p>
It removes quite some code: In <code>libreoffice-4-1</code>, the doctok was 78849 (!)
  lines of code (well, part of that was XML data, and some scripts generated
  C++ code from that).
</p>
</li>
<li>
<p>
dmapper now doesn&#8217;t have to handle the rtf and sprm grammars anymore, so now
  there is a <em>single</em> place in dmapper that handles e.g. the italic character
  property.
</p>
</li>
<li>
<p>
Smaller writerfilter binary for the end user: even if doctok wasn&#8217;t enabled
  at runtime, it was shipped in the installation set.
</p>
</li>
<li>
<p>
Hopefully it&#8217;s now a bit more easy to understand writerfilter: at least e.g.
  if you want to look up the place where dmapper handles the character bold
  ("b") XML tag of OOXML, you don&#8217;t have to know that the binary DOC
  equivalent of that is sprmCFBold, just because we have an unused DOC tokenizer
  there as well. :-)
</p>
</li>
<li>
<p>
Given that DOC and RTF formats are a dead end, I think it&#8217;s a good thing
  that in writerfilter now <em>the</em> grammar is OOXML (that keeps introducing new
  features), rather than some dead format. ;-)
</p>
</li>
</ul></div>
</p><hr/></li>
<li><p>Friday, 28 February 2014<br /><a href="/blog/comments-nested.html">LibreOffice Writer now supports nested comments in its DOC/RTF filters</a>
(<a href="/blog/comments-nested.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-FdnXBOBQWjc/UxA1LD0-fyI/AAAAAAAAEDk/2hYmN8ASkxA/s1024/comments-nested.png">
<img src="https://lh3.googleusercontent.com/-FdnXBOBQWjc/UxA1LD0-fyI/AAAAAAAAEDk/2hYmN8ASkxA/s400/comments-nested.png" alt="https://lh3.googleusercontent.com/-FdnXBOBQWjc/UxA1LD0-fyI/AAAAAAAAEDk/2hYmN8ASkxA/s400/comments-nested.png" />
</a>
</div>
</div>
<div class="paragraph"><p>If you ever tried to use nested comments in Writer (make a selection, Insert
&#8594; Comment, then make an overlapping selection, and do it again), you may have
noticed that only the ODF filter can load and save such a document properly.
Recently I have improved this situation a lot. Motivated by seeing this is now
supported in the DOCX import filter, I now added support for this also to the
DOCX export, RTF import/export and binary DOC import/export filters.</p></div>
<div class="paragraph"><p>If you want to try this out, core.git has a
<a href="http://cgit.freedesktop.org/libreoffice/core/tree/sw/qa/extras/ooxmlexport/data/comments-nested.odt">ODT</a>
and
<a href="http://cgit.freedesktop.org/libreoffice/core/tree/sw/qa/extras/ww8export/data/comments-nested.doc">DOC</a>
samples to play with.</p></div>
</p><hr/></li>
<li><p>Thursday, 06 February 2014<br /><a href="/blog/fosdem2014.html">InteropGrabBag in LibreOffice Writer</a>
(<a href="/blog/fosdem2014.html#disqus_thread">Comments</a>)
</p><p><div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerdeck.com/vmiklos/interopgrabbag-in-libreoffice-writer">
<img src="https://lh5.googleusercontent.com/-XoQPls8ulH4/UvOP_KUNG8I/AAAAAAAAEA0/BSJLDOfvLUA/s400/interopgrabbag-fosdem-brussels-2k14-0.jpg" alt="https://lh5.googleusercontent.com/-XoQPls8ulH4/UvOP_KUNG8I/AAAAAAAAEA0/BSJLDOfvLUA/s400/interopgrabbag-fosdem-brussels-2k14-0.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>I&#8217;ve arrived home yesterday from Brussels where I
<a href="https://fosdem.org/2014/schedule/event/interopgrabbag_in_libreoffice_writer/">presented</a>
at FOSDEM 2014, in the
<a href="https://fosdem.org/2014/schedule/track/open_document_editors/">Open document
editors devroom</a>.</p></div>
<div class="paragraph"><p>We also had a
<a href="https://wiki.documentfoundation.org/Hackfest/FOSDEM2014">Hackfest</a>, kindly
hosted by <a href="http://www.betacowork.com/">Betacowork</a> on Monday and Tuesday.</p></div>
<div class="paragraph"><p>Here are a few talks I enjoyed, not counting the LibreOffice ones:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://fosdem.org/2014/schedule/event/simplifying_reuse_with_metadata_support_in_odf_and_plugin_apis/">Simplifying
  reuse with metadata support in ODF and plugin APIs</a>&#8201;&#8212;&#8201;finally a simple way
  to copy&amp;paste images from Firefox to LibreOffice with source attribution.
</p>
</li>
<li>
<p>
<a href="https://fosdem.org/2014/schedule/event/valgrind_gdb/">Combining the power of
  Valgrind and GDB</a>&#8201;&#8212;&#8201;useful to know about this possibility
</p>
</li>
<li>
<p>
<a href="https://fosdem.org/2014/schedule/event/usecasesclangcppparser/">Two uses
  cases for the clang C++ parser: Online Code Browser and Qt moc Replacement.</a>
 &#8201;&#8212;&#8201;maybe the first could replace our crappy Java-based opengrok? We&#8217;ll see.
</p>
</li>
</ul></div>
<div class="paragraph"><p>I was also happy to meet Jacobo, Matus, Tim and Tomaž finally personally. :-)</p></div>
<div class="paragraph"><p>Quite some other slides are now available on
<a href="http://planet.documentfoundation.org/">Planet</a>, don&#8217;t miss them. I also took
some pictures, available
<a href="https://picasaweb.google.com/104737754628780823336/200140205_Brusszel">here</a>,
including photos of all speakers in our devroom.</p></div>
</p><hr/></li>
</ul></div>
<a href="/blog/archive.html">more &raquo;</a>
<script type="text/javascript">
var disqus_shortname = 'vmiklos';
(function () {
 var s = document.createElement('script'); s.async = true;
 s.src = 'http://disqus.com/forums/vmiklos/count.js';
 (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

</div>
</div>
</div>
</div>
</body>
</html>
