<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />


  <title>
    What is Miklos hacking
  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/pdf-sign.html">Signing existing PDF files in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 12 December 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 6 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm1.staticflickr.com/542/31208923460_e3d674d15f_o.png">
<img src="https://farm1.staticflickr.com/542/31208923460_2eb9bca147_z.jpg" alt="https://farm1.staticflickr.com/542/31208923460_2eb9bca147_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>TL;DR: see above&#8201;&#8212;&#8201;it&#8217;s now possible signing existing PDF files and also
verify those signatures in LibreOffice 5.3.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_problem">The problem</h2>
<div class="sectionbody">
<div class="paragraph"><p>LibreOffice already made it possible to digitally sign PDF files as part of
the PDF export, so in case you had e.g. ODF documents and exported them to
PDF, optionally a single digital signature could be added as part of the
export process. This is now much improved. First, thanks to the Dutch Ministry
of Defense in cooperation with <a href="http://nouenoff.nl/">Nou&amp;Off</a> who made this work
possible.</p></div>
<div class="paragraph"><p>A user can already use an other application to verify that signature or sign
an already existing PDF file. The idea is to allow doing these from inside
LibreOffice, directly.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results">Results</h2>
<div class="sectionbody">
<div class="paragraph"><p>As it can be seen above, now the Digital Signatures dialog not only works for
ODF and OOXML files, but also for PDF files. If the file has been signed, then
the dialog performs verifications of that signature. Signatures are also
verified on opening any signed PDF file.</p></div>
<div class="paragraph"><p>I&#8217;ve also extended the user interface a bit, so that signing an existing PDF
file is easy, similarly how exporting to PDF is easier than exporting to a
random other file format. There is now a new File &#8594; Digital signatures &#8594;
Sign exiting PDF menu item to open a PDF file for signing:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm1.staticflickr.com/30/31543378146_b33c2f0a83_o.png">
<img src="https://farm1.staticflickr.com/30/31543378146_b981a22ee0_z.jpg" alt="https://farm1.staticflickr.com/30/31543378146_b981a22ee0_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>When that happens the infobar has a dedicated button to open the Digital
Signatures dialog, and also going into editing mode triggers a warning dialog,
as going read-write is not needed to be able to sign a document:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm1.staticflickr.com/752/31543377356_d359124361_o.png">
<img src="https://farm1.staticflickr.com/752/31543377356_eaed7c2301_z.jpg" alt="https://farm1.staticflickr.com/752/31543377356_eaed7c2301_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>And that&#8217;s basically it, after you open a PDF file in Draw, you can do the
usual digital signature operations on the file, just like it already works for
previously supported file formats.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_details">Details</h2>
<div class="sectionbody">
<div class="paragraph"><p>What follows is something you can probably skip if you&#8217;re a user&#8201;&#8212;&#8201;however if
you&#8217;re a developer and you want to understand how the above is implemented,
then read on. ;-)</p></div>
<div class="sect2">
<h3 id="_pdf_tokenizer">PDF tokenizer</h3>
<div class="paragraph"><p>The signing feature in ODF/OOXML is implemented by working directly on the ZIP
storage in <code>xmlsecurity/</code>. This means that in the PDF case it&#8217;s necessary to
work on the PDF file directly, except that we had no such PDF tokenizer
ready to be used.</p></div>
<div class="paragraph"><p>Code under <code>xmlsecurity/source/pdfio/</code> now is such a tokenizer that can
extract info from PDF files and can also add incremental updates at the end of
the file, this way we can make sure adding a signature to a file won&#8217;t loose
existing content in the file. This is fundamentally different form the usual
load-edit-save workflow, when we convert the file into a document model, and
work on that.</p></div>
</div>
<div class="sect2">
<h3 id="_verification_of_signatures">Verification of signatures</h3>
<div class="paragraph"><p>Previously LO was only able to generate signatures, not verify them. I&#8217;ve
implemented PDF signature verification using both NSS and CryptoAPI, so all
Windows, Linux and macOS are covered. I have to admit that the initial verification
was much easier with CryptoAPI. Until I hit corner-cases, I could use an API
that&#8217;s well-documented and is higher level than NSS. (I don&#8217;t have to support
different hash types explicitly, for example.)</p></div>
<div class="paragraph"><p>When I added support for non-detached signatures, that changed the situation a bit:</p></div>
<div class="listingblock">
<div class="content">
<pre><code> 1 file changed, 15 insertions(+), 11 deletions(-)</code></pre>
</div></div>
<div class="paragraph"><p>was the NSS patch, and</p></div>
<div class="listingblock">
<div class="content">
<pre><code> 1 file changed, 104 insertions(+), 8 deletions(-)</code></pre>
</div></div>
<div class="paragraph"><p>was the CryptoAPI patch.</p></div>
</div>
<div class="sect2">
<h3 id="_signing_existing_files">Signing existing files</h3>
<div class="paragraph"><p>Signing an existing file means tokenizing a document, figuring out how an
incremental update should look like for that file, writing an incremental
update that has a placeholder for the actual signature (a PKCS#7 blob, where
the input is just the non-placeholder parts of the document as binary data), and
finally filling in the placeholder with the actual signature.</p></div>
<div class="paragraph"><p>For the last step, I could reuse code from the PDF export (modulo fixing bugs
like <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=99327">tdf#99327</a>).
For the other steps, the tokenizer remembers the input offset / length for the
given token, this way it&#8217;s relatively easy to create incremental updates. You
can add new objects or update new objects in such an incremental update, and
this source tracking feature allows copying even the unchanged parts of
updated objects verbatim.</p></div>
</div>
<div class="sect2">
<h3 id="_pdf_1_5">PDF 1.5+</h3>
<div class="paragraph"><p>Everything becomes a bit more complicated once I started to handle not only
LO-generated PDF-1.4, but also newer PDF versions. I think this is important,
as Adobe Acrobat creates PDF 1.6 by default today, which has a number of new
features (I think all of them were actually introduced in PDF-1.5) that
affects the tokenizer:</p></div>
<div class="ulist"><ul>
<li>
<p>
xref stream: instead of an ASCII xref table ("table of contents") at the end
  of the file, it&#8217;s now possible to write the binary equivalent of this as an
  xref stream. Because the binary version can describe more features we must
  also write an updated xref stream (and not an xref table) when the import
  already had an xref stream.
</p>
</li>
<li>
<p>
object streams: it&#8217;s now possible to write multiple objects inside the
  stream section of a single object in binary form. The tokenizer is necessary
  to be able to read these objects and also roundtripping (source tracking)
  should work not only with physical file offsets, but also inside such
  compressed streams where the offset is no longer just a number inside the
  input file. (It&#8217;s OK to write the updated objects outside object streams,
  still.)
</p>
</li>
<li>
<p>
stream predictors: this is a concept from the PNG format, but also used in
  PDF when compressing the xref stream. See the spec for the gory details, but
  in short it&#8217;s not enough that instead of plaintext you have to deal with
  binary compressed data, you also have to filter the data before actually
  parsing the file offsets, and the filter is defined not in terms of object IDs
  and file offsets, but in terms of adjacent pixels, since it&#8217;s documented in
  the PNG spec. :-) (To be close to the Adobe output, we also apply such
  predictors when writing compressed xref streams.)
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_user_interface">User Interface</h3>
<div class="paragraph"><p>In addition to be UI changes already mentioned above, one more improvement I
did is that now the Digital Signatures dialog has a new column to show the
signature type.  This is either XML-DSig (for ODF/OOXML) or PDF.</p></div>
</div>
<div class="sect2">
<h3 id="_testing">Testing</h3>
<div class="paragraph"><p>I&#8217;ve added an integration test in the existing
<code>CppunitTest_xmlsecurity_signing</code> to have coverage for the small new code that
calls into <code>xmlsecurity/</code> from <code>sfx2/</code> in case of PDF files. But fortunately
because all other code in <code>xmlsecurity/</code> was new, I could do unit testing in
<code>CppunitTest_xmlsecurity_pdfsigning</code> for the rest of the features.</p></div>
<div class="paragraph"><p>Needless to say that invoking the PDF tokenizer + signature creator/verifier
directly is <strong>much</strong> quicker than loading a full PDF file into Draw, just to see
the signature status. ;-)</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you want to try these out yourself, get a
<a href="http://dev-builds.libreoffice.org/daily/">daily build</a> and play with it! This
work is part of both <code>master</code> or <code>libreoffice-5-3</code>, so those builds are of
interest. Happy testing! :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/devtalks.html">LibreOffice session at DevTalks Jr.</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Sat 12 November 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div style="text-align: center; font-size: 0.6em;">
<img src="https://farm6.staticflickr.com/5687/30900149756_0abd3a3218_z.jpg"/>
<p>(via <a href="https://twitter.com/DevTalksRo/status/797429977968939008">DevTalksRo</a>)</p>
</div>
<div class="paragraph"><p>Today I gave a
<a href="https://speakerdeck.com/vmiklos/getting-involved-with-libreoffice-online-and-android">Getting
involved with LibreOffice Online and Android</a> session at
<a href="http://www.devtalks.ro/bucharest/devtalks-jr/">DevTalks Jr</a>, Bucharest. The
event had two tracks in parallel, with a total attendees of about 200
developers.</p></div>
<div class="paragraph"><p>Some photos I took after the event are <a href="https://www.flickr.com/photos/vmiklos/sets/72157675071819211/">available</a>.</p></div>
<div class="paragraph"><p>Thanks the organizers and sponsors for the great event! :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/lo-insert-pdf-image.html">Insert PDF as image in LibreOffice 5.3</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 10 October 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div class="sect1">
<h2 id="_results">Results</h2>
<div class="sectionbody">
<div class="paragraph"><p>LibreOffice 5.3 will add one more vector-based format that can be inserted as
an image into documents: PDF. First, thanks to <a href="http://pmg.be/">PMG</a> who made
this work possible. On the user interface you can now select PDF files when
you choose e.g. Writer&#8217;s Insert &#8594; Image option:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm6.staticflickr.com/5552/29583461353_0c2da79c8e_o.png">
<img src="https://farm6.staticflickr.com/5552/29583461353_02fc75dd7f_z.jpg" alt="https://farm6.staticflickr.com/5552/29583461353_02fc75dd7f_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>The first page of the PDF document will be shown, which is handy if the PDF
file is basically used as a vector image format.</p></div>
<div class="paragraph"><p>Similarly to the SVG feature, the original vector image is stored in the
document, but when saving to ODF, a replacement PNG file is also generated to
be backwards compatible with older ODF readers. The image context menu &#8594; Save
menu item allows to extract your original PDF data from the image, too:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm8.staticflickr.com/7501/30098334712_569ebbe55b_o.png">
<img src="https://farm8.staticflickr.com/7501/30098334712_535e16ea05_z.jpg" alt="https://farm8.staticflickr.com/7501/30098334712_535e16ea05_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>And that&#8217;s it, as long as you save your document in ODF, your PDF-as-an-image
will be kept without loosing any data. As usual, you can try this right now
with a 5.3 <a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
<div class="paragraph"><p>However, if you&#8217;re interested in how this is implemented, keep reading&#8230;</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_document_model">Document model</h2>
<div class="sectionbody">
<div class="paragraph"><p>The PDF image in the document model is really similar to how SVG is handled,
next to <code>Graphic::getSvgData()</code>, there is now a <code>Graphic::getPdfData()</code>.
This new member function exposes the original PDF data, otherwise the Graphic
is just a metafile.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_uno_api">UNO API</h2>
<div class="sectionbody">
<div class="paragraph"><p>The <code>ReplacementGraphicURL</code> property of the image at an UNO level now exposes
the generated metafile for PDF images. This is implemented for both Draw and
Writer images, and is used by the ODF export filter.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_layout">Layout</h2>
<div class="sectionbody">
<div class="paragraph"><p>When the <code>Graphic</code> instance is rendered, the layout knows nothing about the
PDF data attached to the object, only parses the generated metafile. This way
the display of the PDF image works out of the box.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_filters">Filters</h2>
<div class="sectionbody">
<div class="paragraph"><p>First I&#8217;ve implemented a
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=878a860dff10bd91491d6c9f2f4e2308bfe4f0b2">PDF
import-as-graphic filter</a>, then the
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=7d76bb251e0c88ff17282a33b801a5d17a434af5">export
equivalent of it</a>. As you can see, the PDF import-as-graphic filter isn&#8217;t too
complicated, it completely reuses the existing "import PDF into Draw" filter,
it simply copies the first page of the resulting document model as a metafile.</p></div>
<div class="paragraph"><p>Second, once the graphic filters were working, I&#8217;ve also
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=d1c346ba848c54424d6ffa88df7a5ff6a3717430">improved</a>
the ODF import to recognize PDF data&#8201;&#8212;&#8201;the export side needed no explicit
work, once the <code>ReplacementGraphicURL</code> bits were in place.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_tests">Tests</h2>
<div class="sectionbody">
<div class="paragraph"><p>As mentioned above, the Draw and the Writer image implementation is separate,
so first I&#8217;ve added tests for ODT files in the <code>testEmbeddedPdf</code> of
<code>CppunitTest_sw_odfexport</code>, and then <code>SdExportTest::testEmbeddedPdf()</code> to
cover ODP files (and other ODF formats).  Second, the PDF part of the graphic
swapout/in code has a dedicated test in <code>GraphicObjectTest::testPdf()</code>, and
the UI&#8217;s "Save original PDF" feature has a new
<code>XOutdevTest::testPdfGraphicExport()</code> test.</p></div>
<div class="paragraph"><p>Oh, and if you intent to test this manually in a self-created build, make sure
to avoid <code>--disable-pdfimport</code>, otherwise this feature can&#8217;t work. ;-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-smallcaps-toolbar-button.html">Small capitals toolbar button in LibreOffice Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 03 October 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm6.staticflickr.com/5235/29982452081_a9ca103f2f_o.png">
<img src="https://farm6.staticflickr.com/5235/29982452081_187d99dece_z.jpg" alt="https://farm6.staticflickr.com/5235/29982452081_187d99dece_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>It was <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=87914">requested</a> to
be able to set the small capitals character property via a toolbar button in
Writer, which was indeed not possible. Not only the toolbar button wasn&#8217;t
there, but the underlying UNO command was also missing (which you can use e.g.
from a macro to format the current selection).</p></div>
<div class="paragraph"><p>So my
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=d378cd2f766eeb1fd1c98f62c9ae6b5b59fd00f1">commit</a>
added a simple set of icons to the galaxy theme for the new toolbar button,
defined the new UNO command for Writer text and added it to Writer&#8217;s text
object bar, next to the upper case and lower case buttons (hidden by default).
One difference from those buttons is that those buttons perform a
transliteration, while this one really just sets a character property, you can
easily undo the property later if needed.</p></div>
<div class="paragraph"><p>Wrt. other icon themes, see
<a href="http://listarchives.libreoffice.org/global/design/msg07922.html">this mail</a>,
hopefully the design team can help there.</p></div>
<div class="paragraph"><p>As usual, you can try this right now with a 5.3
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/clang-locon-brno-2k16.html">Using clang-based tools beyond loplugin LOCon lightning talk</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 13 September 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/731c4bb5277c48d8acbba1c867ece856/clang-locon-brno-2k16.pdf">
<img src="https://farm9.staticflickr.com/8074/29618061316_308e7e9b30_z.jpg" alt="https://farm9.staticflickr.com/8074/29618061316_308e7e9b30_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>The last week I gave a
<a href="http://conference.libreoffice.org/2016/the-program/sept-9th-friday/">Using
clang-based tools beyond loplugin</a> lightning talk at LibreOffice conference
2016, on the last day. Click on the image to see all the slides.</p></div>
<div class="paragraph"><p>If you&#8217;re a vim or emacs user and you work with C++11 code, you probably
want to have a look at
<a href="http://clang.llvm.org/extra/clang-rename.html">clang-rename</a>,
<a href="http://clang.llvm.org/extra/include-fixer.html">include-fixer</a> and some editor
plugin exposing the power of libclang (like
<a href="https://valloric.github.io/YouCompleteMe/">YouCompleteMe</a> or
<a href="https://github.com/libclang-vim/libclang-vim">libclang-vim</a>), sometimes these
are really helpful.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/rtf-locon-brno-2k16.html">A year in LibreOffice's RTF support LOCon talk</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 12 September 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/65dac04a99f146649b08cf66211469fd/rtf-locon-brno-2k16.pdf">
<img src="https://farm9.staticflickr.com/8004/29626765785_7f35c9bfd6_z.jpg" alt="https://farm9.staticflickr.com/8004/29626765785_7f35c9bfd6_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Last week I gave a
<a href="http://conference.libreoffice.org/2016/the-program/sept-8th-thursday/"> year in
LibreOffice&#8217;s RTF support</a> talk at LibreOffice conference 2016, in the
development track. Click on the image to see all the slides.</p></div>
<div class="paragraph"><p>I&#8217;ve also published a number of (mostly)
<a href="https://www.flickr.com/photos/vmiklos/albums/72157673517450165">sightseeing
pictures</a> based on wondering around in Brno before and after the conference.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/collaborative-locon-brno-2k16.html">Collaborative editing using LibreOfficeKit LOCon talk</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 09 September 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/035a8c526e5b4748a062a266cd4ffd94/collaborative-locon-brno-2k16.pdf">
<img src="https://farm9.staticflickr.com/8830/29558170685_8aa768ec84_z.jpg" alt="https://farm9.staticflickr.com/8830/29558170685_8aa768ec84_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Yesterday I gave a
<a href="http://conference.libreoffice.org/2016/the-program/sept-8th-thursday/">Collaborative
editing using LibreOfficeKit</a> talk at LibreOffice conference 2016, in the
development track. There were many interested parties&#8201;&#8212;&#8201;not a surprise, as
this is the power horse behind LibreOffice Online. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/locon2016.html">Improved digital signature handling in LibreOffice LOCon talk</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 08 September 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/d7946ac560054fcb9f9a3953f079d9a7/xmlsec-locon-brno-2k16.pdf">
<img src="https://farm9.staticflickr.com/8646/29432546522_585a16f89a_z.jpg" alt="https://farm9.staticflickr.com/8646/29432546522_585a16f89a_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Earlier today I gave a
<a href="http://conference.libreoffice.org/2016/the-program/sept-8th-thursday/">Improved
digital signature handling in LibreOffice</a> talk at LibreOffice conference
2016, in the development track. The room was well-crowded&#8201;&#8212;&#8201;seems this year
classification was a hot topic. ;-)</p></div>
<div class="paragraph"><p>Quite some pictures are now available <a href="https://twitter.com/libreoffice">on</a>
<a href="https://twitter.com/CollaboraOffice">Twitter</a>, don&#8217;t miss them.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/libreoffice-xmlsec.html">LibreOffice now bundles the latest libxmlsec version</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 05 August 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I wrote about how LibreOffice uses the <a href="https://www.aleksey.com/xmlsec/">XMLSec
Library</a> in an
<a href="https://vmiklos.hu/blog/libreoffice-sha256-signatures.html">earlier post</a> from
March. There are two long-term goals regarding xmlsec in LibreOffice:</p></div>
<div class="ulist"><ul>
<li>
<p>
bundle the latest xmlsec version, instead the one from 2009
</p>
</li>
<li>
<p>
upstream enough of the patches, so building &amp; running against xmlsec as
  provided by a Linux distro also works
</p>
</li>
</ul></div>
<div class="paragraph"><p>I&#8217;m happy to say that the first goal is now reached:</p></div>
<div class="ulist"><ul>
<li>
<p>
libreoffice-5-1 bundled xmlsec 1.2.14 from 2009
</p>
</li>
<li>
<p>
libreoffice-5-2 bundles xmlsec 1.2.20 from 2014
</p>
</li>
<li>
<p>
master bundles the latest xmlsec 1.2.22, released earlier this year :-)
</p>
</li>
</ul></div>
<div class="paragraph"><p>This is good, as this way it&#8217;s easier to integrate xmlsec upstream
improvements into LibreOffice in the future.</p></div>
<div class="paragraph"><p>Regarding the other goal, shrinking the patch list is still to be done. ;-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/libreoffice-asan-setup.html">A LibreOffice / AddressSanitizer setup</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 25 July 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 4 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p><a href="https://github.com/google/sanitizers">sanitizers</a> (ASAN, UBSAN, etc.) is a
collection of tools to detect memory corruption bugs, undefined behavior and
more by instrumenting the code generated by the compiler. (That&#8217;s the main
difference from valgrind.) From LibreOffice&#8217;s perspective one more important
difference is that there is a
<a href="http://ci.libreoffice.org/job/lo_ubsan/">Jenkins_Linux_Ubsan</a> tinderbox that
makes sure that the master branch is kept clean from errors detected by a
given configuration.</p></div>
<div class="paragraph"><p>So when the tinderbox failed after a commit of mine, I wanted to set up a
similar environment locally, reproduce and fix the bug, and push the fix once
I saw that the fix indeed solves the problem. You can set many options both at
build and runtime, so while we have some
<a href="https://wiki.documentfoundation.org/Development/-fsanitize">documentation</a> on
the TDF wiki (and also Stephan was kind enough to share
<a href="https://people.freedesktop.org/~vmiklos/2016/sanitizers-config-sberg">his
config</a>) on how to use these sanitizers, it wasn&#8217;t clear to me what to do step
by step. So here is one possible setup that worked for me&#8201;&#8212;&#8201;in my case I
wanted to reproduce a stack-use-after-return problem. If you haven&#8217;t ever built
LibreOffice before, then go to
<a href="https://wiki.documentfoundation.org/Development">the Development wiki page</a>,
first do a normal build, and if everything went fine, came back here.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_build_options">Build options</h2>
<div class="sectionbody">
<div class="paragraph"><p>My <code>autogen.input</code> looks like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>CC=clang -fsanitize=address
CXX=clang++ -fsanitize=address
--enable-dbgutil
--disable-firebird-sdbc</code></pre>
</div></div>
<div class="paragraph"><p>Which is a normal clang debug build, except:</p></div>
<div class="ulist"><ul>
<li>
<p>
you need to add <code>-fsanitize=...</code> to <code>CXX</code> (not to <code>CXXFLAGS</code>), as explained
  on the wiki
</p>
</li>
<li>
<p>
you need to explicitly disable Firebird integration for now
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_building">Building</h2>
<div class="sectionbody">
<div class="paragraph"><p>My first attempt failed at build time, as even the tools used only during the
build are instrumented, and some memory leak was detected there, which means
the build aborted before reaching the problem I was interested in. To disable
leak detection during build, and disable parallelism (I needed this, as I did
the build in the background while using the machine for something else):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>make build-nocheck ASAN_OPTIONS=detect_leaks=0 PARALLELISM=1</code></pre>
</div></div>
<div class="paragraph"><p>This also means that I explicitly disabled running any tests, as I knew which
is the single unit test I want to run for the purposes of reproducing and
fixing the problem.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">
<div class="paragraph"><p>Once the build completed, it turns out that the stack-use-after-return detection is disabled at runtime by default, which means I could not see any problem locally. Here is the commandline to run one specific CppunitTest with this detection on:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>cd sw; make -sr CppunitTest_sw_tiledrendering ASAN_OPTIONS=detect_leaks=0:detect_stack_use_after_return=1</code></pre>
</div></div>
<div class="paragraph"><p>Again, this is just one possible setup, you can use other <code>-fsanitize=...</code>
options, other environment variables during build and during testing&#8201;&#8212;&#8201;but
hopefully it helps in the future to avoid pushing fixes for such problems
detected by sanitizers just blindly.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_update_2019_01_25">Update, 2019-01-25</h2>
<div class="sectionbody">
<div class="paragraph"><p>The above described "do it yourself" way doesn&#8217;t work with LibreOffice master
(towards 6.3) and openSUSE Leap 15.0 anymore. I tried to debug what is the
exact problem, but there are many moving parts here:</p></div>
<div class="ulist"><ul>
<li>
<p>
gcc version (providing libstdc++)
</p>
</li>
<li>
<p>
clang version (5.0.2 is too old; 7 failed to build the plugins, trunk
  towards 9 also generated false positives for me)
</p>
</li>
<li>
<p>
various sanitizer-related environment variables
</p>
</li>
<li>
<p>
various sanitizer-related compiler options
</p>
</li>
</ul></div>
<div class="paragraph"><p>So it&#8217;s much easier to just use the combination used by the
<code>Jenkins_Linux_Ubsan</code> tinderbox than something custom. Doing that is
reasonably straightforward, but still there are a couple of non-trivial steps.
What worked for me is:</p></div>
<div class="ulist"><ul>
<li>
<p>
Set up LODE according to its
  <a href="https://wiki.documentfoundation.org/Development/lode">wiki page</a>.
</p>
</li>
<li>
<p>
Instead of plain <code>./setup --dev</code>, do:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>./setup --jenkins
./setup --jenkins-san
./setup --dev
cd $LODE_HOME/dev/core</code></pre>
</div></div>
<div class="paragraph"><p>This will build a working version of both gcc and clang for you.</p></div>
<div class="ulist"><ul>
<li>
<p>
Instead of manually setting up the environment variables, do:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>. $LODE_HOME/bin/lode_ubsan_env</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Instead of manually setting autogen options, use this autogen.input:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>--with-distro=Jenkins/Linux_ubsan_master</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Finally to build the code and run a specific test based on tinderbox mail:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>make build-nocheck
cd sw; make -sr CppunitTest_sw_unowriter CPPUNIT_TEST_NAME="testPasteListener"</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_update_2019_11_14">Update, 2019-11-14</h2>
<div class="sectionbody">
<div class="paragraph"><p>The 2019-01-25 setup can be fine-tuned further. Sadly LODE mixes two goals: setting up dependencies
/ environment and cloning repos. I recently added support for bypassing any cloning, so you can use
LODE even if you already built the code and want to keep using your own way. The tricks are:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use <a href="https://github.com/vmiklos/vmexam/blob/master/libreoffice/autogen.env-san">autogen.env-san</a> in
  two ways: first comment out the second half to run the above <code>./setup --jenkins &amp;&amp; ./setup
  --jenkins-san</code>, then to source the full environment. This means you get all the up to date
  environment variables from LODE, but you don&#8217;t need a chroot to avoid LODE messing up your
  environment.
</p>
</li>
<li>
<p>
Use <a href="https://github.com/vmiklos/vmexam/blob/master/libreoffice/autogen.input-san">autogen.input-san</a>
  to again inherit all up to date autogen switches from LODE, but avoid the submodule pain that
  would be the default. Now you can do a <code>make check gb_SUPPRESS_TESTS=y</code> to build (but not run) all
  the code &amp; tests.
</p>
</li>
<li>
<p>
Use <a href="https://github.com/vmiklos/vmexam/blob/master/collaboraonline/up.sh">up.sh</a> to
  build and run all Online code &amp; tests&#8201;&#8212;&#8201;with new enough
  <a href="https://git.libreoffice.org/core/commit/1ad3f6b8d9e0ef1e921c3ed5526ea352d67265cf">core.git master</a>
  and <a href="https://git.libreoffice.org/online/commit/2bba146b28599481dd81fb0d1f57c0a856827107">online.git
  master</a> the online.git <code>make check</code> passes for me in this environment.
</p>
</li>
</ul></div>
<div class="paragraph"><p>I believe this setup mostly delegates (envrionment, config switches and toolchain) maintenance to
LODE, still allows not running in a chroot and managing your git clones without LODE.</p></div>
</div>
</div>

  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/index10.html" class="button_accent">&larr; Older Posts</a>

<a href="https://vmiklos.hu/blog/index8.html" class="button_accent">Newer Posts &rarr;</a>
</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>