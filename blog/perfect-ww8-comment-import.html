<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<meta name="description" content="Perfect WW8 comment import - Miklos' blog" />
<meta name="keywords" content="vmiklos, libereoffice, swig, git, python, hacking, bitlbee" />
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://vmiklos.hu/blog/index.rss" />
<link rel="stylesheet" href="/blog/xhtml11.css" type="text/css" />
<link rel="stylesheet" href="/blog/xhtml11-quirks.css" type="text/css" />
<link rel="stylesheet" href="/blog/layout.css" type="text/css" />
<title>Perfect WW8 comment import</title>
<!-- google analytics start -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24726997-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- google analytics end -->
</head>
<body>
<div id="layout-banner-box">
<div id="layout-banner">
  <div id="layout-title">vmiklos.hu</div>
  <div id="layout-description">shameless self-promoting website</div>
</div>
</div>
<div id="layout-menu-box">
<div id="layout-menu">
  <div>&#187;<a href="/">Root</a></div>
  <div>&#187;<a href="/blog/">Rejourn root</a></div>
  <div>&#187;<a href="http://planet.documentfoundation.org/">LibreOffice Community Blogs</a></div>
  <div>
    Search:<br/>
    <form action="http://www.google.com/cse" id="cse-search-box" target="_blank">
    <input type="hidden" name="cx" value="007336731492173318056:bik8fqvatno"/><input type="hidden" name="ie" value="UTF-8"/><input type="text" name="q" size="15"/><br/>
    <input type="submit" name="sa" value="&#187;"/></form>
  </div>
</div>

</div>
<div id="layout-content-box">
<div id="layout-content">
<div id="header">
	<h1>Perfect WW8 comment import</h1>
</div>
<div id="preamble">
<div class="sectionbody">

<!-- Single entry -->
<div class="verseblock">
<div class="verseblock-content">Posted <span class="timeago" title="2015-01-24T22:14:50Z">Saturday, 24 January 2015</span> by Miklos<br />
    Tags:
    <a href="tags/en.html">en</a>
    <a href="tags/libreoffice.html">libreoffice</a>
</div>
</div>

<!-- Body -->
<div class="paragraph"><p>TL;DR: Import of annotated text ranges from binary DOC format was a problem
for quite some time, now it should be as good as it always was in the
ODT/DOCX/RTF filter.</p></div>
<div class="paragraph"><p>Longer version: the import of annotation marks from binary DOC was never
perfect. My
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=7907cc0ef9751d553014bd3bab49be9e7fc31bca">initial
implementation</a> had a somewhat hidden, but important shortcoming, in the form
of a "Don&#8217;t support ranges affecting multiple SwTxtNode for now." comment. The
underlying problem was that annotation marks have a start and end position,
and this is described as an offset into the piece table (so the unit was a
character position, CP) in the binary DOC format, while in Writer, we work
with document model positions (text node and content indexes, SwPosition), and it isn&#8217;t
trivial to map between these two.</p></div>
<div class="paragraph"><p><a href="http://zolnaitamas.blogspot.com/">Tam√°s</a> somewhat
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=f2945255df273404ee2457dcf761cb8f334b732b">improved</a>
this homegrown CP &#8594; SwPosition mapping code, but was still far from perfect. Here is an example. This is how <a href="http://people.freedesktop.org/~vmiklos/2015/perfect-ww8-comment-import.doc">this demo document</a> looks like now in LibreOffice Writer:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s0/">
<img src="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s800/" alt="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>And this is how it looked like before the end of last year:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s0/">
<img src="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s800/" alt="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>Notice how "Start" is commented and it wasn&#8217;t before. Which one is correct? Here is the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s0/">
<img src="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s800/" alt="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>The reason is that the document has fields and tables, and the homegrown CP &#8594;
SwPosition mapping did not handle this. A much better approach is to handle
the mapping as we do it for bookmarks: even if at the end annotation marks and
bookmarks are entires in <code>sw::mark::MarkManager</code>, it&#8217;s possible to set the
start position as a character attribute during import (since mapping the
<em>current</em> CP to the current SwPosition is easy) and when we know both the
start and end, delete the character attribute and turn it into a mark manager
entry. That&#8217;s exactly what I&#8217;ve done. The first screenshot is the result of 3
changes:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=271722d923610d128a358528e64d7233641ea0dc">add
  a annotationmark-start character attribute</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=677fdd4fa235466649911042577bc4980d42deb6">tokenize
  the annitationmark start and end structures from binary DOC</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=0ec0ec267986644084baaa5bda5ba917dc5744df">handle
  annotation marks via the character attribute added in the first change</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Hopefully this makes LibreOffice not only
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=b1cd83c625a2afeb9da43cc9745d79c01963c797">avoid
crashing</a> on such complex annotated contents, but also puts an end to the
long story of "annotation marks from binary DOC" problems.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Just like how C++11 perfect forwarding isn&#8217;t perfect&#8201;&#8212;&#8201;if you think
it is, see "Familiarize yourself with perfect forwarding failure cases." in
<a href="http://scottmeyers.blogspot.hu/2014/08/near-final-draft-of-effective-modern-c.html">this
post of Scoot</a>&#8201;&#8212;&#8201;the above changes may still not result in a truly perfect
import result of DOC annotation marks. But I think the #1 problem in this area
is now solved. :-)</td>
</tr></table>
</div>


<script src="https://apis.google.com/js/plusone.js"></script>
<g:plus action="share"></g:plus>

<!-- Disqus comments -->
<h1 id="comment-header">Comments</h1>
<div id="disqus_thread"></div>
<script type="text/javascript" src="http://vmiklos.disqus.com/embed.js">
	var disqus_developer = 1;
</script>
<noscript>
  <p><a href="http://disqus.com/?ref_noscript=vmiklos">View the discussion thread.</a></p>
</noscript>

</div>
</div>
</div>
</div>
</body>
</html>
