<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />


  <title>
    What is Miklos hacking
&ndash; Posts by: Miklos Vajna  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
&gt; Author: Miklos Vajna
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/open-source-budapest-5.html">Open Source Budapest 5. meetup</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 17 April 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div style="text-align: center; font-size: 0.6em;">
<img src="https://lh3.googleusercontent.com/-ZPI3opPIqYE/VTIW5Igo5SI/AAAAAAAAFZc/rTmjqi14fZY/s800/"/>
<p>(via <a href="https://www.youtube.com/watch?v=cKTpJtRQaCM">Open Source Budapest Meetup</a>)</p>
</div>
<div class="paragraph"><p>On Tuesday the 5th Open Source Budapest meetup was held, I was one of the
invited speakers, and gave a lightning talk about
<a href="https://github.com/vmiklos/ged2dot">ged2dot</a>, both as a standalone Python
script and as a
<a href="http://extensions.libreoffice.org/extension-center/gedcom">LibreOffice
extension</a>.</p></div>
<div class="paragraph"><p>My uploaded slides are available
<a href="https://speakerdeck.com/vmiklos/csaladfak-abrazolasa-szabad-szoftverekkel">here</a>.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/android-editing-part-5.html">Android editing: from graphic handling to formatting</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 02 April 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>In <a href="https://vmiklos.hu/blog/tiled-editing-part-4.html">from selections to graphic
handling</a>, I wrote about how we let the LibreOffice Android app select, resize
and move images and shapes.  Now that we have all type of selections (at least
for Writer) in this
<a href="http://blog.documentfoundation.org/2015/01/27/the-document-foundation-announces-the-results-of-the-android-tender/">TDF-funded
project</a>, let&#8217;s do some formatting! The example implemented by
<a href="http://holesovsky.blogspot.com/">Jan Holesovsky</a> here is to mark the text bold,
but you can imagine that using the same technique a number of other character
or paragraph properties could be set the same way with little work.</p></div>
<div class="paragraph"><p>Here is how it works:</p></div>
<div class="ulist"><ul>
<li>
<p>
When you click on toolbar buttons on the desktop UI, so-called UNO commands
  are invoked, bold is <code>.uno:Bold</code>.
</p>
</li>
<li>
<p>
This command is generated by the native Android UI as well, and passed to
  the <code>lok::Document::postUnoCommand()</code> LOK API.
</p>
</li>
<li>
<p>
Then the LOK implementation uses the recently introduced
  <code>comphelper::dispatchCommand()</code> internal API to actually execute it.
</p>
</li>
<li>
<p>
In all applications (Writer, Calc, Draw and Impress) this command is then
  evaluated on the current selection: so if you have a cursor position, then
  from now on the new characters will be bold&#8201;&#8212;&#8201;or if you have a selection,
  then that will be adjusted. The point is that this works exactly how it
  happens with the desktop UI, reusing the same code.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you are interested how this looks like, here is a demo (click on the image to see the video):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://youtu.be/5fmjQ6PmBQw">
<img src="https://lh6.googleusercontent.com/-t3TbtyU1BG4/VR05HL8srKI/AAAAAAAAFYQ/cM2Ex5MTkoo/s800/" alt="https://lh6.googleusercontent.com/-t3TbtyU1BG4/VR05HL8srKI/AAAAAAAAFYQ/cM2Ex5MTkoo/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>Notice that Calc also gained a number of new features, like cell selection,
blinking cursor, text selection with much help from Henry Castro.</p></div>
<div class="paragraph"><p>Now that Writer is nearly functional for the basic editing features that would
be good to see in all four applications, time to look at what&#8217;s new in
Impress-land!</p></div>
<div class="paragraph"><p>To bring Impress in line with Writer, we implemented the followings with
<a href="http://tomazvajngerl.blogspot.com/">Tomaž Vajngerl</a>:</p></div>
<div class="ulist"><ul>
<li>
<p>
shape text now has a blinking cursor with a cursor handle that can be
  dragged
</p>
</li>
<li>
<p>
long push on a word results in a shape text selection with selection handles
  that can be dragged
</p>
</li>
<li>
<p>
it&#8217;s now possible to resize shapes
</p>
</li>
<li>
<p>
Impress table selections can be created in two ways: either by long pushing
  on an empty Impress table cell, or by long pushing on shape text inside a
  cell, and then turning that shape text selection into a table one.
</p>
</li>
<li>
<p>
it&#8217;s possible to tap on a selected shape without text to add text to it.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Here is a demo to show this in action:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="http://youtu.be/4KdFMZJK7uY">
<img src="https://lh3.googleusercontent.com/-IwBuKW9bI6Y/VR05HO5Fa_I/AAAAAAAAFYM/YNCT3k56j5I/s800/" alt="https://lh3.googleusercontent.com/-IwBuKW9bI6Y/VR05HO5Fa_I/AAAAAAAAFYM/YNCT3k56j5I/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>For many of the above features, the core part was already implemented due to
Writer shapes, what was missing is to call the same editeng methods from
Impress and/or do missing core coordinates &#8594; LOK coordinates conversions. The
later is twips for both cases in Writer, but Impress works in 100th millimeters
internally, so it was necessary to do a number of conversions here and there
so that LOK callbacks always emit coordinates in twips.</p></div>
<div class="paragraph"><p>We also prepared more in-depth technical documentation about the Android
editing work, <code>libreofficekit/README</code> and <code>android/README</code> now has much more
details about how exactly the editing works.</p></div>
<div class="paragraph"><p>That&#8217;s it for now&#8201;&#8212;&#8201;as usual the commits are in master (a few of them is only
in feature/tiled-editing for now), so you can try this right now, or wait till
the next Tuesday and get the
<a href="http://dev-builds.libreoffice.org/daily/master/Android-ARM@24-Bytemark-Hosting/current/">Android
daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/tiled-editing-part-4.html">Android editing: from selections to graphic handling</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 19 March 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>In <a href="https://vmiklos.hu/blog/tiled-editing-part-3.html">from input handling to
selections</a>, I wrote about how we let LibreOffice Android app draw the
selections around text content natively. A next step in this
<a href="http://blog.documentfoundation.org/2015/01/27/the-document-foundation-announces-the-results-of-the-android-tender/">TDF-funded
project</a> is to provide selections around more UI elements: images and shapes.</p></div>
<div class="paragraph"><p>Here are a number of challenges we (<a href="http://tomazvajngerl.blogspot.com/">Tomaž Vajngerl</a> and me) faced while we implemented this:</p></div>
<div class="ulist"><ul>
<li>
<p>
On Linux (the desktop), the move and resize operations are really similar:
  if you click near a resize handle (you "hit it"), then it&#8217;ll be a resize,
  otherwise it&#8217;ll be a move. Defining "near" means that you don&#8217;t have to
  click exactly at the center of the handle, but we allow some tolerance. Turns
  out that the tolerance depended on the pixel size of the handle drawn on the
  desktop: and because we don&#8217;t package the bitmaps of the desktop UI, that
  tolerance was 0.
</p>
</li>
<li>
<p>
Writer normally requires a click and a double-click to start editing shape
  text. One to select the shape and another to actually start the text
  editing. Instead of literally translating this to a tap and a long push, we
  wanted to start text editing right away if the user tapped on shape text.
</p>
</li>
<li>
<p>
Shape text doesn&#8217;t use the normal Writer text, but editeng&#8201;&#8212;&#8201;used by
  Impress and Calc, too. So we had to instrument the editeng module as well to
  expose the blinking cursor, so that if you tap inside the editeng text, you
  have some feedback where you are. Same is true for the cursor handle: once we
  knew where the cursor is, we could draw the cursor handle, but dragging it did
  nothing: now the <code>setTextSelection()</code> LOK API handles the case when the cursor
  is inside editeng text and can adjust the cursor position there, too.
</p>
</li>
<li>
<p>
On Linux, users got used to the following resize behavior: when images are
  resized, the aspect ratio is kept, but this is not the case for shapes. We
  wanted to keep this behavior on Android, too.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you are interested how this looks like, here is a demo (click on the image to see the video):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="http://youtu.be/bTWLz_4YQtA">
<img src="https://lh5.googleusercontent.com/-JEuiW789JEM/VQqrR8zDHjI/AAAAAAAAFVo/ORgDKNBIIJA/s800/" alt="https://lh5.googleusercontent.com/-JEuiW789JEM/VQqrR8zDHjI/AAAAAAAAFVo/ORgDKNBIIJA/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>Notice how the word selection in a table turns into a table selection, or how
a long push inside an empty cell creates a selection containing only the empty
cell.</p></div>
<div class="paragraph"><p>An other direction we&#8217;re working towards is to show / hide the soft keyboard
of Android as you would expect it. On Linux, it&#8217;s easy: the keyboard is always
available. However on Android you should track when it makes sense to use the
keyboard and when not&#8201;&#8212;&#8201;and show/hide automatically according to the context.
Examples:</p></div>
<div class="ulist"><ul>
<li>
<p>
When you tap inside text, we show the keyboard.
</p>
</li>
<li>
<p>
When you finish editing, we hide it.
</p>
</li>
<li>
<p>
When you start scrolling, we hide it.
</p>
</li>
<li>
<p>
When you select an image, we hide it.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Additionally, we need to handle the situation when this automagic goes wrong.
The Android soft keyboard has a button to hide itself, but we added a toolbar
button to force-show it, too (click on the image to see the video):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="http://youtu.be/36MsGe-7Mpo">
<img src="https://lh6.googleusercontent.com/-rUxX9gC9z4M/VQqrR0rIyMI/AAAAAAAAFVk/y5GluM-u5eg/s800/" alt="https://lh6.googleusercontent.com/-rUxX9gC9z4M/VQqrR0rIyMI/AAAAAAAAFVk/y5GluM-u5eg/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>Finally, <a href="https://siqi43.wordpress.com/">Siqi Liu</a> added a new callback type,
allowing to tap on hyperlinks and handle them according to how you
configured URL handling on your Android device. Here is a demo to show this in
action:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="http://youtu.be/dBcGVu5pcSk">
<img src="https://lh6.googleusercontent.com/-tNnSAiN3p-o/VQqrR5UslSI/AAAAAAAAFVg/xCbkq7-Vark/s800/" alt="https://lh6.googleusercontent.com/-tNnSAiN3p-o/VQqrR5UslSI/AAAAAAAAFVg/xCbkq7-Vark/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>That&#8217;s it for now&#8201;&#8212;&#8201;as usual the commits are in master (a few of them is only
in feature/tiled-editing for now), so you can try this right now, or wait till
the next Tuesday and get the
<a href="http://dev-builds.libreoffice.org/daily/master/Android-ARM@24-Bytemark-Hosting/current/">Android
daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/libvisio-testing.html">Document Liberation Project regression testing</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Sat 14 March 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://lh5.googleusercontent.com/-0Qh5cUx4gGA/VQR_RkRe2jI/AAAAAAAAFU8/5KIPToOna4Q/s0/" alt="https://lh5.googleusercontent.com/-0Qh5cUx4gGA/VQR_RkRe2jI/AAAAAAAAFU8/5KIPToOna4Q/s0/" />
</div>
</div>
<div class="paragraph"><p><a href="https://vmiklos.hu/blog/libvisio-setup.html">Earlier</a> I wrote about my setup to
hack libvisio. One missing bit was testing the contributed code. Testing can
be performed at various levels, so far DLP libraries were tested by recording
the output of the various <code>foo2raw</code> tools and then comparing the current output
to some previously known good state. This has a number of benefits:</p></div>
<div class="ulist"><ul>
<li>
<p>
If you know that the current state is good, then there is no need write
  testcases, you can just record your state automatically.
</p>
</li>
<li>
<p>
Any change in the output fill signal instant failure, so it gives pretty
  good test coverage.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The same technique was used in LibreOffice for Impress testcases initially,
however we saw a drawback there: Being automatically generated, you have no
control over what part of the output is important and what part is not&#8201;&#8212;&#8201;both
parts are recorded and when some part changes, you have to carefully evaluate
on a case by case basis if the change is OK or not. The upshot is that from
time to time you just end up regenerating your reference testsuite and till
the maintainer doesn&#8217;t do that, everyone can only ignore the test results&#8201;&#8212;&#8201;so it doesn&#8217;t really scale.</p></div>
<div class="paragraph"><p>In short, both techniques have some benefits, but given that the
<a href="https://gerrit.libreoffice.org/gitweb?p=libvisio-test.git">libvisio test repo</a>
is quite empty, I thought it&#8217;s a good time to give an other method (what we
use quite successfully in LO code) a go, too. This method is easy: instead of
recording the whole output of some test tool, output a structured format (in
this case XML), and then just assert the interesting part of it using XPath.
Additionally, these tests
<a href="https://gerrit.libreoffice.org/gitweb?p=libvisio.git;a=tree;f=src/test;hb=HEAD">are
in libvisio.git</a>, so you can nicely put the code change and the testcase
<a href="https://gerrit.libreoffice.org/gitweb?p=libvisio.git;a=commitdiff;h=1bda66b9c0c1cc2b9dcf323a0a45e314b5d4410f">in
the same commit</a>. So the hope is that this is a more scalable technique:</p></div>
<div class="ulist"><ul>
<li>
<p>
Provided that <code>make distcheck</code> is ran before committing, you can&#8217;t forget to
  clone and run the tests.
</p>
</li>
<li>
<p>
Writing explicit assertions means that it&#8217;s rarely needed to adjust existing
  tests. Which is a good thing, as there are no tests for the tests, so
  touching existing tests should be avoided, if possible. ;-)
</p>
</li>
<li>
<p>
Having testcase + code change in the same commit is one step closer to the
  dream e.g. the git.git guys do&#8201;&#8212;&#8201;they usually require documentation, code
  and test parts in each patchset. :-)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Technically this method is implemented using a
<code>librevenge::RVNGDrawingInterface</code> implementation that generates XML. For now,
this is part of libvisio, so in case you want to re-use it in some other DLP
library, you need to copy it to your import library, though if indeed multiple
importers start to use it, perhaps it&#8217;ll be moved to librevenge. The rest of
the test framework is a simple
<a href="https://gerrit.libreoffice.org/gitweb?p=libvisio.git;a=blob;f=src/test/test.cpp;hb=HEAD">testsuite
runner</a> and a
<a href="https://gerrit.libreoffice.org/gitweb?p=libvisio.git;a=blob;f=src/test/importtest.cpp;hb=HEAD">cppunit
TestFixture</a> subclass that contains the actual test cases.</p></div>
<div class="paragraph"><p>So in case you are planning how to test your import library, then now you have
two options, evaluate them and choose what seems to be the better tool for
your purpose.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/tiled-editing-part-3.html">Tiled editing: from input handling to selections</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 27 February 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>In <a href="https://vmiklos.hu/blog/tiled-editing-part-2.html">from a living document to
input handling</a>, I wrote about how we handle touch and on-screen keyboard
events in the LibreOffice Android app. A next step in this
<a href="http://blog.documentfoundation.org/2015/01/27/the-document-foundation-announces-the-results-of-the-android-tender/">TDF-funded
project</a> is to provide more UI elements which are specific to touch devices:
selections is one of them.</p></div>
<div class="paragraph"><p>Here are the problems we had to solve to get this working:</p></div>
<div class="ulist"><ul>
<li>
<p>
Long push is not an event core would recognize.
</p>
</li>
<li>
<p>
If you use the mouse and have a selection in Writer, it&#8217;s only possible to
  extend the end of it. If you use the keyboard, then it&#8217;s possible to shrink
  the end of it, but still no adjustment of the start. On touch devices, it&#8217;s
  natural to have selection handles at the start and end of the selection and be
  able to adjust both, in both directions.
</p>
</li>
<li>
<p>
Additionally, when the user drags the selection handles, the expected
  behavior is that the position of the selection and the handle are never the
  same: the handle is placed below the selection position and when you drag the
  handle, the new selection position is above the handle&#8230; ;-)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Long push is reasonable to map to double mouse click, as in both cases e.g. in
Writer the user expects to have a <em>select word</em> action. But for the adjustment
of selections, we really had to define a new API
(<code>lok::Document::setTextSelection()</code>) to allow setting the start or end of the
selection to a new logical (in document coordinates, not paragraph / character
indexes) point.</p></div>
<div class="paragraph"><p>If you are interested how this looks like, here is a demo:</p></div>
<center>
<iframe width="420" height="315" src="https://www.youtube.com/embed/dmZtxA2HD5o" frameborder="0" allowfullscreen></iframe>
</center>
<div class="paragraph"><p>An other direction we&#8217;re working towards is to have the same features in other
applications as well: Impress and Calc. Perhaps not so surprisingly, we hit
similar problems in these applications as well that we had to solve in Writer.
The typical problems are:</p></div>
<div class="ulist"><ul>
<li>
<p>
LibreOffice assumes a given portion of the document is visible (visual
  area), but the Android view is independent from what LO thinks is visible.
  Example: LO thinks a table is not visible, so it doesn&#8217;t send the selection
  events for the text inside the table, even if it&#8217;s in fact visible on the
  Android app.
</p>
</li>
<li>
<p>
Instead of calling Invalidate() and waiting for a timer to call Paint(), at
  some places direct Paint() is performed, so the tile invalidation
  notification triggered by Invalidate() is missing &#8594; lack of content on
  Android.
</p>
</li>
<li>
<p>
We render each tile into a VirtualDevice&#8201;&#8212;&#8201;kind of an off-screen rendering
 &#8201;&#8212;&#8201;and at some places LO assumed that certain content like the actively edited
  shape&#8217;s text is not interesting, as it&#8217;s not interesting "during printing".
</p>
</li>
<li>
<p>
LO&#8217;s mouse events are in pixels, and then this is translated to mm100
  (hunderd of milimeters) or twips in core. So counting in pixels is the
  common language, while the Android app counts everything in twips, and
  doesn&#8217;t want to care about what would be visible at what pixel on the screen,
  if LO would run in desktop mode. So we had to make sure that we can pass in
  event coordinates in twips, and get invalidation coordinates in twips, even if
  previously it was a mix of mm100, twips and pixels.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Here is how Impress looks like, with working tile invalidation, touch and
keyboard handling:</p></div>
<center>
<iframe width="420" height="315" src="https://www.youtube.com/embed/P2cF8zsNnrg" frameborder="0" allowfullscreen></iframe>
</center>
<div class="paragraph"><p>Calc is lagging a bit behind, but it also has working tile invalidation and
keyboard handling:</p></div>
<center>
<iframe width="420" height="315" src="https://www.youtube.com/embed/kQDRpoDkb0s" frameborder="0" allowfullscreen></iframe>
</center>
<div class="paragraph"><p>That&#8217;s it for now&#8201;&#8212;&#8201;as usual the commits of me and
<a href="http://tomazvajngerl.blogspot.com/">Tomaž Vajngerl</a> are in master (a few of
them is only in feature/tiled-editing for now), so you can try this right now,
or wait till the next Tuesday and get the
<a href="http://dev-builds.libreoffice.org/daily/master/Android-ARM@24-Bytemark-Hosting/current/">Android
daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/tiled-editing-part-2.html">Tiled editing: from a living document to input handling</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 09 February 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>In <a href="https://vmiklos.hu/blog/tiled-editing-part-1.html">from viewing only to a
living document</a>, I wrote about how tile invalidation can handle updates in
the Android app in case what should be displayed on the screen changes. A next
step in this
<a href="http://blog.documentfoundation.org/2015/01/27/the-document-foundation-announces-the-results-of-the-android-tender/">TDF-funded
project</a> is to handle more than blinking text: keyboard and mouse/touch events
from the user.</p></div>
<div class="paragraph"><p>First let me enumerate over the issues we had to face:</p></div>
<div class="ulist"><ul>
<li>
<p>
Gtk, Android and LibreOffice&#8217;s VCL use different key codes for the same
  physical keys. We solved this by mapping the special keys manually on the
  Gtk/Android side (using the C++ and Java UNO binding), and for the rest,
  we simply use the unicode representation of the keys.
</p>
</li>
<li>
<p>
Special keys: while "return" was easy to map, getting "backspace" to work
  was more challenging. It worked fine on the Gtk side, but on Android we had
  to make sure that the whole sfx2 dispatching framework works properly, only
  then could map the backspace key to the correct UNO command, which is
  <code>.uno:SwBackspace</code> in case of Writer.
</p>
</li>
<li>
<p>
Mouse handling: VCL sends pixel coordinates to the editing windows, they
  then calculate the offset of the editing area (think about toolbars and
  menus that have to be excluded), and then converts the pixel values to
  document coordinates. In case of tiled editing, we always work with document
  coordinates in logical units (twips), so we had to add the possibility to send
  the coordinates in document ones. This allows core not knowing where the user
  exactly is (in case the tiles are already ready, swiping can be handled
  without any LOK calls), and also allows Android not knowing the implementation
  details of the desktop app (where menus and toolbars would be).
</p>
</li>
<li>
<p>
Cursor caret overlay: we wanted to be sure that it&#8217;s not necessary to
  re-render the affected tiles each time the cursor blinks, so we added a LOK
  API to send the rectangle (its width is nearly zero) of the cursor to Android,
  and then it can handle the blinking cursor itself in a transparent overlay.
  This overlay will be useful for presenting selections as well.
</p>
</li>
</ul></div>
<div class="paragraph"><p>As usual the commits of me and <a href="http://tomazvajngerl.blogspot.com/">Tomaž
Vajngerl</a> are in master, so you can try this right now, or wait till tomorrow
and get the
<a href="http://dev-builds.libreoffice.org/daily/master/Android-ARM@24-Bytemark-Hosting/current/">Android
daily build</a>. However, if you are just interested how this looks like, here are some demos:</p></div>
<div class="ulist"><ul>
<li>
<p>
Keyboard handling in gtktiledviewer:
</p>
</li>
</ul></div>
<center>
<iframe width="420" height="315" src="https://www.youtube.com/embed/Hi9N9IumMZY" frameborder="0" allowfullscreen></iframe>
</center>
<div class="ulist"><ul>
<li>
<p>
Same on Android, including newlines and backspace handling:
</p>
</li>
</ul></div>
<center>
<iframe width="420" height="315" src="https://www.youtube.com/embed/4CJbu_QNUh0" frameborder="0" allowfullscreen></iframe>
</center>
<div class="ulist"><ul>
<li>
<p>
Mouse handling in gtktiledviewer:
</p>
</li>
</ul></div>
<center>
<iframe width="420" height="315" src="https://www.youtube.com/embed/4jH_Ek1p1OA" frameborder="0" allowfullscreen></iframe>
</center>
<div class="ulist"><ul>
<li>
<p>
Same on Android, including the transparent selection overlay that can
  efficiently blink the cursor:
</p>
</li>
</ul></div>
<center>
<iframe width="420" height="315" src="https://www.youtube.com/embed/frQWyjjsl3I" frameborder="0" allowfullscreen></iframe>
</center>
<div class="paragraph"><p>That&#8217;s it for now&#8201;&#8212;&#8201;next on our list are selections, so you can delete and
overwrite more easily. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/fosdem2015.html">LibreOffice on Android FOSDEM talk</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 04 February 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div style="text-align: center; font-size: 0.6em;">
<img src="https://lh4.googleusercontent.com/-3Z-6BCCwldk/VNEQnkMAl8I/AAAAAAAAFO8/m-5535Gu_IM/s400/"/>
<p>(via <a href="https://twitter.com/LOfCollabora/status/561521715550113793">LOfCollabora</a>)</p>
</div>
<div class="paragraph"><p>Today is my last day in Brussels where I
gave a <a href="https://fosdem.org/2015/schedule/event/editors_texboxes_writer/">TextBoxes: complex shapes with complex content</a> and a <a href="https://fosdem.org/2015/schedule/event/editors_libreoffice_android/">LibreOffice on Android</a> talk
at FOSDEM 2015, in the
<a href="https://fosdem.org/2015/schedule/track/open_document_editors/">Open document
editors devroom</a>. The devroom was well-crowded, with about 100 users in the
rows of the audience&#8201;&#8212;&#8201;proof pictures above and below. ;-)</p></div>
<div style="text-align: center; font-size: 0.6em;">
<img src="https://lh3.googleusercontent.com/-sR6rLYO-TWA/VNEQngonBHI/AAAAAAAAFPE/b6wHnfcQ49s/s400/"/>
<p>(via <a href="https://twitter.com/deneb_alpha/status/561559104536477698">deneb_alpha</a>)</p>
</div>
<div class="paragraph"><p>We also had a
<a href="https://wiki.documentfoundation.org/Hackfest/FOSDEM2015">Hackfest</a> with about
20 hackers attending, (again) kindly hosted by
<a href="http://www.betacowork.com/">Betacowork</a> on Monday and Tuesday:</p></div>
<div style="text-align: center; font-size: 0.6em;">
<img src="https://lh5.googleusercontent.com/-yjkNg7omYrI/VNEQnjxF4JI/AAAAAAAAFPA/rO_EtimqYMg/s800/"/>
<p>(via <a href="https://twitter.com/floeff/status/562598533577322496">floeff</a>)</p>
</div>
<div class="paragraph"><p>There were a few topics I hacked on:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=88583">tdf#88583</a>: a fallout from the Writer fillattributes work introduced in
  LibreOffice 4.4
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=68183">tdf#68183</a>: a small new feature missing since the RSID GSoC project ended
</p>
</li>
<li>
<p>
build on HiDPI screens should now
  <a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=1ade66e7e70ce13c419f1ffff5222dcedec281bd">no longer fail</a>
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=88811">tdf#88811</a>: an RTF regression fix, so that now the
  <a href="https://bugs.documentfoundation.org/buglist.cgi?keywords=regression&amp;keywords_type=allwords&amp;status_whiteboard_type=allwordssubstr&amp;query_format=advanced&amp;status_whiteboard=rtf_filter&amp;resolution=---">counter</a> is down to zero again
</p>
</li>
<li>
<p>
we no longer produce invalid ODF output when writing
  <a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=f1f6b6db730ae67a427c7974b59a5e19ab571984">character borders</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>A full list of achievements is
<a href="https://wiki.documentfoundation.org/Hackfest/FOSDEM2015#Achievements">available</a>, if
you were at the hackfest and you did not contribute to that section, please
write a line about what did you hack on. :-)</p></div>
<div class="paragraph"><p>Quite some other slides are now available on
<a href="http://planet.documentfoundation.org/">Planet</a>, don&#8217;t miss them. Mines are
<a href="https://speakerdeck.com/vmiklos/textboxes-in-libreoffice-writer">also</a>
<a href="https://speakerdeck.com/vmiklos/libreoffice-on-android">uploaded</a>.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/tiled-editing-part-1.html">Tiled editing: from viewing only to a living document</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 27 January 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>As it has been announced
<a href="http://blog.documentfoundation.org/2015/01/21/libreoffice-viewer-for-android/">last
week</a>, an Android port of LibreOffice in the form of a viewer app is now
available for download.  What&#8217;s next?
<a href="http://blog.documentfoundation.org/2015/01/27/the-document-foundation-announces-the-results-of-the-android-tender/">Editing</a>,
naturally.  First, thanks again to The Document Foundation&#8201;&#8212;&#8201;and all the
<a href="http://donate.libreoffice.org/">donors</a> who made this (ongoing) work possible.
In this post I would like to explain what did we do with
<a href="http://tomazvajngerl.blogspot.com/">Tomaž Vajngerl</a> at Collabora so far in that
direction.</p></div>
<div class="paragraph"><p>If you ever touched the Android port of LibreOffice, you probably noticed that
sadly developing for Android is much harder compared to Linux (desktop). On
Linux, if you just touch a single module, it&#8217;s possible to rebuild just that
module in a few seconds, and then you can run soffice again with your
modifications included. On Android, this is much harder:</p></div>
<div class="ulist"><ul>
<li>
<p>
due to a limitation of the Android linker, we link all the native code into
  a single shared object, that has to be re-linked after each native code
  modification
</p>
</li>
<li>
<p>
the native + the Java code has to be packed into a .apk archive
</p>
</li>
<li>
<p>
the .apk archive has to be uploaded to the device (or emulator) and
  installed there
</p>
</li>
</ul></div>
<div class="paragraph"><p>and only then can you test your changes. To partly sidestep from this problem,
we split the "Android editing" into two:</p></div>
<div class="ulist"><ul>
<li>
<p>
tiled editing: this can be tested on Linux using the gtktiledviewer test
  application (and ideally any core problem can be seen here already)
</p>
</li>
<li>
<p>
Android LibreOfficeKit client: replacing gtktiledviewer with the real
  Android client code, and this time testing it on the device
</p>
</li>
</ul></div>
<div class="paragraph"><p>One problem with this approach was that while Android properly rendered small
tiles of 256x256 pixels, gtktiledviewer rendered a single huge tile. This
means that in case part of the document changes and we need to re-draw it, we
always repainted the whole document in gtktiledviewer, while we only repainted
the necessary parts on Android. Guess what, if the area to be repainted is
wrong, it&#8217;ll be visible on Android but not on gtktiledviewer. So the first
task we solved was to let gtktiledviewer also render small tiles. For
debugging purposes, small red rectangles are painted at the top left corners
of each rectangle, so the size and position of the tiles can be seen easily:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-VvQFF-Kg270/VMYqe9G76-I/AAAAAAAAFL4/Fnh9_ig03Ww/s0/">
<img src="https://lh5.googleusercontent.com/-VvQFF-Kg270/VMYqe9G76-I/AAAAAAAAFL4/Fnh9_ig03Ww/s420/" alt="https://lh5.googleusercontent.com/-VvQFF-Kg270/VMYqe9G76-I/AAAAAAAAFL4/Fnh9_ig03Ww/s420/" />
</a>
</div>
</div>
<div class="paragraph"><p>The next step was to somehow start work on real editing&#8201;&#8212;&#8201;but where to start? We identified two critical building blocks:</p></div>
<div class="ulist"><ul>
<li>
<p>
there should be some way for the user to provide input (e.g. press a key on
  the software keyboard)
</p>
</li>
<li>
<p>
once the document changed, the application has to redraw the changed part of
  the view
</p>
</li>
</ul></div>
<div class="paragraph"><p>To avoid solving two problems at the same time, we first went after the
second. One use case that only requires the update of the view is blinking
text. Even if no touch or key events are available, a blinking text wants to
update the view using a timer, so it&#8217;s a good testcase. It&#8217;s now possible for
LibreOfficeKit clients to register a notification callback, and using that,
LibreOffice can notify clients if part of the view has to be redrawn. Here is
how it looks using gtktiledviewer:</p></div>
<center>
<iframe width="420" height="315" src="http://www.youtube.com/embed/rgv76GPlMRU" frameborder="0" allowfullscreen></iframe>
</center>
<div class="paragraph"><p>This demonstrates that the LibreOfficeKit implementation in LibreOffice core
and also the gtktiledviewer client code handle correctly tile invalidations.
Once that was done, we could also implement a similar client code in the
Android app&#8201;&#8212;&#8201;it looks like this:</p></div>
<center>
<iframe width="420" height="315" src="http://www.youtube.com/embed/EkGpCrGlhiY" frameborder="0" allowfullscreen></iframe>
</center>
<div class="paragraph"><p>That&#8217;s it for now&#8201;&#8212;&#8201;next on our list is adding support for input handling, so
it&#8217;s possible to type in some text. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/perfect-ww8-comment-import.html">Perfect WW8 comment import</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Sat 24 January 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>TL;DR: Import of annotated text ranges from binary DOC format was a problem
for quite some time, now it should be as good as it always was in the
ODT/DOCX/RTF filter.</p></div>
<div class="paragraph"><p>Longer version: the import of annotation marks from binary DOC was never
perfect. My
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=7907cc0ef9751d553014bd3bab49be9e7fc31bca">initial
implementation</a> had a somewhat hidden, but important shortcoming, in the form
of a "Don&#8217;t support ranges affecting multiple SwTxtNode for now." comment. The
underlying problem was that annotation marks have a start and end position,
and this is described as an offset into the piece table (so the unit was a
character position, CP) in the binary DOC format, while in Writer, we work
with document model positions (text node and content indexes, SwPosition), and it isn&#8217;t
trivial to map between these two.</p></div>
<div class="paragraph"><p><a href="http://zolnaitamas.blogspot.com/">Tamás</a> somewhat
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=f2945255df273404ee2457dcf761cb8f334b732b">improved</a>
this homegrown CP &#8594; SwPosition mapping code, but was still far from perfect. Here is an example. This is how <a href="http://people.freedesktop.org/~vmiklos/2015/perfect-ww8-comment-import.doc">this demo document</a> looks like now in LibreOffice Writer:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s0/">
<img src="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s800/" alt="https://lh6.googleusercontent.com/-SYW-7l2Otpo/VMQDQ-Fme1I/AAAAAAAAFLg/nkGHlfIV85Y/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>And this is how it looked like before the end of last year:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s0/">
<img src="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s800/" alt="https://lh4.googleusercontent.com/-geD82nPpzC4/VMQDQ9souvI/AAAAAAAAFLk/Mhuqrib2DEs/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>Notice how "Start" is commented and it wasn&#8217;t before. Which one is correct? Here is the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s0/">
<img src="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s800/" alt="https://lh5.googleusercontent.com/-L_LmD_wIZks/VMQDQ76Jn3I/AAAAAAAAFLo/mMHr5h5p4oM/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>The reason is that the document has fields and tables, and the homegrown CP &#8594;
SwPosition mapping did not handle this. A much better approach is to handle
the mapping as we do it for bookmarks: even if at the end annotation marks and
bookmarks are entires in <code>sw::mark::MarkManager</code>, it&#8217;s possible to set the
start position as a character attribute during import (since mapping the
<em>current</em> CP to the current SwPosition is easy) and when we know both the
start and end, delete the character attribute and turn it into a mark manager
entry. That&#8217;s exactly what I&#8217;ve done. The first screenshot is the result of 3
changes:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=271722d923610d128a358528e64d7233641ea0dc">add
  a annotationmark-start character attribute</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=677fdd4fa235466649911042577bc4980d42deb6">tokenize
  the annitationmark start and end structures from binary DOC</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=0ec0ec267986644084baaa5bda5ba917dc5744df">handle
  annotation marks via the character attribute added in the first change</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Hopefully this makes LibreOffice not only
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=b1cd83c625a2afeb9da43cc9745d79c01963c797">avoid
crashing</a> on such complex annotated contents, but also puts an end to the
long story of "annotation marks from binary DOC" problems.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Just like how C++11 perfect forwarding isn&#8217;t perfect&#8201;&#8212;&#8201;if you think
it is, see "Familiarize yourself with perfect forwarding failure cases." in
<a href="http://scottmeyers.blogspot.hu/2014/08/near-final-draft-of-effective-modern-c.html">this
post of Scoot</a>&#8201;&#8212;&#8201;the above changes may still not result in a truly perfect
import result of DOC annotation marks. But I think the #1 problem in this area
is now solved. :-)</td>
</tr></table>
</div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/export-validation.html">Export validation as a new year's resolution</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Sat 10 January 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>TL;DR: If you touch the ODF and/or OOXML filters in LibreOffice, please use
the <code>--with-export-validation</code> configure option after you ran the
<a href="https://gerrit.libreoffice.org/gitweb?p=dev-tools.git;a=blob;f=export-validation/setup.sh;hb=HEAD">setup.sh</a>
script.</p></div>
<div class="paragraph"><p><a href="https://mmohrhard.wordpress.com/">Markus Mohrhard</a> did an excellent job with
adding the <code>--with-export-validation</code> build switch to LibreOffice. It does the
following:</p></div>
<div class="ulist"><ul>
<li>
<p>
it validates every Calc and Impress zipped XML document (both ODF and
  OOXML) produced during the build by export filters
</p>
</li>
<li>
<p>
it does the same for Writer, except there only a subset of documents are
  validated
</p>
</li>
</ul></div>
<div class="paragraph"><p>One remaining <a href="https://bugs.freedesktop.org/show_bug.cgi?id=84600">problem</a> was
that it required setting up both
<a href="http://incubator.apache.org/odftoolkit/conformance/ODFValidator.html">odfvalidator</a>
and <a href="https://code.google.com/p/officeotron/">officeotron</a>, neither of them are
standard GNU projects but Java beasts. So even if I and a number of other
developers do use this option, it happens from time to time that we need to
fix new validation regressions, as others don&#8217;t see the problem; and even if
we point it out, it&#8217;s hard to reproduce for the author of the problematic
commit.</p></div>
<div class="paragraph"><p>This has just changed, all you need is to get <code>export-validation/setup.sh</code>
from <a href="https://gerrit.libreoffice.org/gitweb?p=dev-tools.git">dev-tools.git</a>, and run it like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>./setup.sh ~/svn /opt/lo/bin</code></pre>
</div></div>
<div class="paragraph"><p>I.e. the first parameter is a working directory and the second is a directory
that&#8217;s writable by you and is already in your path. And then wait a bit&#8230; ODF
validator uses maven as a build system, so how much you have to wait depends
on how much of the maven dependencies you already have in your local cache&#8230;
it&#8217;s typically 5 to 15 minutes.</p></div>
<div class="paragraph"><p>Once it&#8217;s done, you can add <code>--with-export-validation</code> to your autogen.input
and then toplevel <code>make</code> will invoke odfvalidator and officeotron for the
above mentioned documents.</p></div>
<div class="paragraph"><p>The new year is here, if you don&#8217;t have a new year&#8217;s resolution yet&#8201;&#8212;&#8201;or if
you hate those, but you&#8217;re willing to adopt a new habit from time to time&#8201;&#8212;&#8201;then please consider <code>--with-export-validation</code>, so that such regressions can
be detected before you publish your changes. Thanks! ;-)</p></div>
</div>
</div>

  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/author/miklos-vajna16.html" class="button_accent">&larr; Older Posts</a>

<a href="https://vmiklos.hu/blog/author/miklos-vajna14.html" class="button_accent">Newer Posts &rarr;</a>
</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>