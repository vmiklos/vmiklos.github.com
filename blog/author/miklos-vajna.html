<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />


  <title>
    What is Miklos hacking
&ndash; Posts by: Miklos Vajna  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
&gt; Author: Miklos Vajna
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-markdown-filter.html">Markdown import/export in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 07 October 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer recently got a Markdown import &amp; export filter and there were a number of improvements to
that.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Ujjawal Kumar contributed a markdown import to Writer, as part of Google Summer of Code (GSoC) this
summer. Mike Kaganski of Collabora also created a minimal markdown export in Writer. I looked at the
feature differences between the two, and filled in various gaps in the markdown export. I also added
a few general markdown import/export improvements relevant for normal Writer documents, like
embedded image support.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is a sample case of a document using inline code spans:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/1-code-baseline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/1-code-baseline.png"><figcaption>Code span: baseline</figcaption></figure></a></p>
<p>Exporting this to markdown &amp; loading back to Writer, the code span was lost:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/1-code-old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/1-code-old.png"><figcaption>Code span: old result</figcaption></figure></a></p>
<p>And now it's preserved:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/1-code-new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/1-code-new.png"><figcaption>Code span: new result</figcaption></figure></a></p>
<p>This also works with code blocks.</p>
<p>Second, here is a document with lists:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/2-list-baseline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/2-list-baseline.png"><figcaption>Lists: baseline</figcaption></figure></a></p>
<p>Exporting this to markdown &amp; loading back to Writer, the lists were lost:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/2-list-old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/2-list-old.png"><figcaption>Lists: old result</figcaption></figure></a></p>
<p>And now they are preserved:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/2-list-new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/2-list-new.png"><figcaption>Lists: new result</figcaption></figure></a></p>
<p>This also works with nested lists.</p>
<p>Third, here is a document with an image:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/3-image-baseline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/3-image-baseline.png"><figcaption>Image: baseline</figcaption></figure></a></p>
<p>Exporting this to markdown &amp; loading back to Writer, the image was lost:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/3-image-old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/3-image-old.png"><figcaption>Image: old result</figcaption></figure></a></p>
<p>And now it's preserved:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/3-image-new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/3-image-new.png"><figcaption>Image: new result</figcaption></figure></a></p>
<p>This also works with embedded and anchored images.</p>
<p>Fourth, here is a document with a table:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/4-table-baseline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/4-table-baseline.png"><figcaption>Table: baseline</figcaption></figure></a></p>
<p>Exporting this to markdown &amp; loading back to Writer, the table was lost:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/4-table-old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/4-table-old.png"><figcaption>Table: old result</figcaption></figure></a></p>
<p>And now it's preserved:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/4-table-new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/4-table-new.png"><figcaption>Table: new result</figcaption></figure></a></p>
<p>This also works with table alignments and nested tables (to the extent the markdown markup allows
that).</p>
<p>Fifth, here is a document with a quote block:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/5-quote-baseline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/5-quote-baseline.png"><figcaption>Quote: baseline</figcaption></figure></a></p>
<p>Exporting this to markdown &amp; loading back to Writer, the quote's paragraph indentation was lost:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/5-quote-old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/5-quote-old.png"><figcaption>Quote: old result</figcaption></figure></a></p>
<p>And now it's preserved:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-markdown-filter/5-quote-new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-markdown-filter/5-quote-new.png"><figcaption>Quote: new result</figcaption></figure></a></p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/55393d9cc42b0402362022594b04ab4888257fb7">desktop lok, doc save: register .md for Markdown</a></li>
<li><a href="https://git.libreoffice.org/core/commit/959c448e9531a53e068e4cec3a56b0caf0e0d3d1">sw markdown export: handle code</a></li>
<li><a href="https://git.libreoffice.org/core/commit/bcef97f29a7126cb3469066de4bacafaae30f86a">tdf#168152 sw markdown export: handle lists</a></li>
<li><a href="https://git.libreoffice.org/core/commit/fefd59b58c7d87e034fbf1c45cefa6a87ed09976">tdf#168172 sw markdown export: handle images</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f073d733568d3b635ac8b2c3a5081afd679b4915">tdf#167564 sw markdown export: handle tables</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c94b0c7ace10f5913aa53b593aa0ccd544df3cc3">sw markdown export: handle block quote</a></li>
<li><a href="https://git.libreoffice.org/core/commit/85aa1402c670e8c85949c5aaf01f529a0a59c05b">tdf#168317 sw markdown export: handle code block</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5d0022c28b149dcc1db22176e442d130ff8d0279">sw markdown export: handle table cell adjustment</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b7bc0e5f3999950d6b5f0d2bdcda2c6cc2f04e61">tdf#168341 sw markdown filter: handle links on images</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f63c14c9e45d795c6d5927103181c8d0ede8a34b">sw markdown export: handle line breaks</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3a294f97a9b37cc8ff38f76200b5b58879a3a72f">tdf#168446 sw markdown export: improve image name/description/title handling</a></li>
<li><a href="https://git.libreoffice.org/core/commit/852d8b06bcecc5c68194fced94e4c7af02086c52">tdf#167564 sw markdown export: handle multi-para table cells</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c830c9ab824c8086b2124fec44f834a1d0ae4fa5">tdf#167564 sw markdown export: handle nested table cells</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7608d96302652eb48863da441e121e0c61350412">tdf#168617 sw markdown filter: map tasks to checkbox content controls and back</a></li>
<li><a href="https://git.libreoffice.org/core/commit/169e1f3b914ac590b3719b8129b4f0913d4da228">sw markdown filter: import images with 'data:' URLs</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8d60fcdac9bc79c7b8956ed3cd9e9f518b28c119">sw markdown filter: export non-linked inline images</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3c29e1277bda566b4455123a7a53c8f0fc6eda98">tdf#168662 sw markdown export: extract inline image export functions</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e0601a598977265c5b05ba397bce04d9689fca4b">tdf#168662 sw markdown export: handle anchored images</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (26.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-interdependent-redline-improvements3.html">Interdependent tracked changes improvements in Writer, part 3</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 09 September 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has some support for interdependent (or hierarchical) tracked changes: e.g. the case when you
have a delete on top of an insert. See the <a href="https://vmiklos.hu/blog/sw-interdependent-redline-improvements2.html">second
post</a> for background.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>With the already mentioned improvements in place, the area of format redlines with character style
or direct formatting changes were still lacking: Writer's original model here was just marking a
text range as "formatted" and then either accept the format redline as-is, or reject reverting back
to the paragraph style (default formatting), losing the old character style or old direct
formatting.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is a sample case of a document where the old character style is Strong (~bold) and the font
size is 24pt, while the new character style is Quote (~italic) and the font size is 36pt. The rest
of the document uses no specific character styles and has the font size of 12pt:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements3/1-baseline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements3/1-baseline.png"><figcaption>Interdependent tracked change: improved format, after document load</figcaption></figure></a></p>
<p>Rejecting that format redline resulted in just the defaults, i.e. no character style and 12pt font
size:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements3/2-edit-old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements3/2-edit-old.png"><figcaption>Interdependent tracked change: old reject, lost character style / direct format</figcaption></figure></a></p>
<p>But now we track the old character style &amp; direct format:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements3/3-edit-new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements3/3-edit-new.png"><figcaption>Interdependent tracked change: new reject, handled character style / direct format</figcaption></figure></a></p>
<p>This required changes in the DOCX import, ODF import and ODF export, too.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/7aa34659e2b49bf02a95a17f51e78f3ab9683235">sw: document DocumentRedlineManager</a></li>
<li><a href="https://git.libreoffice.org/core/commit/da3da0635a30f9b61a913bd7553b5e1278bf260e">sw: document IDocumentRedlineAccess</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b2919d5b5ee4e057c99219f5541efc388b2d19b7">sw doc model xml dump: show the item set of a format redline</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d7bf3a17cb27da1a58163e9db657f0a8d8344901">tdf#166319 sw interdependent redlines: fix redo of accept of ins-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/f66d63da05dbe2f254ffaf428257684a38523f66">tdf#166319 sw interdependent redlines: handle deleting a self ins-then-fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1ba53f5ebbd57b7baf72240784d18954688a09b9">tdf#166319 sw interdependent redlines: fix redo of reject of del-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e545ada3501780ee6552bbfa19954794e0440d46">tdf#167194 sw redline reinstate: fix handling of self-inserts</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2db0a779944f9496371b3ba68f7494c635ad431d">tdf#167761 sw format redline: register the item set in the autostyle pool</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b78bdc9eb15fedd22ece76aeb1b43df40caf3b82">tdf#167761 sw format redline: implement ODF export</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0e21f3b36cbd12787021c3b8ef439aab9a09efdd">tdf#167761 sw format redline, char props: implement ODF import</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a6d8608595fd1ecfdff35c2003a28589ea1214ad">tdf#167761 sw format redline, char style: implement DOCX import</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0ba6dd9eb3f342345663b12527a29425675d2078">tdf#167761 sw format redline, char style: implement ODF import</a></li>
<li><a href="https://git.libreoffice.org/core/commit/43104ad996bc9b292b66d9e605632407cb59c4c6">tdf#167761 sw format redline, char style: fix missing encode in ODF filter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c625247680cd5737723154b9a73c45e786611b44">tdf#167761 sw format redline, char style+direct: add ODT export</a></li>
<li><a href="https://git.libreoffice.org/core/commit/bbebb3908ff9a9c384a475737ead537906517387">tdf#167761 sw format redline, char style+direct: add ODT import</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (26.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-floattable12.html">Multi-page floating tables in Writer: keep together or not</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 15 August 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>This post is part of a series to describe how Writer now gets a feature to handle tables that are
both floating and span over multiple pages.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but is useful on
the desktop as well. See the <a href="https://vmiklos.hu/blog/sw-floattable11.html">11th post</a> for the previous part.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Previous posts described the hardest part of multi-page floating tables: making sure that text can
wrap around them and they can split across pages. In this part, we'll look at a conflicting
requirement. On one hand, headings want their text to not split across pages (and shapes anchored
into paragraphs are considered part of the paragraph, too). On the other hand, it should be OK to
have a floating table at the bottom of a page and the following heading to go to the next page.</p>
<p>It turns out, Writer gave "keep together" a priority, while Word gave "floating tables are OK to
split to a previous page" a priority.</p>
<p>Note that if you have a shape (e.g. a triangle) and not a floating table, then both Word and Writer
prevents the move of that shape to a previous page (if the shape is anchored in a heading); this
difference was there just for floating tables.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is how the <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=167222">tdf#167222</a> bugdoc
looks like now in Writer:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable12/new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable12/new.png"><figcaption>Floating table, followed by heading: new Writer render</figcaption></figure></a></p>
<p>And here is how it used to look like:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable12/old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable12/old.png"><figcaption>Floating table, followed by heading: old Writer render</figcaption></figure></a></p>
<p>And here is the reference rendering:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-floattable12/ref.png"><figure><img src="https://share.vmiklos.hu/blog/sw-floattable12/ref.png"><figcaption>Floating table, followed by heading: reference render</figcaption></figure></a></p>
<p>This means that we leave layout for shapes unchanged in general: shapes anchored in headings are
still considered to be part of headings and don't split. But for floating tables, we now allow them
to split and use space at a previous page if they fit there.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/77f0dc4347b8802c56121ca1c5ef59209970214a">tdf#167222 sw floattable: allow split of fly and its keep-together anchor text</a></li>
<li><a href="https://git.libreoffice.org/core/commit/44c0872bf5f1b658b126d8d928c795e74c0e8ecd">Related: tdf#167222 sw floattable: fix split of fly and its 'keep' anchor text</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e1522e2b1985f6ebdbf442bdbd55cbc5f2b85dd6">Related: tdf#167222 sw floattable: fix split of fly and its heading text w/ ftn</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a5154c0de7679e2abc78b33b351025ea5e54a479">sw: fix assertion failure in SwFrameShell::Execute()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e03da71738c72bbaecb824b4ba356a0a9923a0ff">Related: tdf#167222 sw floattable: fix split of fly and heading text fit check</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (26.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-interdependent-redline-improvements2.html">Interdependent tracked changes improvements in Writer, part 2</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 08 July 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has some support for interdependent (or hierarchical) tracked changes: e.g. the case when you
have a delete on top of an insert. See the <a href="https://vmiklos.hu/blog/sw-interdependent-redline-improvements.html">first
post</a> for background.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>With the already mentioned improvements in place, a few areas were still lacking: we didn't have UI
for all cases where the DOCX import was possible already; combining tracked changes (redlines) were
not complete (so you don't have to reject all parts of a logical redline one by one) and some of the
undo/redo code didn't work as expected.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is a sample case where the UI was missing to create something that was possible to import from
DOCX: a format redline on top of an insert redline.</p>
<p>If you had a document with an insert:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/1-baseline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/1-baseline.png"><figcaption>Interdependent tracked change: just insert</figcaption></figure></a></p>
<p>And you selected BBB to mark those characters as bold, we just updated the existing insert redline
to be bold:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/2-edit-old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/2-edit-old.png"><figcaption>Interdependent tracked change: old, format is not tracked separately</figcaption></figure></a></p>
<p>But now we track a format change on top of the insert separately:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/3-edit-new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/3-edit-new.png"><figcaption>Interdependent tracked change: new, format is tracked separately</figcaption></figure></a></p>
<p>This is also visible if you open the track changes dialog, which explains that now you have part of
the insert redline covered by a format redline:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/4-dialog.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/4-dialog.png"><figcaption>Interdependent tracked change: UI dialog now showing multiple redlines </figcaption></figure></a></p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/cc2babfa0a960c7d52ea7997aea19dcf10c12d08">sw interdependent redlines: fix nPamEndtNI -&gt; nPamEndNI typo</a></li>
<li><a href="https://git.libreoffice.org/core/commit/82b24dd9748c6c0a2990e70bda0960ae26415390">tdf#166319 sw interdependent redlines: combine on reject of del-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/612ba7b2bc5d1d12c10287094263f6d31983a3d8">tdf#166319 sw interdependent redlines: fix undo of reject of ins-then-del's del</a></li>
<li><a href="https://git.libreoffice.org/core/commit/eef0dfed817e40cd83e8ba8e290f45c224257f97">tdf#166319 sw interdependent redlines: add UI to create format inside insert</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0566e8e1776921ecb26f0ddd0546ec10afeed8e0">tdf#166319 sw interdependent redlines: undo of creating an ins-then-fmt redline</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e06eb6b4a6176692d25c758121012473fe638043">tdf#166319 sw interdependent redlines: redo of creating an ins-then-fmt redline</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5ed41ca44bee5122a9db4aa946f6e3ecd9432574">tdf#166319 sw interdependent redlines: fix redo of reject of del-then-fmt's del</a></li>
<li><a href="https://git.libreoffice.org/core/commit/76c2168a276f0996deeac08ce176525821fb056e">tdf#166319 sw interdependent redlines: fix bad accept undo action for reject</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-interdependent-redline-improvements.html">Interdependent tracked changes improvements in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 02 June 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 4 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has some support for interdependent (or hierarchical) tracked changes: e.g. the case when you
have a delete on top of an insert. While there were some working cases, handling of many
combinations were missing. I started to make systematic improvements in this area in the recent
past, this post gives you an overview what's done so far.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>DOCX files in Word can often have overlapping tracked changes: Writer tries to split these up to
make sure there is only one tracked change under the cursor at the same time. Still, it's possible
that you have a tracked change with multiple types: e.g. a delete on top of an insert.</p>
<p>The focus in on 3 combinations which appear in DOCX files a lot: "insert, then delete", "insert,
then format" and "delete, then format".</p>
<p>This mostly affects the UI and import/export filters of ODT and DOCX.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Given an insert, then delete:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/ins-then-del.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/ins-then-del.png"><figcaption>Interdependent tracked change: insert, then delete</figcaption></figure></a></p>
<p>Most operations worked nicely here, but in case your cursor was in the middle of AAA and you did a
reject, followed by an undo, proper handling of that was missing, now implemented.</p>
<p>But then given an insert, then a format:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/ins-then-fmt.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/ins-then-fmt.png"><figcaption>Interdependent tracked change: insert, then format</figcaption></figure></a></p>
<p>Then a handling of more actions were missing:</p>
<ol>
<li>DOCX import is now implemented.</li>
<li>ODT import is now implemented.</li>
<li>Accepting when you're inside AAA is now implemented: the insert is accepted for BBB but the
   format stays unchanged.</li>
<li>Rejecting when you're inside AAA is now implemented: the insert is rejected and BBB is also
   removed, together with the format on top of it.</li>
<li>Accepting the BBB now correctly operates on the insert type, so the format type remains after
   accept.</li>
<li>If you accept BBB, now the surrounding AAA and CCC also get accepted as well, as expected.</li>
<li>Now if you reject BBB, then it gets removed from the document, since you rejected an insert.</li>
<li>When you reject BBB, the surrounding AAA and CCC also get rejected.</li>
</ol>
<p>The combined implementation of these should give you a smooth feeling in case you're used to how
Word works: if there is a format redline combined with an insert, then the operations act on the
insert type, and format is only accepted/rejected when there is no insert "under" the format.</p>
<p>Similarly: it's a bit of an implementation detail that Writer splits redlines on DOCX import: so if
you e.g. accept AAA then we combine that with BBB and CCC when it makes sense, so you need to click
a lot less.</p>
<p>Finally, given a delete, then a format:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/del-then-fmt.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/del-then-fmt.png"><figcaption>Interdependent tracked change: delete, then format</figcaption></figure></a></p>
<p>Then again handling of some actions were missing:</p>
<ol>
<li>DOCX import is now implemented.</li>
<li>ODT import is now implemented.</li>
<li>ODT export is now implemented.</li>
<li>Accepting AAA now correctly operates on the delete type of BBB.</li>
<li>Rejecting AAA now correctly operates on the delete type of BBB.</li>
<li>Accepting BBB now correctly works with the delete type.</li>
<li>Accepting BBB now correctly tries to also accept AAA and CCC, too.</li>
</ol>
<p>The current state is not yet complete, but it's a big improvement over what we had in the past,
which was mostly focusing on just "insert, then delete".</p>
<p>You may wonder what about some other cases: if you insert some content with change tracking, that
always creates a new tracked change, so "insert" is never on top of something else. Similarly,
format is always on top of something. Finally the same type is never on top of itself.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/096a40b27d07603880bbf120440ac169a87fe115">tdf#166319 sw interdependent redlines: fix undo of del on top of ins</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ca7a6a57ad1e8d7aadffbbf3fe28d9aabed31286">tdf#166319 sw interdependent redlines: handle format on top of insert</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8e85d559a68f980d99af4ded6a91b7f0458048b9">tdf#166319 sw interdependent redlines: handle accept of insert under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3c039cb31239ba01e3d3b56c526bdb7ba6446032">tdf#166319 sw interdependent redlines: handle reject of insert under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/96faaaf83a1c8b897ce675d175b4d8756d0ea0df">tdf#166319 sw interdependent redlines: handle accept of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/97066d4f5a89ad89d81a45c0b20ce404f9712fc7">tdf#166319 sw interdependent redlines: fix DOCX export of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d659f4b12a24e275e38ec5aa7406c32c9fa08c48">tdf#166319 sw interdependent redlines: handle reject of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ff110bb17b7e003bd205438af94badabeca007c6">tdf#166319 sw interdependent redlines: handle ODF import of insert under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1a340196237ed075b337e6a0ac9f8a45132053bb">tdf#166319 sw interdependent redlines: handle ODF export of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/08acfb815745e7f43ca43557feefcb68607d26c1">tdf#166319 sw interdependent redlines: handle ODF import of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8cabdef0b34210d026ea7a8229f321e272a49109">tdf#166319 sw interdependent redlines: handle accept of ins-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2292bda37378d7f782abbda42c026affd3fa59e5">tdf#166319 sw interdependent redlines: combine on accept of ins-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b6cba0119f8028b426f5eee55be9761971dbfdee">tdf#166319 sw interdependent redlines: handle reject of ins-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/15bd73a093f1f944d504cf555918ca9e60d75c03">tdf#166319 sw interdependent redlines: combine on reject of ins-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5fedce78c8d79a3e86307523c3d74c7df98668f7">tdf#166319 sw interdependent redlines: handle accept of del-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/98f0b23a48246507ced6de5b54d327d95f1725f9">tdf#166319 sw interdependent redlines: combine on accept of del-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/569eb476bbdf83aab0f377da5cb7d2e8c77192b8">tdf#166319 sw interdependent redlines: handle reject of del-then-fmt's fmt</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-redline-reinstate.html">Reinstate for tracked changes in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 08 May 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has the concept of rejecting tracked changes: if a proposed insertion or deletion is not
wanted, then one can reject it to push back on the proposal. So far such an action left no trace in
the document, which is sometimes not wanted. Calling reinstate on a change behaves like reject, but
with history: it reinstates the original state, with the rejected change preserved in the document.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>When Alice works on a document to insert e.g. new conditions for a contract, then perhaps Bob is not
happy with the proposal. But just rejecting the change "silently" would not be polite: the tracked
change then disappears, so possibly Alice thinks it was accepted and Bob didn't communicate the
pushback explicitly in the resulting document, either.</p>
<p>Reinstate is meant to improve this interaction: if an insert is reinstated, then an explicit delete
is created on top of the insert, so Alice can see that Bob was not happy with the proposal. Or in
case Alice proposed a delete, Bob can reinstate that by adding the same content again to the
document, without typing the text manually after the delete.</p>
<p>This is a UI feature: the resulting model still only contains inserts and deletes, so it works even with
DOCX files.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Given an insert:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-redline-reinstate/insert.png"><figure><img src="https://share.vmiklos.hu/blog/sw-redline-reinstate/insert.png"><figcaption>Reinstate: an insert</figcaption></figure></a></p>
<p>Now you can easily create a delete on top of the insert:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-redline-reinstate/insert-after.png"><figure><img src="https://share.vmiklos.hu/blog/sw-redline-reinstate/insert-after.png"><figcaption>Reinstate: a reinstated insert</figcaption></figure></a></p>
<p>And given a delete:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-redline-reinstate/delete.png"><figure><img src="https://share.vmiklos.hu/blog/sw-redline-reinstate/delete.png"><figcaption>Reinstate: a delete</figcaption></figure></a></p>
<p>Now you can easily create an insert right after the delete, preserving complex content:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-redline-reinstate/delete-after.png"><figure><img src="https://share.vmiklos.hu/blog/sw-redline-reinstate/delete-after.png"><figcaption>Reinstate: a reinstated delete</figcaption></figure></a></p>
<p>As you can see, this creates the opposite of the original change as a new tracked change, so it will
in the end still reject the change, but without deleting the original change.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/7af8b3d3305fe8344cb9339269c5dc3f1cd44650">cool#11357 sw redline reinstate: implement this for a single insert</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1df71464588d4cfcba708cf00ef7b6ac94574c8f">cool#11357 sw redline reinstate: handle inserts in selection</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e312cf46fe840f04b729600db9efe89d5f58d6fe">cool#11357 sw redline reinstate: handle a single delete</a></li>
<li><a href="https://git.libreoffice.org/core/commit/db541619cb1ca83598ec479eb9f52e559a8fe72d">cool#11357 sw redline reinstate: handle a single rich delete</a></li>
<li><a href="https://git.libreoffice.org/core/commit/157c00922959adc8fd2e0203ed94dfd847479c54">cool#11357 sw redline reinstate: handle deletes in selection</a></li>
<li><a href="https://git.libreoffice.org/core/commit/447935fba57f1b0f88c0b56cccf5bf971fb1e819">cool#11357 sw redline reinstate: simplify ReinstateRedlinesInSelection()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/9c2c98ac7668e4a3a2e3a70cc54b632de5f79621">cool#11357 sw redline reinstate: add command state</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1926105b47df7b15dd34a8c1135f83b936bf9926">cool#11357 sw redline reinstate: add a reinstate-and-next command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4535698e0b16bf003e8a3705e28f7347f509eb12">cool#11357 sw redline reinstate: add a reinstate-all command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/01311bb1e4c2404354cce8934d36991d91d527b2">cool#11357 sw redline reinstate: avoid unwanted multi- or table selection</a></li>
<li><a href="https://git.libreoffice.org/core/commit/fbf9465e2bc9f878723674d1eff13e0c69656057">cool#11357 sw redline reinstate: fix undo string for a single redline</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7d702ebbfcda41ce2972e30b2a1e493c320df67c">cool#11357 sw redline reinstate: fix undo count &amp; string for multiple redlines</a></li>
<li><a href="https://git.libreoffice.org/core/commit/dcd3427149c33852428b4198c22f6f858125c294">cool#11357 sw redline reinstate: add to the context menu for text</a></li>
</ul>
<p>Online side:</p>
<ul>
<li><a href="https://github.com/collaboraonline/online/commit/3d7933974241fe5d015a9d80f2cc8bde1c1d352e">cool#11357 sw redline reinstate: add UI for this</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-per-view-redline-record.html">Per-user track changes recording in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 02 April 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has the concept of recording tracked changes or not: if recording, typing into a document or
deleting content will create tracked changes of type insertion or deletion. So far this was a
per-document setting, but now individual users can enable or disable this as they wish.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>When Alice keeps typing and Bob enables change tracking, then surprisingly the typed characters of
Alice will form a tracked insertion, which is surprising, since that was not the case a second ago
and Alice didn't do anything other than typing.</p>
<p>Giving users a choice if they enable recording for just this user or for all users fixes this
problem.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is how the per-user (technically per-view) tracked changes recording looks like:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-per-view-redline/sw-per-view-redline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-per-view-redline/sw-per-view-redline.png"><figcaption>Per-view tracked changes recording</figcaption></figure></a></p>
<p>As you can see, the user on the left has recording turned on and this doesn't influence the user on
the right, while this was not possible before.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/ab91358566ccf31f7a9ac57f1c32a9c62840f5d5">cool#11226 sw per-view redline on: support this-view &lt;-&gt; all-views transition</a></li>
<li><a href="https://git.libreoffice.org/core/commit/85fc28a4e55bb8dafd69a19dc5d21a76501446cb">cool#11226 sw per-view redline on: state for the per-view and per-doc commands</a></li>
<li><a href="https://git.libreoffice.org/core/commit/368e2e445c1941d37697cee05a50a34150d18015">cool#11226 sw per-view redline on: allow both per-view and per-doc</a></li>
<li><a href="https://git.libreoffice.org/core/commit/745256f37973d89ea068acd831eba8054a81b93b">Related: cool#11226 sw per-view redline on: fix ratio buttons of is-show</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ae6d396552cd3cebd7fba4942e6ca2fd5de579af">cool#11226 sw per-view redline on: add view-aware getter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e36643877e5ddf57a34481f1c46f87cf250caf19">cool#11226 sw per-view redline on: move the setter to the model</a></li>
<li><a href="https://git.libreoffice.org/core/commit/025a1e4612fecf59f38910fbf52fc63db054ae5f">cool#11226 sw per-view redline on: add new flag in SwViewOption</a></li>
<li><a href="https://git.libreoffice.org/core/commit/88e12a83aec0ffda82195c8a1e34a255d3cfdfd5">cool#11226 sw layout xml dump: show some more view options</a></li>
</ul>
<p>Online side:</p>
<ul>
<li><a href="https://github.com/collaboraonline/online/commit/c37904149498658c3fd25f043fc5f34be89fb120">cool#11226 sw per-view redline on: add tri-state UI in the notebookbar</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/cool-esign.html">Electronic signing in Collabora Online</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 03 March 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 13 minutes</p>
  </div>
  <div class="article_text">
    <p>LibreOffice Technology had the concept of digital signing, but this was not available in <a href="https://www.collaboraonline.com/">Collabora
Online</a>, so it was not possible to combine this with collaborative
editing. Also, once Collabora Online started to expose digital signing with software certificates
for ODF files, that also allowed taking a further step and start supporting electronic signing for PDF
files. Partnering with <a href="https://eideasy.com/">eID Easy</a>, you can create strongest of the electronic
signatures – <a href="https://en.wikipedia.org/wiki/Qualified_electronic_signature">the mighty QES</a>. This
means signing with Collabora Online allows you to:</p>
<ul>
<li>create proper electronic signatures</li>
<li>not share your document with a 3rd-party, only the
  <a href="https://docs.eideasy.com/electronic-signatures/api-flow-with-file-hashes-pdf.html">hash</a> of your
  PDF will be sent to the external service</li>
<li>integrate with e.g. Nextcloud, use the feature without installing anything other than the
  <a href="https://hub.docker.com/r/nextcloud/all-in-one">Nextcloud AIO</a> image</li>
<li>potentially combine signing with other security features like <a href="https://www.collaboraonline.com/blog/collabora-secure-view/">Secure
  View</a> and</li>
<li>work with visual signing in a <a href="https://en.wikipedia.org/wiki/WYSIWYG">WYSIWYG</a> way, which allows
  placing a visible signature widget at the specified page, then dragging it to the preferred
  position.</li>
</ul>
<p>The sample integration presented here is for Nextcloud, but the feature can be made available in
other integrations as well.</p>
<p>See <a href="https://www.collaboraonline.com/blog/sign-pdfs-from-collabora-online-secure-your-documents-now/">Collabora's blog
post</a>
if you prefer less technical information about this feature.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Digital and electronic signing of documents is meant to be based on cryptographic security, and
traditionally this has been exposed to users in a very complex way. You need to know that first you
have to sign your macros and only then your document, you need to somehow get PEM files to have a
signing certificate, you need to somehow get your certificate trusted by some certificate authority
that is commonly trusted by other people who will verify your signature, and so on.</p>
<p>This lead to the need to first support digital signatures in COOL using a single signatures dialog
for ODF files and then later to provide electronic visual signing for PDF files, while continuing to
respect your privacy by not sharing your document with a 3rd-party service.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<h3 id="a-read-write-signatures-dialog">A read-write signatures dialog<a class="headerlink" href="#a-read-write-signatures-dialog" title="Permanent link">&para;</a></h3>
<p>First the signature viewer dialog was turned into a read-write digital signatures dialog in COOL
that is still async (compatible with collaborative editing), first for ODF files &amp; using PEM files.</p>
<p>Related to this, we automatically sign macros (if the document has macros) when signing the
document, so you can’t forget about this or get the order wrong (sign macros first, then the
document).</p>
<p>At this stage implementing signature removal was possible, which again needs an async conversion so
the user can confirm they really want to remove a signature. This also means the signature status of
the document can change, the COOL UI now supports this.</p>
<p>You can now associate a signing certificate / key / CA chain with a COOL editor, so you can sign the
document, but not an other editor working on the same document.</p>
<p>Finally adding a digital signature is now possible, where the certificate chooser just shows your
signing certificates and hides it from other editors.</p>
<p>Here is a screenshot of the early digital signatures dialog at this stage:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-esig/01.png"><figure><img src="https://share.vmiklos.hu/blog/cool-esig/01.png"><figcaption>Initial async digital signatures dialog in COOL with sign and remove buttons</figcaption></figure></a></p>
<h3 id="automatically-signed-documents">Automatically signed documents<a class="headerlink" href="#automatically-signed-documents" title="Permanent link">&para;</a></h3>
<p>The second half of digital signing support in COOL started with WOPI extensions, so an integrator of
COOL can specify the signature settings on their user settings page and pass that to COOL when a
document is edited. We then send this to the document editor process only when needed, i.e. not on
file open, but when the actual signing process would start.</p>
<p>UI is also added on the notebookbar in the form of a new button that allows adding signatures to a
previously unsigned document – before you could only trigger the signatures dialog if the status bar
said something about existing signatures, and only then you could add a signature. This button is
hidden if you don’t have signature settings configured. It looks like this:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-esig/02.png"><figure><img src="https://share.vmiklos.hu/blog/cool-esig/02.png"><figcaption>New sign button on the notebookbar</figcaption></figure></a></p>
<p>When was still missing here is automated Cypress tests to make sure signing e.g. an ODT file keeps
working and the <a href="https://sdk.collaboraonline.com/docs/advanced_integration.html#document-signing">SDK
documentation</a> now
also describes what does it take to support digital signatures in your COOL integration. For example
you can create a Nextcloud integration like this:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-esig/03.png"><figure><img src="https://share.vmiklos.hu/blog/cool-esig/03.png"><figcaption>Nextcloud integration for digital signing</figcaption></figure></a></p>
<p>Finally, COOL’s convert-to endpoint is hooked up with signature support, so you can export to a
signed PDF. Example curl invocation:</p>
<div class="highlight"><pre><span></span><code><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="n">F</span><span class="w"> </span><span class="ss">&quot;data=@in.odt&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">F</span><span class="w"> </span><span class="ss">&quot;format=pdf&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">F</span><span class="w"> </span><span class="s1">&#39;options={&quot;SignPDF&quot;:{&quot;type&quot;:&quot;boolean&quot;,&quot;value&quot;:&quot;true&quot;},&quot;SignCertificateCaPem&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;...&quot;},&quot;SignCertificateCertPem&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;...&quot;},&quot;SignCertificateKeyPem&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;...&quot;}}&#39;</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="nl">localhost</span><span class="p">:</span><span class="mi">9980</span><span class="o">/</span><span class="n">cool</span><span class="o">/</span><span class="nf">convert</span><span class="o">-</span><span class="k">to</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">out</span><span class="p">.</span><span class="n">pdf</span>
</code></pre></div>

<h3 id="plumbing-for-electronic-signing">Plumbing for electronic signing<a class="headerlink" href="#plumbing-for-electronic-signing" title="Permanent link">&para;</a></h3>
<p>Once digital signing of ODF files is handled, let’s switch to PDF signing, which is much more
interesting: you typically want to sign something final, and we see PDF as a final output of your
documents. So first support for digital signing of PDFs was added.</p>
<p>The next part is to integrate with eID Easy, which can do privacy-friendly electronic signing for
us. This is a 5 step process:</p>
<ol>
<li>Extract the hash of the to-be-signed document. This is similar to signing, you start the process
   but once you have the hash that you would sign locally, you just take that hash and abort the
   actual signing.</li>
<li>Send this hash to the electronic signing service.</li>
<li>Open a popup and let the user authenticate with their credentials (passport, personal ID, etc)
   using one of the providers (different providers support different countries) and sign the hash.</li>
<li>Download the signed hash from the service.</li>
<li>Serialize this signed hash into the local document. This requires producing the local PDF
   signature once more, but this time using the previous timestamp (instead of the system clock, so
   the hash is table) and using the downloaded PKCS#7 signature instead of locally signing something.</li>
</ol>
<p>At the end we got something that looks like a signature produced externally, but there was no UI for
this. An initial popup for step 3 looked like this in the test environment (that doesn’t work with
real passport numbers or anything sensitive):</p>
<p><a href="https://share.vmiklos.hu/blog/cool-esig/04.png"><figure><img src="https://share.vmiklos.hu/blog/cool-esig/04.png"><figcaption>COOL popup to sign a document hash</figcaption></figure></a></p>
<h3 id="ui-for-electronic-signing">UI for electronic signing<a class="headerlink" href="#ui-for-electronic-signing" title="Permanent link">&para;</a></h3>
<p>The next step was to create a user interface for electronic signing. The Insert menu had a new menu
item to insert electronic signatures and to specify your country, finally choose one of the
providers available in your country.</p>
<p>Also support for two types of providers is added: the first is the “in context” one, the other is a
“redirect based” one. We now support both: all the redirect (should be familiar to you if you ever
did e.g. online payments) happens in the popup, so the original COOL editor is never closed.</p>
<p>eID also has the concept of multiple tokens for signing: initiating the signing costs money, so is
done using a “secret”, which is never sent to the COOL JS code. Then the “client ID” identifies the
client, but can’t be used to start signing. Finally any single signing transaction has a specific
“document ID”. We took care to follow the guidelines here, so the sensitive “secret” for signing is
always kept on the server.</p>
<p>Similar to the initial document signing, electronic signing settings are also possible to specify
from an integration, we <a href="https://sdk.collaboraonline.com/docs/advanced_integration.html#electronic-signature-handling">documented this in the
SDK</a>
and also created a sample Nextcloud integration for this.</p>
<p>The Nextcloud integration looks like this:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-esig/05.png"><figure><img src="https://share.vmiklos.hu/blog/cool-esig/05.png"><figcaption>Nextcloud integration for electronic signing</figcaption></figure></a></p>
<p>Note that later the API URL was changed to be a <a href="https://github.com/nextcloud/richdocuments/blob/main/docs/app_settings.md#electronic-signature">hidden
setting</a>,
as real signing never needs a custom value there, this is just for testing.</p>
<h3 id="visual-signing">Visual signing<a class="headerlink" href="#visual-signing" title="Permanent link">&para;</a></h3>
<p>The last part of this electronic signing effort was to expose visual singing in COOL, something that
was added to LibreOffice Draw back in 2020, see this <a href="https://vmiklos.hu/blog/sd-visible-pdf-sign.html">earlier blog
post</a>.</p>
<p>First this was exposed in COOL with digital signing, in a way that the current page gets a signature
widget inserted at the page center and then the user can move that signature widget to the desired
location.</p>
<p>Combining this with electronic signing is a bit more tricky, since we don’t want to select a
certificate when the signature widget is inserted, we’ll deal with that in the external service, as
usual.</p>
<p>Also, there was no real reason to not use visual signing unconditionally, so now the way to initiate
a signing process is to open your PDF in COOL, use the Insert → Signature line menu item to insert a
signature widget, move it to the wanted position, click “finish” on the snackbar and that completes
the process with the usual electronic signing popup.</p>
<p>The final problem was that our multi-page PDF viewer was not really prepared to deal with changed
PDF content (assuming your PDF rendering will not change is reasonable), so some last minute work
had to be done to make sure the signature widget’s graphical selection indicator, its dragging and
its rendering works fine even on non-first pages of a PDF document.</p>
<p>At the end, a test signature using the d-trust signature provider’s test environment looks like
this:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-esig/06.png"><figure><img src="https://share.vmiklos.hu/blog/cool-esig/06.png"><figcaption>Electronic signature with a signature widget / visual signature on page 2 of a PDF file, using the test environment of the d-trust provider.</figcaption></figure></a></p>
<p>Or if you prefer watching a demo, a typical electronic signing process session looks like this:</p>
<p><a href="https://www.youtube.com/watch?v=tWS546R3fwE?&amp;t=1022"><figure><img src="https://share.vmiklos.hu/blog/cool-esig/07.png"><figcaption>Demo of electronic signing with Collabora Online, part of a tea-time training</figcaption></figure></a></p>
<p>There were a few more talks with similar content:</p>
<ul>
<li>FOSDEM: <a href="https://fosdem.org/2025/schedule/event/fosdem-2025-5935-automatic-documents-packed-with-content-and-signed/">Automatic Documents, packed with content and signed</a></li>
<li><a href="https://www.youtube.com/watch?v=OkGd_pNuYww&amp;t=4919">Nextcloud Hub 10 announcement</a></li>
</ul>
<p>At the end you get an electronic signature that is trusted by the EU trust list and thus e.g.
Acrobat Reader:</p>
<p><a href="https://share.vmiklos.hu/blog/cool-esig/08.png"><figure><img src="https://share.vmiklos.hu/blog/cool-esig/08.png"><figcaption>A real signature, verified in Acrobat</figcaption></figure></a></p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)
As usual, the high-level problem was addressed by a series of small changes.</p>
<p>LibreOffice core commits:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/0255283974894f5ad9ba92c3a52912657ed4bdf6">cool#9992 lok doc sign: add SfxObjectShell::AfterSignContent()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/de0bc0a2c30a76144b47e9abb17770043813133c">cool#9992 lok doc sign: make <code>SfxMedium::SignContents_Impl()</code> async</a></li>
<li><a href="https://git.libreoffice.org/core/commit/caff013bee53216efeb49db4bcda44b55c223b58">cool#9992 lok doc sign: async DocumentDigitalSignatures::signDocumentContent()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/07df95e75a728fbbce03f6d6efdf9dbceab6c581">cool#9992 lok doc sign: async DocumentDigitalSignatures::ImplViewSignatures()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/482c7c585160681b263c6245a745c21df70e7507">cool#9992 lok doc sign: async read-write DigitalSignaturesDialog</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e5a0209d4b1e1f09191a442e04d626b21c49b9df">cool#9992 lok doc sign: allow sign of macros &amp; the document itself in one step</a></li>
<li><a href="https://git.libreoffice.org/core/commit/40ba7a5c25f0d2ea90a976d4e7d56b9e61dbedd1">cool#9992 lok doc sign: implement signature removal</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a95b90bc0cf0f8a58fc20684acc23bb89b827cd1">cool#9992 lok doc sign: fix signature status after load</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a7830e04f2c33fb8d684d48d00ffc752f7207dea">cool#9992 lok doc sign: add password-less mode to create-certs.sh</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7bad76c3a5b319f8ede74be8f78e5645f9ffd050">cool#9992 lok doc sign: extract duplicated code to SfxLokHelper</a></li>
<li><a href="https://git.libreoffice.org/core/commit/90beea9a9a9ab1a5d4a154704acabadfc83870c9">cool#9992 lok doc sign: handle .uno:SignatureCert/Key/Ca view options</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4787fd4fc86230893a6da309f45964116b3a67df">cool#9992 lok doc sign: store signing cert in the view</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d95ab8d3a3a102c00b69f0b0b49d7eb49e34051e">cool#9992 lok doc sign: fix import of the private key</a></li>
<li><a href="https://git.libreoffice.org/core/commit/c57434559cf5ffd82c3c72e8a0884d4874885dca">cool#9992 lok doc sign: conditionally show the add button in the sign dialog</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a581dbf9829d8407a611907c35c8af632b1397b5">cool#9992 lok doc sign: only take sign cert from the view in the cert chooser</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ced420ca708eb8df5b20c7d537166bd9ec29a0e5">cool#9992 lok doc sign: convert the certificate chooser dialog to async</a></li>
<li><a href="https://git.libreoffice.org/core/commit/298c2d5c8a6791aa6e5846b698d521079aaa445d">cool#9992 lok doc sign: update sign status after modify the list of trusted CAs</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1c7f6188eb5b2a2bbf0cf589843d644306e40d6d">cool#9992 lok doc sign: avoid storing the sign cert in the model after sign</a></li>
<li><a href="https://git.libreoffice.org/core/commit/47fd29a318513d26b86eb0cfa891969ce6c85879">cool#9992 lok doc sign: allow late-init of the sign cert</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4aa8d30c095e08825bc983c699e11f2e88182124">cool#9992 lok doc sign: never remember previous .uno:Signature params</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1e75155c6995e4f1534e2062c64fab35d49ea60b">cool#9992 lok doc sign: allow injecting sign cert/key during pdf export</a></li>
<li><a href="https://git.libreoffice.org/core/commit/27753561a1899949c5cbd5cc6b72a238769e1eeb">cool#9992 lok doc sign, create-certs.sh password-less mode: still create a .p12</a></li>
<li><a href="https://git.libreoffice.org/core/commit/12e50825370dae276d44bea84b3eb2941b401220">cool#9992 lok doc sign, hash extract: initial getCommandValues('Signature')</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0de900cec7b04d75cf9ab0779d7a1ca3c730ae32">cool#9992 lok doc sign, hash extract: time for getCommandValues('Signature')</a></li>
<li><a href="https://git.libreoffice.org/core/commit/eabda77c9735040dd5bdb1d2ebe0b96ce316561a">cool#9992 lok doc sign, hash extract: digest for getCommandValues('Signature')</a></li>
<li><a href="https://git.libreoffice.org/core/commit/39bf87f943cce9a0b5a784bc7426b5b98bbc6992">cool#9992 lok doc sign, hash extract: add signatureTime parameter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/60261557e5311a7b445fb2455aa534697697a9ec">cool#9992 lok doc sign: add initial serialization of external signatures</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0a535147f9bed7856e7ab3513fe3f6c38549a099">cool#9992 doc electronic sign: make return type for .uno:Signature consistent</a></li>
<li><a href="https://git.libreoffice.org/core/commit/70111311f39b52858f7de8b5adb764db9d28a46e">cool#10630 lok doc sign: fix Impress sign line when creating directly</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0cc0896b212b0d1fded8d999b980f18f0379e6e0">cool#10630 lok doc sign: fix Impress sign line when picking a certificate</a></li>
<li><a href="https://git.libreoffice.org/core/commit/fa5be641bc0ad23ed51fb1702a157878cc3ecb04">cool#10630 doc sign: fix Impress sign line, to be able to finish signing again</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a10d5191b62822b96b247e0c95d8be735cc4feed">cool#10630 lok doc sign: allow setting the pos of the Impress sign line</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d925b64ac552348e3862a6b8b61ecd751a8f3a9e">cool#10630 lok doc sign: allow setting the size of the Impress sign line</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7d4222d0088f22a68941d2e910fe50bd10e8bdfe">cool#10630 doc electronic sign: fix insertion of the signature line</a></li>
<li><a href="https://git.libreoffice.org/core/commit/9dd225ee8c45d6c944b9ce5578780d89612e9ffb">cool#10630 doc electronic sign: fix no graphic selection for the signature line</a></li>
<li><a href="https://git.libreoffice.org/core/commit/62dd6274c71bc840f5c5abcd4b1fa536238aa25d">cool#10630 doc electronic sign: move signature line tracking to the view</a></li>
<li><a href="https://git.libreoffice.org/core/commit/76e0a520d6beb118dd6437889fbe16d2a94c941c">cool#10630 doc electronic sign: unselect &amp; reject reselect</a></li>
<li><a href="https://git.libreoffice.org/core/commit/819941bf1422f40e9346eba61d75e0fda3d24275">cool#10630 lok doc sign: reduce the default size of the signature line</a></li>
</ul>
<p>Collabora Online commits:</p>
<ul>
<li><a href="https://github.com/collaboraonline/online/commit/95716823f5a66c18476dd7032a1a1f5fc681f23c">cool#9992 doc sign: fix update of the signature widget in the status bar</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/d5a589e118618e5acaf5a6f381d0f0096da50a39">cool#9992 doc sign: fix missing enable on the cert chooser description entry</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/2a118ab34d57f5e2e4e0bc4d15f9f01c03794943">cool#9992 doc sign: better fix for the cert chooser dialog's disabled description widget</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/e54f2b81158be998f076bdaf310dba826470edf7">cool#9992 doc sign: add sign button to the home tab of the notebookbar</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/497981cd6c7356fc680087997b3217a76a455ac6">cool#9992 doc sign: local file wopi provider: allow setting the sign cert/key/ca</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/0c1cd8c00f88b6cedd8fdb4c4ee15abf16103cd6">cool#9992 doc sign: set the view's sign cert from the WOPI UserPrivateInfo</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/6cdbbe044565b708ef654efc547edd4db5f3b24a">cool#9992 doc sign: add a setting to be able to disable this</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/6de210972ae756a3dad1dbe71ec3a87d5533adf8">cool#10220 doc sign: don't assume that user private data is a dict json</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/89213ce16272579a138c098314b7a96123ffc6c0">cool#9992 doc sign: hide sign button when user pref doesn't provide cert or key</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/925fcd837d0c371f513d70a56ac6c8817b13b271">cool#9992 doc sign: add signature creation cypress test</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/542560f38d09d6d3a03b94822cefba269361eac7">cool#9992 doc sign: move sign key/cert init from doc init to sign dispatch</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/ebc753b7e6d50a861481d0658aeea0fb79c048c5">cool#9992 doc sign: fix handling of saveas options containing spaces</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/d2be47df5fa3593b49057c7a7a2daa8b269d9977">cool#9992 doc sign: add menu item for the compact UI</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/d3806b06157a0de5fa62ad3e292993a3c8590ea7">cool#9992 doc sign: add UI to sign PDF files</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/ab694a028929bad69f2b0761fb291b7acdc34f3d">cool#9992 doc electronic sign: allow passing sign params from JS</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/f6f339088344d2f43facee613ee5c1421a763edc">cool#9992 doc electronic sign: allow more user private info settings with make run</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/da54d2273b82db9664ac7945fd8846b77ad0d3a2">cool#9992 doc electronic sign: add menu item to trigger hash extract</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/b09b20489d9666c107bc0bd332f158d2a9734a77">cool#9992 doc electronic sign: send the hash to be signed</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/a1d81fdd06aa9b313b19e5719ee509270f39de4f">cool#9992 doc electronic sign: actually sign the hash in a popup</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/fb784187b1bc1952c6e0b5f25b208c2439a2e1f3">cool#9992 doc electronic sign: fetch the created signature</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/690fb0413ec4a77a551eba00fbc3d77371a61983">cool#9992 doc electronic sign: serialize the fetched signature</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/cab22ef2cad3727e7731b3e7e7ec8270fd0c07f1">cool#9992 doc electronic sign: add cypress test</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/653107b76e84c7e716a8c3aa71d776c196efca21">cool#9992 doc electronic sign: add a provider selector dialog</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/44ff2a3687dde5a8a9b967be4bc0a50d41612268">cool#9992 doc electronic sign: select the provider interactively</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/63a0d574d523536cd1a51e9847d74972c455fd47">cool#10630 doc electronic sign: improve error handling on bad client ID</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/5e75272cfae784a46dbc068629a30c813ca4e3e3">cool#10630 doc electronic sign: more human-readable names for providers</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/ce7b5bf22f25f4a460ab550bf1d767ed914934fb">cool#10630 doc electronic sign: add /cool/signature endpoint</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/1ffb473e71fa88b882c66c1d7224fe0ffe8969dc">cool#10630 doc electronic sign: implement support for redirect-based providers</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/4a8206bf14d80262c3adf505a14bf51910b5a402">cool#10630 doc electronic sign: expose the name of the document</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/1da7603e641d20fc7ce095ee02d0f34cb4393ed2">cool#10630 doc electronic sign: send the hash on the server</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/8b7fc83546b03b74675077e7999969590f001966">cool#10630 doc electronic sign: get the signature on the server</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/20ac4c2c3c362bb996ad25609be1c8f652254b1d">cool#10630 doc electronic sign: stop sending the secret to the client</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/73ee6c85443eb551b69f4f6f59cd7efd24dfe794">cool#10630 doc electronic sign: remove CSP rules</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/aa6295f3acfad9401769a995807cafc57de2d025">cool#10630 doc electronic sign: configure the language of the popup</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/0e09d9950324997561fcb4e60be5acedcd34592e">cool#10630 doc electronic sign: add a country selector to the dialog</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/bbde01500b559cb402bd19489e3201b582c7f26b">cool#10630 doc electronic sign: add ISO country names</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/830e4608a08050a7593431554ab6113e6283ec20">cool#10630 doc electronic sign: send selected country to the server</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/e1e6a08b15d5a39174c82fa0a4f776d1e7543d2f">cool#10630 doc electronic sign: moved esign settings out of UserPrivateInfo</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/8d043c31b25cd3ab4d8f715650f0610863e3801d">cool#10630 doc electronic sign: support per-server private info during 'make run'</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/5a79a28e5c1952b62ae1e876beb721e11b56d0bf">cool#10630 doc electronic sign: default to a redirect-based provider</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/c8b7cb63fdbb6bb33bb3eebff30eb2bdd65422b6">cool#10630 doc electronic sign: set defaults without an index</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/4d42b1e3e47ad0183649678d2aa931b44c5ffe10">cool#10630 doc electronic sign: return dialog result without an index</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/62aa4d53914421fb4e1cb24ff3787d3d8ad0e038">cool#10630 doc electronic sign: limit the offered providers based on the selected country</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/cb100b9c4a5a8ab93e0edbcbb624b0b68cf2fb23">cool#10630 doc electronic sign: sort the country &amp; provider lists</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/dfa52148c3d0637dc212d69f1f5f42f044dd276a">cool#10630 doc sign: expose visual signing</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/03f9cf4f5749cce8ffeff9ccf44bda5a6fc8f0c4">cool#10630 doc sign: add visual signing testcase</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/bbaa9548a542930747841be0c8cdc3089e6a05d5">cool#10630 doc sign: allow setting the position / size of a visual signature</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/c474a775468b20d7ba31be0d30bd443971276f6b">cool#10630 doc electronic sign: handle visual signatures</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/4c6ce3ad510e98772af6da862ecf7e08c162680a">cool#10630 doc electronic sign: add a snackbar</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/fbb710dd4dc990cb0f5003e78c95b7db008b5cde">cool#10630 doc electronic sign: show the sign view dialog after esign</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/7fbd76027f157b8816af6b5f5643b8d7f747d203">cool#10630 doc electronic sign: remember the provider in localstorage</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/36b509877931c8a0a005f9ed50ada3e7f7d402e2">cool#10630 doc electronic sign: show busy overlay while the popup is open</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/bba469ef8a7a1c6ad5225d554279f3f30c319e31">cool#10630 doc electronic sign: close the popup on tab close</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/2ec5568ef900e309a371758987640eb18f6c52e8">cool#10630 doc electronic sign: avoid unwanted postmessage during sign</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/bbe7badae6bfdc80c8193aa940a78f1af8fc48a9">cool#10630 doc electronic sign: fix no graphic selection on 2nd page</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/e20c1838b3e65900f61ddb2c5f0bb72385577275">cool#11002 kit: fix memory corruption in Document::handleSaveMessage()</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/0ee465340c7a01af4ab2f77930feb642bb0a3558">cool#10630 doc electronic sign: fix no SVG in graphic selection on 2nd page</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/3cf8a2f1f161270fb0a85863bea1d5277e92eed3">cool#10630 doc electronic sign: fix outgoing mouse messages on 2nd page</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/df5c0a672bad3a3e9b1a5a3f792c94a47753ac61">cool#10630 doc electronic sign: fix outgoing transform pos on 2nd page</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/97d166457afeba3654a7c22acc41230a6d13c7c9">cool#10630 doc electronic sign: fix outdated tile for shape move on 2nd page</a></li>
</ul>
<p>Nextcloud richdocuments commits:</p>
<ul>
<li><a href="https://github.com/nextcloud/richdocuments/commit/20ca5fd77d0753b58c997ad6a7889153d8b2469e">feat: add personal setting to specify the CA chain for document signing</a></li>
<li><a href="https://github.com/nextcloud/richdocuments/commit/6ca8071c495ebf4cd7797dd44a0700f9970abc31">feat: expose the documentSigningCa personal setting in the WOPI CheckFileInfo</a></li>
<li><a href="https://github.com/nextcloud/richdocuments/commit/adfb9056d40af3a861463753f47e72ab5f2f905c">feat: document signing, add setting for the signing certificate &amp; key, too (fixes #4123)</a></li>
<li><a href="https://github.com/nextcloud/richdocuments/commit/a9fa62cc5232a20021f206d34f4d295129c72e2c">feat: electronic signing, add settings for eIDEasy (fixes #4311)</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraoffice.com/code/">try
the development edition</a>.</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/cool-sw-visible-area-perf.html">Improving interactivity: the Writer visible area in Collabora Online</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 21 February 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p><a href="https://www.collaboraoffice.com/">Collabora Online</a> now takes the visible area (viewport) of large
Writer documents into account in more cases, leading to better performance &amp; interactivity.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Collabora Online has two kinds of "visible areas" for a document: on one hand, the entire document
is visible, so in case any part of the document changes, the browser client gets notified; on the
other hand, there is a viewport in the web browser, and keeping that up to date is a priority,
compared to the rest of the document.</p>
<p>There were some cases in the past where we handled the entire document with the same priority,
leading to slower than ideal update times on the UI.</p>
<p>Wouldn't it be nice to always update the visible part first, and only then deal with the rest, on
idle?</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>When looking at this topic, we noticed a cluster of problems:</p>
<p>First, consider the case of a long (~300 pages) document, where you insert a page break at the start
and wait for the update of the visible area. The entire document layout (now 301 pages) were
calculated, and now we do this for the visible area synchronously (and the rest on idle).  This
operation is now about 19 times faster.</p>
<p>Second, loading a long document calculated the entire layout before showing the first page. This is
now improved, the document loading time itself at a LOK API level for such a long document is now
about 5 times faster.</p>
<p><a href="https://www.youtube.com/watch?v=0vnEgwBaqt8"><figure><img src="https://share.vmiklos.hu/blog/cool-sw-visible-area-perf/faster-load.png"><figcaption>Faster render of the first page in COOL 24.04</figcaption></figure></a></p>
<p>Third, COOL didn't consider the priority of core tasks when interrupting to do its own work (COOL's
document editing process and LibreOffice core shares the same main loop). Now we do this,
categorizing the core tasks into "high priority" and "low priority" buckets and we only interrupt
when core doesn't have high priority tasks any more (this is only in 25.04).</p>
<p>Fourth, there was no easy access to a large Writer document during development. Now <code>make run
COOL_WRITER_LARGE=y</code> allows opening a long document in your local browser for development / testing
purposes.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://github.com/collaboraonline/online/commit/dec9a0d135bad35c958d1eee8f76048189a5601e">cool#11064 kit: send the client's visible area during file load</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/500df64292e53fe07c92d492511ed82bfcb8b546">cool#11064 kit: check for callbacks &amp; wsd socket in the anyInput callback</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/31dae7872b914e15bf81ab49fd731383808b3a01">cool#11064 any input: conditionally consider priority of core tasks</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/92573acd1bd45b643ab361484cdbfac7dc262dc6">cool#11064 any input: add page insert testcase</a></li>
<li><a href="https://github.com/collaboraonline/online/commit/73793c24c7b77f2026e3af2673c4513278dd27c6">cool#11064 test: support creating a large Writer document with many pages</a></li>
</ul>
<p>The tracking issue was <a href="https://github.com/CollaboraOnline/online/issues/11064">cool#11064</a>.</p>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraoffice.com/code/">try
the development edition</a>.</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-ignore-margin-page-top.html">Ignoring the paragraph margin at the top of pages in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 08 January 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has the concept of paragraph margins and page margins, but what happens when you combine the
two? It turns out the expectation is that sometimes the top paragraph margin is ignored in this
case. We'll see two cases where the behavior of Writer is now improved to better match Word in this
regard.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>As described in a <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=160952">previous bugreport</a>,
there was a first problem where Word ignored the top paragraph margin of a document, but Writer did
not. A <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=164095">recent bugreport</a> then pointed
out that the first implementation went too far and now a wanted top margin was ignored. This lead to
a set of conditions which now does a decent emulation of Word's rules in this regard.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is the old Writer render result for a document where the top margin should be ignored:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/old.png"><figcaption>Bugdoc: old Writer render</figcaption></figure></a></p>
<p>And here is the new Writer render result for a document where the top margin is ignored:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/new.png"><figcaption>Bugdoc: new Writer render</figcaption></figure></a></p>
<p>Finally, the reference render result, showing the ignored top paragraph margin:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/ref.png"><figure><img src="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/ref.png"><figcaption>Bugdoc: reference render</figcaption></figure></a></p>
<p>As you can see, now the unwanted top paragraph margin is omitted at page top.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/abd90828cf101581a07b9d1c371a8c3156521e9f">tdf#160952 sw: ignore top margin of para on non-first pages with newer DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ae7900dd42a65aaf60df6b21b9ad511496b209d9">tdf#164095 sw: fix missing top margin on paragraph after changing page style</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).</p>
  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/author/miklos-vajna2.html" class="button_accent">&larr; Older Posts</a>

</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>