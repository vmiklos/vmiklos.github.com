<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />


  <title>
    What is Miklos hacking
&ndash; Posts by: Miklos Vajna  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
&gt; Author: Miklos Vajna
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sd-undo-fixes.html">Recent undo/redo fixes in LibreOffice Impress</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 18 May 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I&#8217;ve recently spent some time fixing a few bugs around undo/redo in Impress,
in the area of table shapes. I&#8217;m mentioning these here as they&#8217;re all bugfixes, so
they are backported to LibreOffice 5.1, and no major release notes will point
them out. So if you are using Impress table shapes and you consider their
usability suboptimal, then read on, I have some great news. :-)</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-4K07Iu7su4M/Vzs8dQCfx7I/AAAAAAAAGts/7GCj5T3Zs9UMyTaR277tHvlOHSk-9HGmACCo/s0/">
<img src="https://lh3.googleusercontent.com/-4K07Iu7su4M/Vzs8dQCfx7I/AAAAAAAAGts/7GCj5T3Zs9UMyTaR277tHvlOHSk-9HGmACCo/s800/" alt="https://lh3.googleusercontent.com/-4K07Iu7su4M/Vzs8dQCfx7I/AAAAAAAAGts/7GCj5T3Zs9UMyTaR277tHvlOHSk-9HGmACCo/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>The first problem is
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=99396">tdf#99396</a>, where
there were actually two problems:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Vertical alignment is a cell property, but when setting that property, the undo code was simply <a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=6819992113947e7a6272bf750fee712c2df41905">missing</a>.
</p>
</li>
<li>
<p>
When editing cell text (the user is inside "text edit") the undo stack is in
a special mode&#8201;&#8212;&#8201;and ending text edit made the cell property undo items go
away. This wasn&#8217;t a problem for vertical alignment only, it was a problem for
example when the background color of the cell was changed, too. These cell
property changes are now
<a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=100eb15b4d8529d7a11d98a28742f31f0f792fa1">added</a>
to the undo stack after finishing text edit, so you can still undo them later.
</p>
</li>
</ol></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-aCZDFOS8xR4/Vzs8bzEjtvI/AAAAAAAAGtw/ZESadiryhEAwAsLoxwztIRNvSjdwOEmDgCCo/s0/">
<img src="https://lh3.googleusercontent.com/-aCZDFOS8xR4/Vzs8bzEjtvI/AAAAAAAAGtw/ZESadiryhEAwAsLoxwztIRNvSjdwOEmDgCCo/s600/" alt="https://lh3.googleusercontent.com/-aCZDFOS8xR4/Vzs8bzEjtvI/AAAAAAAAGtw/ZESadiryhEAwAsLoxwztIRNvSjdwOEmDgCCo/s600/" />
</a>
</div>
</div>
<div class="paragraph"><p>The second bugreport is
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=99452">tdf#99452</a> where
resizing a table shape row separator and then undoing the resize didn&#8217;t
restore the original state. See the
<a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=cafc53f8b4c08443524b1da6f4918d49afd45bb5">commit</a>
for all the details, but the bottom line is: it isn&#8217;t a good idea to
automatically re-layout the table when we&#8217;ve already resized the shape as part
of undo, but the table rows were not yet resized to reflect their original
sizes.</p></div>
<div class="paragraph"><p>As usual, you can try this right now with a 5.2
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-) (Or even
with an 5.1 one, actually.)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/classification-toolbar.html">Classification toolbar in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 02 May 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>In the past few posts in this blog I wrote about various digital
signing-related improvements that will land in LibreOffice 5.2. In this post I
would like to cover an other aspect of helping secure document handling:
classification.  First, thanks to the Dutch Ministry of Defense who made this
work possible (as part of a project implementing trusted signing and
communication in LibreOffice) in cooperation with
<a href="http://nouenoff.nl/">Nou&amp;Off</a>. The basic idea is that in case the user is
required to follow a policy when editing a document, then LO can help the user
respect these rules in case LO is informed about the rules.</p></div>
<div class="paragraph"><p>Luckily <a href="https://www.tscp.org/">TSCP</a> produced a number of open standards around
this, which LO can implement without going after a specific vendor. For the
scope of this post, two of them are interesting:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://www.tscp.org/wp-content/uploads/2013/08/TSCP_BAFv1.pdf">Business
  Authentication Framework</a> (BAF) specifies how you can describe your existing
  policy (which is probably some legal text) in a machine-readable format.
</p>
</li>
<li>
<p>
<a href="http://www.tscp.org/wp-content/uploads/2013/08/TSCP_BAILSv1.pdf">Business
  Authorization Identification and Labeling Scheme</a> (BAILS) specifies how to
  refer to such a BAF policy in a document. The concepts in BAILS are so
  generic that they can be applied to any format that supports document-level
  user-defined properties.
</p>
</li>
</ul></div>
<div class="paragraph"><p>So how does this look like? View &#8594; Toolbars &#8594; Classification can enable a
toolbar that&#8217;s disabled by default:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-Xax-DgF5OXU/VyMiHHa2MhI/AAAAAAAAGsk/4FhSfBAnSMAt_qUSrTq_C_1Mh68T5GhAACCo/s0/">
<img src="https://lh3.googleusercontent.com/-Xax-DgF5OXU/VyMiHHa2MhI/AAAAAAAAGsk/4FhSfBAnSMAt_qUSrTq_C_1Mh68T5GhAACCo/s400/" alt="https://lh3.googleusercontent.com/-Xax-DgF5OXU/VyMiHHa2MhI/AAAAAAAAGsk/4FhSfBAnSMAt_qUSrTq_C_1Mh68T5GhAACCo/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>It has a list box that contains the categories described by the BAF policy. LO
comes with such an example policy by default, that&#8217;s why you can see
categories there already. If you want to use your own policy, you can do so:
Tools &#8594; Options &#8594; LibreOffice &#8594; Paths has a Classification row to configure
a custom policy:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-F-zzCoVt-Gc/VyMiN6C_BKI/AAAAAAAAGsY/K3XkZDDSX1c5_X266H3hC4KqkA5twGmrgCCo/s0/">
<img src="https://lh3.googleusercontent.com/-F-zzCoVt-Gc/VyMiN6C_BKI/AAAAAAAAGsY/K3XkZDDSX1c5_X266H3hC4KqkA5twGmrgCCo/s400/" alt="https://lh3.googleusercontent.com/-F-zzCoVt-Gc/VyMiN6C_BKI/AAAAAAAAGsY/K3XkZDDSX1c5_X266H3hC4KqkA5twGmrgCCo/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>And if you select the <em>Internal Only</em> category, you&#8217;ll see most of the
features described by a category: it can add an info-bar (UI only),
header/footer fields and a watermark (stored in the document) as well:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-4iEF3y78npI/VyMiTCCMALI/AAAAAAAAGso/IrzORuYa-7IjGwjs9HXYQr3_rLcope0PwCCo/s0/">
<img src="https://lh3.googleusercontent.com/-4iEF3y78npI/VyMiTCCMALI/AAAAAAAAGso/IrzORuYa-7IjGwjs9HXYQr3_rLcope0PwCCo/s400/" alt="https://lh3.googleusercontent.com/-4iEF3y78npI/VyMiTCCMALI/AAAAAAAAGso/IrzORuYa-7IjGwjs9HXYQr3_rLcope0PwCCo/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>I would like to point out that the watermark is a proper scalable customshape,
not a poor bitmap. :-) Perhaps this part could be extracted to a separate <em>Add
Watermark</em> feature later, as I think it&#8217;s quite useful on its own as well.</p></div>
<div class="paragraph"><p>Finally, one feature is that LO knows how secure the document is once it has a
classification category, which means a classification scale and level. For two
documents that have the same scale, LO can detect if the user would accidentally
try to leak sensitive content from a document with higher classification level
to a document that has a lower one. This is implemented when copy&amp;pasting:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-ZRYwwOW0dQ4/VyMiXiqx2cI/AAAAAAAAGso/J6dH-q2nZPESOY3SiMQoCSLDUYfHi9WbACCo/s0/">
<img src="https://lh3.googleusercontent.com/-ZRYwwOW0dQ4/VyMiXiqx2cI/AAAAAAAAGso/J6dH-q2nZPESOY3SiMQoCSLDUYfHi9WbACCo/s400/" alt="https://lh3.googleusercontent.com/-ZRYwwOW0dQ4/VyMiXiqx2cI/AAAAAAAAGso/J6dH-q2nZPESOY3SiMQoCSLDUYfHi9WbACCo/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>Most of these features work in all Writer, Calc and Impress. The header/footer
fields and the watermark are Writer-only, and also Calc/Impress does
classification checks only in its internal copy&amp;paste code (e.g. not when
doing paste special and choosing RTF).</p></div>
<div class="paragraph"><p>Putting all of these together, LO can now help users required to follow
classification rules in a number of different ways, as long as the rules they
have to follow are available as a BAF XML policy. As usual, you can try this
right now with a 5.2 <a href="http://dev-builds.libreoffice.org/daily/master/">daily
build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/ooxml-signature-export.html">OOXML signature export in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 14 April 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 4 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-E5cCfFV5kkk/VwzwIcJ0JqI/AAAAAAAAGqk/4JpTSRlvUok6txiXgp1MgoNoNgPb0ov8gCCo/s0-Ic42/">
<img src="https://lh3.googleusercontent.com/-E5cCfFV5kkk/VwzwIcJ0JqI/AAAAAAAAGqk/4JpTSRlvUok6txiXgp1MgoNoNgPb0ov8gCCo/s600-Ic42/" alt="https://lh3.googleusercontent.com/-E5cCfFV5kkk/VwzwIcJ0JqI/AAAAAAAAGqk/4JpTSRlvUok6txiXgp1MgoNoNgPb0ov8gCCo/s600-Ic42/" />
</a>
</div>
</div>
<div class="paragraph"><p>After adding <a href="https://vmiklos.hu/blog/ooxml-signature-import.html">support
for reading OOXML signatures in LibreOffice</a>, I continued with implementing OOXML
signature export (as in: not only verification, but signing).</p></div>
<div class="paragraph"><p>By verification, I mean that I count the signature of the input document, then
compare it with an existing signature, and if they match, it is verified. This
can be also called "import", as I only read an existing signature, I don&#8217;t
create one.  By signing, I mean the creation of a new signature, which is
always good&#8201;&#8212;&#8201;if it isn&#8217;t, that&#8217;s a programming error. This can be also
called "export", as I write the new signature into the document.</p></div>
<div class="paragraph"><p>First, thanks to the Dutch Ministry of Defense who made this work possible (as
part of a project implementing trusted signing and communication in
LibreOffice), this included:</p></div>
<div class="ulist"><ul>
<li>
<p>
signing a previously unsigned document
</p>
</li>
<li>
<p>
appending a signature to an already signed document
</p>
</li>
<li>
<p>
removing a signature from a document with multiple signatures
</p>
</li>
<li>
<p>
removing the last signature of a signed document, turning it into an
  unsigned one
</p>
</li>
</ul></div>
<div class="paragraph"><p>Obviously the hardest part was the initial success: signing a previously
unsigned document, in a way that is accepted by both LibreOffice and MSO. One
trick here is that while in ODF the signature stream is simply added to an
existing document storage, in OOXML the storage has to refer to the signature
sub-storage (it&#8217;s not a stream, as it has a stream for each individual
signature), then it has to be signed, and finally the signature can be added
to the document storage. So instead of reading the document, then appending
the signature, here we need to modify the document, and then we can append the
signature.  By referring the signature sub-storage, I mean it is necessary to
modify <code>[Content_Types].xml</code> (so it contains a mime type for both the <code>.sigs</code>
extension, and also for the individual <code>/_xmlsignatures/sigN.xml</code> streams) and
also the <code>_rels/.rels</code> stream has to refer <code>_xmlsignatures/origin.sigs</code>, which
will contain the list of actual signatures.  A surprising detail is that the
signature is required to contain quite some software and hardware details
about your environment, like monitor resolution, Windows version and so on.
For a cross-platform project like LibreOffice this isn&#8217;t meaningful, not to
mention we have no interest in leaking such information. So what I did instead
is writing hardcoded values based on what my test environment would produce,
just to please MSO. ;-)</p></div>
<div class="paragraph"><p>After the initial
<a href="https://cgit.freedesktop.org/libreoffice/core/tree/xmlsecurity/source/helper/ooxmlsecexporter.cxx">OOXML
signature exporter</a> was ready, the next challenge was adding multiple
signatures. The problem here is that you have to roundtrip the existing
signatures perfectly. And when I write perfectly, I really mean it: if a
single character is written differently, then the hash of the signature will
be different, so the roundtrip (when we write back an existing and a new
signature to the document) will invalidate the signature. And there is no way
around that: the very point of the signature is that only the original signer
can re-calculate the signature hash. :-) So what we do is simply threating the
existing signatures as a byte array, and when writing back, then we don&#8217;t try
to re-construct the signature stream based on the xmlsecurity data model, but
simply write back the byte array. This way it&#8217;s enough to extract parts of the
signature which are presented to the user (date, certificate, comment), and we
don&#8217;t need to parse the rest.</p></div>
<div class="paragraph"><p>Removing one of multiple existing signatures isn&#8217;t particularly hard, you just
need to update <code>_xmlsignatures/_rels/origin.sigs.rels</code> and
<code>[Content_Types].xml</code> which refer each and every signature stream. It&#8217;s a good
idea to truncate them before writing, otherwise you may get a not even
well-formed XML as a result.</p></div>
<div class="paragraph"><p>Finally removing the last signature is a matter of undoing all changes we did
while adding the first signature (the content type list and the toplevel
relation list), finally removing the signature sub-storage all-together. I
also factored out all this signature management code from
<code>DigitalSignaturesDialog</code> (which is a graphical dialog) to
<code>DocumentSignatureManager</code>, so that all the above mentioned features can be
<a href="https://cgit.freedesktop.org/libreoffice/core/tree/xmlsecurity/qa/unit/signing/signing.cxx">unit-tested</a>.</p></div>
<div class="paragraph"><p>Putting all of these together, LO can now do all signature add, append, remove
and clean operations a user would expect from what is referred as simply
<em>OOXML signature support</em>. As usual, you can try this right now with a 5.2
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/ooxml-signature-import.html">OOXML signature import in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 31 March 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div style="text-align: center; font-size: 0.6em;">
<img src="https://lh3.googleusercontent.com/-8fwMz2Ie0ys/Vvpxvf94SrI/AAAAAAAAGlQ/vVaTBn_vEvY7Y3Fn2rcLYPERx3raDX_UwCCo/s400-Ic42/"/>
<p>(via <a href="http://www.ascertia.com/">ascertia</a>)</p>
</div>
<div class="paragraph"><p>After adding <a href="https://vmiklos.hu/blog/libreoffice-sha256-signatures.html">support
for SHA-256 hashes in LibreOffice</a>, I turned towards implementing OOXML
signature import (as in: verification, not signing) in LibreOffice. First,
thanks to the Dutch Ministry of Defense who made this work possible (as part
of a project implementing trusted signing and communication in LibreOffice), I
collected a list of building blocks needed for this to work:</p></div>
<div class="ulist"><ul>
<li>
<p>
support for the Relationships Transform Algorithm (described in ISO/IEC
  29500-2:2012) in xmlsec
</p>
</li>
<li>
<p>
an actual XML parser for the OOXML signature in <code>xmlsecurity/</code>
</p>
</li>
<li>
<p>
a new filter flag, so that our code no longer assumes "is ODF" means
  "supports digital signing" and
</p>
</li>
<li>
<p>
some refactoring in <code>xmlsecurity/</code>, so that our digital signature code doesn&#8217;t
  assume that multiple signatures are always written to a single file
</p>
</li>
</ul></div>
<div class="paragraph"><p>The xmlsec bits are now
<a href="https://github.com/lsh123/xmlsec/commit/7069e2b0ab49679008abedd6d223fb95538b0684.patch">upstream</a>,
it seems to me that new algorithm is needed, so that MSO can avoid signing a
number of streams (files in ZIP containers), while still being able to verify
that all normal streams are signed. Given that MSO by default doesn&#8217;t sign all
streams (so that e.g. the metadata of the document can be modified without
invalidating signatures), this is in use even for a hello-world document. This
implies that a typical OOXML signature will never gain the best "signed"
category in LO, as we&#8217;ll always warn that even though the signature is valid,
not all streams are signed. This is a bit of a rant, but better not hide the
reality: a default ODF signature covers more than a default OOXML signature.</p></div>
<div class="paragraph"><p>The
<a href="https://cgit.freedesktop.org/libreoffice/core/tree/xmlsecurity/source/helper/ooxmlsecparser.cxx">OOXML
signature parser</a> had to extract all information from the signature markup
that&#8217;s interesting for LibreOffice, like the certificate, the signature date
or the signature description. I considered extending the ODF signature parser
instead of implementing a new one for OOXML, since both markups are based on
the same W3C signing spec, but they are different enough that the added
complexity doesn&#8217;t outweigh the benefit of code sharing here.</p></div>
<div class="paragraph"><p>The next step was to add a new <code>SUPPORTSSIGNING</code> filter flag in <code>filter/</code>, and
mark the DOCX, XLSX and PPTX file filters as such, and then of course find
places mostly in <code>sfx2/</code> and <code>xmlsecurity/</code> that assume only ODF files can be
signed, and modifying those checks to also handle this new flag.</p></div>
<div class="paragraph"><p>Finally, a difference between ODF and OOXML signatures is that ODF puts all of
them in a single stream, and all the signing and verifying code works with
that stream. However, in case of OOXML, all signatures are in separate
streams, so if we want to work with a single object as kind of a signature
context, we need a storage (a sub-directory inside the ZIP container), and
work with that.</p></div>
<div class="paragraph"><p>Putting all of these together, we now have unit tests that take test documents
having "good" and "bad" signatures, and the verification result in LO will
match with the one of MSO. As usual, you can try this right now with a 5.2
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/libreoffice-sha256-signatures.html">SHA-256 hashes for ODF signatures in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 23 March 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>As it happened with MD5 hashes in the past, the world is currently moving from
SHA1 hashes to SHA-256 hashes these days. This affects LibreOffice&#8217;s ODF
signing feature as well, where we previously wrote and read SHA-1 hashes, but
not SHA-256 ones. First, thanks to the Dutch Ministry of Defense who made this
work possible (as part of a project implementing trusted signing and
communication in LibreOffice), I could start work on
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=76142">tdf#76142</a> which
attached a reproducer document as well, helping the implementation of this
feature.</p></div>
<div class="paragraph"><p>If you&#8217;re not into the digital signature details, SHA-256 is relevant in two
aspects here:</p></div>
<div class="ulist"><ul>
<li>
<p>
it can be a signature method, denoted by the
  <code>http://www.w3.org/2001/04/xmldsig-more#rsa-sha256</code> URI, and
</p>
</li>
<li>
<p>
it can be a digest method, denoted by the
  <code>http://www.w3.org/2001/04/xmlenc#sha256</code> URI
</p>
</li>
</ul></div>
<div class="paragraph"><p>Hashing is interesting in the context of digital signatures because typically
not the whole document is signed, just a hash of it, and crypto frameworks
like nss or mscrypto typically tie these two together, so you just say you
sign with rsa-sha256, which in more detail means hashing with SHA-256 and then
signing using rsa.</p></div>
<div class="paragraph"><p>A valid signed document using SHA-256 hashing looked like this before:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-c6JR6vywSuY/Vuw4CdYpj8I/AAAAAAAAGjE/hUOW-Ul073QM4SqMN2GM8K0mjGUdGSk5wCCo/s0-Ic42/">
<img src="https://lh3.googleusercontent.com/-c6JR6vywSuY/Vuw4CdYpj8I/AAAAAAAAGjE/hUOW-Ul073QM4SqMN2GM8K0mjGUdGSk5wCCo/s400-Ic42/" alt="https://lh3.googleusercontent.com/-c6JR6vywSuY/Vuw4CdYpj8I/AAAAAAAAGjE/hUOW-Ul073QM4SqMN2GM8K0mjGUdGSk5wCCo/s400-Ic42/" />
</a>
</div>
</div>
<div class="paragraph"><p>I.e. we failed to validate the signature, and presented a dialog that suggested the signature is not valid. After my changes, it looks like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-QLHuSvGkFJQ/Vuw4CQD60ZI/AAAAAAAAGjI/GcmqED9Vqmc7KEw1BpDVNg_uxyrJp693gCCo/s0-Ic42/">
<img src="https://lh3.googleusercontent.com/-QLHuSvGkFJQ/Vuw4CQD60ZI/AAAAAAAAGjI/GcmqED9Vqmc7KEw1BpDVNg_uxyrJp693gCCo/s400-Ic42/" alt="https://lh3.googleusercontent.com/-QLHuSvGkFJQ/Vuw4CQD60ZI/AAAAAAAAGjI/GcmqED9Vqmc7KEw1BpDVNg_uxyrJp693gCCo/s400-Ic42/" />
</a>
</div>
</div>
<div class="paragraph"><p>I.e. no error on loading, and the status bar icon tells the user that
everything is fine, except that we can&#8217;t validate the certificate used for
signing.</p></div>
<div class="paragraph"><p>As for when should LibreOffice start <strong>writing</strong> (not reading) SHA-256 hashes
when creating signatures, it&#8217;s an open question. Probably best to wait till
most users already have a version that can read those hashes. Then we would
still keep support for reading SHA-1 hashes, but we would use SHA-256 when
creating new signatures.</p></div>
<div class="paragraph"><p>Another detail is that the hard work of signing in LibreOffice is done by
using <a href="https://www.aleksey.com/xmlsec/">libxmlsec</a>. We bundled a heavily patched
version from 2009, and it wasn&#8217;t clear how much work it is to port our patches
to a newer upstream version, so I&#8217;ve initially backported the SHA-256 patches
to our older version (for the nss and mscrypto backends of libxmlsec, as that
covers what LibreOffice uses on Linux, Windows and OS X). At the end I managed
to update our bundled libxmlsec to a newer (even if not the newest yet)
version, so latest master got rid of those custom backports.  As usual, you
can try this right now with a 5.2
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/libreoffice-signature-descriptions.html">Signature descriptions in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 16 March 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>LibreOffice&#8217;s user interface prohibited creating multiple signatures by the
same author on a document, because there was no semantic meaning of signing
the same document multiple times. I&#8217;ve recently extended the user interface to
be able to provide a signature description: this way it makes sense to allow
multiple signatures from the same author, because now each signature can have
a different meaning. First, thanks to the Dutch Ministry of Defense who
made this work possible.</p></div>
<div class="paragraph"><p>When the user selects File &#8594; Digital Signatures, the dialog lists existing
signatures together with their description (if they have any):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-DqvpQOrLq6c/VuGAEfC56AI/AAAAAAAAGhg/CnFGm5z5Uoo/s0-Ic42/">
<img src="https://lh3.googleusercontent.com/-DqvpQOrLq6c/VuGAEfC56AI/AAAAAAAAGhg/CnFGm5z5Uoo/s600-Ic42/" alt="https://lh3.googleusercontent.com/-DqvpQOrLq6c/VuGAEfC56AI/AAAAAAAAGhg/CnFGm5z5Uoo/s600-Ic42/" />
</a>
</div>
</div>
<div class="paragraph"><p>When the user clicks on the Sign Document button, the dialog for certificate
selection now also asks for an optional description:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-OoA7rDynpzo/VuGAFuHpskI/AAAAAAAAGhg/aEqUEOVtcEo/s0-Ic42/">
<img src="https://lh3.googleusercontent.com/-OoA7rDynpzo/VuGAFuHpskI/AAAAAAAAGhg/aEqUEOVtcEo/s600-Ic42/" alt="https://lh3.googleusercontent.com/-OoA7rDynpzo/VuGAFuHpskI/AAAAAAAAGhg/aEqUEOVtcEo/s600-Ic42/" />
</a>
</div>
</div>
<div class="paragraph"><p>Changing the value of the description invalidates the signature. For this
feature to work, I have extended LibreOffice&#8217;s ODF signature markup to store
not only a <code>&lt;dc:date&gt;</code> element as signature metadata, but also the
<code>&lt;dc:description&gt;</code>. Given that the metadata of an ODF signature is not part of
the ODF specification, it is allowed to extend the metadata with custom child
elements, so it was not necessary to submit an ODF enhancement proposal for
this file format change at this stage.  As usual the commits are in master, so
you can try this right now with a 5.2
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-linked-graphic-import.html">Import of DOCX and RTF linked graphic into LibreOffice Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 25 February 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-ov8ANPdqriE/Vs3em0UknHI/AAAAAAAAGc8/7mHejdWPLlg/s900-Ic42/">
<img src="https://lh3.googleusercontent.com/-ov8ANPdqriE/Vs3em0UknHI/AAAAAAAAGc8/7mHejdWPLlg/s900-Ic42/" alt="https://lh3.googleusercontent.com/-ov8ANPdqriE/Vs3em0UknHI/AAAAAAAAGc8/7mHejdWPLlg/s900-Ic42/" />
</a>
</div>
</div>
<div class="paragraph"><p>As it has been
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=59699">reported</a>, the RTF
<code>includepicture</code> field was ignored on import. As writerfilter has quite some
shared code for DOCX and RTF import, I also looked at the state of linked
graphics in the DOCX import, and that wasn&#8217;t better, either.</p></div>
<div class="paragraph"><p>Although, the root causes were different. ;-) Regarding DOCX, a linked and a
non-linked graphic has quite similar drawingML markup: the only difference is
if the graphic has a relationship alias (embedded case) or a (possibly
relative) external URL. Relative external URLs were broken, as the
writerfilter &#8594; oox call (to import the graphic) did not forward the base URL,
so oox had no chance to properly resolve a relative URL.</p></div>
<div class="paragraph"><p>Regarding RTF, a linked graphic is represented as an <code>includepicture</code> field, and
now the RTF tokenizer resolves that to a real graphic. As you can see on the
above screenshot series (new Writer behavior, old Writer, and reference), we
now behave the same way as the reference (or the Writer DOC import).</p></div>
<div class="paragraph"><p>A related interesting fact I noticed is that <code>includepicture</code> fields in OOXML
are valid, but it seems Word never writes them: either their expanded field
result is outdated (e.g. it&#8217;s some text), or if the user updates the field,
then their implementation instantly replaces the field with a drawingML markup
that links the graphic.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/fosdem2016.html">Mail merge embedding in LibreOffice Writer FOSDEM talk</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Sun 31 January 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/30e7f96db4a8430cbe7938245b545880/mm-fosdem-brussels-2k16.pdf">
<img src="https://lh3.googleusercontent.com/-tY-2qENlPkA/Vq3iZ4wlO9I/AAAAAAAAGbY/o7lbUDAUoHo/s800-Ic42/" alt="https://lh3.googleusercontent.com/-tY-2qENlPkA/Vq3iZ4wlO9I/AAAAAAAAGbY/o7lbUDAUoHo/s800-Ic42/" />
</a>
</div>
</div>
<div class="paragraph"><p>Yesterday I gave a
<a href="https://fosdem.org/2016/schedule/event/libreoffice_mail_merging/">Mail merge
embedding in LibreOffice Writer</a> talk at FOSDEM 2016, in the
<a href="https://fosdem.org/2016/schedule/track/open_document_editors/">Open document
editors developer room</a>. The room was well-crowded&#8201;&#8212;&#8201;seems this year LibreOffice
Online was a hot topic. ;-)</p></div>
<div class="paragraph"><p>We also had a
<a href="https://wiki.documentfoundation.org/Hackfest/FOSDEM2016">hackfest</a> with about
20 hackers attending, (again) kindly hosted by
<a href="http://www.betacowork.com/">Betacowork</a> on Thursday and Friday, before FOSDEM.</p></div>
<div class="paragraph"><p>There were a few topics I hacked on:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=552361aaad740e55fcfa7993b4111aba354f863f">.uno:Paste
  AnchorType param</a> for Writer
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=97371">tdf#97371</a> DOCX import regression fix about TextBoxes
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=96175">tdf#96175</a> RTF export feature about <em>company</em> doc property
</p>
</li>
<li>
<p>
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=363aa5dbb2c223b6cc3a109bd654f39772e310fa">refactoring</a>
  around Writer&#8217;s new (in 5.1) hide-whitespace feature, as requested by Ashod
</p>
</li>
<li>
<p>
code coverage: <code>RtfExport::WriteRevTab()</code> was completely untested
  previously, now
  <a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=8ff66c71bb4da8d0e4454e250e480eada9fe226c">fixed</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>A full list of achievements is
<a href="https://wiki.documentfoundation.org/Hackfest/FOSDEM2016#Achievements">available</a>, if
you were at the hackfest and you did not contribute to that section, please
write a line about what did you hack on. :-)</p></div>
<div class="paragraph"><p>Quite some other slides are now available on
<a href="http://planet.documentfoundation.org/">Planet</a>, don&#8217;t miss them.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/rtf-page-background-export.html">RTF page background export in LibreOffice Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 12 January 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>While I added support for page background colors in the RTF import
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=14e163b0caf97addf340aefc5760a9031ec98390">back
in 2013</a>, the export part was missing up to now.</p></div>
<div class="paragraph"><p>If you set a solid color fill for a page style, and you export it to RTF, here
is how the reference rendering output looks like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-JI384fzDsng/VpEkSeMEgfI/AAAAAAAAGYY/GXhT1tzi4WQ/s900-Ic42/reference.png">
<img src="https://lh3.googleusercontent.com/-JI384fzDsng/VpEkSeMEgfI/AAAAAAAAGYY/GXhT1tzi4WQ/s900-Ic42/reference.png" alt="https://lh3.googleusercontent.com/-JI384fzDsng/VpEkSeMEgfI/AAAAAAAAGYY/GXhT1tzi4WQ/s900-Ic42/reference.png" />
</a>
</div>
</div>
<div class="paragraph"><p>However, in Libreoffice only the background of the paragraph reflected the
color set by the user:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-YZDNx5H0qYQ/VpEkSWxf2II/AAAAAAAAGYU/o4Q06VeBK-I/s900-Ic42/bad.png">
<img src="https://lh3.googleusercontent.com/-YZDNx5H0qYQ/VpEkSWxf2II/AAAAAAAAGYU/o4Q06VeBK-I/s900-Ic42/bad.png" alt="https://lh3.googleusercontent.com/-YZDNx5H0qYQ/VpEkSWxf2II/AAAAAAAAGYU/o4Q06VeBK-I/s900-Ic42/bad.png" />
</a>
</div>
</div>
<div class="paragraph"><p>After implementing this feature in the RTF export filter, it now looks much
closer to the reference:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/--6VbXTzbA_k/VpEkSWJB7tI/AAAAAAAAGYc/D7KEn0lLvXw/s900-Ic42/good.png">
<img src="https://lh3.googleusercontent.com/--6VbXTzbA_k/VpEkSWJB7tI/AAAAAAAAGYc/D7KEn0lLvXw/s900-Ic42/good.png" alt="https://lh3.googleusercontent.com/--6VbXTzbA_k/VpEkSWJB7tI/AAAAAAAAGYc/D7KEn0lLvXw/s900-Ic42/good.png" />
</a>
</div>
</div>
<div class="paragraph"><p>At the moment only solid fill is implemented, so other advanced fill types
like graphics or gradients are still missing.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/rtf-rich-comment-export.html">Rich RTF comment export in LibreOffice Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 11 December 2015</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-cPX4gcKiTxI/VmnrtwdnTXI/AAAAAAAAGTE/cYj_XZONoRg/s0-Ic42/">
<img src="https://lh3.googleusercontent.com/-cPX4gcKiTxI/VmnrtwdnTXI/AAAAAAAAGTE/cYj_XZONoRg/s400-Ic42/" alt="https://lh3.googleusercontent.com/-cPX4gcKiTxI/VmnrtwdnTXI/AAAAAAAAGTE/cYj_XZONoRg/s400-Ic42/" />
</a>
</div>
</div>
<div class="paragraph"><p>As it has been reported in
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=94377">tdf#94377</a>, the
state of Writer comment contents in the RTF export filter wasn&#8217;t great.</p></div>
<div class="paragraph"><p>With two recent changes, however, the situation is now much better:</p></div>
<div class="ulist"><ul>
<li>
<p>
I&#8217;ve added support for multiple paragraphs
</p>
</li>
<li>
<p>
I&#8217;ve added support for both paragraph and text portion formatting
</p>
</li>
</ul></div>
<div class="paragraph"><p>It wasn&#8217;t necessary to implement this from scratch, because comment contents
uses the same editeng store as the shape text, and there formatting was already
handled. A benefit of this code sharing is that shape text also handles
multiple paragraphs without a problem now. :-)</p></div>
<div class="paragraph"><p>The commits are backported to <code>libreoffice-5-1</code>, so users will see them
already in the upcoming 5.1.0 release.</p></div>
</div>
</div>

  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/author/miklos-vajna11.html" class="button_accent">&larr; Older Posts</a>

<a href="https://vmiklos.hu/blog/author/miklos-vajna9.html" class="button_accent">Newer Posts &rarr;</a>
</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>