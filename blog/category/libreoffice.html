<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />

<link href="https://vmiklos.hu/blog/feeds/libreoffice.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking libreoffice Category RSS" />

  <title>
    What is Miklos hacking
&ndash; Category: libreoffice  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
&gt; Category: libreoffice
&brvbar; <a href="https://vmiklos.hu/blog/feeds/libreoffice.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-interdependent-redline-improvements2.html">Interdependent tracked changes improvements in Writer, part 2</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 08 July 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has some support for interdependent (or hierarchical) tracked changes: e.g. the case when you
have a delete on top of an insert. See the <a href="https://vmiklos.hu/blog/sw-interdependent-redline-improvements.html">first
post</a> for background.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>With the already mentioned improvements in place, a few areas were still lacking: we didn't have UI
for all cases where the DOCX import was possible already; combining tracked changes (redlines) were
not complete (so you don't have to reject all parts of a logical redline one by one) and some of the
undo/redo code didn't work as expected.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is a sample case where the UI was missing to create something that was possible to import from
DOCX: a format redline on top of an insert redline.</p>
<p>If you had a document with an insert:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/1-baseline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/1-baseline.png"><figcaption>Interdependent tracked change: just insert</figcaption></figure></a></p>
<p>And you selected BBB to mark those characters as bold, we just updated the existing insert redline
to be bold:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/2-edit-old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/2-edit-old.png"><figcaption>Interdependent tracked change: old, format is not tracked separately</figcaption></figure></a></p>
<p>But now we track a format change on top of the insert separately:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/3-edit-new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/3-edit-new.png"><figcaption>Interdependent tracked change: new, format is tracked separately</figcaption></figure></a></p>
<p>This is also visible if you open the track changes dialog, which explains that now you have part of
the insert redline covered by a format redline:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/4-dialog.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements2/4-dialog.png"><figcaption>Interdependent tracked change: UI dialog now showing multiple redlines </figcaption></figure></a></p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/cc2babfa0a960c7d52ea7997aea19dcf10c12d08">sw interdependent redlines: fix nPamEndtNI -&gt; nPamEndNI typo</a></li>
<li><a href="https://git.libreoffice.org/core/commit/82b24dd9748c6c0a2990e70bda0960ae26415390">tdf#166319 sw interdependent redlines: combine on reject of del-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/612ba7b2bc5d1d12c10287094263f6d31983a3d8">tdf#166319 sw interdependent redlines: fix undo of reject of ins-then-del's del</a></li>
<li><a href="https://git.libreoffice.org/core/commit/eef0dfed817e40cd83e8ba8e290f45c224257f97">tdf#166319 sw interdependent redlines: add UI to create format inside insert</a></li>
<li><a href="https://git.libreoffice.org/core/commit/0566e8e1776921ecb26f0ddd0546ec10afeed8e0">tdf#166319 sw interdependent redlines: undo of creating an ins-then-fmt redline</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e06eb6b4a6176692d25c758121012473fe638043">tdf#166319 sw interdependent redlines: redo of creating an ins-then-fmt redline</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5ed41ca44bee5122a9db4aa946f6e3ecd9432574">tdf#166319 sw interdependent redlines: fix redo of reject of del-then-fmt's del</a></li>
<li><a href="https://git.libreoffice.org/core/commit/76c2168a276f0996deeac08ce176525821fb056e">tdf#166319 sw interdependent redlines: fix bad accept undo action for reject</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-interdependent-redline-improvements.html">Interdependent tracked changes improvements in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 02 June 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 4 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has some support for interdependent (or hierarchical) tracked changes: e.g. the case when you
have a delete on top of an insert. While there were some working cases, handling of many
combinations were missing. I started to make systematic improvements in this area in the recent
past, this post gives you an overview what's done so far.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>DOCX files in Word can often have overlapping tracked changes: Writer tries to split these up to
make sure there is only one tracked change under the cursor at the same time. Still, it's possible
that you have a tracked change with multiple types: e.g. a delete on top of an insert.</p>
<p>The focus in on 3 combinations which appear in DOCX files a lot: "insert, then delete", "insert,
then format" and "delete, then format".</p>
<p>This mostly affects the UI and import/export filters of ODT and DOCX.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Given an insert, then delete:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/ins-then-del.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/ins-then-del.png"><figcaption>Interdependent tracked change: insert, then delete</figcaption></figure></a></p>
<p>Most operations worked nicely here, but in case your cursor was in the middle of AAA and you did a
reject, followed by an undo, proper handling of that was missing, now implemented.</p>
<p>But then given an insert, then a format:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/ins-then-fmt.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/ins-then-fmt.png"><figcaption>Interdependent tracked change: insert, then format</figcaption></figure></a></p>
<p>Then a handling of more actions were missing:</p>
<ol>
<li>DOCX import is now implemented.</li>
<li>ODT import is now implemented.</li>
<li>Accepting when you're inside AAA is now implemented: the insert is accepted for BBB but the
   format stays unchanged.</li>
<li>Rejecting when you're inside AAA is now implemented: the insert is rejected and BBB is also
   removed, together with the format on top of it.</li>
<li>Accepting the BBB now correctly operates on the insert type, so the format type remains after
   accept.</li>
<li>If you accept BBB, now the surrounding AAA and CCC also get accepted as well, as expected.</li>
<li>Now if you reject BBB, then it gets removed from the document, since you rejected an insert.</li>
<li>When you reject BBB, the surrounding AAA and CCC also get rejected.</li>
</ol>
<p>The combined implementation of these should give you a smooth feeling in case you're used to how
Word works: if there is a format redline combined with an insert, then the operations act on the
insert type, and format is only accepted/rejected when there is no insert "under" the format.</p>
<p>Similarly: it's a bit of an implementation detail that Writer splits redlines on DOCX import: so if
you e.g. accept AAA then we combine that with BBB and CCC when it makes sense, so you need to click
a lot less.</p>
<p>Finally, given a delete, then a format:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/del-then-fmt.png"><figure><img src="https://share.vmiklos.hu/blog/sw-interdependent-redline-improvements/del-then-fmt.png"><figcaption>Interdependent tracked change: delete, then format</figcaption></figure></a></p>
<p>Then again handling of some actions were missing:</p>
<ol>
<li>DOCX import is now implemented.</li>
<li>ODT import is now implemented.</li>
<li>ODT export is now implemented.</li>
<li>Accepting AAA now correctly operates on the delete type of BBB.</li>
<li>Rejecting AAA now correctly operates on the delete type of BBB.</li>
<li>Accepting BBB now correctly works with the delete type.</li>
<li>Accepting BBB now correctly tries to also accept AAA and CCC, too.</li>
</ol>
<p>The current state is not yet complete, but it's a big improvement over what we had in the past,
which was mostly focusing on just "insert, then delete".</p>
<p>You may wonder what about some other cases: if you insert some content with change tracking, that
always creates a new tracked change, so "insert" is never on top of something else. Similarly,
format is always on top of something. Finally the same type is never on top of itself.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/096a40b27d07603880bbf120440ac169a87fe115">tdf#166319 sw interdependent redlines: fix undo of del on top of ins</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ca7a6a57ad1e8d7aadffbbf3fe28d9aabed31286">tdf#166319 sw interdependent redlines: handle format on top of insert</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8e85d559a68f980d99af4ded6a91b7f0458048b9">tdf#166319 sw interdependent redlines: handle accept of insert under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3c039cb31239ba01e3d3b56c526bdb7ba6446032">tdf#166319 sw interdependent redlines: handle reject of insert under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/96faaaf83a1c8b897ce675d175b4d8756d0ea0df">tdf#166319 sw interdependent redlines: handle accept of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/97066d4f5a89ad89d81a45c0b20ce404f9712fc7">tdf#166319 sw interdependent redlines: fix DOCX export of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d659f4b12a24e275e38ec5aa7406c32c9fa08c48">tdf#166319 sw interdependent redlines: handle reject of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ff110bb17b7e003bd205438af94badabeca007c6">tdf#166319 sw interdependent redlines: handle ODF import of insert under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1a340196237ed075b337e6a0ac9f8a45132053bb">tdf#166319 sw interdependent redlines: handle ODF export of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/08acfb815745e7f43ca43557feefcb68607d26c1">tdf#166319 sw interdependent redlines: handle ODF import of delete under format</a></li>
<li><a href="https://git.libreoffice.org/core/commit/8cabdef0b34210d026ea7a8229f321e272a49109">tdf#166319 sw interdependent redlines: handle accept of ins-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/2292bda37378d7f782abbda42c026affd3fa59e5">tdf#166319 sw interdependent redlines: combine on accept of ins-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/b6cba0119f8028b426f5eee55be9761971dbfdee">tdf#166319 sw interdependent redlines: handle reject of ins-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/15bd73a093f1f944d504cf555918ca9e60d75c03">tdf#166319 sw interdependent redlines: combine on reject of ins-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/5fedce78c8d79a3e86307523c3d74c7df98668f7">tdf#166319 sw interdependent redlines: handle accept of del-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/98f0b23a48246507ced6de5b54d327d95f1725f9">tdf#166319 sw interdependent redlines: combine on accept of del-then-fmt's fmt</a></li>
<li><a href="https://git.libreoffice.org/core/commit/569eb476bbdf83aab0f377da5cb7d2e8c77192b8">tdf#166319 sw interdependent redlines: handle reject of del-then-fmt's fmt</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-redline-reinstate.html">Reinstate for tracked changes in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 08 May 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has the concept of rejecting tracked changes: if a proposed insertion or deletion is not
wanted, then one can reject it to push back on the proposal. So far such an action left no trace in
the document, which is sometimes not wanted. Calling reinstate on a change behaves like reject, but
with history: it reinstates the original state, with the rejected change preserved in the document.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>When Alice works on a document to insert e.g. new conditions for a contract, then perhaps Bob is not
happy with the proposal. But just rejecting the change "silently" would not be polite: the tracked
change then disappears, so possibly Alice thinks it was accepted and Bob didn't communicate the
pushback explicitly in the resulting document, either.</p>
<p>Reinstate is meant to improve this interaction: if an insert is reinstated, then an explicit delete
is created on top of the insert, so Alice can see that Bob was not happy with the proposal. Or in
case Alice proposed a delete, Bob can reinstate that by adding the same content again to the
document, without typing the text manually after the delete.</p>
<p>This is a UI feature: the resulting model still only contains inserts and deletes, so it works even with
DOCX files.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Given an insert:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-redline-reinstate/insert.png"><figure><img src="https://share.vmiklos.hu/blog/sw-redline-reinstate/insert.png"><figcaption>Reinstate: an insert</figcaption></figure></a></p>
<p>Now you can easily create a delete on top of the insert:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-redline-reinstate/insert-after.png"><figure><img src="https://share.vmiklos.hu/blog/sw-redline-reinstate/insert-after.png"><figcaption>Reinstate: a reinstated insert</figcaption></figure></a></p>
<p>And given a delete:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-redline-reinstate/delete.png"><figure><img src="https://share.vmiklos.hu/blog/sw-redline-reinstate/delete.png"><figcaption>Reinstate: a delete</figcaption></figure></a></p>
<p>Now you can easily create an insert right after the delete, preserving complex content:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-redline-reinstate/delete-after.png"><figure><img src="https://share.vmiklos.hu/blog/sw-redline-reinstate/delete-after.png"><figcaption>Reinstate: a reinstated delete</figcaption></figure></a></p>
<p>As you can see, this creates the opposite of the original change as a new tracked change, so it will
in the end still reject the change, but without deleting the original change.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/7af8b3d3305fe8344cb9339269c5dc3f1cd44650">cool#11357 sw redline reinstate: implement this for a single insert</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1df71464588d4cfcba708cf00ef7b6ac94574c8f">cool#11357 sw redline reinstate: handle inserts in selection</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e312cf46fe840f04b729600db9efe89d5f58d6fe">cool#11357 sw redline reinstate: handle a single delete</a></li>
<li><a href="https://git.libreoffice.org/core/commit/db541619cb1ca83598ec479eb9f52e559a8fe72d">cool#11357 sw redline reinstate: handle a single rich delete</a></li>
<li><a href="https://git.libreoffice.org/core/commit/157c00922959adc8fd2e0203ed94dfd847479c54">cool#11357 sw redline reinstate: handle deletes in selection</a></li>
<li><a href="https://git.libreoffice.org/core/commit/447935fba57f1b0f88c0b56cccf5bf971fb1e819">cool#11357 sw redline reinstate: simplify ReinstateRedlinesInSelection()</a></li>
<li><a href="https://git.libreoffice.org/core/commit/9c2c98ac7668e4a3a2e3a70cc54b632de5f79621">cool#11357 sw redline reinstate: add command state</a></li>
<li><a href="https://git.libreoffice.org/core/commit/1926105b47df7b15dd34a8c1135f83b936bf9926">cool#11357 sw redline reinstate: add a reinstate-and-next command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/4535698e0b16bf003e8a3705e28f7347f509eb12">cool#11357 sw redline reinstate: add a reinstate-all command</a></li>
<li><a href="https://git.libreoffice.org/core/commit/01311bb1e4c2404354cce8934d36991d91d527b2">cool#11357 sw redline reinstate: avoid unwanted multi- or table selection</a></li>
<li><a href="https://git.libreoffice.org/core/commit/fbf9465e2bc9f878723674d1eff13e0c69656057">cool#11357 sw redline reinstate: fix undo string for a single redline</a></li>
<li><a href="https://git.libreoffice.org/core/commit/7d702ebbfcda41ce2972e30b2a1e493c320df67c">cool#11357 sw redline reinstate: fix undo count &amp; string for multiple redlines</a></li>
<li><a href="https://git.libreoffice.org/core/commit/dcd3427149c33852428b4198c22f6f858125c294">cool#11357 sw redline reinstate: add to the context menu for text</a></li>
</ul>
<p>Online side:</p>
<ul>
<li><a href="https://github.com/collaboraonline/online/commit/3d7933974241fe5d015a9d80f2cc8bde1c1d352e">cool#11357 sw redline reinstate: add UI for this</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-per-view-redline-record.html">Per-user track changes recording in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 02 April 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has the concept of recording tracked changes or not: if recording, typing into a document or
deleting content will create tracked changes of type insertion or deletion. So far this was a
per-document setting, but now individual users can enable or disable this as they wish.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>When Alice keeps typing and Bob enables change tracking, then surprisingly the typed characters of
Alice will form a tracked insertion, which is surprising, since that was not the case a second ago
and Alice didn't do anything other than typing.</p>
<p>Giving users a choice if they enable recording for just this user or for all users fixes this
problem.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is how the per-user (technically per-view) tracked changes recording looks like:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-per-view-redline/sw-per-view-redline.png"><figure><img src="https://share.vmiklos.hu/blog/sw-per-view-redline/sw-per-view-redline.png"><figcaption>Per-view tracked changes recording</figcaption></figure></a></p>
<p>As you can see, the user on the left has recording turned on and this doesn't influence the user on
the right, while this was not possible before.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes. Core side:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/ab91358566ccf31f7a9ac57f1c32a9c62840f5d5">cool#11226 sw per-view redline on: support this-view &lt;-&gt; all-views transition</a></li>
<li><a href="https://git.libreoffice.org/core/commit/85fc28a4e55bb8dafd69a19dc5d21a76501446cb">cool#11226 sw per-view redline on: state for the per-view and per-doc commands</a></li>
<li><a href="https://git.libreoffice.org/core/commit/368e2e445c1941d37697cee05a50a34150d18015">cool#11226 sw per-view redline on: allow both per-view and per-doc</a></li>
<li><a href="https://git.libreoffice.org/core/commit/745256f37973d89ea068acd831eba8054a81b93b">Related: cool#11226 sw per-view redline on: fix ratio buttons of is-show</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ae6d396552cd3cebd7fba4942e6ca2fd5de579af">cool#11226 sw per-view redline on: add view-aware getter</a></li>
<li><a href="https://git.libreoffice.org/core/commit/e36643877e5ddf57a34481f1c46f87cf250caf19">cool#11226 sw per-view redline on: move the setter to the model</a></li>
<li><a href="https://git.libreoffice.org/core/commit/025a1e4612fecf59f38910fbf52fc63db054ae5f">cool#11226 sw per-view redline on: add new flag in SwViewOption</a></li>
<li><a href="https://git.libreoffice.org/core/commit/88e12a83aec0ffda82195c8a1e34a255d3cfdfd5">cool#11226 sw layout xml dump: show some more view options</a></li>
</ul>
<p>Online side:</p>
<ul>
<li><a href="https://github.com/collaboraonline/online/commit/c37904149498658c3fd25f043fc5f34be89fb120">cool#11226 sw per-view redline on: add tri-state UI in the notebookbar</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 25.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.8).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-ignore-margin-page-top.html">Ignoring the paragraph margin at the top of pages in Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 08 January 2025</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer has the concept of paragraph margins and page margins, but what happens when you combine the
two? It turns out the expectation is that sometimes the top paragraph margin is ignored in this
case. We'll see two cases where the behavior of Writer is now improved to better match Word in this
regard.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>As described in a <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=160952">previous bugreport</a>,
there was a first problem where Word ignored the top paragraph margin of a document, but Writer did
not. A <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=164095">recent bugreport</a> then pointed
out that the first implementation went too far and now a wanted top margin was ignored. This lead to
a set of conditions which now does a decent emulation of Word's rules in this regard.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is the old Writer render result for a document where the top margin should be ignored:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/old.png"><figcaption>Bugdoc: old Writer render</figcaption></figure></a></p>
<p>And here is the new Writer render result for a document where the top margin is ignored:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/new.png"><figcaption>Bugdoc: new Writer render</figcaption></figure></a></p>
<p>Finally, the reference render result, showing the ignored top paragraph margin:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/ref.png"><figure><img src="https://share.vmiklos.hu/blog/sw-ignore-margin-page-top/ref.png"><figcaption>Bugdoc: reference render</figcaption></figure></a></p>
<p>As you can see, now the unwanted top paragraph margin is omitted at page top.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/abd90828cf101581a07b9d1c371a8c3156521e9f">tdf#160952 sw: ignore top margin of para on non-first pages with newer DOCX</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ae7900dd42a65aaf60df6b21b9ad511496b209d9">tdf#164095 sw: fix missing top margin on paragraph after changing page style</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/editeng-rtf-export-lost-para-style.html">Editeng RTF export: fixing a lost paragraph style</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 04 December 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <p>Impress shape text doesn't have much support for styles, e.g. the default UI in Writer gives you a
paragraph style dropdown, and you don't get the same in Impress. Still, a paragraph style is
attached to bullets based on their outline level, and Impress has a View → Outline menu item to give
you that styled text you can copy. Pasting that to Writer started to lose styles recently and it's
now fixed to work again.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Impress as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>As described in a <a href="https://git.libreoffice.org/core/commit/70d1bd6ee0eba9d6661cd6280566f77a87f2d068">previous
commit</a>, I had a
case where lots of not needed paragraph styles were exported to RTF in case an Impress document had
enough master pages. The idea was to only export actually used paragraph styles, to avoid wasting
CPU power.</p>
<p>Turns out filtering out paragraph styles has to happen at two locations:</p>
<ul>
<li>in the style table to assign an index to a paragraph style</li>
<li>when referring to those styles</li>
</ul>
<p>The problem was that unused styles were removed from the style table, but not from the style → index
mapping, so as soon as you had both used and unused paragraph styles, the declared and the referred
style indexes didn't match anymore.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is a sample paste result in Writer, where you can see that the text doesn't have a custom
paragraph style:</p>
<p><a href="https://share.vmiklos.hu/blog/editeng-rtf-export-lost-para-style/old.png"><figure><img src="https://share.vmiklos.hu/blog/editeng-rtf-export-lost-para-style/old.png"><figcaption>Bugdoc: old Writer paste</figcaption></figure></a></p>
<p>And here is the same paste, now with paragraph styles restored:</p>
<p><a href="https://share.vmiklos.hu/blog/editeng-rtf-export-lost-para-style/new.png"><figure><img src="https://share.vmiklos.hu/blog/editeng-rtf-export-lost-para-style/new.png"><figcaption>Bugdoc: new Writer paste</figcaption></figure></a></p>
<p>As you can see, now the pasted text has paragraph styles.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>The bugfix commit was <a href="https://git.libreoffice.org/core/commit/c8b607b7c0096c58dc5187262bf0133dee728d50">editeng RTF export: fix broken offsets into the para style table</a>.</p>
<p>The tracking bug was <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=163883">tdf#163883</a>.</p>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-textbox-capture.html">Handling page captures for Writer TextBoxes</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 08 November 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer TextBoxes provide the user with shapes that can have complex geometry and complex content.
There is also a feature to capture shapes inside page boundaries: now the two features interact with
each other better.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>As described in a <a href="https://vmiklos.hu/blog/textbox.html">previous post</a>, Writer implements the TextBox
feature with a pair of objects: a Draw shape (with complex geometry) and a (hidden) Writer TextFrame,
providing complex content. To avoid wrapping problems, the underlying TextFrame always has its wrap
type set to "through", i.e. text may wrap around the Draw shape, but the hidden TextFrame is always
ignored during text wrapping.</p>
<p>In most cases this provides the expected behavior, because the user sees one object, so wrapping
around at most one object is not surprising.</p>
<p>However, there is also an other feature, that shapes may be captured inside page frames: if their
position would be outside the page frame, Writer corrects this, so they are not off-page. This also
makes sense, so it can't happen that your document has a shape that is hard to find, due to a silly
position.</p>
<p>The trouble comes when these two are combined: the Draw shape's position gets adjusted to be
captured inside the page frame, but the TextFrame's wrap type is "through", and objects with this
wrap type are an exception from the capturing mechanism, so the position of the two shapes get out
of sync.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The problem is now solved by improving the layout, so in case the TextFrame is actually part of a
Draw shape + TextFrame pair (forming a TextBox), then we calculate the effective wrap type of the
TextFrame based on the wrap type of its Draw shape, so either both objects are captured or none,
which results in consistent render result.</p>
<p>Here is a sample document where all margins are configured to be equal, but capturing corrected the
Draw shape (and not the TextFrame):</p>
<p><a href="https://share.vmiklos.hu/blog/sw-textbox-capture/old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-textbox-capture/old.png"><figcaption>Bugdoc: old Writer render</figcaption></figure></a></p>
<p>And here is the same document, with consistent positioning:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-textbox-capture/new.png"><figure><img src="https://share.vmiklos.hu/blog/sw-textbox-capture/new.png"><figcaption>Bugdoc: new Writer render</figcaption></figure></a></p>
<p>As you can see, now the rendered margins actually equal, as wanted.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>The bugfix commit was <a href="https://git.libreoffice.org/core/commit/c8549fa3204802daec8597ba0f9f4f7ef23d5cd2">sw textbox: capture fly when its draw object is captured</a>.</p>
<p>The tracking bug was <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=138711">tdf#138711</a>.</p>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sd-semi-transparent-text2.html">Per-paragraph semi-transparent shape text in Impress</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 04 October 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <p>The SVG export in Impress now supports a per-paragraph setting to handle semi-transparent shape
text, while previously this was only possible to control at a per-shape level.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
available in desktop Impress as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>As described in a <a href="https://vmiklos.hu/blog/sd-semi-transparent-text.html">previous post</a>, Impress already
had the capability to have semi-transparent shape text, but the SVG export of this for the case when
not all paragraphs have the same setting was broken.</p>
<p>Transparency in SVG can be described as a property of a group (<code>&lt;g style="opacity: 0.5"&gt;...&lt;/g&gt;</code>)
and it can be also a property of the text (<code>&lt;tspan fill-opacity="0.5"&gt;...&lt;/tspan&gt;</code>).</p>
<p>The SVG export works with the metafile of the shape, so when looking for meta actions, it tries to
guess if the transparency will be for text: if so, it needs to use the <code>tspan</code> markup, otherwise
going with the <code>g</code> markup is OK.</p>
<p>What happened here is that meta action for a normal text started, so the SVG export assumed the text
is not semi-transparent, but later the second line was still transparent, so we started a group
element, and this resulted in a not even well-formed XML output.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The relevant part of the test document is simple: just 3 paragraphs, the second one is
semi-transparent (and also has a bullet, as an extra):</p>
<p><a href="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-1input.png"><figure><img src="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-1input.png"><figcaption>Bugdoc: original Impress render</figcaption></figure></a></p>
<p>Once this was exported to SVG, this resulted in a non-well-formed XML, so you got this error in a
web browser:</p>
<p><a href="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-2bad.png"><figure><img src="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-2bad.png"><figcaption>Bugdoc: old SVG render</figcaption></figure></a></p>
<p>Once tweaking the transparency mask writer to check if text started already, we get the correct SVG
render:</p>
<p><a href="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-3good.png"><figure><img src="https://share.vmiklos.hu/blog/sd-semi-transparent-text2/svg-3good.png"><figcaption>Bugdoc: new SVG render</figcaption></figure></a></p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>The bugfix commit was <a href="https://git.libreoffice.org/core/commit/0a89d65e6bb7be293c1a7b4615a08292701694dc">SVG export: fix handling of semi-transparent text inside a
list</a>.</p>
<p>The tracking bug was <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=162782">tdf#162782</a>.</p>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-anyinput-lok.html">Improved interactivity for LOK clients in Writer's layout</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 03 September 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has support for doing partial layout passes when LOK clients have pending events, which
sometimes improves interactivity a lot.</p>
<p>This work is primarily for <a href="https://www.collaboraonline.com/">Collabora Online</a>, but the feature is
useful for any LOK clients.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>I recently worked with a document that has relatively simple structure, but it has 300 pages, and
most of the content is part of a numbered list. Pasting a simple string (like an URL) into the end
of a paragraph resulted in a short, but annoying hang. It turns out we updated Writer's layout for
all the 300 pages before the content was repainted on the single visible page. In theory, you
could reorder events, so you first calculate the first page, you paint the first page, then you
calculate the remaining 299 pages. Is this possible in practice? Let's try!</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>The relevant part of the test document is simple: just an empty numbered paragraph, so we can paste
somewhere:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-anyinput-lok/paste.png"><figure><img src="https://share.vmiklos.hu/blog/sw-anyinput-lok/paste.png"><figcaption>Bugdoc: empty paragraph, part of a numbered list and then pasting an URL there</figcaption></figure></a></p>
<p>This is a good sample, because pasting into a numbered list requires invalidating all list items in that
list, since possibly the paste operation created a new list item, and then the number portion has to
be updated for all items in the rest of the list. So if you paste into a numbered list, you need to
re-calculate the entire document if all the document is just a numbered list.</p>
<p>The first problem was that Writer tracks its visible area, but LOK needs two kinds of visible areas.
The first kind decides if invalidations are interesting for part of the document area. LOK wants to
get all invalidations, so in case we cache some document content in the client that is near the
visible area, we need to know when to throw away that cache.  On the other hand, we want to still
track the actually visible viewport of the client, so we can prioritize visible vs hidden parts of
the document. Writer in LOK mode thought that all parts of the document are a priority, but this
could improved by taking the client's viewport into account.</p>
<p>The second problem was that even if Writer had two layout passes (first is synchronous, for the
visible area; second is async, for the rest of the document), both passes were performed before
allowing a LOK client to request tiles for the issued invalidations.</p>
<p>This is now solved by a new <code>registerAnyInputCallback()</code> API, which allows the LOK client to signal if
it has pending events (e.g. unprocessed callbacks, tiles to be painted) or it's OK for Writer layout
to finish its idle job first.</p>
<p>The end result for pasting a URL into this 300 pages document, when measuring end-to-end (from
sending the paste command to getting the first updated tile) is a decrease in response time, from
963 ms to 14 ms.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/e1e77b313c9fe0fff814384a67de415e33c8b27f">cool#9735 sw lok: take LOK vis area into account when deciding idle layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/a22fe103e7a26270b7213448c570400a563c18ba">Related: cool#9735 vcl lok: add an AnyInput() callback</a></li>
<li><a href="https://git.libreoffice.org/core/commit/41aec3e9a088ad4e99e43e033c7653e2c25a85ba">Related: cool#9735 sw lok: handle the AnyInput() callback during idle layout</a></li>
<li><a href="https://git.libreoffice.org/core/commit/3974af7dca82f887dfdfe88f087583508c19e7ab">sfx2: fix crash in SfxObjectShell::IsHelpDocument()</a></li>
</ul>
<p>The tracking issue for this problem was
<a href="https://github.com/CollaboraOnline/online/issues/9735">cool#9735</a>.</p>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraonline.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (25.2).</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sw-improved-font-falback.html">Improved font fallback in the DOCX import of Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 07 August 2024</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <p>Writer now has improved support for font fallback when you open a DOCX file that refers to fonts
which are not available currently.</p>
<p>This work is primarily for <a href="https://www.collaboraoffice.com/">Collabora Online</a>, but the feature is
fully available in desktop Writer as well.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>Font embedding is meant to solve the problems around missing fonts, but you can also find documents
with stub embedded fonts that are to be ignored and our code didn't have any sanity check on such
fonts, leading to unexpected glyph-level fallbacks. Additionally, once font-level fallback happened,
we didn't take the font style (e.g. sans vs serif) into account, which is expected to work when
finding a good replacement for the missing font.</p>
<h2 id="results-so-far">Results so far<a class="headerlink" href="#results-so-far" title="Permanent link">&para;</a></h2>
<p>Here is how to the original rendering looked like:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-improved-font-falback/old.png"><figure><img src="https://share.vmiklos.hu/blog/sw-improved-font-falback/old.png"><figcaption>Bugdoc, before: ugly glyph-level fallback</figcaption></figure></a></p>
<p>Once the handler for the embedded fonts in ODT/DOCX was improved to ignore stub fonts where even
basic glyphs were not available, the result was a bit more consistent, but still bad. Here is a
different document to show the problem:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-improved-font-falback/first.png"><figure><img src="https://share.vmiklos.hu/blog/sw-improved-font-falback/first.png"><figcaption>Bugdoc, first improvement: no glyph fallback but the result is sans</figcaption></figure></a></p>
<p>Note how now we used the same font, but the glyphs are always sans, not serif. So the final step was
to import the font type from DOCX and consider that while deciding font fallback:</p>
<p><a href="https://share.vmiklos.hu/blog/sw-improved-font-falback/second.png"><figure><img src="https://share.vmiklos.hu/blog/sw-improved-font-falback/second.png"><figcaption>Bugdoc, second improvement: no glyph fallback and the result is sans / serif</figcaption></figure></a></p>
<p>With this, we ignore stub embedded fonts from DOCX, we import the font type and in general font
fallback on Linux takes the font type into account while deciding font fallback.</p>
<h2 id="how-is-this-implemented">How is this implemented?<a class="headerlink" href="#how-is-this-implemented" title="Permanent link">&para;</a></h2>
<p>If you would like to know a bit more about how this works, continue reading... :-)</p>
<p>As usual, the high-level problem was addressed by a series of small changes:</p>
<ul>
<li><a href="https://git.libreoffice.org/core/commit/a9f3c11375525a7708378dd3648febc40db1ad20">tdf#162002 DOCX import: ignore subsetted embedded fonts for editing</a></li>
<li><a href="https://git.libreoffice.org/core/commit/09da7fd9cec9b36f2e09c1105a9263b83e2c66e4">tdf#162002 DOCX import, font embed: only discard subset fonts with few glyphs</a></li>
<li><a href="https://git.libreoffice.org/core/commit/6dfac38bacd449c64a13363797b56aff49cf8f52">tdf#162072 vcl, fontconfig: consider font-family-generic for substitute</a></li>
<li><a href="https://git.libreoffice.org/core/commit/d06de2e049761b7b9e8a95f17557d309812f7acc">Related: tdf#162072 DOCX import: handle font family for characters</a></li>
<li><a href="https://git.libreoffice.org/core/commit/ef1870810ec8c069e26538fd7626ad0656bed276">tdf#162280 vcl: consider font family type for glyph caching</a></li>
</ul>
<h2 id="want-to-start-using-this">Want to start using this?<a class="headerlink" href="#want-to-start-using-this" title="Permanent link">&para;</a></h2>
<p>You can get a development edition of Collabora Online 24.04 and try it out yourself right now: <a href="https://www.collaboraoffice.com/code/">try
the development edition</a>.  Collabora intends to continue
supporting and contributing to LibreOffice, the code is merged so we expect all of this work will be
available in TDF's next release too (24.8).</p>
  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/category/libreoffice2.html" class="button_accent">&larr; Older Posts</a>

</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>