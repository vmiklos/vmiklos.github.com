<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />

<link href="https://vmiklos.hu/blog/feeds/libreoffice.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking libreoffice Category RSS" />

  <title>
    What is Miklos hacking
&ndash; Category: libreoffice  </title>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24726997-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
&gt; Category: libreoffice
&brvbar; <a href="https://vmiklos.hu/blog/feeds/libreoffice.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/locon2016.html">Improved digital signature handling in LibreOffice LOCon talk</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/d7946ac560054fcb9f9a3953f079d9a7/xmlsec-locon-brno-2k16.pdf">
<img src="https://farm9.staticflickr.com/8646/29432546522_585a16f89a_z.jpg" alt="https://farm9.staticflickr.com/8646/29432546522_585a16f89a_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Earlier today I gave a
<a href="http://conference.libreoffice.org/2016/the-program/sept-8th-thursday/">Improved
digital signature handling in LibreOffice</a> talk at LibreOffice conference
2016, in the development track. The room was well-crowded&#8201;&#8212;&#8201;seems this year
classification was a hot topic. ;-)</p></div>
<div class="paragraph"><p>Quite some pictures are now available <a href="https://twitter.com/libreoffice">on</a>
<a href="https://twitter.com/CollaboraOffice">Twitter</a>, don&#8217;t miss them.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/libreoffice-xmlsec.html">LibreOffice now bundles the latest libxmlsec version</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I wrote about how LibreOffice uses the <a href="https://www.aleksey.com/xmlsec/">XMLSec
Library</a> in an
<a href="/blog/libreoffice-sha256-signatures.html">earlier post</a> from
March. There are two long-term goals regarding xmlsec in LibreOffice:</p></div>
<div class="ulist"><ul>
<li>
<p>
bundle the latest xmlsec version, instead the one from 2009
</p>
</li>
<li>
<p>
upstream enough of the patches, so building &amp; running against xmlsec as
  provided by a Linux distro also works
</p>
</li>
</ul></div>
<div class="paragraph"><p>I&#8217;m happy to say that the first goal is now reached:</p></div>
<div class="ulist"><ul>
<li>
<p>
libreoffice-5-1 bundled xmlsec 1.2.14 from 2009
</p>
</li>
<li>
<p>
libreoffice-5-2 bundles xmlsec 1.2.20 from 2014
</p>
</li>
<li>
<p>
master bundles the latest xmlsec 1.2.22, released earlier this year :-)
</p>
</li>
</ul></div>
<div class="paragraph"><p>This is good, as this way it&#8217;s easier to integrate xmlsec upstream
improvements into LibreOffice in the future.</p></div>
<div class="paragraph"><p>Regarding the other goal, shrinking the patch list is still to be done. ;-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/libreoffice-asan-setup.html">A LibreOffice / AddressSanitizer setup</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p><a href="https://github.com/google/sanitizers">sanitizers</a> (ASAN, UBSAN, etc.) is a
collection of tools to detect memory corruption bugs, undefined behavior and
more by instrumenting the code generated by the compiler. (That&#8217;s the main
difference from valgrind.) From LibreOffice&#8217;s perspective one more important
difference is that there is a
<a href="http://ci.libreoffice.org/job/lo_ubsan/">Jenkins_Linux_Ubsan</a> tinderbox that
makes sure that the master branch is kept clean from errors detected by a
given configuration.</p></div>
<div class="paragraph"><p>So when the tinderbox failed after a commit of mine, I wanted to set up a
similar environment locally, reproduce and fix the bug, and push the fix once
I saw that the fix indeed solves the problem. You can set many options both at
build and runtime, so while we have some
<a href="https://wiki.documentfoundation.org/Development/-fsanitize">documentation</a> on
the TDF wiki (and also Stephan was kind enough to share
<a href="https://people.freedesktop.org/~vmiklos/2016/sanitizers-config-sberg">his
config</a>) on how to use these sanitizers, it wasn&#8217;t clear to me what to do step
by step. So here is one possible setup that worked for me&#8201;&#8212;&#8201;in my case I
wanted to reproduce a stack-use-after-return problem. If you haven&#8217;t ever built
LibreOffice before, then go to
<a href="https://wiki.documentfoundation.org/Development">the Development wiki page</a>,
first do a normal build, and if everything went fine, came back here.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_build_options">Build options</h2>
<div class="sectionbody">
<div class="paragraph"><p>My <code>autogen.input</code> looks like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>CC=clang -fsanitize=address
CXX=clang++ -fsanitize=address
--enable-dbgutil
--disable-firebird-sdbc</code></pre>
</div></div>
<div class="paragraph"><p>Which is a normal clang debug build, except:</p></div>
<div class="ulist"><ul>
<li>
<p>
you need to add <code>-fsanitize=...</code> to <code>CXX</code> (not to <code>CXXFLAGS</code>), as explained
  on the wiki
</p>
</li>
<li>
<p>
you need to explicitly disable Firebird integration for now
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_building">Building</h2>
<div class="sectionbody">
<div class="paragraph"><p>My first attempt failed at build time, as even the tools used only during the
build are instrumented, and some memory leak was detected there, which means
the build aborted before reaching the problem I was interested in. To disable
leak detection during build, and disable parallelism (I needed this, as I did
the build in the background while using the machine for something else):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>make build-nocheck ASAN_OPTIONS=detect_leaks=0 PARALLELISM=1</code></pre>
</div></div>
<div class="paragraph"><p>This also means that I explicitly disabled running any tests, as I knew which
is the single unit test I want to run for the purposes of reproducing and
fixing the problem.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">
<div class="paragraph"><p>Once the build completed, it turns out that the stack-use-after-return detection is disabled at runtime by default, which means I could not see any problem locally. Here is the commandline to run one specific CppunitTest with this detection on:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>cd sw; make -sr CppunitTest_sw_tiledrendering ASAN_OPTIONS=detect_leaks=0:detect_stack_use_after_return=1</code></pre>
</div></div>
<div class="paragraph"><p>Again, this is just one possible setup, you can use other <code>-fsanitize=...</code>
options, other environment variables during build and during testing&#8201;&#8212;&#8201;but
hopefully it helps in the future to avoid pushing fixes for such problems
detected by sanitizers just blindly.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_update_2019_01_25">Update, 2019-01-25</h2>
<div class="sectionbody">
<div class="paragraph"><p>The above described "do it yourself" way doesn&#8217;t work with LibreOffice master
(towards 6.3) and openSUSE Leap 15.0 anymore. I tried to debug what is the
exact problem, but there are many moving parts here:</p></div>
<div class="ulist"><ul>
<li>
<p>
gcc version (providing libstdc++)
</p>
</li>
<li>
<p>
clang version (5.0.2 is too old; 7 failed to build the plugins, trunk
  towards 9 also generated false positives for me)
</p>
</li>
<li>
<p>
various sanitizer-related environment variables
</p>
</li>
<li>
<p>
various sanitizer-related compiler options
</p>
</li>
</ul></div>
<div class="paragraph"><p>So it&#8217;s much easier to just use the combination used by the
<code>Jenkins_Linux_Ubsan</code> tinderbox than something custom. Doing that is
reasonably straightforward, but still there are a couple of non-trivial steps.
What worked for me is:</p></div>
<div class="ulist"><ul>
<li>
<p>
Set up LODE according to its
  <a href="https://wiki.documentfoundation.org/Development/lode">wiki page</a>.
</p>
</li>
<li>
<p>
Instead of plain <code>./setup --dev</code>, do:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>./setup --jenkins
./setup --jenkins-san
./setup --dev
cd $LODE_HOME/dev/core</code></pre>
</div></div>
<div class="paragraph"><p>This will build a working version of both gcc and clang for you.</p></div>
<div class="ulist"><ul>
<li>
<p>
Instead of manually setting up the environment variables, do:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>. $LODE_HOME/bin/lode_ubsan_env</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Instead of manually setting autogen options, use this autogen.input:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>--with-distro=Jenkins/Linux_ubsan_master</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Finally to build the code and run a specific test based on tinderbox mail:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>make build-nocheck
cd sw; make -sr CppunitTest_sw_unowriter CPPUNIT_TEST_NAME="testPasteListener"</code></pre>
</div></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/vc-voc-oc.html">On LibreOffice's ViewContact/ViewObjectContact/ObjectContact</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm9.staticflickr.com/8833/28305552801_1d518e31ae_o.png">
<img src="https://farm9.staticflickr.com/8833/28305552801_21343667ff_z.jpg" alt="https://farm9.staticflickr.com/8833/28305552801_21343667ff_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>I&#8217;ve recently
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=ac0b3b05ab52d0ac06137cf93d71187c7957ec99">fixed</a>
a missing-repaint problem in LibreOffice&#8217;s headless backend, but the root
cause wasn&#8217;t close to the symptom I saw first. Part of the debugging process
was to understand what&#8217;s the relation between <code>sdr::contact::ViewContact</code>,
<code>sdr::contact::ViewObjectContact</code> and <code>sdr::contact::ObjectContact</code>.</p></div>
<div class="paragraph"><p>See
<a href="http://www.openoffice.org/marketing/ooocon2006/presentations/wednesday_g11.odp">this
old presentation</a> and the <a href="https://gerrit.libreoffice.org/27190">review of my
documentation update</a> for the details, but the short version is that:</p></div>
<div class="ulist"><ul>
<li>
<p>
somewhat confusingly, <code>sdr::contact::ViewContact</code> is part of the <strong>model</strong>, and
  there is one <code>sdr::contact::ViewContact</code> object per shape
</p>
</li>
<li>
<p>
<code>sdr::contact::ViewObjectContact</code> is part of a view, and there is one
  <code>sdr::contact::ViewObjectContact</code> per shape, per view
</p>
</li>
<li>
<p>
finally <code>sdr::contact::ObjectContact</code> is part of a <strong>view</strong>, and there is one
  <code>sdr::contact::ObjectContact</code> per view
</p>
</li>
</ul></div>
<div class="paragraph"><p>So the answer to my original <em>Is it normal that I have two object contacts and
a single view contact for a shape and two views?</em> question is: yes, that&#8217;s
expected. ;-) Hopefully the updated documentation is now more clear, the
incorrect 1:N relation in the original class diagram first confused me.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/rtf-share-import-scale-flip.html">RTF shape import: group scaling and flip in LibreOffice Writer</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Some kind of simple logo was
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=91684">reported</a> to be
mis-imported in the RTF filter, it looked like this:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm8.staticflickr.com/7451/27320164444_f437d0418e_o.png" alt="https://farm8.staticflickr.com/7451/27320164444_f437d0418e_o.png" />
</div>
</div>
<div class="paragraph"><p>which is interesting, but the reference output is different:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm8.staticflickr.com/7317/27898228066_f5918e59bf_o.png" alt="https://farm8.staticflickr.com/7317/27898228066_f5918e59bf_o.png" />
</div>
</div>
<div class="paragraph"><p>With a bit of investigation, it turns out this was a flipped group shape with
a few rectangles, so the mis-rendering of the logo was due to two independent
problems. The first is that the child shapes inside a group shape were scaled
incorrectly. See the
<a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=c3acc06230169f141930945ebbff43b1a88dfdee">commit</a>
for the exact details, after fixing scaling, it looked closer to the original:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm8.staticflickr.com/7301/27320164424_4ce2ced16c_o.png" alt="https://farm8.staticflickr.com/7301/27320164424_4ce2ced16c_o.png" />
</div>
</div>
<div class="paragraph"><p>The second problem was that the group itself was flipped, and this was again
ignored on import. After
<a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=63965d7dc571c7dce999980737f9d57a7c5151da">fixing</a>
that problem:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm8.staticflickr.com/7228/27898228076_f89fabeb00_o.png" alt="https://farm8.staticflickr.com/7228/27898228076_f89fabeb00_o.png" />
</div>
</div>
<div class="paragraph"><p>the result is basically the same as the reference. Both fixes are not only on
master (towards LibreOffice 5.3) but also backported to LibreOffice 5.2. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/classification-toolbar-multicat.html">Classification toolbar in LibreOffice: Multiple Categories</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm8.staticflickr.com/7073/26791252053_5cd37892f2_o.png">
<img src="https://farm8.staticflickr.com/7073/26791252053_46f2c7d4ae_z.jpg" alt="https://farm8.staticflickr.com/7073/26791252053_46f2c7d4ae_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>I explained the concept of the classification toolbar appearing in LibreOffice
5.2 in a <a href="/blog/classification-toolbar.html">previous post</a>.
One incremental update on top of that is support for multiple categories,
which I&#8217;m describing here.</p></div>
<div class="paragraph"><p><a href="https://www.tscp.org/">TSCP</a> in its
<a href="http://www.tscp.org/wp-content/uploads/2013/08/TSCP_BAILSv1.pdf">BAILSv1</a> spec
defines 3 different policy types (IntellectualProperty, NationalSecurity and
ExportControl), and you can set different classification categories for
different policy types. Giving a practical example, if you&#8217;re communicating
with someone, then you can declare what policy type will you be using for that
communication, and tag a single document multiple times, once for all used
policy types.</p></div>
<div class="paragraph"><p>This multiple-categories feature wasn&#8217;t supported by LibreOffice previously,
we simply read the IntellectualProperty type from the document, and also only
wrote that. Now the user interface still reacts to the IntellectualProperty
policy type (since in case there are multiple policies and each of them wants
a different e.g. watermark, the UI has to pick one in some way), but other
than that we read all types from the document, all values are shown on the
toolbar and of course you can also set all of them.</p></div>
<div class="paragraph"><p>All internal APIs and the <code>.uno</code> command that can be used from macros take a
type parameter to get/set a given type of category, if wanted.  As usual, you
can try this right now with a 5.2 or
<a href="http://dev-builds.libreoffice.org/daily/master/">5.3 daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/sd-undo-fixes.html">Recent undo/redo fixes in LibreOffice Impress</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I&#8217;ve recently spent some time fixing a few bugs around undo/redo in Impress,
in the area of table shapes. I&#8217;m mentioning these here as they&#8217;re all bugfixes, so
they are backported to LibreOffice 5.1, and no major release notes will point
them out. So if you are using Impress table shapes and you consider their
usability suboptimal, then read on, I have some great news. :-)</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-4K07Iu7su4M/Vzs8dQCfx7I/AAAAAAAAGts/7GCj5T3Zs9UMyTaR277tHvlOHSk-9HGmACCo/s0/">
<img src="https://lh3.googleusercontent.com/-4K07Iu7su4M/Vzs8dQCfx7I/AAAAAAAAGts/7GCj5T3Zs9UMyTaR277tHvlOHSk-9HGmACCo/s800/" alt="https://lh3.googleusercontent.com/-4K07Iu7su4M/Vzs8dQCfx7I/AAAAAAAAGts/7GCj5T3Zs9UMyTaR277tHvlOHSk-9HGmACCo/s800/" />
</a>
</div>
</div>
<div class="paragraph"><p>The first problem is
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=99396">tdf#99396</a>, where
there were actually two problems:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Vertical alignment is a cell property, but when setting that property, the undo code was simply <a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=6819992113947e7a6272bf750fee712c2df41905">missing</a>.
</p>
</li>
<li>
<p>
When editing cell text (the user is inside "text edit") the undo stack is in
a special mode&#8201;&#8212;&#8201;and ending text edit made the cell property undo items go
away. This wasn&#8217;t a problem for vertical alignment only, it was a problem for
example when the background color of the cell was changed, too. These cell
property changes are now
<a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=100eb15b4d8529d7a11d98a28742f31f0f792fa1">added</a>
to the undo stack after finishing text edit, so you can still undo them later.
</p>
</li>
</ol></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-aCZDFOS8xR4/Vzs8bzEjtvI/AAAAAAAAGtw/ZESadiryhEAwAsLoxwztIRNvSjdwOEmDgCCo/s0/">
<img src="https://lh3.googleusercontent.com/-aCZDFOS8xR4/Vzs8bzEjtvI/AAAAAAAAGtw/ZESadiryhEAwAsLoxwztIRNvSjdwOEmDgCCo/s600/" alt="https://lh3.googleusercontent.com/-aCZDFOS8xR4/Vzs8bzEjtvI/AAAAAAAAGtw/ZESadiryhEAwAsLoxwztIRNvSjdwOEmDgCCo/s600/" />
</a>
</div>
</div>
<div class="paragraph"><p>The second bugreport is
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=99452">tdf#99452</a> where
resizing a table shape row separator and then undoing the resize didn&#8217;t
restore the original state. See the
<a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=cafc53f8b4c08443524b1da6f4918d49afd45bb5">commit</a>
for all the details, but the bottom line is: it isn&#8217;t a good idea to
automatically re-layout the table when we&#8217;ve already resized the shape as part
of undo, but the table rows were not yet resized to reflect their original
sizes.</p></div>
<div class="paragraph"><p>As usual, you can try this right now with a 5.2
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-) (Or even
with an 5.1 one, actually.)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/classification-toolbar.html">Classification toolbar in LibreOffice</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>In the past few posts in this blog I wrote about various digital
signing-related improvements that will land in LibreOffice 5.2. In this post I
would like to cover an other aspect of helping secure document handling:
classification.  First, thanks to the Dutch Ministry of Defense who made this
work possible (as part of a project implementing trusted signing and
communication in LibreOffice) in cooperation with
<a href="http://nouenoff.nl/">Nou&amp;Off</a>. The basic idea is that in case the user is
required to follow a policy when editing a document, then LO can help the user
respect these rules in case LO is informed about the rules.</p></div>
<div class="paragraph"><p>Luckily <a href="https://www.tscp.org/">TSCP</a> produced a number of open standards around
this, which LO can implement without going after a specific vendor. For the
scope of this post, two of them are interesting:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://www.tscp.org/wp-content/uploads/2013/08/TSCP_BAFv1.pdf">Business
  Authentication Framework</a> (BAF) specifies how you can describe your existing
  policy (which is probably some legal text) in a machine-readable format.
</p>
</li>
<li>
<p>
<a href="http://www.tscp.org/wp-content/uploads/2013/08/TSCP_BAILSv1.pdf">Business
  Authorization Identification and Labeling Scheme</a> (BAILS) specifies how to
  refer to such a BAF policy in a document. The concepts in BAILS are so
  generic that they can be applied to any format that supports document-level
  user-defined properties.
</p>
</li>
</ul></div>
<div class="paragraph"><p>So how does this look like? View &#8594; Toolbars &#8594; Classification can enable a
toolbar that&#8217;s disabled by default:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-Xax-DgF5OXU/VyMiHHa2MhI/AAAAAAAAGsk/4FhSfBAnSMAt_qUSrTq_C_1Mh68T5GhAACCo/s0/">
<img src="https://lh3.googleusercontent.com/-Xax-DgF5OXU/VyMiHHa2MhI/AAAAAAAAGsk/4FhSfBAnSMAt_qUSrTq_C_1Mh68T5GhAACCo/s400/" alt="https://lh3.googleusercontent.com/-Xax-DgF5OXU/VyMiHHa2MhI/AAAAAAAAGsk/4FhSfBAnSMAt_qUSrTq_C_1Mh68T5GhAACCo/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>It has a list box that contains the categories described by the BAF policy. LO
comes with such an example policy by default, that&#8217;s why you can see
categories there already. If you want to use your own policy, you can do so:
Tools &#8594; Options &#8594; LibreOffice &#8594; Paths has a Classification row to configure
a custom policy:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-F-zzCoVt-Gc/VyMiN6C_BKI/AAAAAAAAGsY/K3XkZDDSX1c5_X266H3hC4KqkA5twGmrgCCo/s0/">
<img src="https://lh3.googleusercontent.com/-F-zzCoVt-Gc/VyMiN6C_BKI/AAAAAAAAGsY/K3XkZDDSX1c5_X266H3hC4KqkA5twGmrgCCo/s400/" alt="https://lh3.googleusercontent.com/-F-zzCoVt-Gc/VyMiN6C_BKI/AAAAAAAAGsY/K3XkZDDSX1c5_X266H3hC4KqkA5twGmrgCCo/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>And if you select the <em>Internal Only</em> category, you&#8217;ll see most of the
features described by a category: it can add an info-bar (UI only),
header/footer fields and a watermark (stored in the document) as well:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-4iEF3y78npI/VyMiTCCMALI/AAAAAAAAGso/IrzORuYa-7IjGwjs9HXYQr3_rLcope0PwCCo/s0/">
<img src="https://lh3.googleusercontent.com/-4iEF3y78npI/VyMiTCCMALI/AAAAAAAAGso/IrzORuYa-7IjGwjs9HXYQr3_rLcope0PwCCo/s400/" alt="https://lh3.googleusercontent.com/-4iEF3y78npI/VyMiTCCMALI/AAAAAAAAGso/IrzORuYa-7IjGwjs9HXYQr3_rLcope0PwCCo/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>I would like to point out that the watermark is a proper scalable customshape,
not a poor bitmap. :-) Perhaps this part could be extracted to a separate <em>Add
Watermark</em> feature later, as I think it&#8217;s quite useful on its own as well.</p></div>
<div class="paragraph"><p>Finally, one feature is that LO knows how secure the document is once it has a
classification category, which means a classification scale and level. For two
documents that have the same scale, LO can detect if the user would accidentally
try to leak sensitive content from a document with higher classification level
to a document that has a lower one. This is implemented when copy&amp;pasting:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-ZRYwwOW0dQ4/VyMiXiqx2cI/AAAAAAAAGso/J6dH-q2nZPESOY3SiMQoCSLDUYfHi9WbACCo/s0/">
<img src="https://lh3.googleusercontent.com/-ZRYwwOW0dQ4/VyMiXiqx2cI/AAAAAAAAGso/J6dH-q2nZPESOY3SiMQoCSLDUYfHi9WbACCo/s400/" alt="https://lh3.googleusercontent.com/-ZRYwwOW0dQ4/VyMiXiqx2cI/AAAAAAAAGso/J6dH-q2nZPESOY3SiMQoCSLDUYfHi9WbACCo/s400/" />
</a>
</div>
</div>
<div class="paragraph"><p>Most of these features work in all Writer, Calc and Impress. The header/footer
fields and the watermark are Writer-only, and also Calc/Impress does
classification checks only in its internal copy&amp;paste code (e.g. not when
doing paste special and choosing RTF).</p></div>
<div class="paragraph"><p>Putting all of these together, LO can now help users required to follow
classification rules in a number of different ways, as long as the rules they
have to follow are available as a BAF XML policy. As usual, you can try this
right now with a 5.2 <a href="http://dev-builds.libreoffice.org/daily/master/">daily
build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/ooxml-signature-export.html">OOXML signature export in LibreOffice</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://lh3.googleusercontent.com/-E5cCfFV5kkk/VwzwIcJ0JqI/AAAAAAAAGqk/4JpTSRlvUok6txiXgp1MgoNoNgPb0ov8gCCo/s0-Ic42/">
<img src="https://lh3.googleusercontent.com/-E5cCfFV5kkk/VwzwIcJ0JqI/AAAAAAAAGqk/4JpTSRlvUok6txiXgp1MgoNoNgPb0ov8gCCo/s600-Ic42/" alt="https://lh3.googleusercontent.com/-E5cCfFV5kkk/VwzwIcJ0JqI/AAAAAAAAGqk/4JpTSRlvUok6txiXgp1MgoNoNgPb0ov8gCCo/s600-Ic42/" />
</a>
</div>
</div>
<div class="paragraph"><p>After adding <a href="/blog/ooxml-signature-import.html">support
for reading OOXML signatures in LibreOffice</a>, I continued with implementing OOXML
signature export (as in: not only verification, but signing).</p></div>
<div class="paragraph"><p>By verification, I mean that I count the signature of the input document, then
compare it with an existing signature, and if they match, it is verified. This
can be also called "import", as I only read an existing signature, I don&#8217;t
create one.  By signing, I mean the creation of a new signature, which is
always good&#8201;&#8212;&#8201;if it isn&#8217;t, that&#8217;s a programming error. This can be also
called "export", as I write the new signature into the document.</p></div>
<div class="paragraph"><p>First, thanks to the Dutch Ministry of Defense who made this work possible (as
part of a project implementing trusted signing and communication in
LibreOffice), this included:</p></div>
<div class="ulist"><ul>
<li>
<p>
signing a previously unsigned document
</p>
</li>
<li>
<p>
appending a signature to an already signed document
</p>
</li>
<li>
<p>
removing a signature from a document with multiple signatures
</p>
</li>
<li>
<p>
removing the last signature of a signed document, turning it into an
  unsigned one
</p>
</li>
</ul></div>
<div class="paragraph"><p>Obviously the hardest part was the initial success: signing a previously
unsigned document, in a way that is accepted by both LibreOffice and MSO. One
trick here is that while in ODF the signature stream is simply added to an
existing document storage, in OOXML the storage has to refer to the signature
sub-storage (it&#8217;s not a stream, as it has a stream for each individual
signature), then it has to be signed, and finally the signature can be added
to the document storage. So instead of reading the document, then appending
the signature, here we need to modify the document, and then we can append the
signature.  By referring the signature sub-storage, I mean it is necessary to
modify <code>[Content_Types].xml</code> (so it contains a mime type for both the <code>.sigs</code>
extension, and also for the individual <code>/_xmlsignatures/sigN.xml</code> streams) and
also the <code>_rels/.rels</code> stream has to refer <code>_xmlsignatures/origin.sigs</code>, which
will contain the list of actual signatures.  A surprising detail is that the
signature is required to contain quite some software and hardware details
about your environment, like monitor resolution, Windows version and so on.
For a cross-platform project like LibreOffice this isn&#8217;t meaningful, not to
mention we have no interest in leaking such information. So what I did instead
is writing hardcoded values based on what my test environment would produce,
just to please MSO. ;-)</p></div>
<div class="paragraph"><p>After the initial
<a href="https://cgit.freedesktop.org/libreoffice/core/tree/xmlsecurity/source/helper/ooxmlsecexporter.cxx">OOXML
signature exporter</a> was ready, the next challenge was adding multiple
signatures. The problem here is that you have to roundtrip the existing
signatures perfectly. And when I write perfectly, I really mean it: if a
single character is written differently, then the hash of the signature will
be different, so the roundtrip (when we write back an existing and a new
signature to the document) will invalidate the signature. And there is no way
around that: the very point of the signature is that only the original signer
can re-calculate the signature hash. :-) So what we do is simply threating the
existing signatures as a byte array, and when writing back, then we don&#8217;t try
to re-construct the signature stream based on the xmlsecurity data model, but
simply write back the byte array. This way it&#8217;s enough to extract parts of the
signature which are presented to the user (date, certificate, comment), and we
don&#8217;t need to parse the rest.</p></div>
<div class="paragraph"><p>Removing one of multiple existing signatures isn&#8217;t particularly hard, you just
need to update <code>_xmlsignatures/_rels/origin.sigs.rels</code> and
<code>[Content_Types].xml</code> which refer each and every signature stream. It&#8217;s a good
idea to truncate them before writing, otherwise you may get a not even
well-formed XML as a result.</p></div>
<div class="paragraph"><p>Finally removing the last signature is a matter of undoing all changes we did
while adding the first signature (the content type list and the toplevel
relation list), finally removing the signature sub-storage all-together. I
also factored out all this signature management code from
<code>DigitalSignaturesDialog</code> (which is a graphical dialog) to
<code>DocumentSignatureManager</code>, so that all the above mentioned features can be
<a href="https://cgit.freedesktop.org/libreoffice/core/tree/xmlsecurity/qa/unit/signing/signing.cxx">unit-tested</a>.</p></div>
<div class="paragraph"><p>Putting all of these together, LO can now do all signature add, append, remove
and clean operations a user would expect from what is referred as simply
<em>OOXML signature support</em>. As usual, you can try this right now with a 5.2
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/ooxml-signature-import.html">OOXML signature import in LibreOffice</a></h1>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div style="text-align: center; font-size: 0.6em;">
<img src="https://lh3.googleusercontent.com/-8fwMz2Ie0ys/Vvpxvf94SrI/AAAAAAAAGlQ/vVaTBn_vEvY7Y3Fn2rcLYPERx3raDX_UwCCo/s400-Ic42/"/>
<p>(via <a href="http://www.ascertia.com/">ascertia</a>)</p>
</div>
<div class="paragraph"><p>After adding <a href="/blog/libreoffice-sha256-signatures.html">support
for SHA-256 hashes in LibreOffice</a>, I turned towards implementing OOXML
signature import (as in: verification, not signing) in LibreOffice. First,
thanks to the Dutch Ministry of Defense who made this work possible (as part
of a project implementing trusted signing and communication in LibreOffice), I
collected a list of building blocks needed for this to work:</p></div>
<div class="ulist"><ul>
<li>
<p>
support for the Relationships Transform Algorithm (described in ISO/IEC
  29500-2:2012) in xmlsec
</p>
</li>
<li>
<p>
an actual XML parser for the OOXML signature in <code>xmlsecurity/</code>
</p>
</li>
<li>
<p>
a new filter flag, so that our code no longer assumes "is ODF" means
  "supports digital signing" and
</p>
</li>
<li>
<p>
some refactoring in <code>xmlsecurity/</code>, so that our digital signature code doesn&#8217;t
  assume that multiple signatures are always written to a single file
</p>
</li>
</ul></div>
<div class="paragraph"><p>The xmlsec bits are now
<a href="https://github.com/lsh123/xmlsec/commit/7069e2b0ab49679008abedd6d223fb95538b0684.patch">upstream</a>,
it seems to me that new algorithm is needed, so that MSO can avoid signing a
number of streams (files in ZIP containers), while still being able to verify
that all normal streams are signed. Given that MSO by default doesn&#8217;t sign all
streams (so that e.g. the metadata of the document can be modified without
invalidating signatures), this is in use even for a hello-world document. This
implies that a typical OOXML signature will never gain the best "signed"
category in LO, as we&#8217;ll always warn that even though the signature is valid,
not all streams are signed. This is a bit of a rant, but better not hide the
reality: a default ODF signature covers more than a default OOXML signature.</p></div>
<div class="paragraph"><p>The
<a href="https://cgit.freedesktop.org/libreoffice/core/tree/xmlsecurity/source/helper/ooxmlsecparser.cxx">OOXML
signature parser</a> had to extract all information from the signature markup
that&#8217;s interesting for LibreOffice, like the certificate, the signature date
or the signature description. I considered extending the ODF signature parser
instead of implementing a new one for OOXML, since both markups are based on
the same W3C signing spec, but they are different enough that the added
complexity doesn&#8217;t outweigh the benefit of code sharing here.</p></div>
<div class="paragraph"><p>The next step was to add a new <code>SUPPORTSSIGNING</code> filter flag in <code>filter/</code>, and
mark the DOCX, XLSX and PPTX file filters as such, and then of course find
places mostly in <code>sfx2/</code> and <code>xmlsecurity/</code> that assume only ODF files can be
signed, and modifying those checks to also handle this new flag.</p></div>
<div class="paragraph"><p>Finally, a difference between ODF and OOXML signatures is that ODF puts all of
them in a single stream, and all the signing and verifying code works with
that stream. However, in case of OOXML, all signatures are in separate
streams, so if we want to work with a single object as kind of a signature
context, we need a storage (a sub-directory inside the ZIP container), and
work with that.</p></div>
<div class="paragraph"><p>Putting all of these together, we now have unit tests that take test documents
having "good" and "bad" signatures, and the verification result in LO will
match with the one of MSO. As usual, you can try this right now with a 5.2
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/category/libreoffice6.html" class="button_accent">&larr; Older Posts</a>

<a href="https://vmiklos.hu/blog/category/libreoffice4.html" class="button_accent">Newer Posts &rarr;</a>
</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>