<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />

<link href="https://vmiklos.hu/blog/feeds/libreoffice.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking libreoffice Category RSS" />

  <title>
    What is Miklos hacking
&ndash; Category: libreoffice  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
&gt; Category: libreoffice
&brvbar; <a href="https://vmiklos.hu/blog/feeds/libreoffice.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/smartart-improvements-3.html">SmartArt improvements in LibreOffice, part 3</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 04 January 2019</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I recently <a href="https://vmiklos.hu/blog/smartart-improvements-2.html">dived into</a> the SmartArt
support of LibreOffice, which is the component responsible for displaying
complex diagrams from PPTX. I focus on the case when only the document model
and the layout constraints are given, not a pre-rendered result.</p></div>
<div class="paragraph"><p>First, thanks to our partner <a href="https://www.suse.com/">SUSE</a> for working with
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_continuous_block_process_accent_process_and_organization_chart">Continuous Block Process, Accent Process and Organization Chart</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this post I would like to present the progress done last month regarding
the above mentioned diagram types&#8201;&#8212;&#8201;these are used in many documents.</p></div>
<div class="paragraph"><p>The improvement (as always) come in small incremental steps:</p></div>
<div class="ulist"><ul>
<li>
<p>
Continuous Block Process now reads space width from constraints.
</p>
</li>
<li>
<p>
Accent Process now has the missing bullets and fixes an incorrect large
  paragraph-level indent.
</p>
</li>
<li>
<p>
Organization Chart now has an initial implementation of the <code>hierRoot</code> and
  <code>hierChild</code> algorithms.
</p>
</li>
<li>
<p>
Organization Chart now handles multiple employees for a manager.
</p>
</li>
</ul></div>
<div class="paragraph"><p>With all these fixed, we reach a much better state for the mentioned diagram
types.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>The SmartArt test documents from <a href="https://cgit.freedesktop.org/libreoffice/core/tree/sd/qa/unit/data/pptx/">sd/qa/unit/data/pptx/</a> is what I used for testing this work.</p></div>
<div class="paragraph"><p>Here is how the baseline, the current and the reference rendering of Accent Process looks like:</p></div>
<div style="text-align: center">
<img src="https://lh3.googleusercontent.com/8CH3lhBMrhnNPvcptRvw0R0RUGIW5Jaeh1LxqnuTxcvWFg95OyrZqgAYl2YWMwTJbdyUeGrAB52K-WXu8mSfjPw2k-4NVb0lbXKpnTjtoBuIenqhlX70r8gP3AFuP6RDbgKEl7vPvQ=w640" style="max-width: 100%;"/>
<p>smartart-accent-process.pptx, baseline</p>
</div>
<div style="text-align: center">
<img src="https://lh3.googleusercontent.com/i62jSfzKrCRQmv-EMEPx_ujXepB0qFzWtMOD8F_HIJzqxxHcsIH1fADQQr3eIsRjiJcyAdx95b4f3jckpzASk2Ifks7bAAWDqJQUJBGLWuDmXXrFHO5q769PEBw3UghmMoS_0ihHTA=w640" style="max-width: 100%;"/>
<p>smartart-accent-process.pptx, current</p>
</div>
<div style="text-align: center">
<img src="https://lh3.googleusercontent.com/g9cJmO8PPcqOwgYN18uE6RdfFgq5fWi-bpGSOLOLFGYjEq_B0pLFPz_royCoHhz8_58L5GT71Xu62OtEj8IwLeNI631b_DqXHuSAWSEMbaF-ZU8XM4RykbUTE-egq1FhYE9b8p_Ejg=w640" style="max-width: 100%;"/>
<p>smartart-accent-process.pptx, reference</p>
</div>
<div class="paragraph"><p>And here is how the baseline, the current and the reference rendering of Organization Chart looks like:</p></div>
<div style="text-align: center">
<img src="https://lh3.googleusercontent.com/ze6x3LugJJBPjzEgJaWUVc_l3yiLtCQrcj_H_SN91YrYeR9f6E9Buzs6wrRp7T9mW4Mcho9jmVR3K0dItcGKiBK8ucs08YMkC9qW7kHQGCSE_m5fcEgK0z4srQnSUCJBD7NaYY-LWA=w640" style="max-width: 100%;"/>
<p>smartart-org-chart.pptx, baseline</p>
</div>
<div style="text-align: center">
<img src="https://lh3.googleusercontent.com/fT_as5kTDmnbZQpO0MtV_VYu0LqfrRLSewvEkjl3K4nQ4VmFkWSGWJ7RjUjFJyXcOFqpl5fqEQjU7shiqHotkFIDPEJE5s70Ysdnscxf7oVJcV0R4qjpdePU4CnUN9_HxUdEfYjPlw=w640" style="max-width: 100%;"/>
<p>smartart-org-chart.pptx, current</p>
</div>
<div style="text-align: center">
<img src="https://lh3.googleusercontent.com/Mdoqtf2-u4JISXJsKLp1tLQXnxDDvDg1vPOI5bNpOnAjhM02og80Lz6BnBzA-YkdlT__9lfU-pxFqUOzKpL9ySyJK9EmXnV6ipG5x6SmJTYY92KSzr_0e9qbp5pmZERiBSeBTPbVqg=w640" style="max-width: 100%;"/>
<p>smartart-org-chart.pptx, reference</p>
</div>
<div class="paragraph"><p>This is not not perfect yet, but it&#8217;s clearly a large improvement, all text is
now readable from the diagrams and bullets are no longer missing!</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.3), so you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/smartart-improvements-2.html">SmartArt improvements in LibreOffice, part 2</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 04 December 2018</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I recently <a href="https://vmiklos.hu/blog/smartart-improvements.html">dived into</a> the SmartArt
support of LibreOffice, which is the component responsible for displaying
complex diagrams from PPTX. I focused especially on the case when only
document model and the layout constraints are given, not a pre-rendered
result.</p></div>
<div class="paragraph"><p>First, thanks to our partner <a href="https://www.suse.com/">SUSE</a> for working with
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_accent_process">Accent Process</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this post I would like to present the progress regarding the Accent Process
preset, available in PowerPoint&#8201;&#8212;&#8201;which is used in many documents.</p></div>
<div class="paragraph"><p>This exposed several shortcomings of the current diagram layout we have in LibreOffice:</p></div>
<div class="ulist"><ul>
<li>
<p>
Values are not read from constraints (there was a reason for this, they can
  be complex, given that depending on the context, the unit is points or
  millimeters and the unit is always implicit).
</p>
</li>
<li>
<p>
ZOrder offsets were ignored.
</p>
</li>
<li>
<p>
Linear algorithm did not take size from constraints when it came to
  recursing into child algorithms.
</p>
</li>
<li>
<p>
Data point assumed that all text for it is a single "run" (i.e. either all
  text is bold or nothing, not half of it).
</p>
</li>
<li>
<p>
<code>followSib</code> axis was not implemented for <code>forEach</code>, so when you have arrow
  shapes between objects, we created <code>N</code> arrows, not <code>N - 1</code> ones.
</p>
</li>
<li>
<p>
Connectors were created as invisible shapes and had the wrong width/height
  aspect.
</p>
</li>
</ul></div>
<div class="paragraph"><p>With all these fixed, we reach a much better state for handling accent
process.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="https://cgit.freedesktop.org/libreoffice/core/tree/sd/qa/unit/data/pptx/smartart-accent-process.pptx">smartart-accent-process.pptx</a>
is what I used for testing of this work.</p></div>
<div class="paragraph"><p>Here is how the baseline, the current and the reference rendering of the test documents look like:</p></div>
<div style="text-align: center">
<img src="https://lh3.googleusercontent.com/e4uMwQRLHPsvVTwvnnwkyEIMmE0L-Piv55XreEW9wmA3y29348TWxgUbaCkYGBz-yXf8D55rhEC6Y3-kAp6BbLxNadWQfcxuUB57Z8dXFYPmlw8kjTPcOXNpqeZFKyBvtPiI7eSBhQ=w2400" style="max-width: 100%;"/>
<p>smartart-accent-process.pptx, baseline</p>
</div>
<div style="text-align: center">
<img src="https://lh3.googleusercontent.com/12c8vCrucm23guXlwYvj51MwAYOsePn7znwKBPq9qFzlgPx9XUTyX0wDcUgb0PR9tFVyTKoZPNXkhEur5Nqp7aosUCDuTVXE6yNj-58x3yLudJdqOnionMab6L-5wZ0rLvn1-bg5zA=w2400" style="max-width: 100%;"/>
<p>smartart-accent-process.pptx, current</p>
</div>
<div style="text-align: center">
<img src="https://lh3.googleusercontent.com/FBDUqsXyyBI6-abopLSrzHEYbm4YHHZwxFWxnfUsTO0dwl17HdP6sBcKzW_BvTjMWiRuPX6HC1I7aEOcHzeiZBzE-EnJZ_3fkfaOzxDHtiIc0QoFe9T4V9K3jq9_yRkNELx2tEQYpA=w2400" style="max-width: 100%;"/>
<p>smartart-accent-process.pptx, reference</p>
</div>
<div class="paragraph"><p>This is not not perfect yet, but it&#8217;s clearly a large improvement, all text is
now readable from the diagram!</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.3), so you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/smartart-improvements.html">SmartArt improvements in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 05 November 2018</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I recently dived into the SmartArt support of LibreOffice, which is the
component responsible for displaying complex diagrams from PPTX, especially in
case only document model and the layout constraints are given, not a
pre-rendered result.</p></div>
<div class="paragraph"><p>First, thanks to our partner <a href="https://www.suse.com/">SUSE</a> for working with
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_problem">The problem</h2>
<div class="sectionbody">
<div class="paragraph"><p>There are several ones. :-) If you are just interested in high quality viewing
of PPTX files, then your problem started with PowerPoint 2007 not writing a
pre-rendered drawingML markup of the diagram to the files, only PowerPoint
2010 started behaving like this. Additionally, if a diagram is not edited,
then re-saving with PowerPoint 2010 doesn&#8217;t seem to generate the drawingML
markup, either. This means that data + constraints cases are quite frequent
even today.</p></div>
<div class="paragraph"><p>Also, one day Impress should be able to actually edit these SmartArts as well,
so having the knowledge how to lay out SmartArt (even if it&#8217;s import-time-only
at the moment) is a good thing.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results_so_far">Results so far</h2>
<div class="sectionbody">
<div class="paragraph"><p>I always write cppunit tests when I work on filter code (in this case OOXML), so
far all fixes were visible in just two test files:
<a href="https://cgit.freedesktop.org/libreoffice/core/tree/sd/qa/unit/data/pptx/smartart-vertial-box-list.pptx">smartart-vertial-box-list.pptx</a>
and
<a href="https://cgit.freedesktop.org/libreoffice/core/tree/sd/qa/unit/data/pptx/vertical-bracket-list.pptx">vertical-bracket-list.pptx</a>.</p></div>
<div class="paragraph"><p>Here is how the baseline, the current and the reference rendering of these test documents look like:</p></div>
<div style="text-align: center">
<img src="https://farm2.staticflickr.com/1924/45683201352_52e22af9dc_z.jpg"/>
<p>smartart-vertial-box-list.pptx, baseline</p>
</div>
<div style="text-align: center">
<img src="https://farm5.staticflickr.com/4912/45683200942_8005cd433d_z.jpg"/>
<p>smartart-vertial-box-list.pptx, current</p>
</div>
<div style="text-align: center">
<img src="https://farm2.staticflickr.com/1976/45683201252_edd6eddea4_z.jpg"/>
<p>smartart-vertial-box-list.pptx, reference</p>
</div>
<div style="text-align: center">
<img src="https://farm2.staticflickr.com/1951/45683201002_4c93cc831c_z.jpg"/>
<p>vertical-bracket-list.pptx, baseline</p>
</div>
<div style="text-align: center">
<img src="https://farm5.staticflickr.com/4876/45008491984_61f25e21ca_z.jpg"/>
<p>vertical-bracket-list.pptx, current</p>
</div>
<div style="text-align: center">
<img src="https://farm2.staticflickr.com/1911/45683201082_3022aa8fe5_z.jpg"/>
<p>vertical-bracket-list.pptx, reference</p>
</div>
<div class="paragraph"><p>In terms of code commits, the fixes are split into several ones:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=e49c42d17f50c8b0cac9db08dedc375dd5aa8a98">oox
  smartart, vertical bracket list: fix node counter condition</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=397b64afc62a5632a6648598558a4d2c3ca0d283">oox
  smartart, linear layout: take horizontal position from constraints</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=b083b0808121d19f398a9f6ead195ae7e14ed047">oox
  smartart, linear layout: take width from constraints</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=923061d17d4b5b8bf0d4a8111b270c99a7c649a9">oox
  smartart: work towards accessing parent constraints</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=b61d2784271bf8b042642c378f50e8b446682548">oox
  smartart: fix width of shapes with agl=lin, linDir=fromT</a>
</p>
</li>
<li>
<p>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=a7e86beb00e9635ea4556ef4f8f8e24ff9965391">oox:
  ignore SmartArt "fallback" with empty shape list</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Clearly the results are not perfect yet, but in both cases nothing was
visible, and now all text is readable, so we&#8217;re moving in the right direction!</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.2), so you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/libocon2018-lightning.html">Text layout performance in LibreOffice conference lightning talk</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 01 October 2018</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/6d1f7938f02f40da9a04bd2ce24b0940/vcllayout-locon-tirana-2k19.pdf">
<img src="https://farm2.staticflickr.com/1914/44115509595_ab58bf01f5_z.jpg" alt="https://farm2.staticflickr.com/1914/44115509595_ab58bf01f5_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Last Friday I gave a
<a href="https://conference.libreoffice.org/2018/the-program/sept-18th-friday/">Text
layout performance</a> lightning talk at LibreOffice Conference 2018. Click on
the image to get the hybrid PDF slides!</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/libocon2018.html">ReqIF import/export in LibreOffice Writer conference talk</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 28 September 2018</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://speakerd.s3.amazonaws.com/presentations/a33d7c215e7f493ab1711c614413f6db/reqif-locon-tirana-2k19.pdf">
<img src="https://farm2.staticflickr.com/1939/44246333744_a805435168_z.jpg" alt="https://farm2.staticflickr.com/1939/44246333744_a805435168_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Earlier today I gave an
<a href="https://conference.libreoffice.org/2018/the-program/sept-18th-friday/">Editing
ReqIF-XHTML fragments with Writer</a> talk at LibreOffice Conference 2018. The
room was well-crowded&#8201;&#8212;&#8201;perhaps because the previous talk was about OOXML
interoperability. ;-)</p></div>
<div class="paragraph"><p>I expect quite some other slides will be available on
<a href="http://planet.documentfoundation.org/">Planet</a>, don&#8217;t miss them.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/uno-api-improvements.html">API improvements in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 08 August 2018</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm2.staticflickr.com/1793/43859007612_ca207fed0f_o.png" alt="https://farm2.staticflickr.com/1793/43859007612_ca207fed0f_o.png" />
</div>
</div>
<div class="paragraph"><p>I worked on two small features to extend the public (UNO) API of LibreOffice.
First, thanks to <a href="https://vector.com/">Vector</a> for funding
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_aliased_paths_and_text_in_the_png_export_for_draw">Aliased paths and text in the PNG export for Draw</h2>
<div class="sectionbody">
<div class="paragraph"><p>The UNO API of Draw allows you to build quite complex and custom shapes, but
you may want to export the rendered result to a bitmap for testing purposes,
so you can assert that the actual result matches a reference one.</p></div>
<div class="paragraph"><p>One problem in this area is anti-aliasing, which can easily differ between
machines. Given that normally aliased rendering is ugly, there is now a way to
enable AA, but disable it just during a single invocation of the PNG exporter.</p></div>
<div class="paragraph"><p>The above picture shows how the AA result looks like. You could write a Basic
macro like this to trigger the PNG export from Draw:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>xExporter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">createUnoService</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com.sun.star.drawing.GraphicExportFilter"</span><span style="color: #990000">)</span>
xExporter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SetSourceDocument</span></span><span style="color: #990000">(</span>ThisComponent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">DrawPages</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">Dim</span></span> <span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">)</span> As new com<span style="color: #990000">.</span>sun<span style="color: #990000">.</span>star<span style="color: #990000">.</span>beans<span style="color: #990000">.</span>PropertyValue
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">).</span>Name  <span style="color: #990000">=</span> <span style="color: #FF0000">"URL"</span>
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">).</span>Value <span style="color: #990000">=</span> <span style="color: #FF0000">"file:///tmp/debug/aa.png"</span>
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">).</span>Name  <span style="color: #990000">=</span> <span style="color: #FF0000">"MediaType"</span>
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">).</span>Value <span style="color: #990000">=</span> <span style="color: #FF0000">"image/png"</span>
xExporter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">())</span></tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s see how it looks like if you turn AA off:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm2.staticflickr.com/1832/43859007522_aeb4516f02_o.png" alt="https://farm2.staticflickr.com/1832/43859007522_aeb4516f02_o.png" />
</div>
</div>
<div class="paragraph"><p>You just need to specify a new <code>Antialiasing</code> key under <code>FilterData</code>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">Dim</span></span> <span style="font-weight: bold"><span style="color: #000000">aFilterData</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">)</span> As new com<span style="color: #990000">.</span>sun<span style="color: #990000">.</span>star<span style="color: #990000">.</span>beans<span style="color: #990000">.</span>PropertyValue
<span style="font-weight: bold"><span style="color: #000000">aFilterData</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">).</span>Name <span style="color: #990000">=</span> <span style="color: #FF0000">"AntiAliasing"</span>
<span style="font-weight: bold"><span style="color: #000000">aFilterData</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">).</span>Value <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">False</span></span>
xExporter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">createUnoService</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com.sun.star.drawing.GraphicExportFilter"</span><span style="color: #990000">)</span>
xExporter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SetSourceDocument</span></span><span style="color: #990000">(</span>ThisComponent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">DrawPages</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">Dim</span></span> <span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">)</span> As new com<span style="color: #990000">.</span>sun<span style="color: #990000">.</span>star<span style="color: #990000">.</span>beans<span style="color: #990000">.</span>PropertyValue
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">).</span>Name  <span style="color: #990000">=</span> <span style="color: #FF0000">"URL"</span>
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">).</span>Value <span style="color: #990000">=</span> <span style="color: #FF0000">"file:///tmp/debug/non-aa.png"</span>
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">).</span>Name  <span style="color: #990000">=</span> <span style="color: #FF0000">"FilterData"</span>
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">).</span>Value <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">aFilterData</span></span><span style="color: #990000">()</span>
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">).</span>Name  <span style="color: #990000">=</span> <span style="color: #FF0000">"MediaType"</span>
<span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">).</span>Value <span style="color: #990000">=</span> <span style="color: #FF0000">"image/png"</span>
xExporter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">aArgs</span></span><span style="color: #990000">())</span></tt></pre></div></div>
<div class="paragraph"><p>You can imagine which rendering result is easier to debug when the reference
and the actual bitmap doesn&#8217;t match. ;-)</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">This feature is available for other bitmap formats as well, PNG is only
an example.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_default_character_style_in_writer">Default character style in Writer</h2>
<div class="sectionbody">
<div class="paragraph"><p>In most cases you don&#8217;t really need a default character style: if you&#8217;re fine
with a default, then the default paragraph style should be enough for your
needs. In general, paragraph styles can contain character properties, so if
the default is fine for you, you just don&#8217;t set a character style.</p></div>
<div class="paragraph"><p>However, there is an exception to all rules. If you want to reset the current
character style, it makes sense to just set the <code>CharStyleName</code> property to a
default value, especially since this works with paragraph styles already.</p></div>
<div class="paragraph"><p>Now you can write C++ code like this (see
<a href="https://cgit.freedesktop.org/libreoffice/core/tree/sw/qa/extras/unowriter/unowriter.cxx">SwUnoWriter::testDefaultCharStyle()</a>
for a full example):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>xCursorProps<span style="color: #990000">-&gt;</span><span style="font-weight: bold"><span style="color: #000000">setPropertyValue</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"CharStyleName"</span><span style="color: #990000">,</span> uno<span style="color: #990000">::</span><span style="font-weight: bold"><span style="color: #000000">makeAny</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">OUString</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Standard"</span><span style="color: #990000">)));</span></tt></pre></div></div>
<div class="paragraph"><p>And it&#8217;ll be handled as <code>Default Style</code> in English builds, or their localized
versions in a non-English UI.</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.2), or you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/reqif-xhtml.html">Editing ReqIF-XHTML fragments in LibreOffice Writer</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 05 June 2018</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://youtu.be/hesL0TWZ5JQ">
<img src="https://farm2.staticflickr.com/1752/28703474708_bde744fb13_o.png" alt="https://farm2.staticflickr.com/1752/28703474708_bde744fb13_o.png" />
</a>
</div>
</div>
<div class="paragraph"><p>I worked on a small feature to use Writer as an editor for the XHTML fragments
inside
<a href="https://en.wikipedia.org/wiki/Requirements_Interchange_Format">Requirements
Interchange Format</a> (ReqIF) files.  First, thanks to
<a href="https://vector.com/">Vector</a> for funding
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
<div class="paragraph"><p>Writer already supported XHTML import and export before (see my
<a href="http://vmiklos.hu/blog/odt-xhtml-performance.html">previous post</a>) as a special
mode of the HTML filter, this work builds on top of that. The main speciality
around XHTML as used for fragments inside a ReqIF file is embedded objects.</p></div>
<div class="paragraph"><p>The special mode to opt-in for ReqIF-XHTML behavior can actived like this:</p></div>
<div class="ulist"><ul>
<li>
<p>
during import: <code>--infilter="HTML (StarWriter):xhtmlns=reqif-xhtml"</code>
</p>
</li>
<li>
<p>
during export: <code>-convert-to "xhtml:HTML (StarWriter):xhtmlns=reqif-xhtml"</code>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Three different cases are handled:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Image with native data we don&#8217;t understand and just preserve.
</p>
</li>
<li>
<p>
Image with OLE2 data, which we hand out to external applications (at least
on Windows). On the above video this is an embedded PPSX file, handled by PowerPoint.
</p>
</li>
<li>
<p>
Image with ODF data, which we handle internally. This is a Draw document on the above video.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Regarding how it works, the import is a series of unwrapping containers till
you get to the real data and the export is the opposite of this. Here are the layers:</p></div>
<div class="ulist"><ul>
<li>
<p>
Larger ReqIF files have the <code>.reqifz</code> extension, and are ZIP files
  containing an XML file, having the XHTML fragments. This is not relevant for
  this post, as Writer assumes that extracting the XHTML fragment from ReqIF is
  done before you load the content into Writer.
</p>
</li>
<li>
<p>
XHTML always has a PNG image for the object, and optionally it has RTF as
  native data for the object.
</p>
</li>
<li>
<p>
The RTF file is a fragment, containing just an embedded OLE1 container.
</p>
</li>
<li>
<p>
The OLE1 container is just a wrapper around the real OLE2 container.
</p>
</li>
<li>
<p>
The OLE2 container either has the data directly or MSO has a convention on
  how to include OOXML files in it (see the PPSX example above), and we handle
  that.
</p>
</li>
</ul></div>
<div class="paragraph"><p>On export we do the opposite: save the file, put it into OLE2, then into OLE1,
then into RTF, finally into XHTML.</p></div>
<div class="paragraph"><p>There is no specification on how to put ODF files into OLE2, so I extracted
the relevant code from LibreOffice&#8217;s binary MSO filters and now the Writer
HTML filter uses that as well. This avoids code duplication and also could
avoid inventing some new markup this way.</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.2), or you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/image-lazy-read.html">Lazy reading images from Microsoft formats in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 04 May 2018</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I worked on improving document load performance of Microsoft formats in
general, and DOC/DOCX in particular in LibreOffice recently. First, thanks to
<a href="https://www.documentfoundation.org/">TDF</a> and users that support the foundation
by providing donations for funding <a href="https://www.collaboraoffice.com/">Collabora</a>
to make this possible.</p></div>
<div class="paragraph"><p>I built on top of the
<a href="https://tomazvajngerl.blogspot.com/2018/04/improving-image-handling-in-libreoffice.html">great
work of Tomaz</a>, focusing on these secondary, but important formats.</p></div>
<div class="paragraph"><p>The idea is that if you load an Microsoft binary or OOXML file, it should not
be necessary to parse all images at load time, it&#8217;s enough to lazy read it
when we first render e.g. a Writer page containing that image.</p></div>
<div class="paragraph"><p>The focus here was documents containing large images. I tested with an
<a href="https://www.theverge.com/2012/1/25/2732264/nasas-64-megapixel-photo-of-earth">Earth
photo</a> of size 8000x8000 pixels from NASA, making little modifications to it,
so each picture has a different checksum, embedding them into a binary DOC file.</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm1.staticflickr.com/980/41838412652_c1cbefcfc1_o.png" alt="https://farm1.staticflickr.com/980/41838412652_c1cbefcfc1_o.png" />
</div>
</div>
<div class="paragraph"><p>I measured the time from the <code>soffice</code> process startup to rendering the first
page. We defer the work of loading most images now, as you can see on the
chart. In contrast, we used to decompress all images on file import in the
past. This means the new cost for e.g. 4 images is 37% of the original.</p></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.1), or you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/hamburg2018.html">LibreOffice Hamburg Hackfest 2018</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 10 April 2018</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div style="text-align: center; font-size: 0.6em;">
<img src="https://farm1.staticflickr.com/873/27489617988_4c2ce3fd59_z.jpg"/>
<p>(via <a href="https://twitter.com/Sweet5hark/status/982560887927197696">Sweet5hark</a>)</p>
</div>
<div class="paragraph"><p>I arrived home from Hamburg yesterday where I participated in the
<a href="https://wiki.documentfoundation.org/Hackfest/Hamburg2018">LibreOffice hackfest</a>
over the weekend as a mentor.  First, thanks to The Document Foundation&#8201;&#8212;&#8201;and
all the <a href="https://www.libreoffice.org/donate">donors</a> for funding Collabora to
make this possible.</p></div>
<div class="paragraph"><p>There were a few topics I mentored:</p></div>
<div class="ulist"><ul>
<li>
<p>
Patrick was interested fixing
  <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=116486">tdf#116486</a>,
  which required some background knowledge on the Writer document model and
  layout, so we explored the relevant details together towards providing an
  actual patch for the bug.
</p>
</li>
<li>
<p>
Nithin wanted to fix
  <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=112384">tdf#112384</a>,
  which turned out to be an ideal task for a hackfest. On one hand, the scope is
  limited so that you can implement this mini-feature over a weekened. On the
  other hand, it required touching various parts of Writer (UI, document model,
  UNO API, ODF filter), so it allowed seeing the process of adding a new
  feature. The <a href="https://gerrit.libreoffice.org/52561">patch</a> is merged to master.
</p>
</li>
<li>
<p>
Linus looked for a task that is relatively easy, still useful, we looked at
  <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=42949">tdf#42949</a>, and he
  identified and removed a number of unused includes himself. This should
  especially help with slow incremental builds. Again, the
  <a href="https://gerrit.libreoffice.org/52594">patch</a> is already in master.
</p>
</li>
<li>
<p>
Zdeněk (raal) wanted to write a uitest for
  <a href="https://bugs.documentfoundation.org/show_bug.cgi?id=106280">tdf#106280</a> so we
  were figuring out together how to select images from pyuno and how to avoid
  using graphic URLs in uitests in general.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The full list of achievements is
<a href="https://wiki.documentfoundation.org/Hackfest/Hamburg2018#Achievements">on the
wiki</a>, if you were at the hackfest and you did not contribute to that section,
please write a line about what did you hack on. :-)</p></div>
<div class="paragraph"><p>Finally, thanks for the organizers and the sponsors of the hackfest, it was a
really great event!</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/odt-xhtml-performance.html">Optimizing ODT ↔ XHTML conversion performance for simple documents</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 02 March 2018</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I worked on improving the ODT ↔ XHTML conversion performance for simple
documents in LibreOffice recently.  First, thanks to
<a href="https://vector.com/">Vector</a> for funding
<a href="https://www.collaboraoffice.com/">Collabora</a> to make this possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_odt_8594_xhtml_conversion">ODT &#8594; XHTML conversion</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4605/26697712598_2ace3f45a3_o.png" alt="https://farm5.staticflickr.com/4605/26697712598_2ace3f45a3_o.png" />
</div>
</div>
<div class="paragraph"><p>The focus here was <strong>really</strong> simple documents, like just one sentence with
minimal formatting. The use-case is to have thousands of these simple
documents, only a minority containing complex formatting, the rest is just
that simple.</p></div>
<div class="paragraph"><p>Performance work usually focuses on one specific complex feature, e.g. lots of
bookmarks, lots of document-level user-defined metadata, and so on&#8201;&#8212;&#8201;this way
there were room for improvements when it comes to trivial documents.</p></div>
<div class="paragraph"><p>I managed to reduce the cost of the conversion to the <em>fifth of the original</em>
cost in both directions&#8201;&#8212;&#8201;the chart above shows the impact of my work for
the ODT &#8594; XHTML direction. The steps that helped:</p></div>
<div class="ulist"><ul>
<li>
<p>
Recognize <code>XHTML</code> as a value for the <code>FilterOptions</code> key in the <code>HTML
  (StarWriter)</code> export filter, this way avoid the need to go via XSLT, which
  would be expensive.
</p>
</li>
<li>
<p>
Add a new <code>NoFileSync</code> flag to the <code>frame::XStorable::storeToURL()</code> API, so
  that if you know you&#8217;ll read the result after the conversion finished, you
  can avoid an expensive <code>fsync()</code> call for each and every file, which helps
  HDDs a lot, while means no overhead for SSDs.
</p>
</li>
<li>
<p>
If you know your input format already, then specifying an explicit
  <code>FilterName</code> key for the <code>frame::XComponentLoader::loadComponentFromURL()</code>
  API helps not spending time to detect the file format you already know.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Note that the XHTML mode for the Writer HTML export is still a work in
progress, but it already produces valid output for such simple documents.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_xhtml_8594_odt_conversion">XHTML &#8594; ODT conversion</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm5.staticflickr.com/4608/39674632615_de78265c7f_o.png" alt="https://farm5.staticflickr.com/4608/39674632615_de78265c7f_o.png" />
</div>
</div>
<div class="paragraph"><p>The chart above shows the results of my work for the XHTML &#8594; ODT direction.
The steps to get to the final reduced cost were:</p></div>
<div class="ulist"><ul>
<li>
<p>
The new <code>NoFileSync</code> flag, as mentioned previously.
</p>
</li>
<li>
<p>
A new <code>NoThumbnail</code> flag, which is useful if the ODT will be part of a next
  step in the pipeline and you know that the thumbnail image won&#8217;t be used anyway.
</p>
</li>
<li>
<p>
The default table autoformat definitions in Writer are now
  <a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=53ef918a6839c8d587dec1bb635e6b39397c53d0">lazy-loaded</a>.
  (This is my favorite one, you don&#8217;t have to opt-in for this, so everyone
  benefits.)
</p>
</li>
<li>
<p>
A new <code>HiddenForConversion</code> flag for
  <code>frame::XComponentLoader::loadComponentFromURL()</code>, which means we don&#8217;t lay
  out the UI elements (toolbars, sidebar, status bar, etc.) when we know the
  purpose of the document load is only to save the document model in an other
  format.
</p>
</li>
</ul></div>
<div class="paragraph"><p>All this is available in master (towards LibreOffice 6.1), or you can grab a
<a href="http://dev-builds.libreoffice.org/daily/master/">daily build</a> and try it out
right now. :-)</p></div>
</div>
</div>

  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/category/libreoffice10.html" class="button_accent">&larr; Older Posts</a>

<a href="https://vmiklos.hu/blog/category/libreoffice8.html" class="button_accent">Newer Posts &rarr;</a>
</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>