<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://vmiklos.hu/blog/theme/css/pygments.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Miklos Vajna">
  <meta name="description" content="Posts and writings by Miklos Vajna">

  <link href="https://vmiklos.hu/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking RSS" />

<link href="https://vmiklos.hu/blog/feeds/libreoffice.rss.xml" type="application/rss+xml" rel="alternate" title="What is Miklos hacking libreoffice Category RSS" />

  <title>
    What is Miklos hacking
&ndash; Category: libreoffice  </title>

<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.vmiklos.hu/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <h2><a href="https://vmiklos.hu/blog">What is Miklos hacking</a></h2>
      <p></p>
      <ul>
        <li><a href="/" target="_blank">Root</a></li>
        <li><a href="https://planet.documentfoundation.org/" target="_blank">LibreOffice Blogs</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="https://vmiklos.hu/blog">Index</a> &brvbar; <a href="https://vmiklos.hu/blog/archives.html">Archives</a>
      &brvbar; <a href="https://vmiklos.hu/blog/feeds/all.rss.xml">RSS</a>
&gt; Category: libreoffice
&brvbar; <a href="https://vmiklos.hu/blog/feeds/libreoffice.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/mail-merge-writer-data-source.html">Mail merge Writer data source</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Fri 21 July 2017</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>If you ever used the
<a href="https://help.libreoffice.org/Writer/Mail_Merge_Wizard">mail merge wizard</a> with
data sources, then you know how it works: it typically needs some kind of data
source (e.g. a Calc spreadsheet), a Writer document containing the email or
letter (that contains fields), and then mail merge can generate the
personalized documents for you.</p></div>
<div class="paragraph"><p>In case you have an existing document where you already have such data in a
Writer table, you had to somehow transfer it to one of the formats for which
there was a data source driver, and then you could use it inside mail merge.
I&#8217;ve now added a dedicated Writer driver in <code>connectivity/</code>, so picking up
data directly from Writer tables is now possible.</p></div>
<div class="paragraph"><p>If you are interested how this looks like, here is a demo (click on the image
to see the video):</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://youtu.be/thasVxlF5Fo">
<img src="https://farm5.staticflickr.com/4298/36060010585_900a1c7f1c_o.png" alt="https://farm5.staticflickr.com/4298/36060010585_900a1c7f1c_o.png" />
</a>
</div>
</div>
<div class="paragraph"><p>That&#8217;s it for now&#8201;&#8212;&#8201;as usual the commits are in master, so you can try this
right now with a 6.0 <a href="http://dev-builds.libreoffice.org/daily/master/">daily
build</a>. :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/system-xmlsec.html">Using LibreOffice with xmlsec from the system</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 04 July 2017</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>LibreOffice uses a number of external libraries, and most of them can be
configured to use a bundled version or a system version. libxmlsec was an
exception previously (only the bundled version was usable), but LibreOffice
master (towards 6.0) doesn&#8217;t have this limitation anymore.</p></div>
<div class="paragraph"><p>Using a bundled version is a good choice in case:</p></div>
<div class="ulist"><ul>
<li>
<p>
you want to create self-contained binaries
</p>
</li>
<li>
<p>
you want to bisect a regression, where possibly the regression was
  introduced by upgrading one of the external libraries
</p>
</li>
<li>
<p>
the system (e.g. macOS, Windows) doesn&#8217;t provide the relevant library
</p>
</li>
</ul></div>
<div class="paragraph"><p>Using a system version is a good thing in case:</p></div>
<div class="ulist"><ul>
<li>
<p>
you want to work with the system, not against it (if a Linux distro already
  provides libxmlsec, why ship a duplicated copy inside LibreOffice?)
</p>
</li>
<li>
<p>
being able to use a system version means our bundled version does not have
  custom patches which affect the functionality of the library
</p>
</li>
<li>
<p>
not having custom patches also means upstream benefit from our submitted
  patches, these patches are reviewed by competent maintainers and upgrading
  the external is easier, as there is no patchset to rebase.
</p>
</li>
</ul></div>
<div class="paragraph"><p>With that in mind, let&#8217;s have a look what blocked using system-xmlsec in the past:</p></div>
<div class="ulist"><ul>
<li>
<p>
LibreOffice inherited a large patchset from OpenOffice.org, commit
  694a2c53810dec6d8e069d74baf51e6cdda91faa (2012-11-30) had 16 patches, with
  this scary diffstat:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code> 43 files changed, 5888 insertions(+), 1885 deletions(-)</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
I even increased this when I added the
  <a href="https://vmiklos.hu/blog/libreoffice-sha256-signatures.html">SHA256 patches</a>, as back then
  I wasn&#8217;t sure if it&#8217;ll be ever possible to upgrade to a newer libxmlsec
  version.
</p>
</li>
<li>
<p>
Step by step I got rid of most of these patches, either by upstreaming them
  or realizing they are no longer necessary. Upstreaming wasn&#8217;t always
  trivial, as for our purposes it was always easy to patch something, but for
  upstream non-compatible changes always have to be conditional. Today we have
  3 build-specific patches, 1 backport and 1 feature patch that is (at least)
  not necessary when signing / verifying documents with software-based
  certificates.
</p>
</li>
<li>
<p>
At the end
  <a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=9752eccdd06f6695ec4f173ea93cada65063d1f0">two</a>
  <a href="https://cgit.freedesktop.org/libreoffice/core/commit/?id=ab50f0b08b22af1e60a0b6ce5e7e8e7d1f665216">more</a>
  commits were necessary to support building against system-xmlsec, only adding
  minimal differences when using the system or the bundled xmlsec variants.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you are a Linux distro packager then <code>--with-system-libs</code> already implies
<code>--with-system-xmlsec</code>, so you probably don&#8217;t have to do anything. If you
build LO for static analysis (e.g. Coverity) then this should be also useful,
so not relevant issues in 3rd-party code don&#8217;t have to be ignored manually.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/perugia2017.html">LibreOffice Perugia HackFest 2017</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 31 May 2017</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div style="text-align: center; font-size: 0.6em;">
<img src="https://farm5.staticflickr.com/4272/34874639921_ef2ce56d1c_z.jpg"/>
<p>(via <a href="https://twitter.com/ogervasi/status/868767747756503041">ogervasi</a>)</p>
</div>
<div class="paragraph"><p>Last weekend I attended the LibreOffice
<a href="https://wiki.documentfoundation.org/Hackfest/Perugia2017">Perugia</a> HackFest
2017, with the primary goal of mentoring students (together with
<a href="http://erack.org/blog/">Eike</a> and Christian): provided they manage to
contribute at least one non-trivial easy hack, they get university credits for
their work.</p></div>
<div class="paragraph"><p>I worked with <a href="https://gerrit.libreoffice.org/38160">Arianna</a>,
<a href="https://gerrit.libreoffice.org/38159">Claudio</a>,
<a href="https://gerrit.libreoffice.org/38161">Francesco</a> and
<a href="https://gerrit.libreoffice.org/38134">Gian</a>, all of them managed to
achieve something by the end of the third day.</p></div>
<div class="paragraph"><p>When I was not helping others, I also fixed a few bugs:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=107976">tdf#107976</a> sw: let a view handle multiple transferables
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=107837">tdf#107837</a> DOCX export: fix balanced multi-col section at doc end
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=107684">tdf#107684</a> DOCX export: fix duplicated &lt;w:outlineLvl&gt; element for styles
</p>
</li>
<li>
<p>
<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=106950">tdf#106950</a> sw: support CharShadingValue property on paragraph styles
</p>
</li>
</ul></div>
<div class="paragraph"><p>Some photos I took during the event are <a href="https://www.flickr.com/photos/vmiklos/albums/72157681387507534">available</a>.</p></div>
<div class="paragraph"><p>Thanks the organizers for the great event, also kudos to
<a href="https://www.collaboraoffice.com/">Collabora</a>, Red Hat and TDF for allowing
mentors to come! :-)</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/xmlsec-lo54.html">xmlsec improvements in LibreOffice 5.4</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Wed 17 May 2017</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 1 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>This post summarizes the plumbing work around ODF/OOXML digital signatures
that I did on LibreOffice master after the 5.3 branch-off up to now. The big
thing is the
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commit;h=ad319fdfcaaa6092ea1ff76935e088c5122e0d2e">integration</a>
of the libxmlsec 1.2.24 release. Among other things, this contains 2 larger
changes that I contributed upstream triggered by the needs of LibreOffice:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <a href="https://vmiklos.hu/blog/xmlsec-nss-ecdsa.html">ECDSA-SHA256 feature</a> is something I
  already mentioned, but I did not bother to backport the SHA1 and the SHA256
  part, so those now arrived to LibreOffice as well.
</p>
</li>
<li>
<p>
xmlsec&#8217;s <code>XMLSEC_KEYINFO_FLAGS_X509DATA_DONT_VERIFY_CERTS</code> flag (while
  verifying signatures) was there, but its behavior was not clear (neither
  for <a href="https://github.com/lsh123/xmlsec/pull/78">nss</a> nor for
  <a href="https://github.com/lsh123/xmlsec/pull/79">mscrypto</a>). I&#8217;ve changed it to be in
  sync what you have in other commands to avoid certificate validation (like
  <code>wget -k</code> or <code>curl -k</code>), which means as a next step there will be one less
  xmlsec patch in LibreOffice that prevents us from using xmlsec from the system
  on Linux. (Adding tests also detected that in the nss case not using that flag
  also didn&#8217;t do verification by accident, this is now fixed as well.)
</p>
</li>
</ul></div>
<div class="paragraph"><p>After the release I also noticed that creating signatures on Windows
<a href="https://www.aleksey.com/pipermail/xmlsec/2017/010143.html">was broken</a>, this is
now fixed on xmlsec master and also backported to LibreOffice.</p></div>
<div class="paragraph"><p>All this is available in LibreOffice master, towards 5.4.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/pdf-image-rountrip.html">Improved rountrip of PDF images in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 18 April 2017</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>This is a follow-up to the <a href="https://vmiklos.hu/blog/pdfium.html">previous post</a> that
described how it is now possible to insert a PDF file as an image in
LibreOffice and export that back to PDF, while keeping the original PDF
contents. I&#8217;ve recently improved this feature so the resulting file is smaller
and the vector image can be viewed in more viewers. First, thanks to
<a href="http://www.pmg.be/">PMG</a> who made this work possible.</p></div>
<div class="paragraph"><p>Let&#8217;s look at the previously mentioned <em>front page of a magazine</em> sample when
it&#8217;s viewed in okular. (A KDE pdf viewer, i.e. something that&#8217;s not Adobe
Acrobat). The previously used <em>reference XObject</em> PDF markup is not handled by
it, so the bitmap fallback was displayed:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3947/34031939205_5315a9afb4_o.png" alt="https://farm4.staticflickr.com/3947/34031939205_5315a9afb4_o.png" />
</div>
</div>
<div class="paragraph"><p>Compare it with the new result:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2830/34031939425_24b9a126ee_o.png" alt="https://farm3.staticflickr.com/2830/34031939425_24b9a126ee_o.png" />
</div>
</div>
<div class="paragraph"><p>Notice the sharp text in the first line.</p></div>
<div class="paragraph"><p>Also the size of this sample is smaller now, since we don&#8217;t write a large
bitmap, and the not shown second page of the PDF image: 2 385 984 &#8594; 1 605 558
bytes (about one third of the output is avoided).</p></div>
<div class="paragraph"><p>Both techniques have pros and cons, here is a summary:</p></div>
<div class="ulist"><ul>
<li>
<p>
The <em>reference XObject</em> approach allows you to preserve the full PDF data of
  the image: if it was of multiple pages, even that. Also, the LibreOffice
  code for this is simple: we just preserve a byte array&#8201;&#8212;&#8201;that can hardly go
  wrong. The problem is that no non-Acrobat PDF viewer implements this,
  including e.g. your printer most probably.
</p>
</li>
<li>
<p>
The new approach uses the tokenizer I originally wrote for
  <a href="https://vmiklos.hu/blog/pdf-sign.html">PDF signature verification</a> purposes&#8201;&#8212;&#8201;it extracts
  the page stream of the first page from the original file and uses it as a
  form XObject in the export result&#8201;&#8212;&#8201;this is the same as how e.g. <code>pdfcrop</code>
  works.  This markup is handled by almost all PDF viewers and also the
  resulting size is smaller, since the data of other pages is dropped and there
  is no fallback bitmap. The problem may be that this is a much more complex
  scenario, so it may go wrong (as usual, bugreports
  <a href="https://bugs.documentfoundation.org/enter_bug.cgi?product=LibreOffice">are
  welcome</a>).
</p>
</li>
</ul></div>
<div class="paragraph"><p>Nevertheless, the new approach seems like a much better default, so
LibreOffice no longer writes the <em>reference XObject</em> approach unless you
explicitly request it in the PDF export dialog.</p></div>
<div class="paragraph"><p>Some perhaps interesting details:</p></div>
<div class="ulist"><ul>
<li>
<p>
PDF page streams may be provided by multiple objects, but form XObjects must
  have a single stream, so it we handle the case when different parts of the
  page stream are compressed in different ways.
</p>
</li>
<li>
<p>
LibreOffice writes PDF-1.4 by default, in case you insert a PDF image that
  uses PDF-1.5+, we use pdfium to downgrade that markup to 1.4, and only
  then insert it.
</p>
</li>
<li>
<p>
Copying the page stream of the image is not enough, we also recursively copy
  all referenced objects from the source PDF, while rewriting all contained
  references, since the objects IDs in the old and new files differ. We also
  take care of proper scoping of named references in the resource dictionary, so
  you can use this feature recursively (insert a document as a PDF image, even
  if that document itself contains PDF images already). :-)
</p>
</li>
</ul></div>
<div class="paragraph"><p>All this is available in LibreOffice master, towards 5.4.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/pdfium.html">LibreOffice now uses pdfium to render inserted PDF images</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Mon 20 March 2017</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>pdfium is the rendering library used in Chromium&#8217;s pdf viewer. It&#8217;s based on
the foxit pdf renderer and its rendering quality is much better compared to
the pre-existing "convert PDF to ODG, then to an image" code when it comes to
just viewing a PDF file.  First, thanks to <a href="http://www.pmg.be/">PMG</a> who made
this work possible.</p></div>
<div class="paragraph"><p>Let&#8217;s look at a few samples that compare the old pdfimport rendering result
and the new pdfium-based one. One important feature is that embedded fonts are
handled. This is how this inserted PDF looked like previously:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3727/33163219940_3a2a3278a0_o.png" alt="https://farm4.staticflickr.com/3727/33163219940_3a2a3278a0_o.png" />
</div>
</div>
<div class="paragraph"><p>Compare it with the new result:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2927/33547029855_92c1a5150d_o.png" alt="https://farm3.staticflickr.com/2927/33547029855_92c1a5150d_o.png" />
</div>
</div>
<div class="paragraph"><p>Now let&#8217;s see the front page of a magazine, you can see 4 unexpected artifacts:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3948/33563793222_8a6b8e8a6b_z.jpg" alt="https://farm4.staticflickr.com/3948/33563793222_8a6b8e8a6b_z.jpg" />
</div>
</div>
<div class="paragraph"><p>New result:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2809/33547029645_de7cbcd800_z.jpg" alt="https://farm3.staticflickr.com/2809/33547029645_de7cbcd800_z.jpg" />
</div>
</div>
<div class="paragraph"><p>Finally a problem with pdfium was that LibreOffice got bitmaps from it, so in case you re-exported to PDF, the quality of these PDF images were worse than in the original PDF file. The PDF specification has a <em>reference XObject</em> feature that helps in this case: it allows the PDF export to still write the bitmap to the exported PDF, but in case the reader supports this feature, the vector-based original file will be shown, not the bitmap.</p></div>
<div class="paragraph"><p>Here is a simple hand-crafted star in a PDF file, as it looked initially:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2915/33163219680_30f63b4a82_z.jpg" alt="https://farm3.staticflickr.com/2915/33163219680_30f63b4a82_z.jpg" />
</div>
</div>
<div class="paragraph"><p>This is how it looks after LibreOffice&#8217;s PDF export learned to emit reference XObjects:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3933/33547029485_4f487bb26c_z.jpg" alt="https://farm4.staticflickr.com/3933/33547029485_4f487bb26c_z.jpg" />
</div>
</div>
<div class="paragraph"><p>All this is available in LibreOffice master, towards 5.4.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/pdf-video-export.html">LibreOffice PDF export now supports videos</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 16 February 2017</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm4.staticflickr.com/3924/32549564340_4d0990cfa4_o.png" alt="https://farm4.staticflickr.com/3924/32549564340_4d0990cfa4_o.png" />
</div>
</div>
<div class="paragraph"><p>PDF supports screen annotations, which means it&#8217;s possible to play embedded
and linked videos on top of a static image. Given that LibreOffice also
supports videos, it made sense to add support for this in our PDF export
filter. First, thanks to <a href="http://www.pmg.be/">PMG</a> who made this work possible. This
is currently added for Writer and Impress.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_linked_videos">Linked videos</h2>
<div class="sectionbody">
<div class="paragraph"><p>Linked videos are the situation when the video is not part of the document
itself, but it&#8217;s located somewhere else, e.g. a http:// location. This is
helpful if you want to email around a PDF file, and want to avoid sending
large files when it has video content.</p></div>
<div class="paragraph"><p><a href="https://bugs.documentfoundation.org/show_bug.cgi?id=104841">tdf#104841</a> is
about this situation, first I added support for
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=9d6a749bc664f1876c938afb9eba4adc9f6ee09a">linked
videos in Impress</a>, then
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=81aef113056270ce65f9dee5fe31b6f60617973c">also</a>
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=0e71075bb7379af318482bb3abbb630c58db9ec9">in
Writer</a>.</p></div>
<div class="paragraph"><p>The result can be played using Adobe Acrobat Reader&#8201;&#8212;&#8201;for some reason okular
on Linux is a bit confused about http:// URLs, wants to convert them to
relative ones, and then fails as of today.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_embedded_videos">Embedded videos</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm3.staticflickr.com/2666/32115175413_ec6f64243a_z.jpg" alt="https://farm3.staticflickr.com/2666/32115175413_ec6f64243a_z.jpg" />
</div>
</div>
<div class="paragraph"><p><a href="https://bugs.documentfoundation.org/show_bug.cgi?id=105093">tdf#105093</a> is the
embedded video case, this is handy in case you want to create an entirely
self-contained PDF, where even the video content is inside the PDF file as an
embedded file.</p></div>
<div class="paragraph"><p>After
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=4ad249af88d15f2c8a09f0721a59d82718fcc201">Impress
support</a> (and a trick around
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=64d80d22851a38eb3f320f4e2b2bdf875da4d8b4">Draw
vs Impress shapes</a>) the
<a href="http://cgit.freedesktop.org/libreoffice/core/commit/?id=46153bdcf2f89e88607dfb0dd0003108796424e9">Writer
part</a> wasn&#8217;t too complicated.</p></div>
<div class="paragraph"><p>Regarding the situation around various video containers and codecs, the above
code is quite agnostic. :-) On the LibreOffice side all we require is to be
able to extract a key frame from the video to provide a preview image, so e.g.
on Linux the support depends on what gstreamer plugins you have installed. The
video content is written to the PDF file as-is, so again if it will work in
the PDF reader is up to the reader&#8217;s codec support. On Linux e.g. okular uses
vlc for video playback, so the range of supported formats is quite wide.  The
same is true on Windows, what I personally tested is LibreOffice&#8217;s VLC backend
and the embedded QuickTime player in Acrobat Reader.</p></div>
<div class="paragraph"><p>All of this is available on LibreOffice master towards 5.4.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/fosdem-2017.html">Impress bugfixes, in time for FOSDEM 2017</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 31 January 2017</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm1.staticflickr.com/334/32605456735_ac88121be8_o.png" alt="https://farm1.staticflickr.com/334/32605456735_ac88121be8_o.png" />
</div>
</div>
<div class="paragraph"><p><a href="https://fosdem.org/2017/">FOSDEM 2017</a> is here this weekend, and as Michael
Stahl pointed out, this (together with the LibreOffice annual conference) are
two time periods each year when lots of Impress bugfixes are made, as people
start <a href="https://en.wikipedia.org/wiki/Eating_your_own_dog_food">dogfooding</a>. ;-)
So below you can read about a pair of Impress bugs I fixed recently.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_changing_font_size_now_takes_table_selection_into_account">Changing font size now takes table selection into account</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="https://bugs.documentfoundation.org/show_bug.cgi?id=105502">tdf#105502</a> is a
situation where you have an Impress table shape, and you select part of the
cells, then you click on the sidebar to change the font size. Previously this
affected all cells of the table shape, now only the selected cells are
updated.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_background_fill_for_shapes">Background fill for shapes</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm1.staticflickr.com/277/31761747774_4b1e6b8d38_o.png" alt="https://farm1.staticflickr.com/277/31761747774_4b1e6b8d38_o.png" />
</div>
</div>
<div class="paragraph"><p><a href="https://bugs.documentfoundation.org/show_bug.cgi?id=105150">tdf#105150</a> is a
PPT(X) filter bug where a shape was previously imported as transparent, but it
actually has to have the same fill type as the slide background. In case of
PPTX this was already handled in general, but not in case the slide had no
explicit background. The result was that in case the shape was used to cover
other shapes, they were visible, leading to e.g. this unexpected red rectangle
on the screenshot.</p></div>
<div class="paragraph"><p>The same bug was present in the PPT import, though there existing support was
even more limited: just the "background colored objects" were collected, but
nothing was done to them. Now the above use-case should be as good for PPT as
it is for PPTX.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/hackweek-2016.html">Hack-(rest-of-the)-week at Collabora</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 17 January 2017</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 2 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="https://farm1.staticflickr.com/726/32306648426_b4ee93f6a1_o.png" alt="https://farm1.staticflickr.com/726/32306648426_b4ee93f6a1_o.png" />
</div>
</div>
<div class="paragraph"><p>As mentioned in
<a href="https://mikekaganski.wordpress.com/2016/12/11/my-first-hack-rest-of-the-week-at-collabora/">the
blog post of Mike</a> already, last month we were allowed to hack on anything we
want in LibreOffice for a few days. I used this time to progress with 3
different topics.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_stepping_through_textboxes_using_the_keyboard">Stepping through TextBoxes using the keyboard</h2>
<div class="sectionbody">
<div class="paragraph"><p>Given that a Writer shape with a TextBox is internally two shapes, this needed
explicit support. After my
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=5d2c189aee5057d1533165c368227c9c4c49d330">TextBox
bugfix</a> it&#8217;s possible to have two such shapes in a document, and once you
select one of them, tab properly jumps between the two shapes; previously
nothing happened.</p></div>
<div class="paragraph"><p>What did happen is we tried to activate the TextBox of the selected shape,
which selected the shape itself, so at the end nothing happened.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_rtf_improvements">RTF improvements</h2>
<div class="sectionbody">
<div class="paragraph"><p>For some time it was already possible to import and export custom string
document properties from/to RTF, but just in case the value type of the
property was string. Now I extended support for these custom properties, so
also the remaining types are handled:
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=fc8c4606e0834cd2128a228c2c95fc7c8f9eb7b1">numbers</a>,
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=547de17fcb654e560a60d683c33482feeee84358">bools</a>,
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=51c400dc4cd6a88c01b245e41d0de737d4df4017">doubles</a>
and
<a href="https://gerrit.libreoffice.org/gitweb?p=core.git;a=commitdiff;h=07b0cde32a7eebce996b8c32aa58545e4ec15003">dates</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_xmlsec_patch_upstreaming">xmlsec patch upstreaming</h2>
<div class="sectionbody">
<div class="paragraph"><p>Last, I&#8217;ve started working on upstreaming
<code>external/libxmlsec/xmlsec1-noverify.patch.1</code>. xmlsec has no ability to
disable the verification of certificates (think of <code>curl -k</code> or <code>wget -k</code>), so
in LibreOffice currently we just patch out that code as we don&#8217;t need it. So I
wanted to add a new verification flag to avoid patching, but it turns out that
in the NSS case xmlsec didn&#8217;t do the verification, so as a first step I fixed
that instead in this <a href="https://github.com/lsh123/xmlsec/pull/72">xmlsec GitHub
pull request</a>. Now that it&#8217;s merged, the next step will be to add such a flag,
and then LibreOffice can get rid of the patch after the next xmlsec release.</p></div>
</div>
</div>

  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="https://vmiklos.hu/blog/pades.html">PAdES support for PDF files in LibreOffice</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 20 December 2016</p>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 3 minutes</p>
  </div>
  <div class="article_text">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<a class="image" href="https://farm1.staticflickr.com/443/30919530974_5c5b3cb3a9_o.png">
<img src="https://farm1.staticflickr.com/443/30919530974_7ab3d132d8_z.jpg" alt="https://farm1.staticflickr.com/443/30919530974_7ab3d132d8_z.jpg" />
</a>
</div>
</div>
<div class="paragraph"><p>Building on top of the previously mentioned
<a href="https://vmiklos.hu/blog/pdf-sign.html">signing of existing PDF files</a> work, one
more PDF feature coming in LibreOffice 5.3 is initial support for the PDF
Advanced Electronic Signatures (<a href="https://en.wikipedia.org/wiki/PAdES">PAdES</a>)
standard.  First, thanks to the Dutch Ministry of Defense in cooperation with
<a href="http://nouenoff.nl/">Nou&amp;Off</a> who made this work possible.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_results">Results</h2>
<div class="sectionbody">
<div class="paragraph"><p>PAdES is an extension of the ISO PDF signature with additional constraints, so
that it conforms to the requirements of the European eIDAS regulation, which
in turns makes it more likely that your signed PDF document will be actually
legally binding in many EU member states.</p></div>
<div class="paragraph"><p>The best way to check if LibreOffice produces such PDF signatures is to use a
PAdES validator. So far I found two of them:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://signatures-conformance-checker.etsi.org/">the ETSI one</a>, which
  requires registration and is a free web service
</p>
</li>
<li>
<p>
<a href="https://github.com/esig/dss/">Digital Signature Service</a> (DSS), which is an
  open source tool you can build, use and modify locally
</p>
</li>
</ul></div>
<div class="paragraph"><p>As it can be seen above, the PDF signature produced by LibreOffice 5.3 by
default conforms to the PAdES baseline spec.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation">Implementation</h2>
<div class="sectionbody">
<div class="paragraph"><p>I implemented the followings in LO to make this happen:</p></div>
<div class="ulist"><ul>
<li>
<p>
PDF signature creation now defaults to the stronger SHA-256 (instead of the
  previously used weaker SHA-1), and the PDF verifier understands SHA-256
</p>
</li>
<li>
<p>
the PDF signature creation now embeds the signing certificate into the
  PKCS#7 signature blob in the PDF, so the verifier can check not only the key
  used for the signing, but the actual certificate as well
</p>
</li>
<li>
<p>
the PDF signature import can now detect if such an embedded signing
  certificate is present in the signature or not
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Don&#8217;t get confused, LO does signature verification (checks if the digest
matches and validates the certificate) and now shows if the signing
certificate is present in the signature or not, but it doesn&#8217;t do more than
that, the above mentioned DSS tool is still superior when it comes to do a
full validation of a PAdES signature.</td>
</tr></table>
</div>
<div class="paragraph"><p>As usual, this works both with NSS and MS CryptoAPI. In the previous post I
noted that one task was easier with CryptoAPI. Here I experienced the
opposite: when writing the signing certificate hash, I could provide templates
to NSS on how the ASN.1 encoding of it should happen, and NSS did the actual
ASN.1 DER encoding for me. In the CryptoAPI case there is no such API, so I
had to do this encoding manually (see
<a href="https://github.com/LibreOffice/core/blob/master/vcl/source/gdi/pdfwriter_impl.cxx#L6202">CreateSigningCertificateAttribute()</a>),
which is obviously much more complicated.</p></div>
<div class="paragraph"><p>Another pain was that the DSS tool doesn&#8217;t really separate the validation of
the signature itself and of the certificate. The above screenshot was created
using a non-self-signed certificate, hence the unclear part in the signed-by
row.</p></div>
<div class="paragraph"><p>If you want to try these out yourself, get a
<a href="http://dev-builds.libreoffice.org/daily/">daily build</a> and feel free to play
with it. This work is part of both <code>master</code> or <code>libreoffice-5-3</code>, so those
builds are of interest. Happy testing! :-)</p></div>
</div>
</div>

  </div>
</article>

<footer>
<div id="paginator">
<a href="https://vmiklos.hu/blog/category/libreoffice10.html" class="button_accent">&larr; Older Posts</a>

<a href="https://vmiklos.hu/blog/category/libreoffice8.html" class="button_accent">Newer Posts &rarr;</a>
</div>
</footer>

    <div id="ending_message">
      <p>&copy; Miklos Vajna. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>